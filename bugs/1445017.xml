<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1445017</bug_id>

    <creation_ts>2017-04-24 14:01:00 -0400</creation_ts>
    <short_desc>After enrolling in an AD domain with realmd, no responders are started</short_desc>
    <delta_ts>2017-04-27 16:54:43 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>realmd</component>
    <version>26</version>
    <rep_platform>All</rep_platform>
    <op_sys>Linux</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>ERRATA</resolution>

    <see_also>https://bugs.freedesktop.org/show_bug.cgi?id=98479</see_also>
    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords></keywords>
    <priority>unspecified</priority>
    <bug_severity>high</bug_severity>
    <target_milestone>---</target_milestone>

    <blocked>1349186</blocked>
    <everconfirmed>1</everconfirmed>
    <reporter name="Stephen Gallagher">sgallagh</reporter>
    <assigned_to name="Sumit Bose">sbose</assigned_to>
    <cc>abokovoy</cc>

    <cc>fidencio</cc>

    <cc>jhrozek</cc>

    <cc>lslebodn</cc>

    <cc>mzidek</cc>

    <cc>pbrezina</cc>

    <cc>preichl</cc>

    <cc>rharwood</cc>

    <cc>robatino</cc>

    <cc>sbose</cc>

    <cc>ssorce</cc>

    <cc>stefw</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in>realmd-0.16.3-5.fc26</cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2017-04-27 16:54:43</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>10357806</commentid>
<comment_count>0</comment_count>
<who name="Stephen Gallagher">sgallagh</who>
<bug_when>2017-04-24 14:01:22 -0400</bug_when>
<thetext>Description of problem: While following the Fedora release validation tests for Fedora Server as an AD client[1], I discovered that `getent passwd Administrator@domain` was failing. After investigation, I realized that this was because the
sssd_nss and sssd_pam responders were not started with SSSD. Version-Release number of selected component (if applicable): sssd-1.15.2-2.fc26 realmd-0.16.3-4.fc26 How reproducible: Only tried on a single machine, but unenrolling and re-enrolling with
realmd produces the same result each time. Steps to Reproduce: 1. Download the latest Fedora Server prerelease image (see [1]) 2. Install Fedora Server with all the usual defaults (setting the hostname to something other than
&apos;localhost.localdomain&apos;) 3. Using either realmd directly or the Cockpit UI (which I did), enroll with a 4. Sign into the system via a shell and run `getent passwd Administrator@domain.name` (substituting the appropriate value for
&quot;domain.name&quot;) Actual results: No results returned Expected results: User information about the &quot;Administrator&quot; user in Active Directory should be returned. Additional info: [1]
https://fedoraproject.org/wiki/Test_Results:Fedora_26_Branched_20170420.n.0_Server#Domain_joining_tests:_Active_Directory</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10357906</commentid>
<comment_count>1</comment_count>
<who name="Stephen Gallagher">sgallagh</who>
<bug_when>2017-04-24 14:42:50 -0400</bug_when>
<thetext>Proposing as a Beta Blocker under the criterion: &quot;It must be possible to join the system to a FreeIPA or Active Directory domain at install time and post-install, and the system must respect the identity, authentication and access
control configuration provided by the domain.&quot;</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10358083</commentid>
<comment_count>2</comment_count>
<who name="Lukas Slebodnik">lslebodn</who>
<bug_when>2017-04-24 16:01:19 -0400</bug_when>
<thetext>sssd works well with enabled sockets sh# systemctl status --lines=0 sssd sssd-{nss,pam}.{socket,service} ● sssd.service - System Security Services Daemon Loaded: loaded (/usr/lib/systemd/system/sssd.service; enabled; vendor preset: Drop-In:
/etc/systemd/system/sssd.service.d └─journal.conf Active: inactive (dead) since Mon 2017-04-24 21:57:35 CEST; 30s ago Process: 12884 ExecStart=/usr/sbin/sssd -i -f (code=exited, status=0/SUCCESS) Main PID: 12884 (code=exited, status=0/SUCCESS) CPU:
76ms ● sssd-nss.socket - SSSD NSS Service responder socket Loaded: loaded (/usr/lib/systemd/system/sssd-nss.socket; disabled; vendor pre Active: inactive (dead) Docs: man:sssd.conf(5) Listen: /var/lib/sss/pipes/nss (Stream) ● sssd-nss.service - SSSD
NSS Service responder Loaded: loaded (/usr/lib/systemd/system/sssd-nss.service; indirect; vendor pr Active: inactive (dead) Docs: man:sssd.conf(5) ● sssd-pam.socket - SSSD PAM Service responder socket Loaded: loaded
(/usr/lib/systemd/system/sssd-pam.socket; disabled; vendor pre Active: inactive (dead) Docs: man:sssd.conf(5) Listen: /var/lib/sss/pipes/pam (Stream) ● sssd-pam.service - SSSD PAM Service responder Loaded: loaded
(/usr/lib/systemd/system/sssd-pam.service; indirect; vendor pr Active: inactive (dead) Docs: man:sssd.conf(5) sh# systemctl start sssd-nss.socket sssd-pam.socket sh# systemctl status --lines=0 sssd sssd-{nss,pam}.{socket,service} ● sssd.service -
System Security Services Daemon Loaded: loaded (/usr/lib/systemd/system/sssd.service; enabled; vendor preset: Drop-In: /etc/systemd/system/sssd.service.d └─journal.conf Active: active (running) since Mon 2017-04-24 21:59:03 CEST; 1s ago Main PID:
13062 (sssd) Tasks: 2 (limit: 4915) Memory: 3.9M CPU: 35ms CGroup: /system.slice/sssd.service ├─13062 /usr/sbin/sssd -i -f └─13073 /usr/libexec/sssd/sssd_be --domain example.com --uid 0 --gid 0 ● sssd-nss.socket - SSSD NSS Service responder socket
Loaded: loaded (/usr/lib/systemd/system/sssd-nss.socket; disabled; vendor pre Active: active (listening) since Mon 2017-04-24 21:59:03 CEST; 1s ago Docs: man:sssd.conf(5) Listen: /var/lib/sss/pipes/nss (Stream) Process: 13081
ExecStartPre=/usr/libexec/sssd/sssd_check_socket_activated_resp Tasks: 0 (limit: 4915) Memory: 84.0K CPU: 6ms CGroup: /system.slice/sssd-nss.socket ● sssd-nss.service - SSSD NSS Service responder Loaded: loaded
(/usr/lib/systemd/system/sssd-nss.service; indirect; vendor pr Active: inactive (dead) Docs: man:sssd.conf(5) ● sssd-pam.socket - SSSD PAM Service responder socket Loaded: loaded (/usr/lib/systemd/system/sssd-pam.socket; disabled; vendor pre Active:
active (listening) since Mon 2017-04-24 21:59:03 CEST; 1s ago Docs: man:sssd.conf(5) Listen: /var/lib/sss/pipes/pam (Stream) Process: 13090 ExecStartPre=/usr/libexec/sssd/sssd_check_socket_activated_resp Tasks: 0 (limit: 4915) Memory: 116.0K CPU: 5ms
CGroup: /system.slice/sssd-pam.socket ● sssd-pam.service - SSSD PAM Service responder Loaded: loaded (/usr/lib/systemd/system/sssd-pam.service; indirect; vendor pr Active: inactive (dead) Docs: man:sssd.conf(5) sh# getent passwd lslebodn
lslebodn:*:740728:740728:Lukas Slebodnik:/home/lslebodn:/bin/bash sh$ ssh lslebodn@localhost lslebodn@localhost&apos;s password: Last failed login: Mon Apr 24 21:49:40 CEST 2017 from ::1 on ssh:notty There was 1 failed login attempt since the last
successful login. Last login: Wed Apr 12 17:15:37 2017 -bash-4.4$ logout Connection to localhost closed. sh# systemctl status --lines=0 sssd.service sssd-nss.service sssd-pam.service ● sssd.service - System Security Services Daemon Loaded: loaded
(/usr/lib/systemd/system/sssd.service; enabled; vendor preset: Drop-In: /etc/systemd/system/sssd.service.d └─devel.conf, journal.conf, network.conf, valgrind.conf Active: active (running) since Mon 2017-04-24 21:52:34 CEST; 2min 50s ago Main PID:
12884 (sssd) Tasks: 2 (limit: 4915) Memory: 4.6M CPU: 72ms CGroup: /system.slice/sssd.service ├─12884 /usr/sbin/sssd -i -f └─12897 /usr/libexec/sssd/sssd_be --domain example.com --uid 0 --gid 0 ● sssd-nss.service - SSSD NSS Service responder Loaded:
loaded (/usr/lib/systemd/system/sssd-nss.service; indirect; vendor pr Active: active (running) since Mon 2017-04-24 21:54:22 CEST; 1min 2s ago Docs: man:sssd.conf(5) Main PID: 12945 (sssd_nss) Tasks: 1 (limit: 4915) Memory: 25.7M CPU: 24ms CGroup:
/system.slice/sssd-nss.service └─12945 /usr/libexec/sssd/sssd_nss --debug-to-files --socket-activate ● sssd-pam.service - SSSD PAM Service responder Loaded: loaded (/usr/lib/systemd/system/sssd-pam.service; indirect; vendor pr Active: active
(running) since Mon 2017-04-24 21:55:00 CEST; 25s ago Docs: man:sssd.conf(5) Process: 12999 ExecStartPre=/bin/chown root:root /var/log/sssd/sssd_pam.log (c Main PID: 13010 (sssd_pam) Tasks: 1 (limit: 4915) Memory: 1.7M CPU: 12ms CGroup:
/system.slice/sssd-pam.service └─13010 /usr/libexec/sssd/sssd_pam --debug-to-files --socket-activate</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10358101</commentid>
<comment_count>3</comment_count>
<who name="Lukas Slebodnik">lslebodn</who>
<bug_when>2017-04-24 16:07:16 -0400</bug_when>
<thetext>I tested with &quot;services =&quot; and with missing &quot;services&quot; in domain section of sssd.conf. And very important information is: sh$ rpm -q selinux-policy selinux-policy-3.13.1-251.fc26.noarch It is not a bug in sssd.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10358156</commentid>
<comment_count>4</comment_count>
<who name="Stephen Gallagher">sgallagh</who>
<bug_when>2017-04-24 16:31:01 -0400</bug_when>
<thetext>Well, either realmd needs to properly write the services= line or else realmd and ipa-client-install should *never* create this line and we should switch Fedora to enable the socket-activated responders by default. But right now we have
neither in play. From an earlier discussion in #freeipa, we determined that the problem was introduced in https://bugs.freedesktop.org/show_bug.cgi?id=98479 to fix issues on Debian which had an incomplete services= line in its default configuration.
However, the result was that on the AD path, if the services= line did not exist at all, it was never created because the function that was updating it would skip over it.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10358159</commentid>
<comment_count>5</comment_count>
<who name="Lukas Slebodnik">lslebodn</who>
<bug_when>2017-04-24 16:32:31 -0400</bug_when>
<thetext>If realmd does not add required responders to service option on &quot;sssd&quot; section. Then it should enable+start the related sssd responders sockets e.g. sssd-{nss,pam}.socket</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10358201</commentid>
<comment_count>6</comment_count>
<who name="Lukas Slebodnik">lslebodn</who>
<bug_when>2017-04-24 16:42:39 -0400</bug_when>
<thetext>(In reply to Stephen Gallagher from comment #4) &gt; Well, either realmd needs to properly write the services= line or else &gt; realmd and ipa-client-install should *never* create this line and we should &gt; switch Fedora to enable the
socket-activated responders by default. But &gt; right now we have neither in play. &gt; sssd works well with some services started by sssd (based on the &quot;service&quot; option) and others started as systemd activated services. People can have
their own sssd.conf. Therefore realmd should count with existing or missing option &quot;services&quot; in sssd.conf. And from realmd upstream POV, it should firstly check whether related socket+service files are available on system e.g.
/usr/lib/systemd/system/sssd-nss.socket /etc/systemd/system/sssd-nss.socket ... Then it can rely on socket activated responders otherwise it should fall back to services in sssd.conf</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10359083</commentid>
<comment_count>7</comment_count>
<who name="Fabiano Fidêncio">fidencio</who>
<bug_when>2017-04-25 03:29:30 -0400</bug_when>
<thetext>I&apos;ve submitted a patch for realmd already as the regression happened on their side and hopefully it&apos;ll be merged soon (and I&apos;ll update this bug once it happens).</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10359960</commentid>
<comment_count>8</comment_count>
<who name="Stephen Gallagher">sgallagh</who>
<bug_when>2017-04-25 08:15:58 -0400</bug_when>
<thetext>(In reply to Fabiano Fidêncio from comment #7) &gt; I&apos;ve submitted a patch for realmd already as the regression happened on &gt; their side and hopefully it&apos;ll be merged soon (and I&apos;ll update this bug once &gt; it happens).
Please include a link to the patch in this ticket so we can follow the progress.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10360063</commentid>
<comment_count>9</comment_count>
<who name="Fabiano Fidêncio">fidencio</who>
<bug_when>2017-04-25 08:32:08 -0400</bug_when>
<thetext>(In reply to Stephen Gallagher from comment #8) &gt; (In reply to Fabiano Fidêncio from comment #7) &gt; &gt; I&apos;ve submitted a patch for realmd already as the regression happened on &gt; &gt; their side and hopefully it&apos;ll be
merged soon (and I&apos;ll update this bug once &gt; &gt; it happens). &gt; &gt; Please include a link to the patch in this ticket so we can follow the &gt; progress. I just re-opened https://bugs.freedesktop.org/show_bug.cgi?id=98479 and patch is
already merged. Sumit will do a fedora build including the fix.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10360073</commentid>
<comment_count>10</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-04-25 08:34:37 -0400</bug_when>
<thetext>realmd-0.16.3-5.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-fa8671e454</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10362821</commentid>
<comment_count>11</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-04-25 23:52:42 -0400</bug_when>
<thetext>realmd-0.16.3-5.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-fa8671e454</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10370244</commentid>
<comment_count>12</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-04-27 16:54:43 -0400</bug_when>
<thetext>realmd-0.16.3-5.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>

</bug>

</bugzilla>
