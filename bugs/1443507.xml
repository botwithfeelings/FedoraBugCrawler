<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1443507</bug_id>

    <creation_ts>2017-04-19 07:52:00 -0400</creation_ts>
    <short_desc>wrong uid used for accessing home directory : no login possible</short_desc>
    <delta_ts>2017-05-12 15:23:46 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>proftpd</component>
    <version>24</version>
    <rep_platform>x86_64</rep_platform>
    <op_sys>Linux</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>ERRATA</resolution>

    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords></keywords>
    <priority>unspecified</priority>
    <bug_severity>urgent</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter>customercare</reporter>
    <assigned_to name="Paul Howarth">paul</assigned_to>
    <cc>itamar</cc>

    <cc>matthias</cc>

    <cc>paul</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in>proftpd-1.3.5e-2.fc24</cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2017-05-12 15:23:46</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>10345422</commentid>
<comment_count>0</comment_count>
<who name="">customercare</who>
<bug_when>2017-04-19 07:52:19 -0400</bug_when>
<thetext>Description of problem: ### ### This needs to be addressed asap, as it breaks almost any production servers out there. ### Proftpd uses the wrong userid to access the home directory of a virtual user. This occures since last night, due to an
update caused by the patch for AllowChrootSymlinks CVE ( or any other change coming with it ) As you can see in the strace at the end, for the first access to the users designated home directory in this case
&quot;/opt/root/home/brainwork/public_html&quot; , uid 1000 guid 1001 is used, which is correct! but for the second try: [pid 32571] setgid(1001) = 0 [pid 32571] geteuid() = 0 [pid 32571] setresgid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 99, -1) =
0 [pid 32571] lstat(&quot;/opt/root/home/brainwork/public_html&quot;, 0x7ffee3d84dd0) = -1 EACCES (Permission denied) &quot;nobody&quot; is used and this has to fail, because nobody does not have any permissions to access a users home directory. As
soon as &quot;nobody&quot; gets into a group used by the apache user to access userhome directories, proftpd starts to work again, confirming, that &quot;nobody&quot; is used to access the home directory. Conlusion: The above strace shows, that at
least the correct gid wants to be set, but it gets overwritten by &quot;nobody(99)&quot;. This needs to be addressed asap, as it breaks almost any productions servers out there. Version-Release number of selected component (if applicable):
proftpd-mysql-1.3.5e-1.fc24.x86_64 proftpd-1.3.5e-1.fc24.x86_64 Compile-time Settings: Version: 1.3.5e (maint) Platform: LINUX [Linux 4.9.13-100.fc24.x86_64 x86_64] Built: Mon Apr 10 2017 14:56:42 UTC How reproducible: works only if you use virtual
user from a mysql db. Actual results: Access denied , because uid 99 ( nobody ) is used Expected results: using the actual uid to access the users home directory. Additional info: # grep -E &quot;(uid|gid|lstat|1000)&quot; /tmp/log [pid 32571]
geteuid() = 0 [pid 32571] setresgid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 0, -1) = 0 [pid 32571] setresgid(-1, 0, -1) = 0 [pid 32571] geteuid() = 0 [pid 32571] setresgid(-1, 99, -1) = 0 [pid 32571]
setresuid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 0, -1) = 0 [pid 32571] setresgid(-1, 1001, -1) = 0 [pid 32571] setresuid(-1, 1000, -1) = 0 [pid 32571] lstat(&quot;/&quot;, {st_mode=S_IFDIR|0555, st_size=4096, ...}) = 0 [pid 32571]
lstat(&quot;/opt&quot;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0 [pid 32571] lstat(&quot;/opt/root&quot;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0 [pid 32571] lstat(&quot;/opt/root/home&quot;, {st_mode=S_IFDIR|0755, st_size=20480, ...}) =
0 [pid 32571] lstat(&quot;/opt/root/home/brainwork&quot;, {st_mode=S_IFDIR|0750, st_size=4096, ...}) = 0 [pid 32571] lstat(&quot;/opt/root/home/brainwork/public_html&quot;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0 [pid 32571] geteuid() = 1000
[pid 32571] setresuid(-1, 0, -1) = 0 [pid 32571] setresgid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 0, -1) = 0 [pid 32571] setresgid(-1, 0, -1) = 0 [pid 32571] setgid(1001) = 0 [pid 32571] geteuid() = 0 [pid
32571] setresgid(-1, 99, -1) = 0 [pid 32571] setresuid(-1, 99, -1) = 0 [pid 32571] lstat(&quot;/opt/root/home/brainwork/public_html&quot;, 0x7ffee3d84dd0) = -1 EACCES (Permission denied) --- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED,
si_pid=32571, si_uid=0, si_status=0, si_utime=0, si_stime=0} --- lstat(&quot;/etc/shutmsg&quot;, 0x7ffee3d85cb0) = -1 ENOENT (No such file or directory)</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10345737</commentid>
<comment_count>1</comment_count>
<who name="">customercare</who>
<bug_when>2017-04-19 09:04:16 -0400</bug_when>
<thetext>Update: The Patch for &quot;AllowChrootSymlinks&quot; is the source of the problem. &quot;AllowChrootSymlinks on&quot; allows the login again. note: NO SYMLINKS are involved in the test for this bugreport. There is NO reason, to deny access,
if or if this option is not enabled. I reproduced the issue on another system: This is the homedir used: /opt/root/home/cloud-foode/public_html no Links involved : drwxr-xr-x 4 cloud-foode cloud-foode 4096 2. Feb 15:30 /opt/root/home/cloud-drwxr-x---
12 cloud-foode services 4096 10. Nov 22:37 /opt/root/home/cloud-foode drwxr-xr-x. 12 root root 4096 23. Mär 14:19 /opt/root/home drwxr-xr-x 11 root root 4096 10. Feb 2015 /opt/root drwxr-xr-x 4 root root 4096 10. Feb 2015 /opt but still: 2017-04-19
14:56:11,671 proftpd[6868] X.X.X.X (93.223.221.176[93.223.221.176]): FTP session opened. 2017-04-19 14:56:14,189 proftpd[6868] X.X.X.X (93.223.221.176[93.223.221.176]): error: unable to check /opt/root/home/cloud-foode/public_html: Permission denied
2017-04-19 14:56:14,189 proftpd[6868] X.X.X.X (93.223.221.176[93.223.221.176]): error: unable to determine DefaultRoot directory</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10347060</commentid>
<comment_count>2</comment_count>
<who name="Paul Howarth">paul</who>
<bug_when>2017-04-19 15:21:47 -0400</bug_when>
<thetext>Raised upstream: http://bugs.proftpd.org/show_bug.cgi?id=4306</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10375866</commentid>
<comment_count>3</comment_count>
<who name="Paul Howarth">paul</who>
<bug_when>2017-05-01 06:26:02 -0400</bug_when>
<thetext>Do you have SELinux in enforcing mode? I see that there&apos;s some security attribute set on /opt/root/home (trailing &quot;.&quot; on permissions string). If proftpd is unable to determine whether or not that is a symlink, it assumes that
it may be one. Perhaps SELinux or some other mechanism is preventing a getattr() on that directory?</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10376693</commentid>
<comment_count>4</comment_count>
<who name="">customercare</who>
<bug_when>2017-05-01 13:15:30 -0400</bug_when>
<thetext>SEL is not involved there.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10376986</commentid>
<comment_count>5</comment_count>
<who name="Paul Howarth">paul</who>
<bug_when>2017-05-01 15:40:31 -0400</bug_when>
<thetext>What&apos;s the attribute on /opt/root/home? There don&apos;t seem to be any such attributes on the other directories.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10377190</commentid>
<comment_count>6</comment_count>
<who name="">customercare</who>
<bug_when>2017-05-01 18:07:59 -0400</bug_when>
<thetext>[root@sXX ~]# attr -l /opt/root/home Attribute &quot;selinux&quot; has a 33 byte value for /opt/root/home [root@sXX ~]# attr -g selinux /opt/root/home attr_get: No data available Konnte &quot;selinux&quot; von /opt/root/home nicht lesen
(could not read &quot;selinux&quot; from /o/r/h [root@sXX ~]# stat /opt/root/home Datei: &apos;/opt/root/home&apos; Größe: 20480 Blöcke: 48 EA Block: 4096 Verzeichnis Gerät: ca01h/51713d Inode: 2097153 Verknüpfungen: 423 Zugriff: (0755/drwxr-xr-x)
Uid: ( 0/ root) Gid: ( 0/ root) Zugriff : 2017-05-02 00:05:00.327423508 +0200 Modifiziert: 2017-04-25 12:01:55.000000000 +0200 Geändert : 2017-04-25 13:29:11.814216996 +0200 Geburt : - # stat -f /opt/root/home Datei: &quot;/opt/root/home&quot; ID:
bf2a077579d64c98 Namenslänge: 255 Typ: ext2/ext3 Blockgröße: 4096 Fundamentale Blockgröße: 4096 Blöcke: Gesamt: 64216689 Frei: 18691209 Verfügbar: 15423433 Inodes: Gesamt: 16318464 Frei: 12864001</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10381328</commentid>
<comment_count>7</comment_count>
<who name="Paul Howarth">paul</who>
<bug_when>2017-05-03 04:19:40 -0400</bug_when>
<thetext>OK, we have a patch from upstream that should address this. Can you give this scratch build a try? https://koji.fedoraproject.org/koji/taskinfo?taskID=19385528</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10381540</commentid>
<comment_count>8</comment_count>
<who name="">customercare</who>
<bug_when>2017-05-03 05:26:56 -0400</bug_when>
<thetext>sure, i will try it out asap.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10382254</commentid>
<comment_count>9</comment_count>
<who name="">customercare</who>
<bug_when>2017-05-03 08:49:38 -0400</bug_when>
<thetext>tried it: works for me</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10382931</commentid>
<comment_count>10</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-05-03 11:14:48 -0400</bug_when>
<thetext>proftpd-1.3.5e-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-6bfa33dd9d</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10387268</commentid>
<comment_count>11</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-05-04 16:01:46 -0400</bug_when>
<thetext>proftpd-1.3.5e-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-6bfa33dd9d</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10408854</commentid>
<comment_count>12</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-05-12 15:23:46 -0400</bug_when>
<thetext>proftpd-1.3.5e-2.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>

</bug>

</bugzilla>
