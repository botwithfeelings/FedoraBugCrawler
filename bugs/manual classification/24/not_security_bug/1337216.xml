<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1337216</bug_id>

    <creation_ts>2016-05-18 10:03:00 -0400</creation_ts>
    <short_desc>p1_pam looks into ejabberd&apos;s install path to find epam instead of its own path</short_desc>
    <delta_ts>2016-08-31 11:27:56 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>erlang-p1_pam</component>
    <version>24</version>
    <rep_platform>x86_64</rep_platform>
    <op_sys>Linux</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>ERRATA</resolution>

    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords>Reopened</keywords>
    <priority>high</priority>
    <bug_severity>high</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter name="Alan Milligan">alan.milligan</reporter>
    <assigned_to name="Randy Barlow">rbarlow</assigned_to>
    <cc>erlang</cc>

    <cc>jasons</cc>

    <cc>jeremy</cc>

    <cc>lemenkov</cc>

    <cc>martin</cc>

    <cc>randy</cc>

    <cc>rbarlow</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in>erlang-p1_pam-1.0.0-2.fc25 erlang-p1_pam-1.0.0-2.fc24</cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2016-08-31 11:27:56</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>9337430</commentid>
<comment_count>0</comment_count>
<who name="Alan Milligan">alan.milligan</who>
<bug_when>2016-05-18 10:03:34 -0400</bug_when>
<thetext>Description of problem: p1_pam fails to start because ejabberd is looking in the incorrect place for epam.beam (in ejabberd file path instead of p1_pam) - sorry haven&apos;t looked at code to provide patch Version-Release number of selected
component (if applicable): Rawhide 16.04 How reproducible: Always Steps to Reproduce: 1. Ensure PAM turned on in ejabberd.yml 2. start ejabberd 3. it fails: check /var/log/ejabberd/server.log Actual results: /var/log/ejabberd/server.log 2016-05-18
23:40:47.128 [info] &lt;0.38.0&gt;@cyrsasl_digest:start:60 FQDN used to check DIGEST-MD5 SASL authentication: jenkins-dev.last-bastion.net 2016-05-18 23:40:47.154 [error] &lt;0.392.0&gt; Can&apos;t open file
&quot;/usr/lib64/erlang/lib/ejabberd/priv/bin/epam&quot;: enoent 2016-05-18 23:40:47.154 [error] &lt;0.392.0&gt; CRASH REPORT Process epam with 0 neighbours exited with reason: bad return value: error in gen_server:init_it/6 line 356 2016-05-18
23:40:47.154 [error] &lt;0.391.0&gt; Supervisor epam_sup had child epam started with epam:start_link() at undefined exit with reason bad return value: error in context start_error 2016-05-18 23:40:47.154 [error] &lt;0.389.0&gt; CRASH REPORT Process
&lt;0.389.0&gt; with 0 neighbours exited with reason:
{{shutdown,{failed_to_start_child,epam,{bad_return_value,error}}},{epam_app,start,[normal,[]]}} in application_master:init/4 line 134 2016-05-18 23:40:47.154 [critical] &lt;0.38.0&gt;@ejabberd:exit_or_halt:133 failed to start application &apos;p1_pam&apos;: {error,
{{shutdown,
                                         {failed_to_start_child,epam,
                                          {bad_return_value,error}}}, {epam_app,start,[normal,[]]}}} 2016-05-18 23:40:47.155 [info] &lt;0.7.0&gt; Application p1_pam exited with reason:
{{shutdown,{failed_to_start_child,epam,{bad_return_value,error}}},{epam_app,start,[normal,[]]}} Expected results: Additional info:</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347458</commentid>
<comment_count>1</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-21 19:56:57 -0400</bug_when>
<thetext>I can confirm this issue, though I&apos;m not yet sure why it happens. Thanks for the report, I&apos;ll keep digging to see if I can figure out what&apos;s happening.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347922</commentid>
<comment_count>2</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 12:26:30 -0400</bug_when>
<thetext>I think this may be an issue in p1_pam, though I&apos;m not completely sure yet. I was poking around trying to figure out how this works, and I noticed this function which seems to be generating that particular path:
https://github.com/processone/epam/blob/1.0.0/src/epam.erl#L142-L153</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347926</commentid>
<comment_count>3</comment_count>
<who name="Alan Milligan">alan.milligan</who>
<bug_when>2016-05-22 12:43:00 -0400</bug_when>
<thetext>Hmmm, That&apos;s certainly a little strange. This *should* just be a the local module path surely. But we&apos;re not explicitly setting EJABBERD_BIN_PATH out of systemd nor ejabberdctl.cfg - so wouldn&apos;t it behave itself??</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347932</commentid>
<comment_count>4</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 13:00:07 -0400</bug_when>
<thetext>Hello Alan! I&apos;ve written a patch that basically uses only the false clause of that case statement and tested it on my Rawhide box and now ejabberd does at least start. I&apos;m going to make a new release of erlang-p1_pam with this
patch for now, and then I&apos;ll file an upstream issue about this so we can get it solved in a more general way for everyone (not just Fedora). I agree that it&apos;s strange. Perhaps ejabberd itself is setting that variable, but I&apos;ve honestly
not done any investigation to determine where that is coming from. I did talk to Holger in the official ejabberd MUC and he confirmed that he had seen a similar issue. Thanks for the report, and I&apos;ll drop a link here when I report it upstream.
Oh, and please feel free to let me know how your deployment goes! Jeremy Cline and I did a whole lot of work on ejabberd to upgrade to a recent version and split out the dependencies over the winter. It was much more work than we bargained for, so I
hope it pays off well for our users!</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347950</commentid>
<comment_count>5</comment_count>
<who name="Alan Milligan">alan.milligan</who>
<bug_when>2016-05-22 13:07:32 -0400</bug_when>
<thetext>Just another thought - and I haven&apos;t really looked into this: but if priv/bin/epam starts up as ejabberd user, will it have enough perms et al to actually do pam-based authentication (ie read /etc/shadow)?? This is an issue with ipsilon
and Apache-based PAM auth which requires an suexec if I recall.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347958</commentid>
<comment_count>6</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 13:22:48 -0400</bug_when>
<thetext>Hello Alan! I don&apos;t know the answer to your question as I&apos;ve (obviously) not used the epam module before. It does sound like a reasonable guess that that might be a problem. Once you test the patch I&apos;m making I suppose
we&apos;ll quickly find out if that is an issue as well. If it is, we can open a new issue to track that problem separately. This issue also affects Fedora 24, so I&apos;m going to just mark the ticket as 24 and fix it on both since they pretty much
have the same package.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347976</commentid>
<comment_count>7</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 13:49:19 -0400</bug_when>
<thetext>I have filed this issue upstream: https://github.com/processone/epam/issues/4</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347978</commentid>
<comment_count>8</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 13:54:43 -0400</bug_when>
<thetext>erlang-p1_pam-1.0.0-2.fc25</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347979</commentid>
<comment_count>9</comment_count>
<who name="Randy Barlow">rbarlow</who>
<bug_when>2016-05-22 13:56:01 -0400</bug_when>
<thetext>Hello Alan! When you have a moment, give erlang-p1_pam-1.0.0-2.fc25 a try. It will probably take a day or so before it&apos;s in the mirrors, but you can get it from Koji directly if you want:
http://koji.fedoraproject.org/koji/taskinfo?taskID=14215898</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9347980</commentid>
<comment_count>10</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-05-22 13:56:50 -0400</bug_when>
<thetext>erlang-p1_pam-1.0.0-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-20999100c6</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9348026</commentid>
<comment_count>11</comment_count>
<who name="Alan Milligan">alan.milligan</who>
<bug_when>2016-05-22 15:27:31 -0400</bug_when>
<thetext>Ok. This patch indeed fixes the reported problem. But a cursory test suggests that there may well be PAM authentication issues. Using mcabber connecting to localhost/ejabberd, if I use an /etc/passwd-based user (ie root), ejabberd fails
authentication. This vm has 389DS/nslcd set up, and if I use an LDAP-based user, then (PAM) authentication works fine. I somehow suspect that if one delves further this will prove to be a &apos;known issue&apos; with PAM - and one should configure
ejabberd/ldap directly - unless one runs ejabberd as root (which I didn&apos;t try...).</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9352724</commentid>
<comment_count>12</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-05-23 22:57:23 -0400</bug_when>
<thetext>erlang-p1_pam-1.0.0-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install
test updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-20999100c6</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9366790</commentid>
<comment_count>13</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-05-27 23:33:44 -0400</bug_when>
<thetext>erlang-p1_pam-1.0.0-2.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9656491</commentid>
<comment_count>14</comment_count>
<who name="Jason Spangler">jasons</who>
<bug_when>2016-08-27 16:22:53 -0400</bug_when>
<thetext>I just upgraded to Fedora 24 and ejabberd does not seem to be using epam correctly for auth - all attempts using PAM fail, even . This same configuration used to work under previous Fedora versions. pamtester succeeds with the same auth
attempt: pamtester -I ruser=jasons ejabberd jasons authenticate</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9656493</commentid>
<comment_count>15</comment_count>
<who name="Jason Spangler">jasons</who>
<bug_when>2016-08-27 16:35:43 -0400</bug_when>
<thetext>According to ejabberd epam docs, epam must be setuid root to function: https://docs.ejabberd.im/admin/guide/configuration/#pam-authentication ejabberd was running epam from the erlang-p1_pam package at:
/usr/lib/erlang/lib/p1_pam-1.0.0/priv/bin/epam Making epam setuid root made ejabberd PAM auth work again: chmod 4750 /usr/lib/erlang/lib/p1_pam-1.0.0/priv/bin/epam I would not be surprised if there are negative security implications with this step.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9660932</commentid>
<comment_count>16</comment_count>
<who name="Randy Barlow">randy</who>
<bug_when>2016-08-29 16:44:35 -0400</bug_when>
<thetext>Thanks for the notes Jason, I&apos;m going to reopen this bug for further consideration. As you note, I have some hesitation to setuid the module but I&apos;ll open the bug so I can think about it some more.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9668062</commentid>
<comment_count>17</comment_count>
<who name="Randy Barlow">randy</who>
<bug_when>2016-08-31 11:27:56 -0400</bug_when>
<thetext>I&apos;ve decided to track the setuid epam thing as a separate bug, since this bug was really about an install path problem. Thanks for reporting it! https://bugzilla.redhat.com/show_bug.cgi?id=1371984</thetext>
</long_desc>

</bug>

</bugzilla>
