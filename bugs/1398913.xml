<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1398913</bug_id>

    <creation_ts>2016-11-27 04:42:00 -0500</creation_ts>
    <short_desc>mkdir fails to label some directories when -p -Z options are used.</short_desc>
    <delta_ts>2017-03-06 03:01:05 -0500</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>coreutils</component>
    <version>24</version>
    <rep_platform>Unspecified</rep_platform>
    <op_sys>Unspecified</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>ERRATA</resolution>

    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords>Patch</keywords>
    <priority>unspecified</priority>
    <bug_severity>unspecified</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter name="Scott Shambarger">scott-redhat</reporter>
    <assigned_to name="Kamil Dudka">kdudka</assigned_to>
    <cc>admiller</cc>

    <cc>jamartis</cc>

    <cc>kdudka</cc>

    <cc>kzak</cc>

    <cc>ooprala</cc>

    <cc>ovasik</cc>

    <cc>p</cc>

    <cc>twaugh</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in>coreutils-8.26-1.fc26 coreutils-8.25-16.fc25 coreutils-8.25-8.fc24</cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2017-03-03 16:51:02</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>9931770</commentid>
<comment_count>0</comment_count>
<who name="Scott Shambarger">scott-redhat</who>
<bug_when>2016-11-27 04:42:33 -0500</bug_when>
<thetext>Description of problem: Creating multiple levels of directories together with mkdir -p -Z fails to set the SELinux context for all but the highest and lowest directories. Version-Release number of selected component (if applicable):
coreutils-8.25-7.fc24.x86_64 How reproducible: Always for any more than two directory levels. Steps to Reproduce: 1. Create 3 or more directories together with (for eg) mkdir -p -Z a/b/c Actual results: mkdir: failed to set default creation context
for &apos;a/b&apos;: No such file or directory SELinux labels set on a and a/b/c, but not on a/b. Expected results: a/b should also be labeled. Additional info: Same problem all intermediary directories, eg mkdir -p -Z a/b/c/d fails to label a/b and
a/b/c (but labels a and a/b/c/d). NOTE: mkdir will usually correct the labels on existing directories, but fails to do so here as well.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9933782</commentid>
<comment_count>1</comment_count>
<who name="Kamil Dudka">kdudka</who>
<bug_when>2016-11-28 04:33:14 -0500</bug_when>
<thetext>Confirmed. Minimal example: $ sudo semanage fcontext -a -t user_home_t /tmp/a $ sudo semanage fcontext -a -t mozilla_home_t /tmp/a/b $ sudo semanage fcontext -a -t home_cert_t /tmp/a/b/c $ mkdir -Zp a/b/c $ ls -1Zd a a/b a/b/c
unconfined_u:object_r:user_home_t:s0 a unconfined_u:object_r:user_home_t:s0 a/b unconfined_u:object_r:home_cert_t:s0 a/b/c $ restorecon -R a $ ls -1Zd a a/b a/b/c unconfined_u:object_r:user_home_t:s0 a unconfined_u:object_r:mozilla_home_t:s0 a/b
unconfined_u:object_r:home_cert_t:s0 a/b/c Same problem with install(1): $ rm -fr a $ install -ZDd a/b/c $ ls -1Zd a a/b a/b/c unconfined_u:object_r:user_home_t:s0 a unconfined_u:object_r:user_home_t:s0 a/b unconfined_u:object_r:home_cert_t:s0 a/b/c</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9934881</commentid>
<comment_count>2</comment_count>
<who name="Kamil Dudka">kdudka</who>
<bug_when>2016-11-28 09:16:25 -0500</bug_when>
<thetext>This looks like a copy-paste error (duplicated at two places in the code): --- a/src/install.c +++ b/src/install.c @@ -427,7 +427,7 @@ static int make_ancestor (char const *dir, char const *component, void *options) { struct cp_options const
*x = options; - if (x-&gt;set_security_context &amp;&amp; defaultcon (dir, S_IFDIR) &lt; 0 + if (x-&gt;set_security_context &amp;&amp; defaultcon (component, S_IFDIR) &lt; 0 &amp;&amp; ! ignorable_ctx_err (errno)) error (0, errno, _(&quot;failed to
set default creation context for %s&quot;), quoteaf (dir)); --- a/src/mkdir.c +++ b/src/mkdir.c @@ -123,7 +123,7 @@ make_ancestor (char const *dir, char const *component, void *options) { struct mkdir_options const *o = options; - if
(o-&gt;set_security_context &amp;&amp; defaultcon (dir, S_IFDIR) &lt; 0 + if (o-&gt;set_security_context &amp;&amp; defaultcon (component, S_IFDIR) &lt; 0 &amp;&amp; ! ignorable_ctx_err (errno)) error (0, errno, _(&quot;failed to set default creation
context for %s&quot;), quoteaf (dir)); I will submit a patch upstream once I have idea how to test this...</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9935320</commentid>
<comment_count>3</comment_count>
<who name="Kamil Dudka">kdudka</who>
<bug_when>2016-11-28 10:25:22 -0500</bug_when>
<thetext>(In reply to Kamil Dudka from comment #2) &gt; I will submit a patch upstream once I have idea how to test this... I have not figured out how to reliably test this without having root access but submitted a patch upstream anyway:
https://debbugs.gnu.org/cgi/bugreport.cgi?bug=25052</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9935610</commentid>
<comment_count>4</comment_count>
<who name="Kamil Dudka">kdudka</who>
<bug_when>2016-11-28 11:35:13 -0500</bug_when>
<thetext>upstream commit: http://git.savannah.gnu.org/gitweb/?p=coreutils.git;a=commitdiff;h=d8104265</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10201354</commentid>
<comment_count>5</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-02 05:52:12 -0500</bug_when>
<thetext>coreutils-8.25-8.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-b21a847e7a</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10201355</commentid>
<comment_count>6</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-02 05:52:23 -0500</bug_when>
<thetext>coreutils-8.25-16.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-24ce0b63c4</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10204703</commentid>
<comment_count>7</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-02 23:53:22 -0500</bug_when>
<thetext>coreutils-8.25-16.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-24ce0b63c4</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10204765</commentid>
<comment_count>8</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-03 00:24:04 -0500</bug_when>
<thetext>coreutils-8.25-8.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-b21a847e7a</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10207425</commentid>
<comment_count>9</comment_count>
<who name="Scott Shambarger">scott-redhat</who>
<bug_when>2017-03-03 14:47:36 -0500</bug_when>
<thetext>Tested update, bug appears fixed. Karma added.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10207672</commentid>
<comment_count>10</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-03 16:51:02 -0500</bug_when>
<thetext>coreutils-8.25-16.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10209288</commentid>
<comment_count>11</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2017-03-05 15:50:20 -0500</bug_when>
<thetext>coreutils-8.25-8.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>10210190</commentid>
<comment_count>12</comment_count>
<who name="Kamil Dudka">kdudka</who>
<bug_when>2017-03-06 03:01:05 -0500</bug_when>
<thetext>(In reply to Scott Shambarger from comment #9) &gt; Tested update, bug appears fixed. Karma added. Thanks for confirmation!</thetext>
</long_desc>

</bug>

</bugzilla>
