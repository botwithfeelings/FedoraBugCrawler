<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1271407</bug_id>

    <creation_ts>2015-10-13 18:13:00 -0400</creation_ts>
    <short_desc>emacs leaves behind corrupted symlinks on CIFS share</short_desc>
    <delta_ts>2016-10-18 11:53:40 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>emacs</component>
    <version>24</version>
    <rep_platform>Unspecified</rep_platform>
    <op_sys>Unspecified</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>ERRATA</resolution>

    <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1383968</see_also>
    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords>Reopened</keywords>
    <priority>unspecified</priority>
    <bug_severity>unspecified</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter name="Charles R. Anderson">cra</reporter>
    <assigned_to name="Jan Synacek">jsynacek</assigned_to>
    <cc>abokovoy</cc>

    <cc>anoopcs</cc>

    <cc>asn</cc>

    <cc>eggert</cc>

    <cc>gdeschner</cc>

    <cc>jchaloup</cc>

    <cc>jonathan.underwood</cc>

    <cc>jrivera</cc>

    <cc>jsynacek</cc>

    <cc>lists</cc>

    <cc>lmohanty</cc>

    <cc>madam</cc>

    <cc>msekleta</cc>

    <cc>phracek</cc>

    <cc>sbose</cc>

    <cc>ssorce</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in>emacs-25.1-2.fc25 emacs-25.1-2.fc24</cf_fixed_in>
  <cf_doc_type>Bug Fix</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2016-10-15 12:09:34</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>8717084</commentid>
<comment_count>0</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2015-10-13 18:13:57 -0400</bug_when>
<thetext>Description of problem: Emacs creates a corrupted symlink on a CIFS share when editing a file, and then fails to delete it when closing the file. This doesn&apos;t happen for local files. Version-Release number of selected component (if
applicable): emacs-24.5-2.fc21.x86_64 kernel-4.1.6-100.fc21.x86_64 How reproducible: always Steps to Reproduce: 1. emacs /path/to/CIFS/mount/foo 2. start making changes 3. look at the .#foo symlink created, it has a funny character between the PID
and another large number. 4. Save and exit emacs. 5. The symlink stays behind and is not deleted. Actual results: CIFS share shows a funny character in the symlink: -rw-rw-r--. 1 cra cra 0 Oct 13 18:04 foo lrwxrwxrwx. 1 cra cra 39 Oct 13 2015 .#foo
-&gt; cra@hostname.33151441383545 The funny character between 3315 and 1441383545 is &quot;ef 80 a2&quot; in hex: &gt;cat | hexdump -C  00000000 ef 80 a2 0a |....| 00000004 Local file (ext4) shows no funny character: -rw-r-----. 1 cra cra 9 Oct 13
18:04 foo lrwxrwxrwx. 1 cra cra 37 Oct 13 18:09 .#foo -&gt; cra@hostname.3346:cra@dustpuppy.wpi.edu.3346:1441383545 Expected results: No funny character in the symlink content. The symlink should be removed by emacs upon closing the file. Additional
info: The CIFS server is Centos 5 running samba-3.0.33-3.40.el5_10.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>8717088</commentid>
<comment_count>1</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2015-10-13 18:16:14 -0400</bug_when>
<thetext>Correction to Local file (ext4) shows no funny character: -rw-r-----. 1 cra cra 9 Oct 13 18:04 foo lrwxrwxrwx. 1 cra cra 37 Oct 13 18:09 .#foo -&gt; cra@hostname.3346:1441383545</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>8782922</commentid>
<comment_count>2</comment_count>
<who name="Fedora End Of Life">jkurik</who>
<bug_when>2015-11-04 05:11:54 -0500</bug_when>
<thetext>This message is a reminder that Fedora 21 is nearing its end of life. Approximately 4 (four) weeks from now Fedora will stop maintaining and issuing updates for Fedora 21. It is Fedora&apos;s policy to close all bug reports from releases
that are no longer maintained. At that time this bug will be closed as EOL if it remains open with a Fedora &apos;version&apos; of &apos;21&apos;. Package Maintainer: If you wish for this bug to remain open because you plan to fix it in a currently
maintained version, simply change the &apos;version&apos; to a later Fedora version. Thank you for reporting this issue and we are sorry that we were not able to fix it before Fedora 21 is end of life. If you would still like to see this bug fixed
and are able to reproduce it against a later version of Fedora, you are encouraged change the &apos;version&apos; to a later Fedora version prior this bug is closed as described in the policy above. Although we aim to fix as many bugs as possible
during every release&apos;s lifetime, sometimes those efforts are overtaken by events. Often a more recent Fedora release includes newer upstream software that fixes bugs or makes them obsolete.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>8883123</commentid>
<comment_count>3</comment_count>
<who name="Fedora End Of Life">jkurik</who>
<bug_when>2015-12-02 10:41:06 -0500</bug_when>
<thetext>Fedora 21 changed to end-of-life (EOL) status on 2015-12-01. Fedora 21 is no longer maintained, which means that it will not receive any further security or bug fix updates. As a result we are closing this bug. If you can reproduce this bug
against a currently maintained version of Fedora please feel free to reopen this bug against that version. If you are unable to reopen this bug, please file a new report against the current release. If you experience problems, please add a comment to
this bug. Thank you for reporting this bug and we are sorry it could not be fixed.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9008934</commentid>
<comment_count>4</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-01-25 17:08:22 -0500</bug_when>
<thetext>Still an issue with F23. Maybe this is a Samba bug rather than an Emacs bug?</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9008940</commentid>
<comment_count>5</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-01-25 17:11:05 -0500</bug_when>
<thetext>I think this is an Emacs bug. The same problem happens with symlinks on a CIFS share from a samba-3.0.33-3.40.el5_10 EL5 server and also a samba-4.2.3-11.el7_2.x86_64 EL7 server.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9541139</commentid>
<comment_count>6</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-07-22 09:45:51 -0400</bug_when>
<thetext>Still exists on Fedora 24. emacs-25.0.95-2.fc24.x86_64 kernel-4.6.4-301.fc24.x86_64</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9778034</commentid>
<comment_count>7</comment_count>
<who name="Jan Synacek">jsynacek</who>
<bug_when>2016-10-10 07:56:34 -0400</bug_when>
<thetext>This still happens with emacs-25.1-1.fc24.x86_64. You can work around this by turning off interlocking: (setq create-lockfiles nil) Reported at https://debbugs.gnu.org/cgi/bugreport.cgi?bug=24656.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9782432</commentid>
<comment_count>8</comment_count>
<who name="Paul Eggert">eggert</who>
<bug_when>2016-10-11 15:45:30 -0400</bug_when>
<thetext>This is a bug in Samba, not in Emacs. I can reproduce the bug without Emacs on a CIFS file system (locally mounted, Fedora 24) by running this simple C program: #include &lt;unistd.h&gt; int main (void) { return symlink (&quot;a:b&quot;,
&quot;f&quot;) != 0; } This creates a symbolic link from &quot;f&quot; to &quot;a&lt;F022&gt;b&quot;, where &quot;&lt;F022&gt;&quot; stands for the UTF-8 representation for U+F022, i.e., the bytes EF, 80, A2.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9783863</commentid>
<comment_count>9</comment_count>
<who name="Jan Synacek">jsynacek</who>
<bug_when>2016-10-12 05:18:57 -0400</bug_when>
<thetext>The workaround can be found at http://git.savannah.gnu.org/cgit/emacs.git/commit/?id=1dd54e3eef7543720eff161457677a35fae2435c.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785207</commentid>
<comment_count>10</comment_count>
<who name="Paul Eggert">eggert</who>
<bug_when>2016-10-12 11:28:57 -0400</bug_when>
<thetext>Since the bug is in Samba, the &quot;Component&quot; field of this bug report should be changed from &quot;emacs&quot; to &quot;samba&quot;.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785278</commentid>
<comment_count>11</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-10-12 11:50:45 -0400</bug_when>
<thetext>(In reply to Paul Eggert from comment #10) &gt; Since the bug is in Samba, the &quot;Component&quot; field of this bug report should &gt; be changed from &quot;emacs&quot; to &quot;samba&quot;. How is using a character that isn&apos;t
allowed on a specific filesystem considered to be a bug in that filesystem? It seems to me to be an emacs bug to assume that any character is allowed to be used... If emacs tried to use &apos;/&apos; in a filename it wouldn&apos;t be considerd a bug
in Ext4 would it? Just like &apos;/&apos; is a path separator in Unix filesystems, &apos;:&apos; is a path separator in other filesystems.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785410</commentid>
<comment_count>12</comment_count>
<who name="Paul Eggert">eggert</who>
<bug_when>2016-10-12 12:36:06 -0400</bug_when>
<thetext>(In reply to Charles R. Anderson from comment #11) &gt; How is using a character that isn&apos;t allowed on a specific filesystem &gt; considered to be a bug in that filesystem? First, the contents of a symbolic link do not have to be a file
name, which means that file system restrictions are irrelevant in symlink contents. I can create a symbolic link from &apos;foo&apos; to &apos;a:/never/never/land&apos;, and that&apos;s OK even if &apos;a:/never/never/land&apos; does not and cannot
exist. Second, the file system in question was a Fedora tmpfs file system mounted via CIFS, and this specific file system (tmpfs) does allow &apos;:&apos; in file names. CIFS should not arbitrarily exclude &apos;:&apos; when both client and server
allow &apos;:&apos; in file names.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785429</commentid>
<comment_count>13</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-10-12 12:44:16 -0400</bug_when>
<thetext>(In reply to Paul Eggert from comment #12) &gt; (In reply to Charles R. Anderson from comment #11) &gt; &gt; &gt; How is using a character that isn&apos;t allowed on a specific filesystem &gt; &gt; considered to be a bug in that filesystem?
&gt; &gt; First, the contents of a symbolic link do not have to be a file name, which &gt; means that file system restrictions are irrelevant in symlink contents. I &gt; can create a symbolic link from &apos;foo&apos; to
&apos;a:/never/never/land&apos;, and that&apos;s &gt; OK even if &apos;a:/never/never/land&apos; does not and cannot exist. &gt; &gt; Second, the file system in question was a Fedora tmpfs file system mounted &gt; via CIFS, and this specific file
system (tmpfs) does allow &apos;:&apos; in file &gt; names. CIFS should not arbitrarily exclude &apos;:&apos; when both client and server &gt; allow &apos;:&apos; in file names. Okay, I&apos;ll clone this bug for samba then, but leave this one as-is
so the emacs workaround can be released for Fedora. We need the workaround since Samba servers won&apos;t necessarily be upgraded on the same schedule as Fedora clients.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785438</commentid>
<comment_count>14</comment_count>
<who name="Alexander Bokovoy">abokovoy</who>
<bug_when>2016-10-12 12:48:26 -0400</bug_when>
<thetext>To make clear: this is not a samba bug. It is a cifs.ko bug, e.g. kernel side.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9785444</commentid>
<comment_count>15</comment_count>
<who name="Charles R. Anderson">cra</who>
<bug_when>2016-10-12 12:50:26 -0400</bug_when>
<thetext>Please apply this patch to emacs and relase updates for all supported Fedora releases: http://git.savannah.gnu.org/cgit/emacs.git/commit/?id=1dd54e3eef7543720eff161457677a35fae2435c Thanks!</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9787132</commentid>
<comment_count>16</comment_count>
<who name="Jan Synacek">jsynacek</who>
<bug_when>2016-10-13 02:14:43 -0400</bug_when>
<thetext>I&apos;m already working on it. Also, after comment#9, you can see that I have already created a bug for samba. Please, leave this bug on emacs.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9790407</commentid>
<comment_count>17</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-10-13 23:20:52 -0400</bug_when>
<thetext>emacs-25.1-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-b839b149bf</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9790494</commentid>
<comment_count>18</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-10-14 00:56:18 -0400</bug_when>
<thetext>emacs-25.1-2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report. See https://fedoraproject.org/wiki/QA:Updates_Testing for instructions on how to install test
updates. You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-3c06e0bcf6</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9794356</commentid>
<comment_count>19</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-10-15 12:09:34 -0400</bug_when>
<thetext>emacs-25.1-2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9801521</commentid>
<comment_count>20</comment_count>
<who name="Fedora Update System">updates</who>
<bug_when>2016-10-18 11:53:40 -0400</bug_when>
<thetext>emacs-25.1-2.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
</long_desc>

</bug>

</bugzilla>
