<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1459700</bug_id>
          
          <creation_ts>2017-06-07 18:10:00 -0400</creation_ts>
          <short_desc>&apos;overlay2&apos; is not supported over btrfs</short_desc>
          <delta_ts>2017-06-23 23:05:45 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Evan Nemerson">evan</reporter>
          <assigned_to name="Antonio Murdaca">amurdaca</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>fkluknav</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>vbatts</cc>
    
    
    <cc>vgoyal</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.13.1-19.git27e468e.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-23 23:05:45</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10487371</commentid>
    <comment_count>0</comment_count>
    <who name="Evan Nemerson">evan</who>
    <bug_when>2017-06-07 18:10:50 -0400</bug_when>
    <thetext>Docker fails to start on Fedora 26 when using btrfs.  `systemctl start docker` reports a failure, `journalctl -xe` says:

- Unit docker.service has begun starting up.
Jun 07 15:09:14 peltast dockerd-current[3678]: time=&quot;2017-06-07T15:09:14-07:00&quot; level=info msg=&quot;SUSE:secrets :: enabled&quot;
Jun 07 15:09:15 peltast dockerd-current[3678]: time=&quot;2017-06-07T15:09:15.032034670-07:00&quot; level=error msg=&quot;&apos;overlay2&apos; is not supported over btrfs&quot;
Jun 07 15:09:15 peltast dockerd-current[3678]: Error starting daemon: error initializing graphdriver: backing file system is unsupported for this graph driver
Jun 07 15:09:15 peltast systemd[1]: docker.service: Main process exited, code=exited, status=1/FAILURE
Jun 07 15:09:15 peltast systemd[1]: Failed to start Docker Application Container Engine.
-- Subject: Unit docker.service has failed
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- Unit docker.service has failed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10489613</commentid>
    <comment_count>1</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-06-08 09:51:21 -0400</bug_when>
    <thetext>You have to change the driver to something other then overlay*

Maybe try btrfs.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10489730</commentid>
    <comment_count>2</comment_count>
    <who name="Evan Nemerson">evan</who>
    <bug_when>2017-06-08 10:19:33 -0400</bug_when>
    <thetext>This worked out of the box on F25, it seems like a regression that I can no longer simply `dnf install docker` and have a working installation.

It&apos;s also highly non-obvious what it should be, or where the it should be set.  I didn&apos;t even know &quot;btrfs&quot; was an option, and changing the value in /etc/sysconfig/docker-storage-setup has no effect.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10489740</commentid>
    <comment_count>3</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-06-08 10:20:55 -0400</bug_when>
    <thetext>In F25 we shipped the default as devicemapper, in F26 we changed the default to overlay2 which matches the upstream default.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10489769</commentid>
    <comment_count>4</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2017-06-08 10:29:14 -0400</bug_when>
    <thetext>Yep, you need to go back to using devicemapper graph driver for docker. You can try following.

- systemctl stop docker
- atomic storage reset
- Edit /etc/sysconfig/docker-storage-setup and add following
  STORAGE_DRIVER=devicemapper
- systemctl start docker

This should work as long as you have free space in your root volume group. Otherwise you will need to add additional disk to your VM/system and specify it 
in /etc/sysconfig/docker-storage-setup

DEVS=&quot;/dev/vdb&quot;
STORAGE_DRIVER=devicemapper</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10490525</commentid>
    <comment_count>5</comment_count>
    <who name="Evan Nemerson">evan</who>
    <bug_when>2017-06-08 14:33:07 -0400</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #3)
&gt; In F25 we shipped the default as devicemapper, in F26 we changed the default
&gt; to overlay2 which matches the upstream default.

I understand, but as a user what I see is that, with a btrfs system, docker used to work and now it doesn&apos;t, which seems like an undesirable regression to me.  Even upgrading (with dnf system-upgrade) will break a working installation.  

Maybe an appropriate storage backend should be detected automatically instead of being set to overlay2?  If not, a better error message would be quite helpful.

(In reply to Vivek Goyal from comment #4)
&gt; Yep, you need to go back to using devicemapper graph driver for docker. You
&gt; can try following.
&gt; 
&gt; - systemctl stop docker
&gt; - atomic storage reset
&gt; - Edit /etc/sysconfig/docker-storage-setup and add following
&gt;   STORAGE_DRIVER=devicemapper
&gt; - systemctl start docker

This doesn&apos;t work; /etc/sysconfi/docker-storage doesn&apos;t use $STORAGE_DRIVER, it hard-codes overlay2.  The entire contents of that file are:

    DOCKER_STORAGE_OPTIONS=&quot;--storage-driver overlay2 &quot;

This is where you have to change the storage driver, and s/overlay2/devicemapper/ there does work as expected.

It&apos;s rather difficult to discover this, or even /etc/sysconfig/docker-storage-setup.  Docker&apos;s documentation seems to expect you to set it in /etc/docker/daemon.js, but doing so results in failure (an error about the value conflicting with a command line argument, IIRC).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10490599</commentid>
    <comment_count>6</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2017-06-08 15:07:45 -0400</bug_when>
    <thetext>I want you to edit /etc/sysconfig/docker-storage-setup and not /etc/sysconfig/docker-storage.

There is subtle difference. Notice extra *setup*.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10490602</commentid>
    <comment_count>7</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2017-06-08 15:08:50 -0400</bug_when>
    <thetext>I noticed that upstream docker recently removed the restriction of overlay2 on top of btrfs. Saying it should work for kernel 4.7 onwards. May be we should backport that patch.

https://github.com/moby/moby/commit/f64a4ad008e68996afcec3ab34a869887716f944


Support overlay2 on btrfs
OverlayFS is supported on top of btrfs as of Linux Kernel 4.7.
Skip the hard enforcement when on kernel 4.7 or newer and
respect the kernel check override flag on older kernels.
https://btrfs.wiki.kernel.org/index.php/Changelog#By_feature

Signed-off-by: Derek McGowan &lt;derek@mcgstyle.net&gt;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10490694</commentid>
    <comment_count>8</comment_count>
    <who name="Evan Nemerson">evan</who>
    <bug_when>2017-06-08 15:47:21 -0400</bug_when>
    <thetext>(In reply to Vivek Goyal from comment #6)
&gt; I want you to edit /etc/sysconfig/docker-storage-setup and not
&gt; /etc/sysconfig/docker-storage.
&gt; 
&gt; There is subtle difference. Notice extra *setup*.

Yes, that&apos;s what I was trying to point out.  I tried changing the value in /etc/sysconfig/docker-storage-setup and it didn&apos;t do anything.  The file exists, and there is a STORAGE_DRIVER variable, but setting it has no effect.

However, /etc/sysconfig/docker-storage also exists, and uses the value &quot;overlay2&quot; (instead of referencing the STORAGE_DRIVER variable from /etc/sysconfig/docker-storage-setup.  Changing the value in /etc/sysconfig/docker-storage-setup from overlay2 to devicemapper *does* work.

This seems like a bug in the configuration scripts for the docker package.  Should I file a separate issue for that?

&gt; I noticed that upstream docker recently removed the restriction of overlay2
&gt; on top of btrfs. Saying it should work for kernel 4.7 onwards. May be we
&gt; should backport that patch.

I&apos;d be fine with that.

I know btrfs isn&apos;t the default filesystem, and I understand that there are complications with docker storage drivers and filesystems, but that doesn&apos;t justify failing like this.  `dnf install docker &amp;&amp; systemctl start docker` should just work, even on btrfs, but it doesn&apos;t.  Which storage driver to use is an implementation detail I shouldn&apos;t need to know, and certainly shouldn&apos;t need to tell the OS.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10490783</commentid>
    <comment_count>9</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2017-06-08 16:16:55 -0400</bug_when>
    <thetext>(In reply to Evan Nemerson from comment #8)
&gt; (In reply to Vivek Goyal from comment #6)
&gt; &gt; I want you to edit /etc/sysconfig/docker-storage-setup and not
&gt; &gt; /etc/sysconfig/docker-storage.
&gt; &gt; 
&gt; &gt; There is subtle difference. Notice extra *setup*.
&gt; 
&gt; Yes, that&apos;s what I was trying to point out.  I tried changing the value in
&gt; /etc/sysconfig/docker-storage-setup and it didn&apos;t do anything.  The file
&gt; exists, and there is a STORAGE_DRIVER variable, but setting it has no effect.
&gt; 
&gt; However, /etc/sysconfig/docker-storage also exists, and uses the value
&gt; &quot;overlay2&quot; (instead of referencing the STORAGE_DRIVER variable from
&gt; /etc/sysconfig/docker-storage-setup.  Changing the value in
&gt; /etc/sysconfig/docker-storage-setup from overlay2 to devicemapper *does*
&gt; work.

Can you check your journal logs and look for messages from container-storage-setup.

Did you do &quot;atomic storage reset&quot; before setting STORAGE_DRIVER=. atomic storage reset should have removed /etc/sysconfig/docker-storage file. If it is still there, that means you tried to change STORAGE_DRIVER, without first resetting existing storage. That means container storage setup should exit with an error and that might be in journal logs.

We probably should make docker fail by default if container-storage-setup failed. (If we are not already doing it).

Ideally following should happen.

- atomic storage reset will cleanup existing storage. And will remove /etc/sysconfig/docker-storage file.

- Then you will put STORAGE_DRIVER=devicemapper in /etc/sysconfig/docker-storage-setup

- And restarting docker will start docker-storage-setup.service and that will setup devicemapper storage (as long as there is free space in root volume group). And this will also generate a new /etc/sysconfig/docker-storage file
with storage driver devicemapper.

Not sure why it is not working for you that way. 

&gt; 
&gt; This seems like a bug in the configuration scripts for the docker package. 
&gt; Should I file a separate issue for that?

Anything is fine. Either we can try to first narrow it down in this bz and then track in a separate bz or you can create a new one now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10492621</commentid>
    <comment_count>10</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-06-09 07:33:00 -0400</bug_when>
    <thetext>Even, I agree that this is not ideal, but I want to point out something you got wrong.  If you had upgraded from a previous version of docker to this one, the previous storage would have stayed.  So if in f25 you were running with docker, you would have been on devicemapper and when you upgraded to F26 it would have stayed on devicemapper.

I think changing from overlay to devicemapper is not working because you have some kind of existing storage that is causing docker to use overlay.  If you remove the storage it should switch to devicemapper.

systemctl stop docker
atomic storage modify --driver devicemapper
atomic storage reset 
systemctl start docker

Should switch your storage.

I think removing the check about btrfs and overlay is the best solution.

Antonio can you make this change?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10492723</commentid>
    <comment_count>11</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-06-09 08:06:33 -0400</bug_when>
    <thetext>Yes, I&apos;m working to backport this asap.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10493878</commentid>
    <comment_count>12</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-06-09 14:48:51 -0400</bug_when>
    <thetext>Backported to 1.12.x and 1.13.x branch. Needs a rebuild in fedora now.

Frantisek can you rebuild docker in Fedora 26 from the latest commit here: https://github.com/projectatomic/docker/commits/docker-1.12.6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10509670</commentid>
    <comment_count>13</comment_count>
    <who name="Frantisek Kluknavsky">fkluknav</who>
    <bug_when>2017-06-15 09:39:36 -0400</bug_when>
    <thetext>Maybe... Rebase is in git. Koji does not build for s390 at the moment. Wish for something quickly, a mainframe is falling.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10509947</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-15 10:20:26 -0400</bug_when>
    <thetext>docker-1.13.1-18.git27e468e.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-740382b040</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10510215</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-15 11:33:31 -0400</bug_when>
    <thetext>docker-latest-1.13-31.git27e468e.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-dd12db5cac</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10514597</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-16 18:24:11 -0400</bug_when>
    <thetext>docker-1.13.1-18.git27e468e.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-740382b040</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10514601</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-16 18:24:37 -0400</bug_when>
    <thetext>docker-latest-1.13-31.git27e468e.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-dd12db5cac</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10520406</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-19 15:53:23 -0400</bug_when>
    <thetext>docker-1.13.1-19.git27e468e.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-36d05500ee</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10525914</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-21 02:21:43 -0400</bug_when>
    <thetext>docker-1.13.1-19.git27e468e.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-36d05500ee</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10536989</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-23 23:05:45 -0400</bug_when>
    <thetext>docker-1.13.1-19.git27e468e.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>