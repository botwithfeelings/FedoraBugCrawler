<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1318547</bug_id>
          
          <creation_ts>2016-03-17 04:25:00 -0400</creation_ts>
          <short_desc>Can&apos;t use shared volume mounts with docker 1.10</short_desc>
          <delta_ts>2017-03-02 22:49:04 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>rpm-ostree</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1318690</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Dusty Mabe">dustymabe</reporter>
          <assigned_to name="Colin Walters">walters</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>jlebon</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miabbott</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>vbatts</cc>
    
    
    <cc>walters</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>rpm-ostree-2017.2-2.fc24</cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-02 22:49:04</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9155433</commentid>
    <comment_count>0</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2016-03-17 04:25:35 -0400</bug_when>
    <thetext>Description of problem:

The MountFlags=slave option is set in the docker systemd unit file which is causing shared mounts to not work with docker 1.10. I have not changed the docker.service unit file on my atomic host and it has that MountFlags=slave set in the unit file:

[vagrant@vanilla-f23atomic ~]$ rpm -qV docker | grep docker.service
.......T.    /usr/lib/systemd/system/docker.service
[vagrant@vanilla-f23atomic ~]$ grep Mount /usr/lib/systemd/system/docker.service
MountFlags=slave


I have been told this is not what we want: https://lists.projectatomic.io/projectatomic-archives/atomic-devel/2016-March/msg00083.html


Version-Release number of selected component (if applicable):
[vagrant@vanilla-f23atomic ~]$ rpm -q docker
docker-1.10.2-6.git0f5ac89.fc23.x86_64

How reproducible:
Always


Steps to Reproduce:
[vagrant@vanilla-f23atomic ~]$ sudo mount --make-shared /
[vagrant@vanilla-f23atomic ~]$ sudo docker run -it --privileged --rm -v /tmp/sharedfolder:/tmp/sharedfolder:shared sshfs /bin/bash  
docker: Error response from daemon: Cannot start container 7e99752dd8f2812a7d7acaa58594504be936b6f37aa77b6521a7098450343837: Path /tmp/sharedfolder is mounted on /sysroot but it is not a shared mount..

Actual results:
Can&apos;t run a docker container with :shared volume mount. See error message.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9156433</commentid>
    <comment_count>1</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-03-17 10:02:47 -0400</bug_when>
    <thetext>Lokesh please remove this line from all Fedora and RHEL versions of docker-1.10.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9177350</commentid>
    <comment_count>2</comment_count>
    <who name="Lokesh Mandvekar">lsm5</who>
    <bug_when>2016-03-24 12:23:22 -0400</bug_when>
    <thetext>docker has been downgraded to 1.9.1 on f23 (should land in -testing soon). I&apos;ll remove it once we&apos;re back on 1.10. f24 and rawhide are already on 1.10 and don&apos;t have MountFlags=slave. I&apos;ll make sure to remove it from RHEL 1.10 rpms too.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9378594</commentid>
    <comment_count>3</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2016-06-01 16:21:56 -0400</bug_when>
    <thetext>status on this since 1.10 is in 24 and is in testing in 23?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9386129</commentid>
    <comment_count>4</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-06-03 14:58:15 -0400</bug_when>
    <thetext>Fixed in docker-1.10, which is showing up everywhere now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9398297</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2016-06-08 10:10:11 -0400</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9559708</commentid>
    <comment_count>6</comment_count>
    <who name="Colin Walters">walters</who>
    <bug_when>2016-07-27 12:30:14 -0400</bug_when>
    <thetext>I hit this, and the problem turned out to be the mount propagation on / being private.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9785923</commentid>
    <comment_count>7</comment_count>
    <who name="Jonathan Lebon">jlebon</who>
    <bug_when>2016-10-12 15:30:31 -0400</bug_when>
    <thetext>(In reply to Colin Walters from comment #6)
&gt; I hit this, and the problem turned out to be the mount propagation on /
&gt; being private.

Also hit this on the most recent Fedora 24 tree:

#  findmnt / -o TARGET,PROPAGATION
TARGET PROPAGATION
/      private

# docker run --rm -it --privileged -v /:/host fedora:24 echo ok
docker: Error response from daemon: Cannot start container a9a14be96410e36f6a31e6604c603d1c4f5912a9def42e162e5d5b72fd3bec30: Path / is mounted on / but it is not a shared or slave mount..sh

# mount --make-shared /
# docker run --rm -it --privileged -v /:/host fedora:24 echo ok
ok

Did this somehow change in recent times? Don&apos;t remember running into it before, although I&apos;ve mounted / many times.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9786043</commentid>
    <comment_count>8</comment_count>
    <who name="Colin Walters">walters</who>
    <bug_when>2016-10-12 16:10:15 -0400</bug_when>
    <thetext>This may be an interaction with ostree doing the bind mount for /.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9786046</commentid>
    <comment_count>9</comment_count>
    <who name="Colin Walters">walters</who>
    <bug_when>2016-10-12 16:12:26 -0400</bug_when>
    <thetext>FWIW I think the right workaround is:

mount --make-rshared /

Note the extra `r` - this way you&apos;ll also be able to bind in any other host mount points.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9925541</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2016-11-24 11:07:08 -0500</bug_when>
    <thetext>This message is a reminder that Fedora 23 is nearing its end of life.
Approximately 4 (four) weeks from now Fedora will stop maintaining
and issuing updates for Fedora 23. It is Fedora&apos;s policy to close all
bug reports from releases that are no longer maintained. At that time
this bug will be closed as EOL if it remains open with a Fedora  &apos;version&apos;
of &apos;23&apos;.

Package Maintainer: If you wish for this bug to remain open because you
plan to fix it in a currently maintained version, simply change the &apos;version&apos; 
to a later Fedora version.

Thank you for reporting this issue and we are sorry that we were not 
able to fix it before Fedora 23 is end of life. If you would still like 
to see this bug fixed and are able to reproduce it against a later version 
of Fedora, you are encouraged  change the &apos;version&apos; to a later Fedora 
version prior this bug is closed as described in the policy above.

Although we aim to fix as many bugs as possible during every release&apos;s 
lifetime, sometimes those efforts are overtaken by events. Often a 
more recent Fedora release includes newer upstream software that fixes 
bugs or makes them obsolete.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10117407</commentid>
    <comment_count>11</comment_count>
    <who name="Micah Abbott">miabbott</who>
    <bug_when>2017-02-02 17:07:20 -0500</bug_when>
    <thetext>We are seeing this in our F24 Atomic Host tests.  From what I can deduce, it appears using pkg-layering is causing the root filesystem to have mount propagation set to PRIVATE.

# atomic host status
State: idle
Deployments:
● fedora-atomic:fedora-atomic/24/x86_64/docker-host
       Version: 24.121 (2017-02-02 20:35:47)
        Commit: 57f57ff2eeb82797e3600bd3ce0a6dfb7a6982997abda991cc2b8711e7cb7004
        OSName: fedora-atomic
# findmnt / -o TARGET,PROPAGATION
TARGET PROPAGATION
/      shared
# rpm-ostree install wget
Checking out tree 57f57ff... done

Downloading metadata: [=====================] 100%
Resolving dependencies... done
Overlaying... done
Running %post for wget...... done
Writing rpmdb... done
Writing OSTree commit... done
Copying /etc changes: 26 modified, 0 removed, 65 added
Transaction complete; bootconfig swap: yes deployment count change: 1
Added:
  wget-1.18-1.fc24.x86_64
Run &quot;systemctl reboot&quot; to start a reboot

&lt;&lt;&lt; reboot &gt;&gt;&gt;

# atomic host status
State: idle
Deployments:
● fedora-atomic:fedora-atomic/24/x86_64/docker-host
       Version: 24.121 (2017-02-02 22:04:01)
    BaseCommit: 57f57ff2eeb82797e3600bd3ce0a6dfb7a6982997abda991cc2b8711e7cb7004
        Commit: 71aa1683f43ec9e61b3fc8dccb2bc6d1a52d06c9aa8164035fd16ba7db6e2fff
        OSName: fedora-atomic
      Packages: wget

  fedora-atomic:fedora-atomic/24/x86_64/docker-host
       Version: 24.121 (2017-02-02 20:35:47)
        Commit: 57f57ff2eeb82797e3600bd3ce0a6dfb7a6982997abda991cc2b8711e7cb7004
        OSName: fedora-atomic
-bash-4.3# findmnt / -o TARGET,PROPAGATION
TARGET PROPAGATION
/      private
# docker run --rm -it --privileged -v /:/host fedora:24 echo ok
docker: Error response from daemon: Cannot start container b8b6355cac7af433724236b58669495c8e378236fb4de242f43a610247372c75: Path / is mounted on / but it is not a shared or slave mount..


So is this really an ostree bug?  Do we want to ship a new version of ostree in F24?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10120718</commentid>
    <comment_count>12</comment_count>
    <who name="Jonathan Lebon">jlebon</who>
    <bug_when>2017-02-03 18:33:02 -0500</bug_when>
    <thetext>Good catch, Micah. This is indeed caused by rpm-ostree package layering. Should be fixed by:

https://github.com/projectatomic/rpm-ostree/pull/605

Note that although this also happens on F25, the docker there can deal with it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150639</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-15 10:57:03 -0500</bug_when>
    <thetext>ostree-2017.2-2.fc24 rpm-ostree-2017.2-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-758aab74a4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10161856</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-17 11:58:12 -0500</bug_when>
    <thetext>ostree-2017.2-2.fc24 rpm-ostree-2017.2-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-758aab74a4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10164185</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-18 16:50:47 -0500</bug_when>
    <thetext>ostree-2017.2-2.fc24, rpm-ostree-2017.2-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-758aab74a4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10179176</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-23 12:11:07 -0500</bug_when>
    <thetext>ostree-2017.2-3.fc24 rpm-ostree-2017.2-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-758aab74a4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10183325</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-24 19:52:54 -0500</bug_when>
    <thetext>ostree-2017.2-3.fc24, rpm-ostree-2017.2-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-758aab74a4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10190819</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 04:56:00 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10204534</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-02 22:49:04 -0500</bug_when>
    <thetext>ostree-2017.2-3.fc24, rpm-ostree-2017.2-2.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>