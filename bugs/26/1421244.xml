<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1421244</bug_id>
          
          <creation_ts>2017-02-10 12:35:00 -0500</creation_ts>
          <short_desc>DNF keeps packages with broken scriptlets installed, although it claims they were removed.</short_desc>
          <delta_ts>2017-05-05 09:34:55 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>dnf</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Triaged</keywords>
          <priority>high</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Vít Ondruch">vondruch</reporter>
          <assigned_to name="Jaroslav Mracek">jmracek</assigned_to>
          <cc>ignatenko</cc>
    
    
    <cc>jmracek</cc>
    
    
    <cc>kardos.lubos</cc>
    
    
    <cc>mjw</cc>
    
    
    <cc>packaging-team-maint</cc>
    
    
    <cc>pmatilai</cc>
    
    
    <cc>rpm-software-management</cc>
    
    
    <cc>vmukhame</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>dnf-2.4.0-1.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-05-05 09:34:55</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10138953</commentid>
    <comment_count>0</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2017-02-10 12:35:46 -0500</bug_when>
    <thetext>Description of problem:
DNF keeps packages with broken scriptlets installed, although it claims they were removed:

~~~
$ LANG=C.utf-8 sudo dnf remove vagrant-adbinfo
Dependencies resolved.
========================================================================
 Package              Arch        Version           Repository     Size
========================================================================
Removing:
 vagrant-adbinfo      noarch      0.0.9-4.fc24      @rawhide       24 k

Transaction Summary
========================================================================
Remove  1 Package

Installed size: 24 k
Is this ok [y/N]: y
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
/usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in `require&apos;: cannot load such file -- vagrant/plugin/manager (LoadError)
	from /usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in `require&apos;
	from -e:3:in `&lt;main&gt;&apos;
error: %preun(vagrant-adbinfo-0.0.9-4.fc24.noarch) scriptlet failed, exit status 1
Error in PREUN scriptlet in rpm package vagrant-adbinfo
Error in PREUN scriptlet in rpm package vagrant-adbinfo
vagrant-adbinfo-0.0.9-4.fc24.noarch was supposed to be removed but is not!
  Verifying   : vagrant-adbinfo-0.0.9-4.fc24.noarch                 1/1 

Removed:
  vagrant-adbinfo.noarch 0.0.9-4.fc24                                   

Complete!

$ rpm -q vagrant-adbinfo 
vagrant-adbinfo-0.0.9-4.fc24.noarch
~~~

Interestingly enough, if the package had some dependencies, they would be removed.

Also, there is no way (AFAIK) to remove such package via DNF ...



Version-Release number of selected component (if applicable):
$ rpm -q dnf
dnf-2.0.0-2.fc26.noarch


How reproducible:


Steps to Reproduce:
1.
2.
3.

Actual results:
Package with broken scriptlet is kept installed, while it is reported to be removed. Also its dependencies are possibly removed. There is noway how to remove such package via DNF.


Expected results:
The issue should be properly reported, the transaction possibly aborted. But the package should be definitely possible to remove ...


Additional info:
Actually, it happened to me that by series of install/remove I got 4 copies of this package on my system reported by RPM.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10143204</commentid>
    <comment_count>1</comment_count>
    <who name="Honza Silhan">jsilhan</who>
    <bug_when>2017-02-13 09:31:09 -0500</bug_when>
    <thetext>we will investigate why DNF does not report the package was not removed correctly. The DNF return code should be checked as well.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10192197</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 06:14:56 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10249634</commentid>
    <comment_count>3</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-17 10:07:10 -0400</bug_when>
    <thetext>I have to ask rpm team, how to solve a problem. Simply rpm refuse to remove the file and even it do not report removal as fail. 

It can be reproduce:

1. dnf install https://kojipkgs.fedoraproject.org//packages/vagrant-adbinfo/0.0.9/4.fc24/noarch/vagrant-adbinfo-doc-0.0.9-4.fc24.noarch.rpm

2. rpm -e --nodeps $(dnf repoquery --installed -q rubygem*)

3. rpm -e vagrant-adbinfo

In this case rpm refuse to remove package with return code 255.

We really cannot do much if rpm cannot handle it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10301748</commentid>
    <comment_count>4</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2017-04-04 05:42:24 -0400</bug_when>
    <thetext>%preun scriptlets have the power to stop a package from being removed, this is expected behavior. Yes, typos fixed in the next release and all.

&quot;rpm -e --noscripts vagrant-adbinfo&quot; to get around it. IIRC yum had some switch to do the same.

As for the verifying step showing all okay I dunno what yum (and now dnf due to the inheritance) do there, it always seemed like a strange addition to me. Instead of filling the screen with redundant goo that&apos;s not even accurate (as witnessed here), it could ask rpm whether a transaction element failed (te.Failed()) and only report the failed ones if there were any, or something like that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10306689</commentid>
    <comment_count>5</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-04-05 08:44:13 -0400</bug_when>
    <thetext>Thanks Panu for info. 

But to fix problem we need an assistance from RPM.

In this case we run:
errors = rpm.transaction.TransactionSet.run()
But errors is 0.
then we tests (code dnf.base lines 796-833)
        # ts.run() exit codes are, hmm, &quot;creative&quot;: None means all ok, empty
        # list means some errors happened in the transaction and non-empty
        # list that there were errors preventing the ts from starting...
        if errors is None:
            pass
        elif len(errors) == 0:
            # this is a particularly tricky case happening also when rpm failed
            # to obtain the transaction lock. We can only try to see if a
            # particular element failed and if not, decide that is the
            # case.
            if len([el for el in self._ts if el.Failed()]) &gt; 0:
                errstring = _(&apos;Warning: scriptlet or other non-fatal errors &apos;
                              &apos;occurred during transaction.&apos;)
                logger.debug(errstring)



and el.Failed() == 1 but we recognize it as soft problem. Please can you provide detailed information how we should handle the returns from rpm and their combinations? Thanks a lot for your help.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10306857</commentid>
    <comment_count>6</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2017-04-05 09:28:48 -0400</bug_when>
    <thetext>Well that&apos;s more &quot;creativity&quot; in this area. Chasing down the origins of that el.Failed() and its interpretation comes to this:

commit 543a95d8859377530270a7515002d099a87abfd7
Author: Ales Kozumplik &lt;akozumpl@redhat.com&gt;
Date:   Tue Apr 17 13:58:42 2012 +0200

    better handling of the no-root situtation.

...for which checking te.Failed() seems bizarre. At any rate, te.Failed() returning true certainly signifies a hard error and is what rpm itself uses to track failures within transaction.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10307597</commentid>
    <comment_count>7</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-04-05 12:30:25 -0400</bug_when>
    <thetext>Thanks for help. I created a pull request that should solve the problem with marking unremoved packages as removed: https://github.com/rpm-software-management/dnf/pull/780 .
To remove packages with broken scriplets it is possible to use &quot;dnf remove --setopt=tsflags=noscripts &lt;package&gt;&quot; .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10379510</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-02 11:41:03 -0400</bug_when>
    <thetext>dnf-plugins-core-2.0.0-1.fc26 libdnf-0.8.2-1.fc26 dnf-2.4.0-1.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10385162</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-04 05:48:53 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26 dnf-plugins-core-2.0.0-1.fc26 dnf-plugins-extras-2.0.0-1.fc26 libdnf-0.8.2-1.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10387503</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-04 18:05:11 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26, dnf-plugins-core-2.0.0-1.fc26, dnf-plugins-extras-2.0.0-1.fc26, libdnf-0.8.2-1.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10389254</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-05 09:34:55 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26, dnf-plugins-core-2.0.0-1.fc26, dnf-plugins-extras-2.0.0-1.fc26, libdnf-0.8.2-1.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>