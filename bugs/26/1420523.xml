<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1420523</bug_id>
          
          <creation_ts>2017-02-08 16:29:00 -0500</creation_ts>
          <short_desc>Cloud base image composes fail in current Rawhide</short_desc>
          <delta_ts>2017-03-02 18:44:44 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>lorax</component>
          <version>26</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>RAWHIDE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>AcceptedBlocker</status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1349184</blocked>
    
    
    <blocked>1420146</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="Brian Lane">bcl</assigned_to>
          <cc>anaconda-maint-list</cc>
    
    
    <cc>bcl</cc>
    
    
    <cc>dennis</cc>
    
    
    <cc>dgilmore</cc>
    
    
    <cc>dueno</cc>
    
    
    <cc>emaldona</cc>
    
    
    <cc>kdudka</cc>
    
    
    <cc>kengert</cc>
    
    
    <cc>kevin</cc>
    
    
    <cc>robatino</cc>
    
    
    <cc>sgallagh</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>lorax-26.6-1</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-02 18:44:44</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10132482</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-08 16:29:19 -0500</bug_when>
    <thetext>The Cloud base images always fail to build in current Rawhide composes, e.g.: https://koji.fedoraproject.org/koji/taskinfo?taskID=17670764

The problem looks to be a size one (see screenshot.ppm): &quot;Not enough space in file systems for the current software selection. An additional 295 MiB is needed.&quot;

Dennis says this likely needs a tweak in the Pungi config.

On https://fedoraproject.org/wiki/Releases/26/ReleaseBlocking , these images are still listed as release blocking. Therefore I&apos;m marking this as an automatic blocker: &quot;Bugs which entirely prevent the composition of one or more of the release-blocking images required to be built for a currently-pending (pre-)release&quot; - https://fedoraproject.org/wiki/QA:SOP_blocker_bug_process#Automatic_blockers . From other discussions though, we may not actually want these images to be release blocking any more; I&apos;ll try and start a discussion about that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10132505</commentid>
    <comment_count>1</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-08 16:38:04 -0500</bug_when>
    <thetext>Reported to Pagure pungi-fedora (as requested by Dennis): https://pagure.io/pungi-fedora/issue/130</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10141137</commentid>
    <comment_count>2</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-12 10:57:38 -0500</bug_when>
    <thetext>A kickstart change has been made which ought to fix this, I believe, but in recent composes, the buildinstall-Cloud task is failing instead:

https://kojipkgs.fedoraproject.org/compose/rawhide/Fedora-Rawhide-20170212.n.0/logs/x86_64/buildinstall-Cloud.x86_64.log

2017-02-12 07:26:37,013: doing post-install configuration
doing post-install configuration
2017-02-12 07:26:37,035: running runtime-postinstall.tmpl
running runtime-postinstall.tmpl
2017-02-12 07:26:37,151: command output:
error: Failed to initialize NSS library

command output:
error: Failed to initialize NSS library

2017-02-12 07:26:37,151: command returned failure (1)
command returned failure (1)
2017-02-12 07:26:37,152: template command error in runtime-postinstall.tmpl:
template command error in runtime-postinstall.tmpl:
2017-02-12 07:26:37,152:   runcmd chroot /var/tmp/lorax.sxfb6lkt/installtree /bin/rpm -qa --pipe tee /root/lorax-packages.log
  runcmd chroot /var/tmp/lorax.sxfb6lkt/installtree /bin/rpm -qa --pipe tee /root/lorax-packages.log
2017-02-12 07:26:37,153:   subprocess.CalledProcessError: Command &apos;[&apos;chroot&apos;, &apos;/var/tmp/lorax.sxfb6lkt/installtree&apos;, &apos;/bin/rpm&apos;, &apos;-qa&apos;, &apos;--pipe&apos;, &apos;tee /root/lorax-packages.log&apos;]&apos; returned non-zero exit status 1.
  subprocess.CalledProcessError: Command &apos;[&apos;chroot&apos;, &apos;/var/tmp/lorax.sxfb6lkt/installtree&apos;, &apos;/bin/rpm&apos;, &apos;-qa&apos;, &apos;--pipe&apos;, &apos;tee /root/lorax-packages.log&apos;]&apos; returned non-zero exit status 1.
Traceback (most recent call last):
  File &quot;/usr/sbin/lorax&quot;, line 273, in &lt;module&gt;
    main()
  File &quot;/usr/sbin/lorax&quot;, line 133, in main
    remove_temp=True, verify=opts.verify)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/__init__.py&quot;, line 292, in run
    rb.postinstall()
  File &quot;/usr/lib/python3.6/site-packages/pylorax/treebuilder.py&quot;, line 145, in postinstall
    self._runner.run(&quot;runtime-postinstall.tmpl&quot;, configdir=configdir_path)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/ltmpl.py&quot;, line 220, in run
    self._run(commands)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/ltmpl.py&quot;, line 239, in _run
    f(*args)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/ltmpl.py&quot;, line 515, in runcmd
    stdout = runcmd_output(cmd)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/executils.py&quot;, line 347, in runcmd_output
    return execWithCapture(cmd[0], cmd[1:], **kwargs)
  File &quot;/usr/lib/python3.6/site-packages/pylorax/executils.py&quot;, line 249, in execWithCapture
    reset_handlers=reset_handlers, reset_lang=reset_lang)[1]
  File &quot;/usr/lib/python3.6/site-packages/pylorax/executils.py&quot;, line 201, in _run_program
    raise subprocess.CalledProcessError(proc.returncode, argv, output)
subprocess.CalledProcessError: Command &apos;[&apos;chroot&apos;, &apos;/var/tmp/lorax.sxfb6lkt/installtree&apos;, &apos;/bin/rpm&apos;, &apos;-qa&apos;, &apos;--pipe&apos;, &apos;tee /root/lorax-packages.log&apos;]&apos; returned non-zero exit status 1.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10168574</commentid>
    <comment_count>3</comment_count>
    <who name="Dennis Gilmore">dgilmore</who>
    <bug_when>2017-02-20 15:54:03 -0500</bug_when>
    <thetext>changes in the most recent version of nss have broken the ability to compose fedora. as a workaround we have untagged the latest nvr.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10168589</commentid>
    <comment_count>4</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-20 16:00:11 -0500</bug_when>
    <thetext>Very strange.
Did 3.29 break, but 3.28.x works?

Could you please name the NVRs that work for you?
Thanks</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10168601</commentid>
    <comment_count>5</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-20 16:07:35 -0500</bug_when>
    <thetext>Does this bug occur without lorax, simply by executing &quot;rpm -qa&quot; ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10168675</commentid>
    <comment_count>6</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-20 16:25:02 -0500</bug_when>
    <thetext>I&apos;ll give you some information about a recent issue with NSS, although I had assumed it&apos;s unrelated to RPM.

We had recently discovered that NSS 3.28 had introduced an incompatible change of a binary API. If an application was built against earlier version of NSS, and upgraded to NSS 3.28, the application could be broken.

We reverted the bad change upstream.

Broken upstream versions are:
- 3.28
- 3.28.1
- 3.28.2
- 3.29

Fixed upstream versions are:
- 3.28.3
- 3.29.1

This means, an application that was built against 3.28, 3.28.1, 3.28.2, 3.29, and then is linked to 3.28.3 or 3.29.1, the application must be rebuilt, to ensure it&apos;s back to using the old ABI.

However, based on source inspection, I assumed that the list of affected applications/packages is limited to java-1.8.0-openssl and nss-pem.

I couldn&apos;t find any use of the affected data structures in the RPM sources, so I currently believe that RPM isn&apos;t affected by this ABI issue. Am I wrong?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10169958</commentid>
    <comment_count>7</comment_count>
    <who name="Kamil Dudka">kdudka</who>
    <bug_when>2017-02-21 04:22:51 -0500</bug_when>
    <thetext>(In reply to Dennis Gilmore from comment #3)
&gt; changes in the most recent version of nss have broken the ability to compose
&gt; fedora. as a workaround we have untagged the latest nvr.

I guess this implies I cannot easily rebuild nss-pem against the latest nss any more?

(In reply to Kai Engert (:kaie) from comment #6)
&gt; We had recently discovered that NSS 3.28 had introduced an incompatible
&gt; change of a binary API. If an application was built against earlier version
&gt; of NSS, and upgraded to NSS 3.28, the application could be broken.

Based on which technical data are you assuming that the broken rpm and some ABI change that broke java are the same issues?

Do we have some steps to reproduce this bug locally?

I believe that nss maintainers tried to install the updated nss packages on their staging systems before pushing it to rawhide.  So just installing the latest nss will likely not be sufficient to trigger this bug?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10170126</commentid>
    <comment_count>8</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 05:00:49 -0500</bug_when>
    <thetext>(In reply to Kamil Dudka from comment #7)
&gt; (In reply to Kai Engert (:kaie) from comment #6)
&gt; &gt; We had recently discovered that NSS 3.28 had introduced an incompatible
&gt; &gt; change of a binary API. If an application was built against earlier version
&gt; &gt; of NSS, and upgraded to NSS 3.28, the application could be broken.
&gt; 
&gt; Based on which technical data are you assuming that the broken rpm and some
&gt; ABI change that broke java are the same issues?

I don&apos;t know if they are the same issue.

I provided the information in case it&apos;s related.


&gt; Do we have some steps to reproduce this bug locally?

That&apos;s my question, too.


FYI, I have a local rawhide VM, which was using the NSS 3.29 build, and the system was working for me. The graphical desktop was starting, and I could even run firefox.

I want to help, but I don&apos;t know how to trigger the failure with rpm.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10170971</commentid>
    <comment_count>9</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 09:01:03 -0500</bug_when>
    <thetext>Good news. I&apos;m able to reproduce the bug.

I&apos;ve downloaded a mirror of the latest-rawhide tree from the download server. jkonecny pointed me to the config files that are used by lorax. I&apos;ve tweaked those files to install only a small subset of the files. (Because for whatever reason I don&apos;t know, the latest-rawhide tree is missing a lot of files that lorax wants to install, like tmux, gdb etc.)

With nss-*3.28.1*.rpm files, I gets past step &quot;running runtime-postinstall.tmpl&quot; and can run &quot;rpm -qa&quot; fine.

Then I tweaked my local tree. Because changing the repodata files is complicated, I used a symbolic link approach, and simply linked the nss-*3.28.1*.rpm files to newer 3.29.x files.

I was able to reproduce the failure using both 3.29 and 3.29.1.
That means, the issue isn&apos;t related to the ABI issue I had mentioned in comment 6, which means &quot;rpm&quot; isn&apos;t affected by the ABI issue, which is good news.

So the issue must be change between 3.28.x and 3.29.x


Then Daiki Ueno guessed that the issue might be related to 
  https://bugzilla.mozilla.org/show_bug.cgi?id=889116

And indeed, I was able to confirm that&apos;s the issue.

NSS now requires that /dev/urandom is present on Linux, but the chroot environment created by lorax doesn&apos;t have that.


Can lorax be fixed to setup /dev/urandom ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171127</commentid>
    <comment_count>10</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 09:38:58 -0500</bug_when>
    <thetext>I suggest to mount /dev inside the chroot environment.

I&apos;ve submitted a pull request at https://github.com/rhinstaller/lorax/pull/189
That change makes it work in my reduced test case.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171134</commentid>
    <comment_count>11</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 09:39:41 -0500</bug_when>
    <thetext>I&apos;m reassining to lorax. Do you agree to apply a fix to lorax?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171178</commentid>
    <comment_count>12</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 09:53:45 -0500</bug_when>
    <thetext>FWIW, I&apos;d like to ask that once you fix this bug with lorax, please move back to the newer NSS 3.29.1 packages, beause some other rawhide packages already depend on it - and we need to ensure that java-1.8.0-openjdk and nss-pem are rebuilt into a sane state.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171662</commentid>
    <comment_count>13</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 11:30:37 -0500</bug_when>
    <thetext>Brian said he doesn&apos;t want to mount all of /dev
and suggested to use mknod to create the device node for /dev/urandom only.
I confirmed that works, too.

mknod -m 444 /dev/random c 1 8
mknod -m 444 /dev/urandom c 1 9</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171737</commentid>
    <comment_count>14</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-21 11:42:22 -0500</bug_when>
    <thetext>Holy crap, mknod? Let&apos;s party like it&apos;s 1999!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171852</commentid>
    <comment_count>15</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-21 12:11:37 -0500</bug_when>
    <thetext>(In reply to Adam Williamson from comment #14)
&gt; Holy crap, mknod? Let&apos;s party like it&apos;s 1999!

lorax sets up a OS environment from scratch, and in 2017 a good randomness source shall be present</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171870</commentid>
    <comment_count>16</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-21 12:16:27 -0500</bug_when>
    <thetext>sure, I wasn&apos;t criticising, just found it funny :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171908</commentid>
    <comment_count>17</comment_count>
    <who name="Kevin Fenzi">kevin</who>
    <bug_when>2017-02-21 12:25:56 -0500</bug_when>
    <thetext>*** Bug 1424812 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10174923</commentid>
    <comment_count>18</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-02-22 10:14:40 -0500</bug_when>
    <thetext>Brian, thanks a lot for fixing Rawhide F26 !

Would it be possible to deliver this fix into stable F24 + F25, too?

I guess that&apos;s blocking an upgrade to NSS 3.29.x (which will be required for Firefox 53).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10175201</commentid>
    <comment_count>19</comment_count>
    <who name="Brian Lane">bcl</who>
    <bug_when>2017-02-22 11:09:41 -0500</bug_when>
    <thetext>(In reply to Kai Engert (:kaie) from comment #18)
&gt; Brian, thanks a lot for fixing Rawhide F26 !
&gt; 
&gt; Would it be possible to deliver this fix into stable F24 + F25, too?
&gt; 
&gt; I guess that&apos;s blocking an upgrade to NSS 3.29.x (which will be required for
&gt; Firefox 53).

I&apos;ll do that today.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10192172</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 06:13:25 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10204117</commentid>
    <comment_count>21</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-02 18:44:44 -0500</bug_when>
    <thetext>This is clearly resolved, as we have Cloud image composes again in recent Rawhide.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>