<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1372255</bug_id>
          
          <creation_ts>2016-09-01 05:18:00 -0400</creation_ts>
          <short_desc>[libvirt][xen-4.7] libvirt still supports &quot;model type=&apos;netfront&apos;&quot; when &apos;netfront&apos; type is ommited in xen-4.7.</short_desc>
          <delta_ts>2017-05-03 15:05:43 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt</component>
          <version>26</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Lin Liu">linl</reporter>
          <assigned_to name="Libvirt Maintainers">libvirt-maint</assigned_to>
          <cc>agedosier</cc>
    
    
    <cc>berrange</cc>
    
    
    <cc>clalancette</cc>
    
    
    <cc>crobinso</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>laine</cc>
    
    
    <cc>leiwang</cc>
    
    
    <cc>libvirt-maint</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
    
    
    <cc>vkuznets</cc>
    
    
    <cc>wshi</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-05-03 15:05:43</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9670508</commentid>
    <comment_count>0</comment_count>
    <who name="Lin Liu">linl</who>
    <bug_when>2016-09-01 05:18:19 -0400</bug_when>
    <thetext>Description of problem:
When creating a guest by xl command with &quot;type=netfront&quot; in cfg file on xen version larger than 4.6 host, it will reports warning &quot;Invalid parameter `type&apos;&quot; and check the guest NIC after created, the network device uses rtl8139 model. But creating guest by virsh command with &quot;&lt;model type=&apos;netfront&apos;/&gt;&quot; in XML file, it doesn&apos;t add an emulated NIC to VM. There is difference between xl and libvirt with the same configuration.


Version-Release number of selected component (if applicable):
Host Fedora Rawhide with latest libvirt, xen and kernel:
libvirt-2.1.0-1.fc26.x86_64
xen-4.7.0-2.fc26.x86_64
kernel-4.7.0-0.rc7.git4.1.fc25.x86_64

Guest RHEL7.2 with kernel (Actually this bug isn&apos;t related to guest version, it also ca be reproduced with RHEL7.3 guest):
kernel-3.10.0-327.el7.x86_64

How reproducible: Always

Steps to Reproduce:
1. Create a guest on Fedora Rawhide xen-4.7 host using command &quot;xl create xen-hvm-guest.cfg&quot; with below configuration:
[root@dhcp-9-56 ~]# cat xen-hvm-guest.cfg
name = &quot;xen-hvm-a&quot;
memory = 1024
vcpus = 2
builder = &quot;hvm&quot;
kernel = &quot;/usr/lib/xen/boot/hvmloader&quot;
boot = &quot;c&quot;
pae = 1
acpi = 1
apic = 1
sdl = 0
vnc = 1
vncunused = 1
vnclisten = &quot;0.0.0.0&quot;
localtime = 0
on_poweroff = &quot;destroy&quot;
on_reboot = &quot;restart&quot;
on_crash = &quot;restart&quot;
device_model = &quot;/usr/lib64/xen/bin/qemu-dm&quot;
disk = [ &quot;file:/home/RHEL-Server-7.2-64-20151030.0-hvm.raw,xvda,w&quot; ]
vif = [ &quot;type=netfront,mac=00:16:36:43:72:c9,script=vif-bridge,bridge=xenbr0&quot; ]
serial = &quot;pty&quot;

[root@dhcp-9-56 ~]# xl create xen-hvm-guest.cfg
Parsing config from xen-hvm-guest.cfg
WARNING: you seem to be using &quot;kernel&quot; directive to override HVM guest firmware. Ignore that. Use &quot;firmware_override&quot; instead if you really want a non-default firmware
Invalid parameter `type&apos;.
WARNING: ignoring device_model directive.
WARNING: Use &quot;device_model_override&quot; instead if you really want a non-default device_model

Check the dm-qemu process, we can see that the network device use rtl8139 model.
[root@dhcp-9-56 ~]# ps ax | grep qemu
30963 ?        SLsl   0:12 /usr/bin/qemu-system-i386 -xen-domid 135 -chardev socket,id=libxl-cmd,path=/var/run/xen/qmp-libxl-135,server,nowait -no-shutdown -mon chardev=libxl-cmd,mode=control -chardev socket,id=libxenstat-cmd,path=/var/run/xen/qmp-libxenstat-135,server,nowait -mon chardev=libxenstat-cmd,mode=control -nodefaults -no-user-config -name xen-hvm-a -vnc 0.0.0.0:0,to=99 -display none -serial pty -device cirrus-vga,vgamem_mb=8 -boot order=c -smp 2,maxcpus=2 -device rtl8139,id=nic0,netdev=net0,mac=00:16:36:43:72:c9 -netdev type=tap,id=net0,ifname=vif135.0-emu,script=no,downscript=no -machine xenfv -m 1016 -drive file=/home/RHEL-Server-7.2-64-20151030.0-hvm.raw,if=ide,index=0,media=disk,format=raw,cache=writeback

We can see that the network device use rtl8139 model.

2. Create guest with xml file with &quot;&lt;model type=&apos;netfront&apos;/&gt;&quot;:
[root@dhcp-9-56 ~]# cat xen-hvm-guest.xml
&lt;domain type=&apos;xen&apos;&gt;
  &lt;name&gt;xen-hvm-guest&lt;/name&gt;
  &lt;memory unit=&apos;KiB&apos;&gt;5120000&lt;/memory&gt;
  &lt;currentMemory unit=&apos;KiB&apos;&gt;5120000&lt;/currentMemory&gt;
&lt;vcpu placement=&apos;static&apos; current=&apos;4&apos;&gt;4&lt;/vcpu&gt;  
&lt;os&gt;
    &lt;type arch=&apos;x86_64&apos; machine=&apos;xenfv&apos;&gt;hvm&lt;/type&gt;
    &lt;loader type=&apos;rom&apos;&gt;/usr/lib/xen/boot/hvmloader&lt;/loader&gt;
    &lt;boot dev=&apos;hd&apos;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset=&apos;variable&apos; adjustment=&apos;0&apos; basis=&apos;utc&apos;/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;preserve&lt;/on_crash&gt;
  &lt;devices&gt;
&lt;emulator&gt;/usr/bin/qemu-system-i386&lt;/emulator&gt;    
&lt;disk type=&apos;file&apos; device=&apos;disk&apos;&gt;
      &lt;driver name=&apos;file&apos;/&gt;
      &lt;source file=&apos;/home/RHEL-Server-7.3-64-hvm.raw&apos;/&gt;
      &lt;target dev=&apos;hda&apos; bus=&apos;ide&apos;/&gt;
    &lt;/disk&gt;
&lt;interface type=&apos;bridge&apos;&gt;
&lt;mac address=&apos;00:16:3e:fc:e5:46&apos;/&gt;
&lt;model type=&apos;netfront&apos;/&gt;
&lt;source bridge=&apos;xenbr0&apos;/&gt;
&lt;/interface&gt;
&lt;serial type=&apos;pty&apos;&gt;
      &lt;target port=&apos;0&apos;/&gt;
    &lt;/serial&gt;
    &lt;console type=&apos;pty&apos;&gt;
      &lt;target type=&apos;serial&apos; port=&apos;0&apos;/&gt;
    &lt;/console&gt;
    &lt;input type=&apos;mouse&apos; bus=&apos;ps2&apos;/&gt;
    &lt;input type=&apos;keyboard&apos; bus=&apos;ps2&apos;/&gt;
    &lt;graphics type=&apos;vnc&apos; port=&apos;-1&apos; autoport=&apos;yes&apos; listen=&apos;0.0.0.0&apos;&gt;
      &lt;listen type=&apos;address&apos; address=&apos;0.0.0.0&apos;/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type=&apos;cirrus&apos; vram=&apos;8096&apos; heads=&apos;1&apos; primary=&apos;yes&apos;/&gt;
    &lt;/video&gt;
  &lt;/devices&gt;
&lt;/domain&gt;



Actual results:
Guest is created without warning about netfront model.
And check the qemu-dm process, it doesn&apos;t add an emulated NIC to guest as the xl does.
[root@dhcp-9-56 ~]# ps ax | grep qemu
  470 pts/0    S+     0:00 grep --color=auto qemu
32751 ?        SLsl   0:10 /usr/bin/qemu-system-i386 -xen-domid 140 -chardev socket,id=libxl-cmd,path=/var/run/xen/qmp-libxl-140,server,nowait -no-shutdown -mon chardev=libxl-cmd,mode=control -chardev socket,id=libxenstat-cmd,path=/var/run/xen/qmp-libxenstat-140,server,nowait -mon chardev=libxenstat-cmd,mode=control -nodefaults -no-user-config -name xen-hvm-guest -vnc 0.0.0.0:1 -display none -serial pty -device cirrus-vga,vgamem_mb=8 -boot order=c -usb -smp 4,maxcpus=4 -net none -machine xenfv -m 4992 -drive file=/home/RHEL-Server-7.3-64-hvm.raw,if=ide,index=0,media=disk,format=raw,cache=writeback

Expected results:
Libvirt should perform the same as xl that ommit netfront type.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10191138</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 05:11:20 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10383505</commentid>
    <comment_count>2</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2017-05-03 15:05:43 -0400</bug_when>
    <thetext>Sounds like this is fixed by this commit, which is in rawhide/f26 nowadays, so please reopen if this issue is still present

commit 03f8bba26e24db9fbce32078f587ed6b8424ce8e
Author: Chunyan Liu &lt;cyliu@suse.com&gt;
Date:   Tue May 17 17:34:45 2016 +0800

    xenFormatNet: correct `type=netfront&apos; to &apos;type=vif&apos; to match libxl
    
    According to current xl.cfg docs and xl codes, it uses type=vif
    instead of type=netfront.
    
    Currently after domxml-to-native, libvirt xml model=netfront will be
    converted to xl type=netfront. This has no problem before, xen codes
    for a long time just check type=ioemu, if not, set type to _VIF.
    
    Since libxl uses parse_nic_config to avoid duplicate codes, it
    compares &apos;type=vif&apos; and &apos;type=ioemu&apos; for valid parameters, others
    are considered as invalid, thus we have problem with type=netfront
    in xl config file.
     #xl create sles12gm-hvm.orig
     Parsing config from sles12gm-hvm.orig
     Invalid parameter `type&apos;.
    
    Correct the conversion in libvirt, so that it matchs libxl codes
    and also xl.cfg.
    
    Signed-off-by: Chunyan Liu &lt;cyliu@suse.com&gt;</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>