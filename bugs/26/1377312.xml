<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1377312</bug_id>
          
          <creation_ts>2016-09-19 08:25:00 -0400</creation_ts>
          <short_desc>Certificate renewal automation</short_desc>
          <delta_ts>2017-04-02 11:28:15 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>certbot</component>
          <version>26</version>
          <rep_platform>All</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          <dependson>1289778</dependson>
    
    
    <dependson>1385167</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Didier">d-bugzilla</reporter>
          <assigned_to name="James Hogarth">james.hogarth</assigned_to>
          <cc>bradmwarren</cc>
    
    
    <cc>dominik</cc>
    
    
    <cc>goeran</cc>
    
    
    <cc>ilmostro7</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>james.hogarth</cc>
    
    
    <cc>nb</cc>
    
    
    <cc>nick</cc>
    
    
    <cc>olchansk</cc>
    
    
    <cc>rbu</cc>
    
    
    <cc>tadej.j</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-22 14:21:32</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9721107</commentid>
    <comment_count>0</comment_count>
    <who name="Didier">d-bugzilla</who>
    <bug_when>2016-09-19 08:25:37 -0400</bug_when>
    <thetext>Description of problem:

As the LetsEncrypt issued certificates have a life time of 3 months, automated certificate renewal is of paramount importance.
Currently, the certbot package is missing a (cron- or systemd-based) automation mechanism.

The EFF (https://certbot.eff.org/all-instructions/#centos-rhel-7-apache) suggests running the cron/systemd job twice a day.



Version-Release number of selected component (if applicable):

certbot-0.8.1



Additional info:

https://wiki.archlinux.org/index.php/Let%E2%80%99s_Encrypt#Automatic_renewal
https://mjanja.ch/2016/07/using-systemd-timers-to-renew-lets-encrypt-certificates/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9741990</commentid>
    <comment_count>1</comment_count>
    <who name="">ilmostro7</who>
    <bug_when>2016-09-26 05:22:13 -0400</bug_when>
    <thetext>Excellent point! Though, as you linked to RHEL/CentOS instructions, I&apos;d like to point out that the `certbot` package is provided by EPEL.  Therefore, I&apos;m not sure how/where this should be reported.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9742123</commentid>
    <comment_count>2</comment_count>
    <who name="Didier">d-bugzilla</who>
    <bug_when>2016-09-26 06:03:47 -0400</bug_when>
    <thetext>IIRC, the instructions are mostly generic/identical for all distributions, hence it applies to Fedora too ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9742177</commentid>
    <comment_count>3</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2016-09-26 06:24:10 -0400</bug_when>
    <thetext>The report is fine and on our radar.

This will be picked up in a future update</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9793701</commentid>
    <comment_count>4</comment_count>
    <who name="Göran Uddeborg">goeran</who>
    <bug_when>2016-10-14 16:08:58 -0400</bug_when>
    <thetext>May I also bring your attention to that the instructions asks us to randomize the minute the renewal is done, presumably to avoid overloading the servers.  The default anacrontab has a random delay which would do this for a cron.daily job, or it could be a systemd timer unit with AccuracySec and/or RandomizedDelaySec.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10056494</commentid>
    <comment_count>5</comment_count>
    <who name="Dominik &apos;Rathann&apos; Mierzejewski">dominik</who>
    <bug_when>2017-01-12 05:30:26 -0500</bug_when>
    <thetext>Current SELinux policy prevents certificate modifications from cron, so bug 1385167 must be fixed first.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10191292</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 05:20:00 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211300</commentid>
    <comment_count>7</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-03-06 07:56:58 -0500</bug_when>
    <thetext>Hi Dominik,

I&apos;m planning to address this in the near future.

The main blocker is to get the correct certificate type applied to files in /etc/letsencrypt/(live|archive)/ 

I&apos;ve opened this PR against the base policy to get it applied:

https://github.com/fedora-selinux/selinux-policy/pull/194

After the current 0.12.0 update goes out the next will include a systemd timer to handle this.

I&apos;ll update this when the package is built and ready to test.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211440</commentid>
    <comment_count>8</comment_count>
    <who name="Dominik &apos;Rathann&apos; Mierzejewski">dominik</who>
    <bug_when>2017-03-06 08:21:58 -0500</bug_when>
    <thetext>Hi, James.
Excellent news! Thank you for working on this.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211897</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-06 09:56:59 -0500</bug_when>
    <thetext>certbot-0.12.0-3.fc24 python-acme-0.12.0-3.fc24 python-certbot-apache-0.12.0-1.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-0b35be64b3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211907</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-06 09:59:07 -0500</bug_when>
    <thetext>certbot-0.12.0-3.fc25 python-acme-0.12.0-3.fc25 python-certbot-apache-0.12.0-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-e06b5ed81c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211911</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-06 10:00:00 -0500</bug_when>
    <thetext>certbot-0.12.0-3.el7 python-acme-0.12.0-2.el7 python-certbot-apache-0.12.0-1.el7 has been submitted as an update to Fedora EPEL 7. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-7036057408</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211914</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-06 10:00:13 -0500</bug_when>
    <thetext>certbot-0.12.0-3.el7 python-acme-0.12.0-2.el7 python-certbot-apache-0.12.0-1.el7 has been submitted as an update to Fedora EPEL 7. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-7036057408</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211936</commentid>
    <comment_count>13</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-03-06 10:07:24 -0500</bug_when>
    <thetext>Okay so we can shortcut this a little.

The certbot package now has a dependency on semanage to correctly label the certificates, this gets run in %post

When the base policy is updated I&apos;ll remove the %post and requires.

Meanwhile I tested this on my server and systemctl start certbot-renew.service correctly generated my webroot based certificates and a post hook restarting httpd worked.

If you could test the systems unit in your environments as well that would be great.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10214237</commentid>
    <comment_count>14</comment_count>
    <who name="Brad Warren">bradmwarren</who>
    <bug_when>2017-03-06 17:28:17 -0500</bug_when>
    <thetext>Great! I&apos;ve been meaning to ask something like this be added for a while. Taking a look at https://src.fedoraproject.org/cgit/rpms/certbot.git/tree/, I appreciate you randomizing when the timer fires. I&apos;d like to see a few things changed though.

First, you&apos;ll probably want to include `-q/--quiet` on the command line. By default Certbot prints a ton of information about what it&apos;s doing. Adding `-q/--quiet` suppresses this and only prints any errors if they occur.

Second, I think you should significantly increase how often Certbot runs. Certbot by default only attempts to renew your certs 30 days before they expire. If Let&apos;s Encrypt happens to be down when you try to renew, your certs may expire before Certbot is run again. Additionally, my knowledge of systemd unit files is limited, but because monthly is defined as 30.44 days (according to https://www.freedesktop.org/software/systemd/man/systemd.time.html#Parsing%20Time%20Spans) and you randomize it over a week, I believe it&apos;s possible Certbot runs right before your certificate reaches 30 days from expiration and not run again until after it expires.

The recommendation we give everyone is to run `certbot renew` twice a day. This the approach taken in the systemd timers in the Debian. If there is nothing to renew, the command should be a very lightweight operation; it reads the notAfter date of your certs, compares it to the time, and exits). In addition to solving the potential problems above, it should also prevent outages if Let&apos;s Encrypt has to revoke your cert for some reason and it allows us to do things like optionally handle OCSP fetching for the user in the future (see https://github.com/certbot/certbot/issues/956).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10214667</commentid>
    <comment_count>15</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-03-06 19:42:25 -0500</bug_when>
    <thetext>Thanks for taking a look and providing feedback :)

Since the stdout goes to the journal I&apos;m going to err on the side of being verbose in the output by default, at least for now, to help people keep an eye on what&apos;s going on.

The way this unit is set up they can always add --quiet to CERTBOT_ARGS in /etc/sysconfig/certbot if they want to reduce the verbosity... Perhaps I should update the Fedora readme and comments in the config file to that extent.

Happy to reduce the default timer though, I&apos;ll update the build tomorrow with a daily check with an accuracy of a few hours.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10214790</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-06 20:50:19 -0500</bug_when>
    <thetext>certbot-0.12.0-3.fc25, python-acme-0.12.0-3.fc25, python-certbot-apache-0.12.0-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-e06b5ed81c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10215199</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 00:53:28 -0500</bug_when>
    <thetext>certbot-0.12.0-3.el7, python-acme-0.12.0-2.el7, python-certbot-apache-0.12.0-1.el7 has been pushed to the Fedora EPEL 7 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-7036057408</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10215828</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 05:00:46 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc25 python-acme-0.12.0-3.fc25 python-certbot-apache-0.12.0-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-e06b5ed81c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10215834</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 05:01:15 -0500</bug_when>
    <thetext>certbot-0.12.0-4.el7 python-acme-0.12.0-2.el7 python-certbot-apache-0.12.0-1.el7 has been submitted as an update to Fedora EPEL 7. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-7036057408</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10217461</commentid>
    <comment_count>20</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-03-07 11:20:56 -0500</bug_when>
    <thetext>ok that&apos;s built and waiting to go out ... I&apos;m not going to do any further edits yet otherwise 0.12.0 will never make it to stable ;)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10217560</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 11:51:40 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-c51c77f333</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10217751</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 12:53:00 -0500</bug_when>
    <thetext>certbot-0.12.0-3.fc24, python-acme-0.12.0-3.fc24, python-certbot-apache-0.12.0-1.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-0b35be64b3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10217972</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-07 14:11:39 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc24 python-acme-0.12.0-3.fc24 python-certbot-apache-0.12.0-1.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-0b35be64b3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10221559</commentid>
    <comment_count>24</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-08 09:52:51 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc24, python-acme-0.12.0-3.fc24, python-certbot-apache-0.12.0-1.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-0b35be64b3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10221589</commentid>
    <comment_count>25</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-08 09:53:58 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc25, python-acme-0.12.0-3.fc25, python-certbot-apache-0.12.0-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-e06b5ed81c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10222149</commentid>
    <comment_count>26</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-08 11:17:11 -0500</bug_when>
    <thetext>certbot-0.12.0-4.el7, python-acme-0.12.0-2.el7, python-certbot-apache-0.12.0-1.el7 has been pushed to the Fedora EPEL 7 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-7036057408</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10229776</commentid>
    <comment_count>27</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-10 18:20:07 -0500</bug_when>
    <thetext>certbot-0.12.0-4.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-c51c77f333</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10247520</commentid>
    <comment_count>28</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-16 17:17:55 -0400</bug_when>
    <thetext>certbot-0.12.0-4.fc24, python-acme-0.12.0-3.fc24, python-certbot-apache-0.12.0-1.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10247647</commentid>
    <comment_count>29</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-16 18:21:00 -0400</bug_when>
    <thetext>certbot-0.12.0-4.fc25, python-acme-0.12.0-3.fc25, python-certbot-apache-0.12.0-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10272553</commentid>
    <comment_count>30</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-23 16:18:19 -0400</bug_when>
    <thetext>certbot-0.12.0-4.el7, python-acme-0.12.0-2.el7, python-certbot-apache-0.12.0-1.el7 has been pushed to the Fedora EPEL 7 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10273048</commentid>
    <comment_count>31</comment_count>
    <who name="Göran Uddeborg">goeran</who>
    <bug_when>2017-03-23 17:29:34 -0400</bug_when>
    <thetext>It seems you forgot to update the documentation when you shortened the timer interval.  :-)  The README.fedora file still says it runs monthly, with a week of fudge.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10296507</commentid>
    <comment_count>32</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-01 12:50:57 -0400</bug_when>
    <thetext>certbot-0.12.0-4.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10297483</commentid>
    <comment_count>33</comment_count>
    <who name="Konstantin Olchanski">olchansk</who>
    <bug_when>2017-04-02 11:28:15 -0400</bug_when>
    <thetext>(In reply to Fedora Update System from comment #30)
&gt; certbot-0.12.0-4.el7, python-acme-0.12.0-2.el7,
&gt; python-certbot-apache-0.12.0-1.el7 has been pushed to the Fedora EPEL 7
&gt; stable repository. If problems still persist, please make note of it in this
&gt; bug report.

On CentOS7, certbot-renew timer runs, but does not renew the certificates,
looks like it runs the wrong certbot command. The correct command is &quot;certbot renew&quot;,
and what is all this --port-hook and --renew-hook stuff and who is supposed to expand all these $PRE_HOOK
variables.

[root@titan00 ~]# systemctl status certbot-renew -l
● certbot-renew.service - This service automatically renews any certbot certificates found
   Loaded: loaded (/usr/lib/systemd/system/certbot-renew.service; static; vendor preset: disabled)
   Active: failed (Result: exit-code) since Sun 2017-04-02 00:00:01 PDT; 8h ago
  Process: 20545 ExecStart=/usr/bin/certbot renew --pre-hook $PRE_HOOK --post-hook $POST_HOOK --renew-hook $RENEW_HOOK $CERTBOT_ARGS (code=exited, status=2)
 Main PID: 20545 (code=exited, status=2)

Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: usage:
Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: certbot [SUBCOMMAND] [options] [-d DOMAIN] [-d DOMAIN] ...
Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: Certbot can obtain and install HTTPS/TLS/SSL certificates.  By default,
Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: it will attempt to use a webserver both for obtaining and installing the
Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: cert.
Apr 02 00:00:01 titan00.triumf.ca certbot[20545]: certbot: error: argument --pre-hook: expected one argument
[root@titan00 ~]# 
[root@titan00 ~]# rpm -q certbot
certbot-0.12.0-4.el7.noarch
[root@titan00 ~]# 
[root@titan00 ~]# more /etc/redhat-release 
CentOS Linux release 7.3.1611 (Core) 
[root@titan00 ~]# 

K.O.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>