<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1432582</bug_id>
          
          <creation_ts>2017-03-15 13:31:00 -0400</creation_ts>
          <short_desc>authconfig 7.0.0 breaks nsswitch.conf (empty passwd, shadow and group lines)</short_desc>
          <delta_ts>2017-03-16 21:08:16 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>authconfig</component>
          <version>26</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>AcceptedBlocker</status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>urgent</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1349184</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="Tomas Mraz">tmraz</assigned_to>
          <cc>abokovoy</cc>
    
    
    <cc>ipa-maint</cc>
    
    
    <cc>jbwillia</cc>
    
    
    <cc>jcholast</cc>
    
    
    <cc>jhrozek</cc>
    
    
    <cc>jlieskov</cc>
    
    
    <cc>kevin</cc>
    
    
    <cc>lslebodn</cc>
    
    
    <cc>pvoborni</cc>
    
    
    <cc>rcritten</cc>
    
    
    <cc>robatino</cc>
    
    
    <cc>satellitgo</cc>
    
    
    <cc>ssorce</cc>
    
    
    <cc>tkrizek</cc>
    
    
    <cc>tmraz</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>authconfig-7.0.0-2.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-16 21:08:16</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10242802</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 13:31:31 -0400</bug_when>
    <thetext>In Fedora 26 FreeIPA testing we can now get as far as deploying the server and enrolling a client. However, one of the early post-enrolment client tests fails.

One of the first things the client tests after enrolment is to run this:

getent passwd admin@DOMAIN

(where DOMAIN is the correct name of the domain). In testing of current Fedora 26 plus 389-ds-base-1.3.6.2-2.fc26 , this consistently returns nothing (rather than details of the admin user account, as it should).

I don&apos;t have a lot of debugging info yet, will update this report as I manage to get it.

This is probably a violation of Alpha criterion &quot;The core functional requirements for all Featured Server Roles must be met, but it is acceptable if moderate workarounds are necessary to achieve this&quot;, core requirement &quot;Client systems must be able to authenticate users with Kerberos&quot; - https://fedoraproject.org/wiki/Fedora_26_Alpha_Release_Criteria#Role_functional_requirements , https://fedoraproject.org/wiki/Domain_controller_role_requirements .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243307</commentid>
    <comment_count>1</comment_count>
    <who name="Jakub Hrozek">jhrozek</who>
    <bug_when>2017-03-15 15:43:51 -0400</bug_when>
    <thetext>Right, logs are needed (this works for me with sssd built from master which is quite similar to what is in 26)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243325</commentid>
    <comment_count>2</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 15:51:00 -0400</bug_when>
    <thetext>Looks like logging in as a domain user doesn&apos;t work either, per the cockpit enrolment / webui test:

https://openqa.stg.fedoraproject.org/tests/80457

that one tries logging in as a domain user (created via the webui) before it tries the &apos;getent passwd&apos; test, and the login is refused...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243482</commentid>
    <comment_count>3</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 16:24:53 -0400</bug_when>
    <thetext>So I adapted the test to upload /etc/nsswitch.conf , and that looks wrong:

https://openqa.stg.fedoraproject.org/tests/80574/file/freeipa_client-nsswitch.conf

Note these lines:

passwd:    
shadow:    
group:     

it seems like client enrolment somehow didn&apos;t modify nsswitch.conf correctly. I guess I&apos;ll tweak the test again to upload it once *before* enrolment and once *after* and we can diff the result.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243492</commentid>
    <comment_count>4</comment_count>
    <who name="Lukas Slebodnik">lslebodn</who>
    <bug_when>2017-03-15 16:26:09 -0400</bug_when>
    <thetext>It would be also good to see content of /etc/nsswitch, /etc/pam.d/system-auth, /etc/pam.d/password-auth.

+ related part of journald (equivalent to /var/log/secure) for failed authentication</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243498</commentid>
    <comment_count>5</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 16:27:39 -0400</bug_when>
    <thetext>It looks like the &apos;authconfig&apos; command realmd ran was:

/usr/bin/sh -c /usr/sbin/authconfig --update --enablesssd --enablesssdauth --enablemkhomedir --nostart

The authconfig in Fedora 26 currently is authconfig-7.0.0-1.fc26 .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243509</commentid>
    <comment_count>6</comment_count>
    <who name="Lukas Slebodnik">lslebodn</who>
    <bug_when>2017-03-15 16:30:53 -0400</bug_when>
    <thetext>(In reply to Adam Williamson from comment #3)
&gt; So I adapted the test to upload /etc/nsswitch.conf , and that looks wrong:
&gt; 
&gt; https://openqa.stg.fedoraproject.org/tests/80574/file/freeipa_client-
&gt; nsswitch.conf
&gt; 
&gt; Note these lines:
&gt; 
&gt; passwd:    
&gt; shadow:    
&gt; group:     
&gt; 
&gt; it seems like client enrolment somehow didn&apos;t modify nsswitch.conf
&gt; correctly. I guess I&apos;ll tweak the test again to upload it once *before*
&gt; enrolment and once *after* and we can diff the result.

I would expect some issue with authconfig; which is called from ipa-client-install. Because IIRC ipa-client-install does not touch this file directly.

It might be related to glibc change in order
Current default on f26+ is
  passwd:      sss files systemd
  shadow:     files sss
  group:       sss files systemd</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243511</commentid>
    <comment_count>7</comment_count>
    <who name="Lukas Slebodnik">lslebodn</who>
    <bug_when>2017-03-15 16:31:27 -0400</bug_when>
    <thetext>(In reply to Adam Williamson from comment #5)
&gt; It looks like the &apos;authconfig&apos; command realmd ran was:
&gt; 
&gt; /usr/bin/sh -c /usr/sbin/authconfig --update --enablesssd --enablesssdauth
&gt; --enablemkhomedir --nostart
&gt; 
&gt; The authconfig in Fedora 26 currently is authconfig-7.0.0-1.fc26 .

BTW does &quot;authconfig --updateall&quot; help?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243557</commentid>
    <comment_count>8</comment_count>
    <who name="Jakub Hrozek">jhrozek</who>
    <bug_when>2017-03-15 16:48:06 -0400</bug_when>
    <thetext>Well, this is my fault for assuming that if sss is already in nsswitch.conf, then running authconfig --enablesssd wouldn&apos;t touch nsswitch.conf because...sss is already there. But this must be fixed on the authconfig side, the nsswitch.conf file is definitely wrong.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243581</commentid>
    <comment_count>9</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 16:58:51 -0400</bug_when>
    <thetext>So it looks like this is a bug in authconfig 7.0.0. Luckily you don&apos;t actually need to go through a whole FreeIPA deployment to test this: you can easily do it with just a stock Fedora 26 install.

Do a stock F26 install, then do:

cp /etc/nsswitch.conf /etc/nsswitch.conf.bak
authconfig --update --enablesssd --enablesssdauth --enablemkhomedir --nostart

Inspect /etc/nsswitch.conf and note the passwd, shadow and group lines are all blank.

If you restore the original nsswitch.conf, downgrade authconfig to the previous build - authconfig-6.2.10-16.fc26 - and try again, the lines are not blank. So clearly this broke in authconfig 7.0.0.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243659</commentid>
    <comment_count>10</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 17:36:14 -0400</bug_when>
    <thetext>Actually, this behaves rather oddly.

The *first* time you run the authconfig command, it messes up nsswitch.conf . You can then re-run it as many times as you like, and it&apos;ll leave it messed up.

But if you then copy the backup file back into place and run authconfig *again*, it&apos;ll produce a correct-looking nsswitch.conf! I have no idea why that happens.

From that point on, I can&apos;t get it to break again: I have to revert to a snapshot of the clean post-install state to recreate the bug again. But it seems like the first run always breaks the file.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243674</commentid>
    <comment_count>11</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 17:43:58 -0400</bug_when>
    <thetext>It&apos;s still a bug in 7.0.0, though, it seems: 6.2.10 doesn&apos;t do the same. If I downgrade to authconfig 6.2.10 before the first authconfig attempt, the first one works OK. Only 7.0.0 seems to have this weird &quot;first attempt fails&quot; bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243743</commentid>
    <comment_count>12</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 18:09:48 -0400</bug_when>
    <thetext>OK, the bug here is actually pretty obvious: the `writeNSS` function in authinfo.py (in authconfig) initializes a variable called `users` as the empty string, then never updates it from that value, then uses it as the value for the passwd, shadow and group lines. It does a lot of work to populate a *different* variable called `normal`, and I suspect what&apos;s missing is a simple:

users = normal

at some point. I&apos;m going to send a PR for authconfig and do a package build with it included.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243783</commentid>
    <comment_count>13</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 18:25:22 -0400</bug_when>
    <thetext>https://pagure.io/authconfig/pull-request/7 should fix this. I will do a package build with the patch applied and test it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243791</commentid>
    <comment_count>14</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 18:28:24 -0400</bug_when>
    <thetext>Note on the &apos;only happens on first run&apos; thing: that&apos;s just because of the `--update` arg. That tells authconfig to only update things it expects to change compared to the previous authconfig configuration, so if you run the same authconfig command with `--update` multiple times, it won&apos;t change anything. You can pass `--updateall` to force it to rewrite everything.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10243851</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-15 19:02:45 -0400</bug_when>
    <thetext>authconfig-7.0.0-2.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-eab00916f2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244022</commentid>
    <comment_count>16</comment_count>
    <who name="Kevin Fenzi">kevin</who>
    <bug_when>2017-03-15 20:18:25 -0400</bug_when>
    <thetext>+1 blocker here. There&apos;s probibly several critera that could work: 

*  Client systems must be able to authenticate users with Kerberos 

*  A system installed with a release-blocking desktop must boot to a log in screen where it is possible to log in to a working desktop using a user account created during installation or a &apos;first boot&apos; utility. 

etc...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244082</commentid>
    <comment_count>17</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 20:45:49 -0400</bug_when>
    <thetext>I think the most relevant is &quot;It must be possible to join the system to a FreeIPA or Active Directory domain at install time and post-install, and the system must respect the identity, authentication and access control configuration provided by the domain.&quot;

The &quot;Kerberos&quot; thing is part of the FreeIPA server end requirements, and the *server* actually is set up such as to allow this, the error is on the *client* end.

A &apos;normal&apos; install doesn&apos;t hit this, because while authconfig is run during install, unless you join the system to a domain via kickstart or in some other way cause non-&apos;standard&apos; authconfig args to be set, the authconfig run decides not to edit nsswitch.conf.

So the most clear case here is the criterion cited, I think. The system clearly does not &quot;respect the identity, authentication and access control configuration provided by the domain&quot; when nsswitch.conf is messed up like this.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244087</commentid>
    <comment_count>18</comment_count>
    <who name="Dennis Gilmore">dennis</who>
    <bug_when>2017-03-15 20:48:14 -0400</bug_when>
    <thetext>+1 to blocker here as well</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244094</commentid>
    <comment_count>19</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-15 20:49:24 -0400</bug_when>
    <thetext>That&apos;s +3 (me, Kevin, Dennis), setting accepted.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244129</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-15 20:51:40 -0400</bug_when>
    <thetext>authconfig-7.0.0-2.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-eab00916f2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10244136</commentid>
    <comment_count>21</comment_count>
    <who name="Ben Williams">jbwillia</who>
    <bug_when>2017-03-15 20:58:20 -0400</bug_when>
    <thetext>+1 blocker</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10248038</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-16 21:08:16 -0400</bug_when>
    <thetext>authconfig-7.0.0-2.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>