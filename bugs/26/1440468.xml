<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1440468</bug_id>
          
          <creation_ts>2017-04-09 03:36:00 -0400</creation_ts>
          <short_desc>OpenVPN 2.4 in F26 lacks --pkcs12 support when built against mbed TLS</short_desc>
          <delta_ts>2017-05-14 16:21:13 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>openvpn</component>
          <version>26</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          <dependson>1444994</dependson>
    
    
    <dependson>1445349</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Alexandre Roumiantsev">ran</reporter>
          <assigned_to name="David Sommerseth">dazo</assigned_to>
          <cc>dazo</cc>
    
    
    <cc>dwmw2</cc>
    
    
    <cc>huzaifas</cc>
    
    
    <cc>mauricio.teixeira</cc>
    
    
    <cc>rdieter</cc>
    
    
    <cc>steve</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>openvpn-2.4.2-1.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-05-14 16:21:13</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10317019</commentid>
    <comment_count>0</comment_count>
    <who name="Alexandre Roumiantsev">ran</who>
    <bug_when>2017-04-09 03:36:10 -0400</bug_when>
    <thetext>Description of problem: My VPN connection won&apos;t work after upgrading to F26:
Here is error message:
Apr  9 10:28:53 notebook nm-openvpn[2946]: Options error: Unrecognized option or missing or extra parameter(s) in [CMD-LINE]:1: pkcs12 (2.4.1)

Version-Release number of selected component (if applicable):
NetworkManager-openvpn.x86_64          1:1.2.8-2.fc26              @@commandline
NetworkManager-openvpn-gnome.x86_64    1:1.2.8-2.fc26              @@commandline
openvpn.x86_64                         2.4.1-3.fc26                @fedora      

How reproducible:


Steps to Reproduce:
1.
2.
3.

Actual results:


Expected results:


Additional info: My VPN connection work successfully with F25 ( and early versions ) long time.  I get the error message above after upgrading to F26. Same error if I reset my VPN connection ( delete old one and install new under F26 ). 
My attempt to add pkcs12 line in config file allow go throw syntax check, but connection could not be esteblished - server part does not know such option.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321408</commentid>
    <comment_count>1</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-10 13:32:49 -0400</bug_when>
    <thetext>

*** This bug has been marked as a duplicate of bug 1432152 ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321426</commentid>
    <comment_count>2</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-10 13:39:57 -0400</bug_when>
    <thetext>Sorry!  This is a different issue (PKCS#12) than bug #1432152 (PKCS#11).

But my gut feeling is that it is related to the move from using OpenSSL to mbed TLS.  It might be the Fedora mbed TLS builds is also lacking PKCS#12 support.

Workaround - extract certs and keys from the pkcs#12 file.

$Â openssl pkcs12 -in $PKCS12FILE -nokeys -cacerts &gt; openvpn-ca.crt
$ openssl pkcs12 -in $PKCS12FILE -nokeys -clcerts &gt; openvpn-cert.crt
$ openssl pkcs12 -in $PKCS12FILE -nocerts -nodes &gt; openvpn-private.key

If you skip &apos;-nodes&apos; in the last line private key file will be password encrypted.

I will look into the mbed TLS packaging and see what is needed to change to resolve this issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321450</commentid>
    <comment_count>3</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-10 13:46:05 -0400</bug_when>
    <thetext>Btw ... can you also please provide a configuration file?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321477</commentid>
    <comment_count>4</comment_count>
      <attachid>1270548</attachid>
    <who name="Alexandre Roumiantsev">ran</who>
    <bug_when>2017-04-10 14:00:23 -0400</bug_when>
    <thetext>Created attachment 1270548
openvpn configuration file</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321484</commentid>
    <comment_count>5</comment_count>
      <attachid>1270549</attachid>
    <who name="Alexandre Roumiantsev">ran</who>
    <bug_when>2017-04-10 14:02:17 -0400</bug_when>
    <thetext>Created attachment 1270549
configuration file for Network Manager</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321492</commentid>
    <comment_count>6</comment_count>
    <who name="Alexandre Roumiantsev">ran</who>
    <bug_when>2017-04-10 14:05:23 -0400</bug_when>
    <thetext>Hello, David.
Thank you for attention to my request. Find in attachment openvpn configuration file and the file, which was used by Network Manager to create this connection (openvpn configuration file)
Best regards, Alexandre.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321844</commentid>
    <comment_count>7</comment_count>
    <who name="David Woodhouse">dwmw2</who>
    <bug_when>2017-04-10 16:13:39 -0400</bug_when>
    <thetext>See the openconnect test suite for a set of certificate files you should probably be testing with...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10321996</commentid>
    <comment_count>8</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-10 17:45:45 -0400</bug_when>
    <thetext>I&apos;m quite surprised.  When starting to test your configuration, it seems to &quot;work&quot; (pass and start connecting to a server of mine) when compiled with OpenSSL. When doing the same test with mbed TLS, it is a very different story.

The quick answer is: The current state is that the mbed TLS implementation in OpenVPN does _not_ support --pkcs12.  This is something I was not aware of.  When looking at the mbed TLS API, it seems to be quite a bit more work to implement the missing pieces for PKCS#12 support.

Tomorrow I will get in touch with some guys knowing the mbed TLS implementation far better.  Perhaps we can put down a plan to resolve this.  But I can not make any promises now.

The short version of why we&apos;ve switched to mbed TLS in F26 is that F26 want to ship with openssl-1.1.  OpenVPN is not prepared for that yet (Only ~50% if the contributed patches to make this work is reviewed and applied to the upstream OpenVPN tree)  So in the mean time it was decided to ship an OpenVPN built against mbed TLS instead - knowing it was not 100% feature compatible with the OpenSSL builds.  But it would be better with a reduced OpenVPN than no OpenVPN.  

Once OpenVPN can build against OpenSSL 1.1, I will switch back.  But right now, that isn&apos;t an option.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10338738</commentid>
    <comment_count>9</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-17 13:01:36 -0400</bug_when>
    <thetext>I have checked this more carefully now.  The mbed TLS library completely lacks support for PKCS#12 files.  Which makes it impossible to make use of those files as it is today.  There are some partial PKCS#12 support, but that only covers password encryption used in PKCS#8 private keys and not the PKCS#12 file container.  So I am sorry to say that the mbed TLS library and PKCS#12 files is currently a dead-end.

On the other hand, I have recently discovered the compat-openssl10.  But that breaks PKCS#11 support, as there are package conflicts between openssl-devel and compat-openssl10-devel when installing the needed pkcs11-helper-devel package.

So currently, I have the options of:  a)  Keep mbed TLS builds and break PKCS#12, or b) Switch to compat-openssl10 and break PKCS#11 smart card support.

To be honest ... I have no idea which path is the least painful for most of the users.  Had I known that, I&apos;d do a decision right now.

I have reached out to Tomas Mraz (openssl/compat-openssl10 maintainer) and Kalev Lember (pkcs11-helper maintainer) to see if we can find a way to avoid the pkcs11-helper situation.  If that is doable, I will soon switch back to OpenSSL again.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10349219</commentid>
    <comment_count>10</comment_count>
    <who name="David Sommerseth">dazo</who>
    <bug_when>2017-04-20 07:15:34 -0400</bug_when>
    <thetext>Using compat-openssl10 is not possible for OpenVPN, as it depends on pkcs11-helper also being built against compat-openssl10.

I have asked for confirmation if the mbed TLS builds with PKCS#11 support is working.  If it is, I will prefer PKCS#11 support over PKCS#12.  The reason for that is that PKCS#11 have a workaround (you can split that file up into CA, Certificate and Private Key files using the &quot;openssl pkcs12&quot; command).

If however PKCS#11 support is _not_ functional with mbed TLS, I will switch to build OpenVPN against compat-openssl10 without PKCS#11 support.  Which re-enables PKCS#12 support.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10405686</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-11 16:24:05 -0400</bug_when>
    <thetext>openvpn-2.4.2-1.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-89d98779ec</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10409427</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-12 21:12:30 -0400</bug_when>
    <thetext>openvpn-2.4.2-1.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-89d98779ec</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10410091</commentid>
    <comment_count>13</comment_count>
    <who name="Alexandre Roumiantsev">ran</who>
    <bug_when>2017-05-14 01:31:52 -0400</bug_when>
    <thetext>Work well for me now</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10410668</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-14 16:21:13 -0400</bug_when>
    <thetext>openvpn-2.4.2-1.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>1270548</attachid>
            <date>2017-04-10 14:00:00 -0400</date>
            <delta_ts>2017-04-10 14:00:23 -0400</delta_ts>
            <desc>openvpn configuration file</desc>
            <filename>ran-TO-IPCop-38468749-8dee-4355-b4a8-c54ef06e9585</filename>
            <type>text/plain</type>
            <size>456</size>
            <attacher name="Alexandre Roumiantsev">ran</attacher>
            
              <data encoding="base64">W2Nvbm5lY3Rpb25dCmlkPXJhbi1UTy1JUENvcAp1dWlkPTM4NDY4NzQ5LThkZWUtNDM1NS1iNGE4
LWM1NGVmMDZlOTU4NQp0eXBlPXZwbgpwZXJtaXNzaW9ucz0KClt2cG5dCmNhPS9ldGMvb3BlbnZw
bi9yYW4ucDEyCmNlcnQ9L2V0Yy9vcGVudnBuL3Jhbi5wMTIKY2VydC1wYXNzLWZsYWdzPTEKY2lw
aGVyPUJGLUNCQwpjb25uZWN0aW9uLXR5cGU9dGxzCmRldj10dW4Ka2V5PS9ldGMvb3BlbnZwbi9y
YW4ucDEyCm5zLWNlcnQtdHlwZT1zZXJ2ZXIKcHJvdG8tdGNwPXllcwpyZW1vdGU9NjIuMTgxLjQx
LjE0MjoxMTk0CnR1bm5lbC1tdHU9MTQwMApzZXJ2aWNlLXR5cGU9b3JnLmZyZWVkZXNrdG9wLk5l
dHdvcmtNYW5hZ2VyLm9wZW52cG4KCltpcHY0XQpkbnMtc2VhcmNoPQptZXRob2Q9YXV0bwoKW2lw
djZdCmFkZHItZ2VuLW1vZGU9c3RhYmxlLXByaXZhY3kKZG5zLXNlYXJjaD0KbWV0aG9kPWF1dG8K
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>1270549</attachid>
            <date>2017-04-10 14:02:00 -0400</date>
            <delta_ts>2017-04-10 14:02:17 -0400</delta_ts>
            <desc>configuration file for Network Manager</desc>
            <filename>ran-TO-IPCop.ovpn</filename>
            <type>text/plain</type>
            <size>208</size>
            <attacher name="Alexandre Roumiantsev">ran</attacher>
            
              <data encoding="base64">I09wZW5WUE4gU2VydmVyIGNvbmYNCnRscy1jbGllbnQNCmNsaWVudA0KZGV2IHR1bg0KcHJvdG8g
dGNwDQp0dW4tbXR1IDE0MDANCnJlbW90ZSA2Mi4xODEuNDEuMTQyIDExOTQNCnBrY3MxMiByYW4u
cDEyDQpjaXBoZXIgQkYtQ0JDDQp2ZXJiIDMNCm5zLWNlcnQtdHlwZSBzZXJ2ZXINCnJvdXRlIDE5
Mi4xNjguMS4wIDI1NS4yNTUuMjU0LjAgdnBuX2dhdGV3YXkNCg==
</data>

          </attachment>
      

    </bug>

</bugzilla>