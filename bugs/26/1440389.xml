<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1440389</bug_id>
          
          <creation_ts>2017-04-08 08:48:00 -0400</creation_ts>
          <short_desc>Can not create services with secrets in swarm mode</short_desc>
          <delta_ts>2017-06-16 03:40:47 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Spyros Trigazis">strigazi</reporter>
          <assigned_to name="Antonio Murdaca">amurdaca</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dustymabe</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>strigazi</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.13.1-7.git14cc629.fc26 docker-1.13.1-13.git51eb16e.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-09 15:14:02</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10316287</commentid>
    <comment_count>0</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-08 08:48:41 -0400</bug_when>
    <thetext>Description of problem:
In a swarm mode cluster using docker 1.13 in fedora atomic 26,
it&apos;s impossible to create a service with a secret mounted in
its containers. The service is created but the containers are
crashing. 

Version-Release number of selected component (if applicable):
docker-1.13.1-5.git5be1549.fc26.x86_64

How reproducible: 100%


Steps to Reproduce:
1. Boot a F26AH with [1]
2. Login to the host and switch to the root user
3.
# docker swarm init
Swarm initialized: current node (yxoss27y1h5d87mrtgfij4q3d) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-0sg2bj4onjvyaygcmcsftvx5z48f2r0oq6abg4izaflch9d8r8-dva3kq1zw7vrzjg8sav3e5mcs \
    xxx.xxx.xxx.xxx:2377

To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.
4.
# docker service ls
ID  NAME  MODE  REPLICAS  IMAGE
5.
#  echo &quot;This is a secret&quot; | docker secret create my_secret_data -
2ab8kotd9e9q9wcpe387tryez
6.
# docker service create --name=&quot;httpd&quot; --secret=&quot;my_secret_data&quot; docker.io/httpd
ri4wtno7wu93yfczzb93l6s8s


Actual results:
# docker service ps httpd --no-trunc
ID                         NAME         IMAGE                                                                                           NODE                                 DESIRED STATE  CURRENT STATE         ERROR                                                                                                                                                                                                    PORTS
p6jrn0kybq8vjx69avb3xdcxc  httpd.1      docker.io/httpd:latest@sha256:fc9b21c3faf2e1aa4cbe91d60df40a0d30ff151d8a5f5228d77fe5e0a18fa3c2  strigazi-fa26-swarm-mode-04.cern.ch  Ready          Ready 2 seconds ago                                                                                                                                                                                                            
yx2mquqmna77u8uxo7exgxc6m   \_ httpd.1  docker.io/httpd:latest@sha256:fc9b21c3faf2e1aa4cbe91d60df40a0d30ff151d8a5f5228d77fe5e0a18fa3c2  strigazi-fa26-swarm-mode-04.cern.ch  Shutdown       Failed 2 seconds ago  &quot;starting container failed: RemoveSecretsPath failed: remove /var/lib/docker/containers/115332b56220016b062dcdd69f128775736f86605219d3081af848d5b4ca6a15/secrets/my_secret_data: read-only file system&quot;  

Expected results:
The service running, something like:
# docker service ps redis

ID            NAME     IMAGE         NODE              DESIRED STATE  CURRENT STATE          ERROR  PORTS
bkna6bpn8r1a  redis.1  redis:alpine  ip-172-31-46-109  Running        Running 8 seconds ago  

Additional info:
Follow [2] using a F26AH like [1].

[1] https://s3.amazonaws.com/fedora-atomic-s3/Fedora-26-20170331.n.0/Fedora-Atomic-26-20170331.n.0.x86_64.qcow2
[2] https://docs.docker.com/engine/swarm/secrets/#simple-example-get-started-with-secrets</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10323628</commentid>
    <comment_count>4</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-11 06:54:58 -0400</bug_when>
    <thetext>rewrote the secret patch to allow this workflow (patch set is at https://github.com/runcom/docker/tree/secrets-rewrite)

Not sure how we&apos;re going with this. The commits I did aren&apos;t in the main &quot;docker-1.13.1 tree&quot; as I think we need full docker testing (autotest also) to run with my branches before merging my patches.

By any change, can you build docker from https://github.com/runcom/docker/tree/secrets-rewrite and test this out? it&apos;s working to my testing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10323650</commentid>
    <comment_count>5</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-11 07:01:52 -0400</bug_when>
    <thetext>PR opened https://github.com/projectatomic/docker/pull/235</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10325295</commentid>
    <comment_count>6</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-11 11:07:04 -0400</bug_when>
    <thetext>I used this [1] image, upgraded to 26 and installed these packages:
docker-1.13.1-9.gitdcc0a71.fc27.x86_64.rpm
docker-common-1.13.1-9.gitdcc0a71.fc27.x86_64.rpm
docker-rhel-push-plugin-1.13.1-9.gitdcc0a71.fc27.x86_64.rpm


Now the container is running:
# docker service ps redis
ID            NAME     IMAGE                   NODE                                               DESIRED STATE  CURRENT STATE          ERROR  PORTS
whvth13frrhv  redis.1  docker.io/redis:alpine  strigazi-fedora-cloud-base-25-20170411-01.cern.ch  Running        Running 2 minutes ago         


BUT I can&apos;t access the secret:
# echo &quot;This is a secret&quot; | docker secret create my_secret_data -
jq9szkiqdg1kh3rip836mry36
# docker service  create --name=&quot;redis&quot; --secret=&quot;my_secret_data&quot; docker.io/redis:alpine
vfhequwmelqg1ljzueh109jcx
# docker exec $(docker ps --filter name=redis -q) ls -l /run/secrets
total 0
ls: can&apos;t open &apos;/run/secrets&apos;: Permission denied

[1] https://kojipkgs.fedoraproject.org/compose/Fedora-Cloud-25-20170411.0/compose/CloudImages/x86_64/images/Fedora-Cloud-Base-25-20170411.0.x86_64.qcow2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10325354</commentid>
    <comment_count>7</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-11 11:14:10 -0400</bug_when>
    <thetext>That&apos;s caused by SELinux, I&apos;m trying to fix the patch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10325408</commentid>
    <comment_count>8</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-11 11:31:48 -0400</bug_when>
    <thetext>Confirmed, with selinux in permissive, it works.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10325449</commentid>
    <comment_count>9</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-11 11:41:19 -0400</bug_when>
    <thetext>alright, fixed the selinux issue in the latest iteration of https://github.com/runcom/docker/commits/secrets-rewrite

I&apos;ll have a scratch build for you to test!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10326232</commentid>
    <comment_count>10</comment_count>
    <who name="Lokesh Mandvekar">lsm5</who>
    <bug_when>2017-04-11 16:08:22 -0400</bug_when>
    <thetext>Scratch build at https://koji.fedoraproject.org/koji/taskinfo?taskID=18935284</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10327425</commentid>
    <comment_count>11</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-12 03:51:51 -0400</bug_when>
    <thetext>working, thanks</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10327453</commentid>
    <comment_count>12</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-12 03:59:57 -0400</bug_when>
    <thetext>Are we getting this fix in F26 ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10328146</commentid>
    <comment_count>13</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-12 06:18:34 -0400</bug_when>
    <thetext>(In reply to Spyros Trigazis from comment #12)
&gt; Are we getting this fix in F26 ?

yeah, possibly.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10330271</commentid>
    <comment_count>14</comment_count>
    <who name="Lokesh Mandvekar">lsm5</who>
    <bug_when>2017-04-12 13:17:26 -0400</bug_when>
    <thetext>updated scratch builds:

rawhide: https://koji.fedoraproject.org/koji/taskinfo?taskID=18952865
f26: https://koji.fedoraproject.org/koji/taskinfo?taskID=18952872</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10332725</commentid>
    <comment_count>15</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-13 07:35:34 -0400</bug_when>
    <thetext>Any chance you can re-test with new rpms?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10333251</commentid>
    <comment_count>16</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2017-04-13 10:06:49 -0400</bug_when>
    <thetext>you can pull down this qcow which has the new docker installed. 
http://artifacts.ci.centos.org/sig-atomic/expires-7-days/20170413-scratch-docker/0bef1375-6bb2-47f6-807b-cfba18eacbaa.body.qcow2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10334210</commentid>
    <comment_count>17</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-04-13 14:49:29 -0400</bug_when>
    <thetext>Antonio, so this was just swarm created the directory with a bad label?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10335877</commentid>
    <comment_count>18</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-14 10:20:30 -0400</bug_when>
    <thetext>(In reply to Antonio Murdaca from comment #15)
&gt; Any chance you can re-test with new rpms?

Tested both builds They work fine, thanks!

docker swarm init
echo &quot;This is a secret&quot; | docker secret create my_secret_data -
docker service  create --name=&quot;httpd&quot; --secret=&quot;my_secret_data&quot; docker.io/httpd
# wait for service to start
docker exec $(docker ps --filter name=httpd -q) cat /run/secrets/my_secret_data

(In reply to Dusty Mabe from comment #16)
&gt; you can pull down this qcow which has the new docker installed. 
&gt; http://artifacts.ci.centos.org/sig-atomic/expires-7-days/20170413-scratch-
&gt; docker/0bef1375-6bb2-47f6-807b-cfba18eacbaa.body.qcow2

Downloading. It is really slow.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10335937</commentid>
    <comment_count>19</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-04-14 11:20:54 -0400</bug_when>
    <thetext>(In reply to Dusty Mabe from comment #16)
&gt; you can pull down this qcow which has the new docker installed. 
&gt; http://artifacts.ci.centos.org/sig-atomic/expires-7-days/20170413-scratch-
&gt; docker/0bef1375-6bb2-47f6-807b-cfba18eacbaa.body.qcow2

Works great! Thanks! SELinux enforcing :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10338421</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-17 10:44:24 -0400</bug_when>
    <thetext>docker-1.13.1-7.git14cc629.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-e66179a210</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10339497</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-17 19:50:55 -0400</bug_when>
    <thetext>docker-1.13.1-7.git14cc629.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-e66179a210</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10353660</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-21 10:28:05 -0400</bug_when>
    <thetext>docker-1.13.1-7.git14cc629.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10353690</commentid>
    <comment_count>23</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-04-21 10:31:24 -0400</bug_when>
    <thetext>PR still pending! https://github.com/projectatomic/docker/pull/235</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10451592</commentid>
    <comment_count>24</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2017-05-26 10:30:41 -0400</bug_when>
    <thetext>did this make it into a build? can we attach it to a proper bodhi update?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10454078</commentid>
    <comment_count>25</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-28 11:44:32 -0400</bug_when>
    <thetext>docker-1.13.1-13.git51eb16e.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-8a6d53a5d6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10454080</commentid>
    <comment_count>26</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-28 11:47:22 -0400</bug_when>
    <thetext>docker-latest-1.13-30.git51eb16e.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-e8d134ef02</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10454270</commentid>
    <comment_count>27</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-28 17:37:36 -0400</bug_when>
    <thetext>docker-1.13.1-13.git51eb16e.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-8a6d53a5d6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10454271</commentid>
    <comment_count>28</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-28 17:37:43 -0400</bug_when>
    <thetext>docker-latest-1.13-30.git51eb16e.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-e8d134ef02</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10494247</commentid>
    <comment_count>29</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-09 15:14:02 -0400</bug_when>
    <thetext>docker-1.13.1-13.git51eb16e.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10494248</commentid>
    <comment_count>30</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-09 15:14:10 -0400</bug_when>
    <thetext>docker-latest-1.13-30.git51eb16e.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10498845</commentid>
    <comment_count>31</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2017-06-12 14:22:36 -0400</bug_when>
    <thetext>hey strigazi can you test this in latest F26AH and make sure it is fixed for you? 

https://kojipkgs.fedoraproject.org/compose/branched/Fedora-26-20170611.n.1/compose/CloudImages/x86_64/images/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10512031</commentid>
    <comment_count>32</comment_count>
    <who name="Spyros Trigazis">strigazi</who>
    <bug_when>2017-06-16 03:40:47 -0400</bug_when>
    <thetext>Tested, works fine!

Thanks!</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>