<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1445212</bug_id>
          
          <creation_ts>2017-04-25 05:20:00 -0400</creation_ts>
          <short_desc>trust anchor --remove stopped working</short_desc>
          <delta_ts>2017-06-16 13:49:17 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>p11-kit</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1451307</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Christophe Fergeau">cfergeau</reporter>
          <assigned_to name="Daiki Ueno">dueno</assigned_to>
          <cc>dueno</cc>
    
    
    <cc>kengert</cc>
    
    
    <cc>mpreisle</cc>
    
    
    <cc>stefw</cc>
    
    
    <cc>tmraz</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>p11-kit-0.23.5-3.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-09 15:01:35</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10359446</commentid>
    <comment_count>0</comment_count>
    <who name="Christophe Fergeau">cfergeau</who>
    <bug_when>2017-04-25 05:20:18 -0400</bug_when>
    <thetext>I&apos;m using trust anchor foo.crt/trust anchor --remove foo.crt as root to temporarily add the CA my company uses to my system-wide trust store. However, this stopped working with p11-kit-0.23.2-3.fc25 / p11-kit-0.23.5-1.fc26 , trust anchor succeeds, but then trust anchor --remove tells me it cannot remove from a read-only store (forgot the exact wording but started with &quot;couldn&apos;t remove read-only XXX&quot;).
I downgraded to p11-kit-0.23.2-2.fc24 and trust anchor --remove worked fine with it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10364747</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2017-04-26 09:56:52 -0400</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10378942</commentid>
    <comment_count>2</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-02 09:02:26 -0400</bug_when>
    <thetext>Thank you for the report.  This was caused by this commit:
https://github.com/p11-glue/p11-kit/commit/8eed1e60b0921d05872e2f43eee9088cef038d7e

The original issue addressed by the commit was that, after the input format change of ca-certificate[1], all the built-in certificates had CKA_MODIFIABLE(true).  The commit restricted the behavior by checking &quot;modifiable&quot; flag set in the file, but it was apparently too generic and caused unwanted effect.

Given that all the built-in certificates have CKA_NSS_MOZILLA_CA_POLICY attribute, I guess a more conservative fix would be to check &quot;nss-mozilla-ca-policy&quot;:
https://github.com/p11-glue/p11-kit/pull/66</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10381625</commentid>
    <comment_count>3</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-03 05:58:25 -0400</bug_when>
    <thetext>Kai, since you reported the original issue, could you double check if this follow-up change is okay?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10386462</commentid>
    <comment_count>4</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-04 10:50:52 -0400</bug_when>
    <thetext>I&apos;ll work on it soon</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10403551</commentid>
    <comment_count>5</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-11 06:47:27 -0400</bug_when>
    <thetext>It seems that with your patch, you want to allow to remove an anchor that has attribute &quot;modifiable: false&quot;. Is my understanding correct?

Was attribute &quot;modifable: false&quot; set when the anchor was added using the &quot;trust anchor&quot; command?

If yes, isn&apos;t that the real bug?

If &quot;trust anchor&quot; installs a file, which is allowed to be removed later, I think &quot;trust anchor&quot; should set &quot;modifable: true&quot;?

(I don&apos;t know the full internals of p11-kit-trust, so I cannot say if this makes sense. I don&apos;t know for which purposes p11-kit-trust uses the modifiable attribute.)


Regarding the original bug I had reported:

When I started to use the MOZILLA_POLICY_CA flag, I had switched from the BEGIN TRUSTED CERTIFICATE file format to the p11-kit file format. I had used the &quot;trust dump&quot; command to compare the state with the old and new file formats. I saw that the old file format produced &quot;modifiable: false&quot;, and that the dump with the new format always produced &quot;modifiable: true&quot;, even if the new p11-kit input format specified &quot;modifiable: false&quot;.

I didn&apos;t have a specific requirement for &quot;modifiable: false&quot;. I had simply intended to be as identical as possible to the old state when using the new file format, for completeness.


After this new information, do you still want to use the same patch, or do you want to check if the behavior of trust anchor should be changed, to set &quot;modifiable: true&quot;?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10403585</commentid>
    <comment_count>6</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-11 07:01:12 -0400</bug_when>
    <thetext>(In reply to Kai Engert (:kaie) from comment #5)

&gt; If &quot;trust anchor&quot; installs a file, which is allowed to be removed later, I
&gt; think &quot;trust anchor&quot; should set &quot;modifable: true&quot;?

That would be ideal, but in reality it would be a backward incompatible change, because the &quot;trust anchor&quot; command has never done that and &quot;trust anchor --remove&quot; would only be able to remove anchors installed by the newer &quot;trust anchor&quot; command.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10403772</commentid>
    <comment_count>7</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-11 08:00:00 -0400</bug_when>
    <thetext>I see, that&apos;s unfortunate.

I just made a test, without your patch, but I changed the p11-kit file installed by ca-certificate into the /usr/share/pki/ca-trust-source directory to say &quot;modifiable: true&quot; for a CA, I copied the certificate data to a PEM file, and executed &quot;trust anchor --remove&quot; on that file.

This had the effect that the file in /usr/share/pki/ca-trust-source was modified and the CA was removed. This surprised me. I wasn&apos;t aware that the &quot;trust&quot; command can be used to have that effect.

(This would also happen with your patch, for CAs that don&apos;t have the policy CA flag.)

I think we shouldn&apos;t assume that all files installed by the ca-certificates.rpm will contain the policy-ca attribute. Distrusted certificates might not have it. Mozilla has also occassionally added neutral certificates to the trust bundle, to help with trust chain detection, without giving them any positive trust flags. Those don&apos;t qualify to have the mozilla_ca_policy attribute.

Some deployments could have their own RPM package, that installs a set of local CAs into the /usr/share/pki/ca-trust-source directory. Such files will not contain the MOZILLA_POLICY_CA attribute.

If an administrator runs a command to distrust a CA that is stored in /usr, that change will be silently overwritten the next time a CA RPM is updated.

I think it isn&apos;t ideal to use that flag to conclude &quot;cannot be modified&quot;, because it might not cover everything that is installed in /usr.

I think the trust command shouldn&apos;t modify any files in /usr/ because /usr shouldn&apos;t contain local configuration. (And it may be even read only on some systems, if /usr lives on read-only storage.)

When adding new files, it seems the trust command always adds these files to the /etc/pki/ca-trust/source directory.

I conclude this means, that the trust command is already able to distinguish between the /etc and /usr directories, and knows that the /etc directory is the place to add local configuration.


My suggestion is, the trust command should:

- never modify anything that is installed below /usr

- allow to modify anything that is installed in /etc

regardless of attributes.


You could argue, it would be again a backwards incompatible change, if we change trust to never modify /usr. But in my opinion it was a bug that it ever allowed to do that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10411923</commentid>
    <comment_count>8</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-15 05:15:49 -0400</bug_when>
    <thetext>Thank you for the suggestion.  That sounds like a better approach indeed.  I have updated the pull-request along those lines.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424758</commentid>
    <comment_count>9</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-18 06:51:44 -0400</bug_when>
    <thetext>I came up with a new idea:

From the start, the trust module adds a line to the generated .p11-kit files:

  # This file has been auto-generated and written by p11-kit.

We can use this as a magic comment to determine whether the objects read from a .p11-kit file are read only.  This approach shouldn&apos;t break backward compatibility and still allow the certificates installed by the ca-certificates package to be read-only.

I have filed a new PR:
https://github.com/p11-glue/p11-kit/pull/70</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424816</commentid>
    <comment_count>10</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-18 07:13:33 -0400</bug_when>
    <thetext>If a file contains the line
    # This file has been auto-generated and written by p11-kit.

do you suggest this file is &quot;read-only&quot; or is it &quot;read-write&quot; ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424833</commentid>
    <comment_count>11</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-18 07:19:22 -0400</bug_when>
    <thetext>(In reply to Kai Engert (:kaie) from comment #10)
&gt; If a file contains the line
&gt;     # This file has been auto-generated and written by p11-kit.
&gt; 
&gt; do you suggest this file is &quot;read-only&quot; or is it &quot;read-write&quot; ?

I mean &quot;read-write&quot;, so no change to the current ca-certificate package is necessary.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424860</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-18 07:27:11 -0400</bug_when>
    <thetext>p11-kit-0.23.5-2.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-6d3abc84f6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424861</commentid>
    <comment_count>13</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-18 07:27:53 -0400</bug_when>
    <thetext>As a consequence, does that mean, files without that line are read-only?

If files without that line are read-only, how can the &quot;trust&quot; command remove the files that were installed with past versions?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424887</commentid>
    <comment_count>14</comment_count>
    <who name="Daiki Ueno">dueno</who>
    <bug_when>2017-05-18 07:38:18 -0400</bug_when>
    <thetext>(In reply to Kai Engert (:kaie) from comment #13)
&gt; As a consequence, does that mean, files without that line are read-only?

Yes.

&gt; If files without that line are read-only, how can the &quot;trust&quot; command remove
&gt; the files that were installed with past versions?

All files written by the trust command should have that line even for the past versions, because the change which added the write capability to the &quot;trust&quot; command also had a logic to produce this comment:

https://github.com/p11-glue/p11-kit/commit/a2165fe35e336fd807af053a21a396b020f90a23</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10424897</commentid>
    <comment_count>15</comment_count>
    <who name="Kai Engert (:kaie)">kengert</who>
    <bug_when>2017-05-18 07:41:40 -0400</bug_when>
    <thetext>(In reply to Daiki Ueno from comment #14)
&gt; All files written by the trust command should have that line even for the
&gt; past versions, because the change which added the write capability to the
&gt; &quot;trust&quot; command also had a logic to produce this comment:

Ok, this wasn&apos;t clear to me previously, thanks for the clarification!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10426827</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-18 15:04:51 -0400</bug_when>
    <thetext>p11-kit-0.23.5-3.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-6d3abc84f6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10440876</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-23 12:28:58 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-11fb7450f4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10440878</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-23 12:29:08 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-c54e3353b6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10442476</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-24 03:06:36 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-c54e3353b6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10442510</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-24 03:11:12 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-11fb7450f4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10452951</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-26 23:01:28 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10494058</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-09 15:01:35 -0400</bug_when>
    <thetext>p11-kit-0.23.5-3.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10513925</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-16 13:49:17 -0400</bug_when>
    <thetext>p11-kit-0.23.2-4.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>