<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1427359</bug_id>
          
          <creation_ts>2017-02-27 20:26:00 -0500</creation_ts>
          <short_desc>iSCSI Target discovery during Fedora Rawhide install fails with &quot;Cannot perform discovery. Initiatorname required.&quot;</short_desc>
          <delta_ts>2017-03-03 18:39:19 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>iscsi-initiator-utils</component>
          <version>26</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>RAWHIDE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1349188</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="Chris Leech">cleech</assigned_to>
          <cc>agrover</cc>
    
    
    <cc>cleech</cc>
    
    
    <cc>robatino</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>iscsi-initiator-utils-6.2.0.874-3.git86e8892.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-02-28 13:39:07</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10189298</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-27 20:26:48 -0500</bug_when>
    <thetext>Between Fedora-Rawhide-20170208.n.0, when this test run happened:

https://openqa.fedoraproject.org/tests/56780

and Fedora-Rawhide-20170214.n.0, when this one happened:

https://openqa.fedoraproject.org/tests/56875

something seems to have changed in iSCSI target discovery. The 20170208.n.0 test successfully completed iSCSI target discovery (it&apos;s marked as &apos;failed&apos; because of an issue that was going on in Rawhide at the time with ttys, but it has nothing to do with iSCSI - the iSCSI stuff worked fine in that run). The 20170214.n.0 test, and the same iSCSI test for every subsequent Rawhide compose, failed when iSCSI target discovery should have occurred. The screen shows an error message:

https://openqa.fedoraproject.org/tests/56875#step/disk_custom_iscsi/8

&quot;Discovery login rejected. The following error occurred discovering iSCSI targets. Please double check your authorization information and try again.

Cannot perform discovery. Initiatorname required.&quot;

Note that the test *does* provide an initiator name; you can see it also in the screenshot, iqn.2016-06.local.domain:support.target1 . The test&apos;s behaviour did not change at all between 20170208 (when this worked) and 201702014 (when it failed). Note there were no successful composes between 20170208 and 20170214, hence the gap.

The first part of the error is a generic anaconda error message shown whenever iSCSI target discovery fails for any reason. The specific error message is &quot;Cannot perform discovery. Initiatorname required.&quot;, which comes from iscsi-initiator-utils. Specifically I think it comes from here:

https://github.com/open-iscsi/open-iscsi/blob/master/usr/discovery.c#L853-L854

the exact error text actually occurs twice in that file, but the other occurrence is in a function named `discovery_isns`, and I don&apos;t think iSNS is involved here.

I note that the error condition immediately follows this line:

	*rc = request_initiator_name(tmo);

which was changed in this commit:

https://github.com/open-iscsi/open-iscsi/commit/2b099d7b7e04bc42f747e75e87b053d564ee76bd

which seems to have already been found to cause some problems, at least on the basis of this commit:

https://github.com/open-iscsi/open-iscsi/commit/81f52b082f5b111d084d5c349bdef7077e23d650

so my guess is this is another case of that timeout change causing problems. The iscsi-initiator-utils package was updated on 2017-02-09:

https://koji.fedoraproject.org/koji/buildinfo?buildID=839902

that build bumped the package from a mid-2016 git snapshot to a new release that included the timeout commit, and it falls exactly in the time frame when the bug started happening. So it seems like a pretty strong suspect. Note that there has been another iscsi-initiator-utils package build since then which includes the 81f52b082f5b111d084d5c349bdef7077e23d650 commit, and we&apos;re still seeing this bug in current Rawhide nightly tests, so that one obviously doesn&apos;t fix this problem.

Proposing as a Final release blocker, per criterion &quot;The installer must be able to detect (if possible) and install to supported network-attached storage devices.&quot; - https://fedoraproject.org/wiki/Fedora_26_Final_Release_Criteria#network-attached-storage . iSCSI is a &apos;supported network-attached storage&apos; protocol.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10193455</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 07:28:05 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10194899</commentid>
    <comment_count>2</comment_count>
    <who name="Chris Leech">cleech</who>
    <bug_when>2017-02-28 13:39:07 -0500</bug_when>
    <thetext>This looks to be the same timeout regression with discovery commands, but manifesting through the libiscsi interfaces used by blivet, while just the iscsiadm tool was fixed previously.

Testing with an updates.img containing the new build seems to work.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10194934</commentid>
    <comment_count>3</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-02-28 13:53:58 -0500</bug_when>
    <thetext>Thanks for the quick fix!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10207870</commentid>
    <comment_count>4</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-03-03 18:39:19 -0500</bug_when>
    <thetext>Fix confirmed, iSCSI tests are now passing in openQA.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>