<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1416627</bug_id>
          
          <creation_ts>2017-01-26 00:37:00 -0500</creation_ts>
          <short_desc>[Xen][libvirt] Can&apos;t allocate low memory for guest when creating xen vm with virsh command.</short_desc>
          <delta_ts>2017-04-07 04:38:35 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Lin Liu">linl</reporter>
          <assigned_to name="Libvirt Maintainers">libvirt-maint</assigned_to>
          <cc>agedosier</cc>
    
    
    <cc>berrange</cc>
    
    
    <cc>clalancette</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>laine</cc>
    
    
    <cc>libvirt-maint</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
    
    
    <cc>xiliang</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-04-07 04:38:35</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10097727</commentid>
    <comment_count>0</comment_count>
      <attachid>1244596</attachid>
    <who name="Lin Liu">linl</who>
    <bug_when>2017-01-26 00:37:03 -0500</bug_when>
    <thetext>Created attachment 1244596
guest_create_failed.log

Description of problem:
Using virsh command to create xen guest, only guest with 1G(1048576Mb) memory can be created, guests with other size memory cannot be created with error message: &quot;xc_dom_boot_mem_init: can&apos;t allocate low memory for domain: Out of memory&quot;. Using xl to create the same configuration guest is OK.

Version-Release number of selected component (if applicable):
kernel-4.9.0-0.rc6.git2.1.fc26.x86_64
libvirt-3.0.0-1.fc26.x86_64
xen-4.8.0-2.fc26.x86_64

How reproducible: Always

Steps to Reproduce:
1. Boot Fedora Rawhide system xen hypervisor with &quot;dom0_mem=1024M,max:1024M&quot; in kernel command:
[root@dhcp-10-249 ~]# cat /etc/grub2.cfg | grep 1024
        multiboot        /xen-4.8.0.gz dom0_mem=1024M,max:1024M placeholder   ${xen_rm_opts}
The total memory is enough to balloon to guests:
[root@dhcp-10-249 ~]# cat /proc/meminfo
MemTotal:         911280 kB
MemFree:           11708 kB
MemAvailable:     705572 kB

2. Create a guest with command &quot;virsh create xen-hvm-guest.xml&quot; with below configure file:
[root@dhcp-10-249 ~]# cat xen-hvm-guest.xml
&lt;domain type=&apos;xen&apos;&gt;
&lt;name&gt;rhel-hvm&lt;/name&gt;
&lt;memory unit=&apos;KiB&apos;&gt;1048576&lt;/memory&gt;
&lt;currentMemory unit=&apos;KiB&apos;&gt;1048576&lt;/currentMemory&gt;
&lt;vcpu placement=&apos;static&apos;&gt;2&lt;/vcpu&gt;
&lt;os&gt;
&lt;type arch=&apos;x86_64&apos; machine=&apos;xenfv&apos;&gt;hvm&lt;/type&gt;
&lt;loader&gt;/usr/lib/xen/boot/hvmloader&lt;/loader&gt;
&lt;boot dev=&apos;hd&apos;/&gt;
&lt;/os&gt;
&lt;features&gt;
&lt;acpi/&gt;
&lt;apic/&gt;
&lt;pae/&gt;
&lt;/features&gt;
&lt;clock offset=&apos;utc&apos;/&gt;
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&lt;on_crash&gt;restart&lt;/on_crash&gt;
&lt;devices&gt;
&lt;emulator&gt;/usr/lib64/xen/bin/qemu-dm&lt;/emulator&gt;
&lt;disk type=&apos;file&apos; device=&apos;disk&apos;&gt;
&lt;source file=&apos;/home/RHEL-Server-6.9-64-hvm.raw&apos;/&gt;
&lt;target dev=&apos;xvda&apos; bus=&apos;xen&apos;/&gt;
&lt;address type=&apos;drive&apos; controller=&apos;0&apos; bus=&apos;0&apos; target=&apos;0&apos; unit=&apos;0&apos;/&gt;
&lt;/disk&gt;
&lt;controller type=&apos;ide&apos; index=&apos;0&apos;/&gt;
&lt;interface type=&apos;bridge&apos;&gt;
&lt;mac address=&apos;00:16:3e:83f:81&apos;/&gt;
&lt;source bridge=&apos;xenbr0&apos;/&gt;
&lt;/interface&gt;
&lt;serial type=&apos;pty&apos;&gt;
&lt;target port=&apos;0&apos;/&gt;
&lt;/serial&gt;
&lt;console type=&apos;pty&apos;&gt;
&lt;target type=&apos;serial&apos; port=&apos;0&apos;/&gt;
&lt;/console&gt;
&lt;input type=&apos;tablet&apos; bus=&apos;usb&apos;/&gt;
&lt;input type=&apos;mouse&apos; bus=&apos;ps2&apos;/&gt;
&lt;graphics type=&apos;vnc&apos; port=&apos;-1&apos; autoport=&apos;yes&apos; keymap=&apos;en-us&apos;/&gt;
&lt;video&gt;
&lt;model type=&apos;cirrus&apos; vram=&apos;4096&apos; heads=&apos;1&apos;/&gt;
&lt;/video&gt;
&lt;/devices&gt;
&lt;/domain&gt;

3. Guest is created successfully and then destroy it.
4. Change the memory to other size for example 1048575 as below:
[root@dhcp-10-249 ~]# cat xen-hvm-guest.xml  | grep -i memory
&lt;memory unit=&apos;KiB&apos;&gt;1048575&lt;/memory&gt;
&lt;currentMemory unit=&apos;KiB&apos;&gt;1048575&lt;/currentMemory&gt;
5. Create the guest again.

Actual results:
Cannot create guest with error message:
[root@dhcp-10-249 ~]# virsh create xen-hvm-guest.xml
error: Failed to create domain from xen-hvm-guest.xml
error: internal error: libxenlight failed to create new domain &apos;rhel-hvm&apos;

Expected results:
The guest should be created successfully since there is enough memory and the same configuration guest can be created by xl command.

Additional information:
In the log file /var/log/libvirt/libxl/libxl-driver.log it reports that: xc: panic: xc_dom_boot.c:141: xc_dom_boot_mem_init: can&apos;t allocate low memory for domain: Out of memory
Attach the full log file as guest_create_failed.log, also attach the log file when creating 1G(1048576Mb) memory guest successfully as virsh_guest.log.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10192005</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 06:03:42 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10313463</commentid>
    <comment_count>2</comment_count>
    <who name="Xiao, Liang">xiliang</who>
    <bug_when>2017-04-07 04:38:35 -0400</bug_when>
    <thetext>On Fedora-26-20170320.n.0 build, this bug is not reproducible. I can create guest domain with different memory setting, eg 524288,1048576,8388608. So close it.

[root@dhcp-3-6 media]# virsh dominfo test_hvm4
Id:             23
Name:           test_hvm4
UUID:           dabcd635-edc0-4f85-abaa-68602104a3d2
OS Type:        hvm
State:          running
CPU(s):         32
CPU time:       231.6s
Max memory:     8388608 KiB
Used memory:    8376332 KiB
Persistent:     no
Autostart:      disable
Managed save:   no
[root@dhcp-2-248 ~]# free -m
             total       used       free     shared    buffers     cached
Mem:          7979        672       7307          2         62        212
-/+ buffers/cache:        397       7582
Swap:         1199          0       1199

[root@dhcp-3-6 media]# cat test_hvm4.cfg 
&lt;domain type=&apos;xen&apos; id=&apos;1&apos;&gt;
&lt;name&gt;test_hvm4&lt;/name&gt;
&lt;memory unit=&apos;KiB&apos;&gt;8388608&lt;/memory&gt;
&lt;currentMemory unit=&apos;KiB&apos;&gt;8388608&lt;/currentMemory&gt;
&lt;vcpu placement=&apos;static&apos;&gt;32&lt;/vcpu&gt;
&lt;os&gt;
&lt;type arch=&apos;x86_64&apos; machine=&apos;xenfv&apos;&gt;hvm&lt;/type&gt;
&lt;loader&gt;/usr/lib/xen/boot/hvmloader&lt;/loader&gt;
&lt;boot dev=&apos;hd&apos;/&gt;
&lt;boot dev=&apos;network&apos;/&gt;
&lt;/os&gt;
&lt;features&gt;
&lt;acpi/&gt;
&lt;apic/&gt;
&lt;pae/&gt;
&lt;/features&gt;
&lt;clock offset=&apos;utc&apos;/&gt;
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&lt;on_crash&gt;preserve&lt;/on_crash&gt;
&lt;devices&gt;
&lt;emulator&gt;/usr/lib64/xen/bin/qemu-dm&lt;/emulator&gt;
&lt;disk type=&apos;file&apos; device=&apos;disk&apos;&gt;
&lt;source file=&apos;/media/guest_hvm4.img&apos;/&gt;
&lt;target dev=&apos;xvda&apos; bus=&apos;xen&apos;/&gt;
&lt;/disk&gt;
&lt;disk type=&apos;file&apos; device=&apos;disk&apos;&gt;
&lt;driver name=&apos;qemu&apos;/&gt;
&lt;source file=&apos;/media/test.img&apos;/&gt;
&lt;target dev=&apos;xvdb&apos; bus=&apos;xen&apos;/&gt;
&lt;/disk&gt;
&lt;interface type=&apos;bridge&apos;&gt;
&lt;mac address=&apos;00:16:3b:f1:1c:59&apos;/&gt;
&lt;source bridge=&apos;xenbr0&apos;/&gt;
&lt;model type=&apos;e1000&apos;/&gt;
&lt;/interface&gt;
&lt;controller type=&apos;ide&apos; index=&apos;0&apos;/&gt;
&lt;serial type=&apos;pty&apos;&gt;
&lt;source path=&apos;/dev/pts/3&apos;/&gt;
&lt;target port=&apos;0&apos;/&gt;
&lt;/serial&gt;
&lt;console type=&apos;pty&apos;&gt;
&lt;target type=&apos;serial&apos; port=&apos;0&apos;/&gt;
&lt;/console&gt;
&lt;input type=&apos;tablet&apos; bus=&apos;usb&apos;/&gt;
&lt;input type=&apos;mouse&apos; bus=&apos;ps2&apos;/&gt;
&lt;graphics type=&apos;vnc&apos; listen=&apos;10.66.3.6&apos; port=&apos;5900&apos; autoport=&apos;yes&apos; keymap=&apos;en-us&apos;/&gt;
&lt;video&gt;
&lt;model type=&apos;cirrus&apos; vram=&apos;9216&apos; heads=&apos;1&apos;/&gt;
&lt;/video&gt;
&lt;/devices&gt;
&lt;/domain&gt;


Packages information:
kernel-4.11.0-0.rc1.git0.1.fc26.x86_64
libvirt-3.1.0-1.fc26.x86_64
xen-4.8.0-8.fc26.x86_64</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>1244596</attachid>
            <date>2017-01-26 00:37:00 -0500</date>
            <delta_ts>2017-01-26 00:37:03 -0500</delta_ts>
            <desc>guest_create_failed.log</desc>
            <filename>guest_create_failed.log</filename>
            <type>text/plain</type>
            <size>2972</size>
            <attacher name="Lin Liu">linl</attacher>
            
              <data encoding="base64">MjAxNy0wMS0yNiAwMzoyNToyNy45NzkrMDAwMDogbGlieGw6IGxpYnhsX2NyZWF0ZS5jOjE2MTQ6
ZG9fZG9tYWluX2NyZWF0ZTogYW8gMHg3ZjQxODQwMDZmNjA6IGNyZWF0ZTogaG93PShuaWwpIGNh
bGxiYWNrPShuaWwpIHBvbGxlcj0weDdmNDE3NDAwMWIyMAoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5
NiswMDAwOiBsaWJ4bDogbGlieGxfZGV2aWNlLmM6MzYxOmxpYnhsX19kZXZpY2VfZGlza19zZXRf
YmFja2VuZDogRGlzayB2ZGV2PXh2ZGEgc3BlYy5iYWNrZW5kPXVua25vd24KMjAxNy0wMS0yNiAw
MzoyNToyNy45OTYrMDAwMDogbGlieGw6IGxpYnhsX2RldmljZS5jOjM5NjpsaWJ4bF9fZGV2aWNl
X2Rpc2tfc2V0X2JhY2tlbmQ6IERpc2sgdmRldj14dmRhLCB1c2luZyBiYWNrZW5kIHBoeQoyMDE3
LTAxLTI2IDAzOjI1OjI3Ljk5NiswMDAwOiBsaWJ4bDogbGlieGxfY3JlYXRlLmM6OTcwOmluaXRp
YXRlX2RvbWFpbl9jcmVhdGU6IHJ1bm5pbmcgYm9vdGxvYWRlcgoyMDE3LTAxLTI2IDAzOjI1OjI3
Ljk5NiswMDAwOiBsaWJ4bDogbGlieGxfYm9vdGxvYWRlci5jOjMyNDpsaWJ4bF9fYm9vdGxvYWRl
cl9ydW46IG5vdCBhIFBWIGRvbWFpbiwgc2tpcHBpbmcgYm9vdGxvYWRlcgoyMDE3LTAxLTI2IDAz
OjI1OjI3Ljk5NiswMDAwOiBsaWJ4bDogbGlieGxfZXZlbnQuYzo2ODY6bGlieGxfX2V2X3hzd2F0
Y2hfZGVyZWdpc3Rlcjogd2F0Y2ggdz0weDdmNDE4NDAwM2Q0MDogZGVyZWdpc3RlciB1bnJlZ2lz
dGVyZWQKMjAxNy0wMS0yNiAwMzoyNToyNy45OTcrMDAwMDogZG9tYWluYnVpbGRlcjogeGNfZG9t
X2FsbG9jYXRlOiBjbWRsaW5lPSIobnVsbCkiLCBmZWF0dXJlcz0iKG51bGwpIgoyMDE3LTAxLTI2
IDAzOjI1OjI3Ljk5NyswMDAwOiBkb21haW5idWlsZGVyOiB4Y19kb21fa2VybmVsX2ZpbGU6IGZp
bGVuYW1lPSIvdXNyL2xpYi94ZW4vYm9vdC9odm1sb2FkZXIiCjIwMTctMDEtMjYgMDM6MjU6Mjcu
OTk3KzAwMDA6IGRvbWFpbmJ1aWxkZXI6IHhjX2RvbV9tYWxsb2NfZmlsZW1hcCAgICA6IDQ3MiBr
QgoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5OCswMDAwOiBkb21haW5idWlsZGVyOiB4Y19kb21fYm9v
dF94ZW5faW5pdDogdmVyIDQuOCwgY2FwcyB4ZW4tMy4wLXg4Nl82NCB4ZW4tMy4wLXg4Nl8zMnAg
aHZtLTMuMC14ODZfMzIgaHZtLTMuMC14ODZfMzJwIGh2bS0zLjAteDg2XzY0IAoyMDE3LTAxLTI2
IDAzOjI1OjI3Ljk5OCswMDAwOiBkb21haW5idWlsZGVyOiB4Y19kb21fcGFyc2VfaW1hZ2U6IGNh
bGxlZAoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5OCswMDAwOiBkb21haW5idWlsZGVyOiB4Y19kb21f
ZmluZF9sb2FkZXI6IHRyeWluZyBtdWx0aWJvb3QtYmluYXJ5IGxvYWRlciAuLi4gCjIwMTctMDEt
MjYgMDM6MjU6MjcuOTk4KzAwMDA6IGRvbWFpbmJ1aWxkZXI6IGxvYWRlciBwcm9iZSBmYWlsZWQK
MjAxNy0wMS0yNiAwMzoyNToyNy45OTgrMDAwMDogZG9tYWluYnVpbGRlcjogeGNfZG9tX2ZpbmRf
bG9hZGVyOiB0cnlpbmcgSFZNLWdlbmVyaWMgbG9hZGVyIC4uLiAKMjAxNy0wMS0yNiAwMzoyNToy
Ny45OTgrMDAwMDogZG9tYWluYnVpbGRlcjogbG9hZGVyIHByb2JlIE9LCjIwMTctMDEtMjYgMDM6
MjU6MjcuOTk4KzAwMDA6IHhjOiBFTEY6IHBoZHI6IHBhZGRyPTB4MTAwMDAwIG1lbXN6PTB4N2Uz
NjQKMjAxNy0wMS0yNiAwMzoyNToyNy45OTgrMDAwMDogeGM6IEVMRjogbWVtb3J5OiAweDEwMDAw
MCAtPiAweDE3ZTM2NAoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5OSswMDAwOiBkb21haW5idWlsZGVy
OiB4Y19kb21fbWVtX2luaXQ6IG1lbSAxMDIwIE1CLCBwYWdlcyAweDNmYzAwIHBhZ2VzLCA0ayBl
YWNoCjIwMTctMDEtMjYgMDM6MjU6MjcuOTk5KzAwMDA6IGRvbWFpbmJ1aWxkZXI6IHhjX2RvbV9t
ZW1faW5pdDogMHgzZmMwMCBwYWdlcwoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5OSswMDAwOiBkb21h
aW5idWlsZGVyOiB4Y19kb21fYm9vdF9tZW1faW5pdDogY2FsbGVkCjIwMTctMDEtMjYgMDM6MjU6
MjcuOTk5KzAwMDA6IGRvbWFpbmJ1aWxkZXI6IHZOVU1BIG1lbW9yeSBwYWdlcyBtaXNtYXRjaCAo
MHgzZmMwMSAhPSAweDNmYzAwKQoyMDE3LTAxLTI2IDAzOjI1OjI3Ljk5OSswMDAwOiB4YzogcGFu
aWM6IHhjX2RvbV9ib290LmM6MTQxOiB4Y19kb21fYm9vdF9tZW1faW5pdDogY2FuJ3QgYWxsb2Nh
dGUgbG93IG1lbW9yeSBmb3IgZG9tYWluOiBPdXQgb2YgbWVtb3J5CjIwMTctMDEtMjYgMDM6MjU6
MjcuOTk5KzAwMDA6IGxpYnhsOiBsaWJ4bF9kb20uYzo2NTM6bGlieGxfX2J1aWxkX2RvbTogeGNf
ZG9tX2Jvb3RfbWVtX2luaXQgZmFpbGVkOiBObyBzdWNoIGZpbGUgb3IgZGlyZWN0b3J5CjIwMTct
MDEtMjYgMDM6MjU6MjcuOTk5KzAwMDA6IGRvbWFpbmJ1aWxkZXI6IHhjX2RvbV9yZWxlYXNlOiBj
YWxsZWQKMjAxNy0wMS0yNiAwMzoyNToyNy45OTkrMDAwMDogbGlieGw6IGxpYnhsX2NyZWF0ZS5j
OjEyMjM6ZG9tY3JlYXRlX3JlYnVpbGRfZG9uZTogY2Fubm90IChyZS0pYnVpbGQgZG9tYWluOiAt
MwoyMDE3LTAxLTI2IDAzOjI1OjI4LjAxMiswMDAwOiBsaWJ4bDogbGlieGwuYzoxNzEyOmRldmlj
ZXNfZGVzdHJveV9jYjogZm9ya2VkIHBpZCA0MDUxIGZvciBkZXN0cm95IG9mIGRvbWFpbiA4CjIw
MTctMDEtMjYgMDM6MjU6MjguMDEyKzAwMDA6IGxpYnhsOiBsaWJ4bF9jcmVhdGUuYzoxNjQwOmRv
X2RvbWFpbl9jcmVhdGU6IGFvIDB4N2Y0MTg0MDA2ZjYwOiBpbnByb2dyZXNzOiBwb2xsZXI9MHg3
ZjQxNzQwMDFiMjAsIGZsYWdzPWkKMjAxNy0wMS0yNiAwMzoyNToyOC4wMTcrMDAwMDogbGlieGw6
IGxpYnhsX2V2ZW50LmM6MTg2OTpsaWJ4bF9fYW9fY29tcGxldGU6IGFvIDB4N2Y0MTg0MDA2ZjYw
OiBjb21wbGV0ZSwgcmM9LTMKMjAxNy0wMS0yNiAwMzoyNToyOC4wMTcrMDAwMDogbGlieGw6IGxp
YnhsX2V2ZW50LmM6MTgzODpsaWJ4bF9fYW9fX2Rlc3Ryb3k6IGFvIDB4N2Y0MTg0MDA2ZjYwOiBk
ZXN0cm95Cgo=
</data>

          </attachment>
      

    </bug>

</bugzilla>