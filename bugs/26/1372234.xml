<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1372234</bug_id>
          
          <creation_ts>2016-09-01 04:27:00 -0400</creation_ts>
          <short_desc>mock --new-chroot can&apos;t shutdown mongo running inside</short_desc>
          <delta_ts>2017-04-12 20:16:43 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>mock</component>
          <version>26</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Vít Ondruch">vondruch</reporter>
          <assigned_to name="Miroslav Suchý">msuchy</assigned_to>
          <cc>Frodox</cc>
    
    
    <cc>jdisnard</cc>
    
    
    <cc>mebrown</cc>
    
    
    <cc>msimacek</cc>
    
    
    <cc>msuchy</cc>
    
    
    <cc>praiskup</cc>
    
    
    <cc>williams</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>mock-1.3.4-1.fc25 mock-1.3.4-1.fc24 mock-1.3.4-1.el7 mock-1.3.5-1.el6</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-08 08:28:36</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9670297</commentid>
    <comment_count>0</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-09-01 04:27:45 -0400</bug_when>
    <thetext>Description of problem:
I am trying to update rubygem-mongo and in this package, the MongoDB service is started to provide the database backend for the test suite [1]. After the test suite is executed, the MongoDB is shut down [2]. This works just fine with --old-chroot, but with --new-chroot it actually gets stick at the point, when MongoDB should be shut down:

```
+ mongod --shutdown --dbpath data
killing process with pid: 2500
```

Version-Release number of selected component (if applicable):
$ rpm -q mock
mock-1.2.20-1.fc26.noarch


How reproducible:


Steps to Reproduce:
1.
2.
3.

Actual results:


Expected results:


Additional info:



[1] http://pkgs.fedoraproject.org/cgit/rpms/rubygem-mongo.git/tree/rubygem-mongo.spec?id=07ccdc22bad0a63943b82c9de4e11c643ea68570#n68
[2] http://pkgs.fedoraproject.org/cgit/rpms/rubygem-mongo.git/tree/rubygem-mongo.spec?id=07ccdc22bad0a63943b82c9de4e11c643ea68570#n83</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9670320</commentid>
    <comment_count>1</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-09-01 04:33:13 -0400</bug_when>
    <thetext>This should be the nspawn command used to execute the build:

Executing command: [&apos;/usr/bin/systemd-nspawn&apos;, &apos;-q&apos;, &apos;-M&apos;, &apos;cd998437cdff44219744d978b17b999f&apos;, &apos;-D&apos;, &apos;/var/lib/mock/fedora-rawhide-x86_64/root&apos;, &apos;--setenv=PS1=&lt;mock-chroot&gt; \\s-\\v\\$ &apos;, &apos;--setenv=LANG=cs_CZ.utf8&apos;, &apos;--setenv=PROMPT_COMMAND=printf &quot;\\033]0;&lt;mock-chroot&gt;\\007&quot;&apos;, &apos;--setenv=HOSTNAME=mock&apos;, &apos;--setenv=HOME=/builddir&apos;, &apos;--setenv=TERM=vt100&apos;, &apos;--setenv=PATH=/usr/bin:/bin:/usr/sbin:/sbin&apos;, &apos;--setenv=SHELL=/bin/bash&apos;, &apos;-u&apos;, &apos;mockbuild&apos;, &apos;/usr/bin/rpmbuild&apos;, &apos;-bb&apos;, &apos;--target&apos;, &apos;x86_64&apos;, &apos;--nodeps&apos;, &apos;/builddir/build/SPECS/rubygem-mongo.spec&apos;] with env {&apos;PS1&apos;: &apos;&lt;mock-chroot&gt; \\s-\\v\\$ &apos;, &apos;LANG&apos;: &apos;cs_CZ.utf8&apos;, &apos;PROMPT_COMMAND&apos;: &apos;printf &quot;\\033]0;&lt;mock-chroot&gt;\\007&quot;&apos;, &apos;HOSTNAME&apos;: &apos;mock&apos;, &apos;HOME&apos;: &apos;/builddir&apos;, &apos;TERM&apos;: &apos;vt100&apos;, &apos;PATH&apos;: &apos;/usr/bin:/bin:/usr/sbin:/sbin&apos;, &apos;SHELL&apos;: &apos;/bin/bash&apos;} and shell False</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9670821</commentid>
    <comment_count>2</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-09-01 06:20:56 -0400</bug_when>
    <thetext>So far it looks like /proc is not correctly mounted. Let me explain.

To debug this issue, I executed the &quot;mongod --shutdown --dbpath data&quot; with strace, here is the snippet of output:

```
stat(&quot;/proc/2500&quot;, {st_mode=S_IFDIR|0555, st_size=0, ...}) = 0
nanosleep({1, 0}, 0x7fff02417b80)       = 0
```

So it tries to access the process directory, but overall the output is not very helpful.

As a next step, I tried to debug what is going on with the process, so I followed this guide [1] how to debug the container. I my case, it was something like:

```
$ machinectl 
MACHINE                          CLASS     SERVICE       
213731c4a85d47f38e2e83765d201807 container systemd-nspawn

1 machines listed.

$ machinectl status 213731c4a85d47f38e2e83765d201807
213731c4a85d47f38e2e83765d201807(224dc752107d419d9c071eb3c7e745b8)
           Since: Čt 2016-09-01 11:01:38 CEST; 17s ago
          Leader: 21334 (rpmbuild)
         Service: systemd-nspawn; class container
            Root: /var/lib/mock/fedora-rawhide-x86_64/root
              OS: Fedora 26 (Rawhide)
            Unit: machine-213731c4a85d47f38e2e83765d201807.scope
                  ├─21334 /usr/bin/rpmbuild -bb --target x86_64 --nodeps /builddir/build/SPECS/rubygem-mongo.spec
                  ├─23913 /bin/sh -e /var/tmp/rpm-tmp.d8iLLi
                  ├─23935 strace mongod --shutdown --dbpath data
                  └─23937 mongod --shutdown --dbpath data

zář 01 11:01:38 unused-4-132.brq.redhat.com systemd[1]: Started Container 213731c4a85d47f38e2e83765d201807.

$ sudo nsenter --target 23937 --mount --uts --ipc --net
```

But as soon as I tried to list the running processes, I got this error:

```
# ps -ef
Error, do this: mount -t proc proc /proc
```

As soon as I executed the mount command suggest by the ps error output, suddenly, the ps started to work, but not only that, also the mongodb immediately shuts down.

My question now is what is wrong with the /proc directory, since it seems to be mounted but it is probably not properly accessible for some reason. Is this mock issue or nspawn issue?

[1] https://seanmcgary.com/posts/nsenter-a-systemd-nspawn-container</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9670988</commentid>
    <comment_count>3</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-09-01 07:03:30 -0400</bug_when>
    <thetext>I should probably also mention SystemD version I am using:

$ rpm -qf `which systemd-nspawn`
systemd-container-231-3.fc26.x86_64</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9992726</commentid>
    <comment_count>4</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-12-16 04:47:33 -0500</bug_when>
    <thetext>Ping?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10102123</commentid>
    <comment_count>5</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2017-01-27 11:08:12 -0500</bug_when>
    <thetext>Now I leardned, that there is this options of systemd-nspawn:

  -a --as-pid2              Maintain a stub init as PID1, invoke binary as PID2

Trying the command above with this option, it seems the build passes. Nevertheless, I have no idea if this is the right medicine ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10103303</commentid>
    <comment_count>6</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2017-01-28 03:39:28 -0500</bug_when>
    <thetext>https://github.com/rpm-software-management/mock/pull/36</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10171629</commentid>
    <comment_count>7</comment_count>
    <who name="Miroslav Suchý">msuchy</who>
    <bug_when>2017-02-21 11:22:04 -0500</bug_when>
    <thetext>PR in #6 has been merged.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10187681</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-27 12:55:46 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-1c433a692a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10187688</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-27 12:56:08 -0500</bug_when>
    <thetext>mock-1.3.4-1.el6 has been submitted as an update to Fedora EPEL 6. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-2c7e8574bf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10187693</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-27 12:56:30 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-3cb1bb5aa5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10187697</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-27 12:56:52 -0500</bug_when>
    <thetext>mock-1.3.4-1.el7 has been submitted as an update to Fedora EPEL 7. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-89e17056c0</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10191136</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2017-02-28 05:11:15 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 26 development cycle.
Changing version to &apos;26&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10195721</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-28 20:48:46 -0500</bug_when>
    <thetext>mock-1.3.4-1.el7 has been pushed to the Fedora EPEL 7 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-89e17056c0</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10195836</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-28 21:50:42 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-1c433a692a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10195875</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-28 21:53:34 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-3cb1bb5aa5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10198437</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-01 12:17:42 -0500</bug_when>
    <thetext>mock-1.3.4-1.el6 has been pushed to the Fedora EPEL 6 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-2c7e8574bf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10201278</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-02 05:21:44 -0500</bug_when>
    <thetext>mock-1.3.5-1.el6 has been submitted as an update to Fedora EPEL 6. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-2c7e8574bf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10204586</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-02 22:54:59 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10204610</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-02 23:17:17 -0500</bug_when>
    <thetext>mock-1.3.5-1.el6 has been pushed to the Fedora EPEL 6 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-2c7e8574bf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10221118</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-08 08:28:36 -0500</bug_when>
    <thetext>mock-1.3.4-1.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10241921</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-15 09:48:20 -0400</bug_when>
    <thetext>mock-1.3.4-1.el7 has been pushed to the Fedora EPEL 7 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10331363</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-12 20:16:43 -0400</bug_when>
    <thetext>mock-1.3.5-1.el6 has been pushed to the Fedora EPEL 6 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>