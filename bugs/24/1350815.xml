<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1350815</bug_id>
          
          <creation_ts>2016-06-28 09:07:00 -0400</creation_ts>
          <short_desc>systemctl restart chrony-wait causes AVC denials</short_desc>
          <delta_ts>2016-12-07 22:20:10 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>chrony</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>high</priority>
          <bug_severity>medium</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jan Pazdziora">jpazdziora</reporter>
          <assigned_to name="Miroslav Lichvar">mlichvar</assigned_to>
          <cc>dominick.grift</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>edgar.hoch</cc>
    
    
    <cc>jbieren</cc>
    
    
    <cc>jhutar</cc>
    
    
    <cc>jpazdziora</cc>
    
    
    <cc>lvrabec</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>michal.jnn</cc>
    
    
    <cc>mihai</cc>
    
    
    <cc>mjia</cc>
    
    
    <cc>mkorbel</cc>
    
    
    <cc>mkosek</cc>
    
    
    <cc>mlichvar</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>pstudeni</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>chrony-2.4-4.fc24 chrony-2.4-4.fc25 chrony-2.4.1-1.fc23</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-07 22:20:10</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9459211</commentid>
    <comment_count>0</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-28 09:07:19 -0400</bug_when>
    <thetext>Description of problem:

When systemctl restart chrony-wait is run (and time is a bit off, I assume),
AVC denial is logged.

Version-Release number of selected component (if applicable):

chrony-2.4-1.fc24.x86_64

How reproducible:

Semi-deterministic.

Steps to Reproduce:
1. Have Fedora 24 installed.
2. Set time five seconds back: date -s &apos;-5 sec&apos;
3. Run systemctl restart chrony-wait

Actual results:

type=AVC msg=audit(1467119106.048:204): avc:  denied  { sendto } for  pid=671 comm=&quot;chronyd&quot; path=&quot;/run/chrony/chronyc.1654.sock&quot; scontext=system_u:system_r:chronyd_t:s0 tcontext=system_u:system_r:unconfined_service_t:s0 tclass=unix_dgram_socket permissive=0

Expected results:

No AVC denial.

Additional info:</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459215</commentid>
    <comment_count>1</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-28 09:08:18 -0400</bug_when>
    <thetext>The process of pid 1654 is

/usr/bin/chronyc waitsync 600 0.1 0.0 1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459221</commentid>
    <comment_count>3</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-28 09:09:57 -0400</bug_when>
    <thetext>The SELinux policy is selinux-policy-targeted-3.13.1-191.fc24.2.noarch.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459229</commentid>
    <comment_count>4</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-28 09:11:34 -0400</bug_when>
    <thetext>I can actually see this on Fedora 23 as well:

chrony-2.4-1.fc23.x86_64
selinux-policy-targeted-3.13.1-158.15.fc23.noarch

I haven&apos;t seen it in automated Fedora 23 tests in the past and I see it with virtually every Fedora 24 setup now. But maybe Fedora 23 did not run chrony-wait in the past?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459263</commentid>
    <comment_count>5</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-28 09:15:12 -0400</bug_when>
    <thetext>Is this something that https://bodhi.fedoraproject.org/updates/FEDORA-2016-7553eb6439 and https://bodhi.fedoraproject.org/updates/FEDORA-2016-4c9c2badcb could have caused?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459281</commentid>
    <comment_count>6</comment_count>
    <who name="Miroslav Lichvar">mlichvar</who>
    <bug_when>2016-06-28 09:20:45 -0400</bug_when>
    <thetext>chrony since 2.4 uses a Unix domain socket for communication between chronyd and chronyc (running with root privileges). There was a request to support this change in bug #1259636. I think it worked for me before, so I&apos;m not sure if the initial support was incomplete or the policy has changed recently.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9459292</commentid>
    <comment_count>7</comment_count>
    <who name="Miroslav Lichvar">mlichvar</who>
    <bug_when>2016-06-28 09:22:40 -0400</bug_when>
    <thetext>It&apos;s actually chrony version 2.2 and later which use the Unix socket. In Fedora 23 there was recently an update from 2.1.1 to 2.4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9468247</commentid>
    <comment_count>8</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-06-30 07:57:16 -0400</bug_when>
    <thetext>Do you think this is an issue in chrony, or should I move the bugzilla to selinux-policy?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9468424</commentid>
    <comment_count>10</comment_count>
    <who name="Miroslav Lichvar">mlichvar</who>
    <bug_when>2016-06-30 08:40:37 -0400</bug_when>
    <thetext>I think it&apos;s a missing rule in the selinux policy. chronyd can&apos;t respond to chronyc when it&apos;s running as a service (it has unconfined_service_t context).

As a quick workaround you can force chronyc in the chrony-wait service to not use Unix domain socket:

sed &apos;s|chronyc waitsync|chronyc -h ::1 waitsync|&apos; \
      &lt; /usr/lib/systemd/system/chrony-wait.service \
      &gt; /etc/systemd/system/chrony-wait.service

Another issue I noticed when I was trying different configuration directives is blocked access to /etc/adjtime:

#============= chronyd_t ==============
allow chronyd_t adjtime_t:file { read open getattr };</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9495407</commentid>
    <comment_count>11</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-07-11 03:27:46 -0400</bug_when>
    <thetext>(In reply to Miroslav Lichvar from comment #10)
&gt; I think it&apos;s a missing rule in the selinux policy. chronyd can&apos;t respond to
&gt; chronyc when it&apos;s running as a service (it has unconfined_service_t context).
&gt; 
&gt; As a quick workaround you can force chronyc in the chrony-wait service to
&gt; not use Unix domain socket:
&gt; 
&gt; sed &apos;s|chronyc waitsync|chronyc -h ::1 waitsync|&apos; \
&gt;       &lt; /usr/lib/systemd/system/chrony-wait.service \
&gt;       &gt; /etc/systemd/system/chrony-wait.service

I confirm that

   sed -i &apos;s|chronyc waitsync|chronyc -h ::1 waitsync|&apos; /usr/lib/systemd/system/chrony-wait.service

makes the problem go away.

Do we know what the proper fix (in the SELinux policy) would be?

&gt; Another issue I noticed when I was trying different configuration directives
&gt; is blocked access to /etc/adjtime:
&gt; 
&gt; #============= chronyd_t ==============
&gt; allow chronyd_t adjtime_t:file { read open getattr };</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9679537</commentid>
    <comment_count>12</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-09-05 08:36:18 -0400</bug_when>
    <thetext>Could we please get the proper fix in? The need to include workaround complicates our testing of other components.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9747330</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2016-09-27 11:08:27 -0400</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9760763</commentid>
    <comment_count>15</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-10-03 07:29:35 -0400</bug_when>
    <thetext>Could we please get the proper fix in? The need to include workaround complicates our testing of other components.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9763921</commentid>
    <comment_count>16</comment_count>
    <who name="Jan Hutař">jhutar</who>
    <bug_when>2016-10-04 04:21:44 -0400</bug_when>
    <thetext>Possibly a duplicate of bug 1284691?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9822139</commentid>
    <comment_count>19</comment_count>
    <who name="Miroslav Grepl">mgrepl</who>
    <bug_when>2016-10-26 04:35:26 -0400</bug_when>
    <thetext>*** Bug 1284691 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9822301</commentid>
    <comment_count>20</comment_count>
    <who name="Miroslav Grepl">mgrepl</who>
    <bug_when>2016-10-26 05:28:46 -0400</bug_when>
    <thetext>The problem is with

ExecStart=/usr/bin/chronyc waitsync 600 0.1 0.0 1

because /usr/bin/chronyc is labeled as bin_t and we end up with unconfined_service_t. We don&apos;t want to label it as chronyd_exec_t because of chronyc is a command line interface.

Could we get a helper script here which we could label as chronyd_exec_t?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9822380</commentid>
    <comment_count>21</comment_count>
    <who name="Miroslav Lichvar">mlichvar</who>
    <bug_when>2016-10-26 06:00:48 -0400</bug_when>
    <thetext>You mean to change the ExecStart line to call /usr/libexec/chrony-helper instead of /usr/bin/chronyc?

We can do that, but this change wouldn&apos;t go upstream and I&apos;d rather avoid adding another Fedora-specific patch. If this can&apos;t be fixed properly, I liked better the workaround from comment #10.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9829859</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-10-28 10:55:36 -0400</bug_when>
    <thetext>chrony-2.4-4.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-1121fb57c9</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9830698</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-10-28 23:55:25 -0400</bug_when>
    <thetext>chrony-2.4-4.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-2ee0547cf1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9832637</commentid>
    <comment_count>24</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-10-31 03:37:54 -0400</bug_when>
    <thetext>chrony-2.4-4.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9837492</commentid>
    <comment_count>25</comment_count>
    <who name="Lukas Vrabec">lvrabec</who>
    <bug_when>2016-11-01 10:37:05 -0400</bug_when>
    <thetext>*** Bug 1390204 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9856852</commentid>
    <comment_count>26</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-03 19:54:39 -0400</bug_when>
    <thetext>chrony-2.4-4.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9933728</commentid>
    <comment_count>27</comment_count>
    <who name="Miroslav Lichvar">mlichvar</who>
    <bug_when>2016-11-28 04:19:29 -0500</bug_when>
    <thetext>*** Bug 1398980 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9933775</commentid>
    <comment_count>28</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-28 04:32:08 -0500</bug_when>
    <thetext>chrony-2.4.1-1.fc23 has been submitted as an update to Fedora 23. https://bodhi.fedoraproject.org/updates/FEDORA-2016-e62d5b25ee</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9936025</commentid>
    <comment_count>29</comment_count>
    <who name="Michal Jaegermann">michal.jnn</who>
    <bug_when>2016-11-28 13:25:45 -0500</bug_when>
    <thetext>(In reply to Fedora Update System from comment #28)
&gt; chrony-2.4.1-1.fc23 has been submitted as an update to Fedora 23.

Long waits for the next flight in Toronto seem to have some advantages. :-)  This refers to a duplicate bug 1398980.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9941581</commentid>
    <comment_count>30</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-30 01:52:06 -0500</bug_when>
    <thetext>chrony-2.4.1-1.fc23 has been pushed to the Fedora 23 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-e62d5b25ee</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966592</commentid>
    <comment_count>31</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-07 22:20:10 -0500</bug_when>
    <thetext>chrony-2.4.1-1.fc23 has been pushed to the Fedora 23 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>