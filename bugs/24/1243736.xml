<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1243736</bug_id>
          
          <creation_ts>2015-07-16 03:49:00 -0400</creation_ts>
          <short_desc>Layered Docker Image Build Service</short_desc>
          <delta_ts>2016-09-29 07:26:06 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>Changes Tracking</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>ChangeAcceptedF23, SystemWideChange, ChangeAcceptedF24</status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jan Kurik">jkurik</reporter>
          <assigned_to name="Adam Miller">admiller</assigned_to>
          <cc>acarter</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>bkabrda</cc>
    
    
    <cc>dennis</cc>
    
    
    <cc>dgregor</cc>
    
    
    <cc>lslebodn</cc>
    
    
    <cc>mattdm</cc>
    
    
    <cc>me</cc>
    
    
    <cc>pbrobinson</cc>
    
    
    <cc>ttomecek</cc>
    
    
    <cc>twaugh</cc>
    
    
    <cc>vrutkovs</cc>
          <qa_contact name="Pete Travis">me</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-29 07:26:06</cf_last_closed>
          <cf_type>---</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>8447781</commentid>
    <comment_count>0</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-07-16 03:49:21 -0400</bug_when>
    <thetext>This is a tracking bug for Change: Layered Docker Image Build Service
For more details, see: https://fedoraproject.org//wiki/Changes/Layered_Docker_Image_Build_Service

Fedora currently ships a Docker base image, but Docker supports a layering concept.
There are some applications like Cockpit which we would like to ship as layered applications.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8516767</commentid>
    <comment_count>1</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-08-06 05:05:23 -0400</bug_when>
    <thetext>Removing from the scope of F23 as we have already passed the deadline when this change needs to be in MODIFIED state.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8516770</commentid>
    <comment_count>2</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-08-06 05:06:04 -0400</bug_when>
    <thetext>Oh, sorry. This stays in the F23 scope.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8595058</commentid>
    <comment_count>3</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-09-01 10:54:26 -0400</bug_when>
    <thetext>This message is a reminder that Fedora 23 Change Checkpoint: 100% Code Complete Deadline is on 2015-Sep-08 [1].

Expected bug state is ON_QA - Change has to be code complete and is possible to test it in the Beta release.

Status will be provided to FESCo right after the deadline. If, for any reasons, your Change is not in required state, let me know and we will try to find solution.  It&apos;s important milestone as contingency plan may be put into effect if the Change that miss this deadline.

In case of any questions, don&apos;t hesitate to ask Wrangler (jkurik). Thank you.

[1] https://fedoraproject.org/wiki/Releases/23/Schedule</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8600227</commentid>
    <comment_count>4</comment_count>
    <who name="Dennis Gilmore">dennis</who>
    <bug_when>2015-09-02 16:03:27 -0400</bug_when>
    <thetext>We are delaying this to Fedora 24</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8600362</commentid>
    <comment_count>5</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2015-09-02 17:01:00 -0400</bug_when>
    <thetext>My apologies for the radio silence. I&apos;ve been relatively head-down on this work as much as possible. All involved upstreams have been very helpful and responsive along the way, but the container build toolchain is a space where there&apos;s a lot of very active development, moving parts, and sometimes things changing out from one another. Here&apos;s the saga so far:

Were considering a different backend for the koji component focused directly on atomic-reactor instead of a full OpenShift Install (there were concerns that running a full PaaS just for build tooling was a lot of overhead but given the momentum behind, development effort going into it, and the upstream acceptance it ended up being the best option)

Proof-of-concept atomic-reactor koji plugin
    https://pagure.io/koji-atomic-reactor-plugin
    http://koji.stg.fedoraproject.org/koji/taskinfo?taskID=90001193
Discussion upstream:
https://lists.projectatomic.io/projectatomic-archives/atomic-devel/2015-July/msg00039.html

Issues along the way:

osbs uses system:anonymous no matter what username passed in
    https://github.com/projectatomic/osbs-client/issues/164

OSBS Ansible Playbook failing deployment of OSv3 Node
    https://github.com/projectatomic/ansible-osbs/issues/11

OpenShift&apos;s Ansible playbook failing on pre-existing host
    https://github.com/openshift/openshift-ansible/issues/293

atomic-reactor fails on RHEL7/CentOS7 (python-requests too old)
    https://github.com/projectatomic/atomic-reactor/issues/225
    - This has been fixed, but now it fails because the version is too new.

atomic-reactor fails on Fedora 22 (python-requests too new)
    https://github.com/projectatomic/atomic-reactor/issues/226

I ended up maintaining my own atomic-reactor CORP (and a handful of other packages) where work arounds were necessary
    https://copr.fedoraproject.org/coprs/maxamillion/atomic-reactor/

SELinux permission denied for atomic-reactor builds
    https://github.com/projectatomic/atomic-reactor/issues/206

&quot;No valid build json&quot; error related to SELinux issue in atomic-reactor
    https://github.com/projectatomic/atomic-reactor/issues/228

Deployment notes on multi-tenant/multi-namespaced OpenShift for OSBS deploy (upstream does not recommend this, we&apos;re not going that route)
    https://gist.github.com/maxamillion/620d29ebb4894eb262e8

Deployment notes on dedicated OpenShift deploy for OSBS (this doc is continuing to be updated as work is being done)
    https://gist.github.com/maxamillion/7e71f252830d08da4e3a 

The OpenShift Ansible deployment documentation was incorrect which
lead to a wild goose chase of what was going wrong with the
deployment. Opened an issue upstream and submitted a fix.
    https://github.com/openshift/openshift-ansible/issues/403
    https://github.com/openshift/openshift-ansible/pull/404

Found that OpenShift is logging RSA private keys, for the sake of
OSBS this likely doesn&apos;t impact us since users won&apos;t be on the
builder and therefore won&apos;t have access to the log but it&apos;s still
concerning and I reported upstream.
    https://github.com/openshift/origin/issues/3951

atomic-reactor added backports-lzma but didn&apos;t update their spec, this
caused failures when testing tito built rpms from git
    https://github.com/projectatomic/atomic-reactor/issues/247

Another issue found with backports-lzma from inside the container,
this is still ongoing upstream to decide on a proper fix
    https://github.com/projectatomic/atomic-reactor/pull/246

Build issue with upstream atomic-reactor
- Added dependencies to runtime without adding them to the internal
docker build container or the spec file.
    https://github.com/projectatomic/atomic-reactor/issues/247
    https://github.com/projectatomic/atomic-reactor/pull/252
    https://github.com/projectatomic/atomic-reactor/pull/246
Also some changes made to the project file layout and not updated in the spec
    https://github.com/projectatomic/atomic-reactor/issues/250
    https://github.com/projectatomic/atomic-reactor/pull/251

Ambiguous naming in the openshift-ansible repo (concern for Fedora Infra)
  Unfortunately the names &apos;master&apos; and &apos;node&apos; are used to identify
host groups in their ansible configs which is extremely vague. This
issue has been brought up but broke something else so the commit has
been reverted and this will be revisited.
    https://github.com/openshift/openshift-ansible/pull/423

atomic-reactor dep issue on RHEL7 because python-websocket-client version too old
    https://github.com/projectatomic/atomic-reactor/issues/262

Dusty Mabe found an issue where docker changed default functionality
and it turns out that the docker fedora package is in violation of all
sorts of guidlelines. I&apos;ve become a co-maintainer and plan to work on
fixing asap. It&apos;s in bad shape, more on this as I find time to work on
it.
    https://bugzilla.redhat.com/show_bug.cgi?id=1252168
    https://github.com/release-engineering/koji-containerbuild/issues/9

Started some work on breaking out the docker package properly, found
that docker-selinux had no license. This has been resolved upstream.
    https://github.com/fedora-cloud/docker-selinux/issues/6

atomic-reactor fails on python-six verson for EL7
    https://github.com/projectatomic/atomic-reactor/issues/286

docker 1.7 is broken because of Red Hat patches (not upstream&apos;d)
    https://github.com/docker/docker/issues/12487#issuecomment-135550256

docker 1.8 is broken because of Red Hat patches (not upstream&apos;d)
    https://bugzilla.redhat.com/show_bug.cgi?id=1258037

Fix up some openshift origin spec file problems found in osbs testing
with v1.0.5.
    https://github.com/openshift/origin/pull/4413

RFE docs on koji-container build what to do after initial install (I
ended up figuring this out, I have plans to submit a PR with added as
soon as I find the time).
       https://github.com/release-engineering/koji-containerbuild/issues/11

fix paths for koji-containerbuild spec file
       https://github.com/release-engineering/koji-containerbuild/pull/12</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8602199</commentid>
    <comment_count>6</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-09-03 07:38:53 -0400</bug_when>
    <thetext>Change moved from Category:ChangeAcceptedF23 to Category:ChangePageIncomplete.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8603243</commentid>
    <comment_count>7</comment_count>
    <who name="Matthew Miller">mattdm</who>
    <bug_when>2015-09-03 10:56:02 -0400</bug_when>
    <thetext>Should this be resubmitted to fesco as an F24 change?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8605468</commentid>
    <comment_count>8</comment_count>
    <who name="Tomas Tomecek">ttomecek</who>
    <bug_when>2015-09-04 03:48:28 -0400</bug_when>
    <thetext>Current status is that Fedora will have full OSBS deployment (openshift with builder image with atomic-reactor preinstalled inside), as described in e.g. [1]. I think it would be good idea to write down precise architecture of final solution (how will authentication work, what workflow for building images will be used, how will builder image be updated, will there be stage and prod? ...).

Adam, are you planning to write such design and if so, can we (osbs upstream) assist with that somehow?

[1] https://github.com/projectatomic/osbs-client/blob/master/docs/osbs_instance_setup.md</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8607040</commentid>
    <comment_count>9</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2015-09-04 11:43:34 -0400</bug_when>
    <thetext>For the sake of posterity, the proof of concept atomic-reactor koji plugin was evaluated and decided against not because it was a bad option but because we would have had to re-implement a lot of the functionality the the koji-containerbuild plugin already delivers and by the time we were done it would not have been much more simple of an approach if at all. The koji-containerbuild plugin provides introspection into the resulting built image in order to verify that the contents of the image originated from the koji build sytem, provides a manifest of the included content, among other reproduce-ability features that the release engineering team is interested in. So, for the sake of not re-inventing the wheel specifically for Fedora and to align with others in the upstream community it was decided to go with koji-containerbuild backed by OSBS which is comprised of OpenShift V3, osbs-client, atomic-reactor, and docker. The above log is a listing of various issues found along the way with each of these very actively developed components.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8607041</commentid>
    <comment_count>10</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2015-09-04 11:45:13 -0400</bug_when>
    <thetext>Tomas,
    I would love to work together on the final design, there are some aspects of the authentication that need hashing out and I would appreciate your help with. I&apos;ll sync with you off-BZ and once we have something we can update here with information.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8610841</commentid>
    <comment_count>11</comment_count>
    <who name="Tomáš Hozza">thozza</who>
    <bug_when>2015-09-07 05:21:44 -0400</bug_when>
    <thetext>So just to double check, the change is moved to F24 due to incompleteness?


(In reply to Matthew Miller from comment #7)
&gt; Should this be resubmitted to fesco as an F24 change?

Yes, this is the case with any change that is moved to the next release.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8649514</commentid>
    <comment_count>12</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2015-09-18 11:31:27 -0400</bug_when>
    <thetext>Yes, this change has been moved to F24.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8926773</commentid>
    <comment_count>13</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2015-12-17 09:50:08 -0500</bug_when>
    <thetext>*** Bug 1292478 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8978121</commentid>
    <comment_count>14</comment_count>
    <who name="Amanda Carter">acarter</who>
    <bug_when>2016-01-13 16:56:39 -0500</bug_when>
    <thetext>=Status update=

Completed
 - OpenShift Origin change is completed
 - Internal changes to support v2 completed
 - OSBS running on F23
 - distgit changes to support containers
 - fedpkg changes to support containers
 - pkgdb changes to support containers


Currently working on
 - Proposal for a containers committee to make decisions about packaging, naming, and other standards
 - Filing RFEs with Taskotron &amp; to test containers
 - Packaging pulp &amp; pulp plugins for Fedora
 - Ansible for OSBS


Next up
 - Deploying the koji-containerbuild plugin
 - rhpkg changes to support containers


Risks / notes
 - Due to timelines and complexity, deploying Pulp in prod is at risk for F24 Alpha; we have a contingency plan for this if needed and will target it at a later date</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9093078</commentid>
    <comment_count>15</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-02-24 09:26:19 -0500</bug_when>
    <thetext>On 2016-Feb-23, we have reached Fedora 24 Change Checkpoint: Completion deadline (testable).

At this point, all accepted changes should be substantially complete, and testable. Additionally, if a change is to be enabled by default, it must be so enabled at Change Completion deadline.

Change tracking bug should be set to the MODIFIED state to indicate it achieved completeness.

Incomplete and non testable Changes will be reported to FESCo on 2016-Feb-26 meeting.  Contingency plan for System Wide Changes, if planned for Alpha (or in case of serious doubts regarding Change completion), will be activated.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9098477</commentid>
    <comment_count>16</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-02-25 13:08:26 -0500</bug_when>
    <thetext>Current status:
 - The Fedora OSBS System deploy-able via Fedora Infrastructure Ansible Playbooks
 - Testing osbs deployment is in place
 - OSBS builds can be completed (however not yet tied to koji)
 - docker-distribution registry is deploy-able via Fedora Infrastructure Ansible Playbooks
 - Testing docker-distribution registry is in place
 - koji-containerbuild plugin has a patch for Ansible playbooks, but there are Infrastructure networking concerns that need to be sorted out to allow the builder network to talk to OSBS
 - Request for Resources has been placed for both Stage and Production environment (these will be deployed with same Ansible Roles as testing environment just with environment configuration changes as needed)
 - distgit has been &quot;namespaced&quot; to allow for docker/ and rpms/ namespaces (allowing builds for both via fedpkg)

Things not yet done:
 - fedpkg still needs some config entries to enable &apos;fedpkg container-build&apos;
 - deployment to stage and prod (pending network configs, as listed above)
 - testing the system end-to-end

Risks:
 - Once everything is deployed and in place, it might not work

Fallback plan:
 - Worst case scenario, this gets pushed to F25 since it won&apos;t impact any current Fedora deliverables. It&apos;s goal is to enable new deliverables in the future.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9142627</commentid>
    <comment_count>17</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-03-11 14:55:07 -0500</bug_when>
    <thetext>Everything is deployed, we are testing but running into a potential NSS bug. 
- https://github.com/release-engineering/koji-containerbuild/issues/25


Also, patches are in for fedpkg/rpkg
- https://pagure.io/rpkg/pull-request/36
- https://pagure.io/fedpkg/pull-request/12</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9176962</commentid>
    <comment_count>18</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-03-24 10:49:05 -0400</bug_when>
    <thetext>Just an update here, we&apos;re having to rework the way that the OSBS/Koji integration functions because of some changes with docker v2 images.

    We have a new plan, all builds will be Content Generators:

    - koji-containerbuild still starts OSBS build for builds explicitly
      requested by developers, but does *not* create a Koji Build for it,
      only the createContainer Koji Task. It will fetch logs from the OSBS
      build, but not the &apos;docker save&apos; output.

    - osbs-client always enables the koji_promote plugin for prod builds,
      regardless of whether chain rebuild triggers are enabled (need to
      figure out how to handle scratch builds)

    - koji_promote plugin runs CG import for all builds, not just for
      automated rebuilds

    I&apos;m going to be taking a pass at patching koji-containerbuild,
    osbs-client, and atomic-reactor while twaugh is afk on PTO this week.

        https://github.com/projectatomic/atomic-reactor/issues/435
        https://github.com/projectatomic/osbs-client/issues/366
        https://github.com/release-engineering/koji-containerbuild/issues/27
        https://github.com/projectatomic/osbs-client/issues/367

    I now have patches in my own branch of each project and am iterating as
    I test the code (hope to have this done within a day or two).

        https://github.com/maxamillion/osbs-client/tree/content-generator
        https://github.com/maxamillion/koji-containerbuild/tree/content-generator
        https://github.com/maxamillion/atomic-reactor/tree/content-generator

    I&apos;m doing builds in my COPR space here (in case anyone is interested):

        https://copr.fedorainfracloud.org/coprs/maxamillion/atomic-reactor

    Request for koji account to enable Content Generator Imports
        https://fedorahosted.org/rel-eng/ticket/6380</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9176966</commentid>
    <comment_count>19</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-03-24 10:50:17 -0400</bug_when>
    <thetext>Also as a note, I&apos;m working around the pycurl error for now by just calling the osbs-client tools via a subprocess call. This is just a temporary fix to not block forward progress on everything else.

https://github.com/maxamillion/koji-containerbuild/tree/shell-out</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9205223</commentid>
    <comment_count>20</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-04-04 12:16:13 -0400</bug_when>
    <thetext>We have working builds with content generator import:

        $ fedpkg --config ~/.fedpkg-stg.conf container-build
        Created task: 90071655
        Task info:
               http://koji.stg.fedoraproject.org/koji/taskinfo?taskID=90071655
        Watching tasks (this may be safely interrupted)...
        90071655 buildContainer (noarch): free
        90071655 buildContainer (noarch): free
            -&gt; open (buildvm-01.stg.phx2.fedoraproject.org)
              90071657 createContainer (x86_64): free
              90071657 createContainer (x86_64): free
                -&gt; open (buildvm-01.stg.phx2.fedoraproject.org)
              90071657 createContainer (x86_64): open
                (buildvm-01.stg.phx2.fedoraproject.org) -&gt; closed
              0 free  1 open  1 done  0 failed
              90071655 buildContainer (noarch): open
                (buildvm-01.stg.phx2.fedoraproject.org) -&gt; closed
              0 free  0 open  2 done  0 failed

        90071655 buildContainer (noarch) completed successfully

    Content Generator Import:
        http://koji.stg.fedoraproject.org/koji/buildinfo?buildID=741588

Pull Requests upstream to enable this:
    https://github.com/projectatomic/atomic-reactor/pull/445
    https://github.com/projectatomic/osbs-client/pull/378
    https://github.com/release-engineering/koji-containerbuild/pull/32

There will still be some deployment work needed into the Fedora Infra, but I already have the Request For Resources filed and fulfilled so there are no blockers.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9254904</commentid>
    <comment_count>21</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-04-20 10:22:25 -0400</bug_when>
    <thetext>This has been completely ansible-ized and deployed on the new stage VMs (also can push-button destroy and redeploy it all). Testing end-to-end builds is passing. We need to get some patches into Fedora proper before going to production and that is being worked on now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9255066</commentid>
    <comment_count>22</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-04-20 11:02:15 -0400</bug_when>
    <thetext>On 2016-Apr-19 we reached the &quot;Change Checkpoint: 100% Code Complete Deadline&quot; milestone for Fedora 24 release. At this point all the Changes not at least in in &quot;ON_QA&quot; state should be brought to FESCo for review. Please update the state of this bug to &quot;ON_QA&quot; if it is already 100% completed. Please let me know in case you have any trouble with the implementation and the Change needs any help or review.

Thanks, Jan</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9257764</commentid>
    <comment_count>23</comment_count>
    <who name="Adam Miller">admiller</who>
    <bug_when>2016-04-21 09:12:03 -0400</bug_when>
    <thetext>This is code complete, deployed, and testable. Marking ON_QA.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>