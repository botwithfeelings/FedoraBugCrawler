<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1333105</bug_id>
          
          <creation_ts>2016-05-04 12:28:00 -0400</creation_ts>
          <short_desc>ssh-agent enters busy loop when running out of fds</short_desc>
          <delta_ts>2017-03-21 10:28:59 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>openssh</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>RAWHIDE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Lennart Poettering">lpoetter</reporter>
          <assigned_to name="Jakub Jelen">jjelen</assigned_to>
          <cc>jjelen</cc>
    
    
    <cc>mattias.ellert</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>tmraz</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-21 10:28:59</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          <external_bugs name="OpenSSH Project">2576</external_bugs>
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9292665</commentid>
    <comment_count>0</comment_count>
    <who name="Lennart Poettering">lpoetter</who>
    <bug_when>2016-05-04 12:28:09 -0400</bug_when>
    <thetext>ssh-agent starts eating 100% if it gets bombarded by connections, and runs out of file descriptors to use. Looking at strace, it starts to cycle in a select() loop, where the listening AF_UNIX socket is reported active, which makes ssh-agent invoke accept() which will then fail with EMFILE. It will then immediately invoke select() again, and be in a busy loop from then on.

I figure ssh-agent should enforce a limit on concurrent connections (that is much lower than RLIMIT_NOFILE) and quickly terminate further incoming connections when that limit is hit. Most internet software handles this that way, and I figure ssh-agent should do that too for incoming local clients.

I noticed that while creating a ton of ssh connections to my local system in a tight loop, which uses the ssh keyring.

(When ssh-agent is in this mode, and you start further ssh instances with the &amp; suffix in a shell (to make it background), then they will also enter a busy loop handling of SIGTTOU. I don&apos;t have further details about this, though, was too lazy to figure out what is really going on there).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9292668</commentid>
    <comment_count>1</comment_count>
    <who name="Lennart Poettering">lpoetter</who>
    <bug_when>2016-05-04 12:29:13 -0400</bug_when>
    <thetext>That was supposed to say &quot;starts eating 100% CPU&quot;...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9362255</commentid>
    <comment_count>2</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-05-26 11:01:26 -0400</bug_when>
    <thetext>I was trying to burn my virtual box with a lot of requests to ssh-agent but only with partial success. But the behavior you explain sounds possible.

My test case:

  eval `ulimit -n 10; ssh-agent`
  ssh-add rsa
  cat rsa.pub &gt;&gt; .ssh/authorized_keys
  for i in `seq 1 128`; do ssh localhost id &amp; done
  ls /proc/$SSH_AGENT_PID/fd/ | wc -w

and I am left with few cycling ssh processes in some cases, but not with the ssh-agent live-locked.

This sounds like reasonable feature for upstream. I will check that probably next week what can we do here.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9368880</commentid>
    <comment_count>3</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-05-30 07:38:15 -0400</bug_when>
    <thetext>&gt; Most internet software handles this that way.

SSHD as an internet software handles it too, but ssh-agent is probably not considered as an internet software since it is not facing internet directly.

Parallel tests showed that it is quite hard to reach even the 10 FDs limit with single pair of VMs. Though, handling this case better way would make sense.

The exact way of fixing this is probably up to the upstream developers. Opened upstream bug [1].

[1] https://bugzilla.mindrot.org/show_bug.cgi?id=2576</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9557569</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-07-27 06:40:16 -0400</bug_when>
    <thetext>openssh-7.2p2-11.fc24 selinux-policy-3.13.1-191.8.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-99191c4aab</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9557615</commentid>
    <comment_count>5</comment_count>
    <who name="Lukas Vrabec">lvrabec</who>
    <bug_when>2016-07-27 06:52:09 -0400</bug_when>
    <thetext>Reverting to NEW state. BZ was switched to MODIFIED due to wrong bodhi update.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10261609</commentid>
    <comment_count>6</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2017-03-21 10:28:59 -0400</bug_when>
    <thetext>This should be fixed in rawhide (upstream openssh-7.5 version).</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>