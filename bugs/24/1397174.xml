<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1397174</bug_id>
          
          <creation_ts>2016-11-21 14:15:00 -0500</creation_ts>
          <short_desc>Create internal repo from packages in cache</short_desc>
          <delta_ts>2017-05-19 15:45:25 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>dnf</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CANTFIX</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Triaged</keywords>
          <priority>medium</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Robin A. Meade">robin.a.meade</reporter>
          <assigned_to>rpm-software-management</assigned_to>
          <cc>jmracek</cc>
    
    
    <cc>kparal</cc>
    
    
    <cc>mluscon</cc>
    
    
    <cc>packaging-team-maint</cc>
    
    
    <cc>robin.a.meade</cc>
    
    
    <cc>rpm-software-management</cc>
    
    
    <cc>vmukhame</cc>
    
    
    <cc>vondruch</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-05-19 04:47:52</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9909750</commentid>
    <comment_count>0</comment_count>
    <who name="Robin A. Meade">robin.a.meade</who>
    <bug_when>2016-11-21 14:15:02 -0500</bug_when>
    <thetext>A while back I enbabled keepcache=1 so that I&apos;d be able to undo transactions.

Today I tried and it didn&apos;t work. I wanted to undo transaction 151, the last transaction. This is what I did:

$ sudo dnf history list | tac | tail
   144 | --refresh update -y      | 2016-11-10 08:00 | I, U           |   24   
   145 | --refresh update -y      | 2016-11-12 12:41 | I, U           |   52 EE
   146 | --refresh update -y      | 2016-11-14 08:03 | Update         |   14 EE
   147 | --refresh update -y      | 2016-11-15 10:47 | Update         |    1   
   148 | --refresh update -y      | 2016-11-17 08:40 | E, I, U        |   18   
   149 | install key-mon          | 2016-11-17 09:17 | Install        |    2   
   150 | --refresh update -y      | 2016-11-19 18:21 | E, I, U        |   34   
   151 | --refresh update -y      | 2016-11-21 08:03 | Update         |    3   

$ sudo dnf history undo 151
Last metadata expiration check: 1:03:05 ago on Mon Nov 21 08:02:31 2016.
Undoing transaction 151, from Mon Nov 21 08:03:03 2016
    Upgraded libsndfile-1.0.25-20.fc24.x86_64 @koji-override-0
    Upgrade             1.0.27-1.fc24.x86_64  @updates
    Upgraded wxBase3-3.0.2-26.fc24.x86_64     @updates
    Upgrade          3.0.2-29.fc24.x86_64     @updates
    Upgraded wxGTK3-3.0.2-26.fc24.x86_64      @updates
    Upgrade         3.0.2-29.fc24.x86_64      @updates
No package wxGTK3-0:3.0.2-26.fc24.x86_64 available.
Error: An operation cannot be undone

It says the package is not available, but it is present in the cache:

$ ls -l /var/cache/dnf/updates-c4f1c95f64c2b794/packages/wxGTK3*
-rw-r--r--. 1 root root 5566614 Oct 14 08:28 /var/cache/dnf/updates-c4f1c95f64c2b794/packages/wxGTK3-3.0.2-26.fc24.x86_64.rpm
-rw-r--r--. 1 root root 5566486 Nov 21 08:03 /var/cache/dnf/updates-c4f1c95f64c2b794/packages/wxGTK3-3.0.2-29.fc24.x86_64.rpm</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9915633</commentid>
    <comment_count>1</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-11-23 05:56:59 -0500</bug_when>
    <thetext>I second that ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9934649</commentid>
    <comment_count>2</comment_count>
    <who name="Michal Luscon">mluscon</who>
    <bug_when>2016-11-28 08:25:13 -0500</bug_when>
    <thetext>Hi,

DNF currently doesn&apos;t create local repos from downloaded packages in cache. You will have to specify those repos manually until we implement this RFE.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9934897</commentid>
    <comment_count>3</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2016-11-28 09:18:52 -0500</bug_when>
    <thetext>This makes the reverts and downgrades very hard and I&apos;d say this is regression in comparison to YUM. In YUM, I could always use the &quot;history undo&quot; ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9934919</commentid>
    <comment_count>4</comment_count>
    <who name="Michal Luscon">mluscon</who>
    <bug_when>2016-11-28 09:24:10 -0500</bug_when>
    <thetext>Ok, fair point -&gt; raising prio</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10200842</commentid>
    <comment_count>5</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-02 03:13:08 -0500</bug_when>
    <thetext>According to my knowledge there is local plugin that support requested functionality. Well I am not a user of that plugin and probably there is a behavior that is different from request presented here. Please can you provide a feedback?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10201377</commentid>
    <comment_count>6</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2017-03-02 06:02:52 -0500</bug_when>
    <thetext>&quot;Automatically copy all downloaded packages to a repository on the local filesystem&quot;

I don&apos;t want to copy the packages anywhere, they are stored in DNF cache directory, why would I want to copy them somewhere? I just want to be able to use them for &quot;downgrade&quot; it that case happens. Using Rawhide, this makes big difference.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10207602</commentid>
    <comment_count>7</comment_count>
    <who name="Robin A. Meade">robin.a.meade</who>
    <bug_when>2017-03-03 16:13:33 -0500</bug_when>
    <thetext>I installed the &apos;local&apos; plugin to give it a try.

Ran into bug 1209862. Workaround:
sudo mkdir -p /var/lib/dnf/plugins/local
sudo /usr/bin/createrepo_c /var/lib/dnf/plugins/local

I disabled keepcache in dnf.conf because otherwise the disk usage devoted to cached packages on my machine would double from approximately 6 GB to 12 GB over a 6 month period.

It will take some time to accumulate packages in my &apos;local&apos; repo and be able to test whether it makes dnf&apos;s undo functionality work in the situation of old package missing from remote repo but present in &apos;local&apos; repo. I&apos;ll report back when I&apos;ve tested this.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10211302</commentid>
    <comment_count>8</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-06 07:58:12 -0500</bug_when>
    <thetext>The problem with missing directory in LOCAL plugin will be fixed with pull-request https://github.com/rpm-software-management/dnf-plugins-extras/pull/88 . 
Thanks all for participation and testing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10217855</commentid>
    <comment_count>9</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-07 13:32:19 -0500</bug_when>
    <thetext>Hi everyone, I have create pull-request (https://github.com/rpm-software-management/dnf/pull/759) that introduce requested feature. Hope that it will work like you expect. Please if you will try it, I will be very happy. On request I can provide packages for your Fedora version.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219132</commentid>
    <comment_count>10</comment_count>
    <who name="Robin A. Meade">robin.a.meade</who>
    <bug_when>2017-03-07 23:14:34 -0500</bug_when>
    <thetext>I&apos;d like to try it. May I have packages for Fedora 25?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219513</commentid>
    <comment_count>11</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-08 02:52:58 -0500</bug_when>
    <thetext>You will need to enable two copr repositories, then install dnf with patch
How to install:
1. sudo dnf copr enable rpmsoftwaremanagement/dnf-nightly
2. sudo dnf copr enable jmracek/dnf-use-cached-rpm 
3. sudo dnf install dnf-2.1.0-1.git.26.e9603f8.fc25 --exclude dnf-2.1.0-1.git.26.e9603f8.fc25.src 

Hope that it will work</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219727</commentid>
    <comment_count>12</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2017-03-08 04:08:46 -0500</bug_when>
    <thetext>(In reply to Jaroslav Mracek from comment #11)
&gt; 1. sudo dnf copr enable rpmsoftwaremanagement/dnf-nightly

Could you enable builds for Rawhide/F27 plzz</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10220132</commentid>
    <comment_count>13</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-08 05:26:03 -0500</bug_when>
    <thetext>For rawhide:

1. sudo dnf copr enable jmracek/dnf-use-cached-rpm 
2. sudo dnf install dnf-2.1.0-1.git.26.e9603f8*

Hope that it will work

PS: The enabling of rawhide builds for dnf-nightly repo is on the way :-)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10226007</commentid>
    <comment_count>14</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-09 13:00:41 -0500</bug_when>
    <thetext>The proposed patch has downside therefore I made an investigation how yum handle it. I have found no support for requested feature in yum. I asked for help Valentina Mukhamedzhanova as a YUM expert, but she also didn&apos;t find any support for loading of cached rpms that are not anymore in repos. I would like to ask you if the information in Comment 3 is based on rawhide experience or RHEL?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10227842</commentid>
    <comment_count>15</comment_count>
    <who name="Vít Ondruch">vondruch</who>
    <bug_when>2017-03-10 05:56:16 -0500</bug_when>
    <thetext>(In reply to Jaroslav Mracek from comment #14)
&gt; The proposed patch has downside therefore I made an investigation how yum
&gt; handle it. I have found no support for requested feature in yum. I asked for
&gt; help Valentina Mukhamedzhanova as a YUM expert, but she also didn&apos;t find any
&gt; support for loading of cached rpms that are not anymore in repos. I would
&gt; like to ask you if the information in Comment 3 is based on rawhide
&gt; experience or RHEL?

Strange ... I&apos;d swear that I used either &quot;history undo&quot; or &quot;downgrade&quot; on Fedora and is stopped to work with DNF. Unfortunately, I cannot reproduce the behavior now, since I don&apos;t use YUM and I don&apos;t have the YUM cache populated :/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10232026</commentid>
    <comment_count>16</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-13 04:14:59 -0400</bug_when>
    <thetext>I am sorry but I have to reconsider my decision how to provide requested functionality. From my point of view the best solution would be to use local plugin, because presented solution in pullreguest from Comment 9 is not a secure approach (The packages added into repo don&apos;t have checksum from repodata therefore we cannot verify them, but exclude them from verification is even worse solution). I know that local plugin do not do that either (it copies files and on top of them it creates new metadata), but this is plugin, and not default dnf behavior. If there will be a problem with local plugin I can make a promise that I will try to solve it. Just report it in this bugzilla.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10428161</commentid>
    <comment_count>17</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-05-19 04:47:52 -0400</bug_when>
    <thetext>It looks like that work around with local plugin works, therefore we can close this request.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10430187</commentid>
    <comment_count>18</comment_count>
    <who name="Robin A. Meade">robin.a.meade</who>
    <bug_when>2017-05-19 15:45:25 -0400</bug_when>
    <thetext>Thank you. I confirm that the &apos;local&apos; plugin is a solution to the problem of dnf&apos;s undo functionality not working when old package is missing from remote repo.

A preferable solution, IMO, is for the remote repo to retain old packages (at least 1 previous). I&apos;ll make a separate request for that.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>