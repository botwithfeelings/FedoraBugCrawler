<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1373772</bug_id>
          
          <creation_ts>2016-09-07 02:39:00 -0400</creation_ts>
          <short_desc>Running systemd in fedora:rawhide container produces AVC denial about blk</short_desc>
          <delta_ts>2017-01-05 15:22:24 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Regression</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jan Pazdziora">jpazdziora</reporter>
          <assigned_to name="Lokesh Mandvekar">lsm5</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>jpazdziora</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.12.5-4.git03508cc.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-01-05 15:22:24</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9685179</commentid>
    <comment_count>0</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-09-07 02:39:56 -0400</bug_when>
    <thetext>Description of problem:

When /usr/sbin/init is run in container based on fedora:rawhide, AVC denial

type=AVC msg=audit(1473230214.607:567): avc:  denied  { create } for  pid=4774 comm=&quot;systemd&quot; name=&quot;blk&quot; scontext=system_u:system_r:svirt_lxc_net_t:s0:c163,c244 tcontext=system_u:object_r:svirt_sandbox_file_t:s0:c163,c244 tclass=blk_file permissive=1

is produced, in addition to the on tracked in bug 1373746.

Version-Release number of selected component (if applicable):

On the host:

kernel-4.7.2-201.fc24.x86_64
systemd-229-13.fc24.x86_64
selinux-policy-3.13.1-191.14.fc24.noarch
docker-1.10.3-26.git1ecb834.fc24.x86_64

In the container:

docker.io/fedora rawhide 3bcdeb6ee43b 3 weeks ago 174 MB
systemd-231-3.fc26.x86_64

How reproducible:

Deterministic.

Steps to Reproduce:
1. docker run --rm -ti -e container=docker -v /sys/fs/cgroup:/sys/fs/cgroup:ro --tmpfs /run --tmpfs /tmp fedora:rawhide /usr/sbin/init

Actual results:

On the host in audit.log, AVC denial

type=AVC msg=audit(1473230214.607:567): avc:  denied  { create } for  pid=4774 comm=&quot;systemd&quot; name=&quot;blk&quot; scontext=system_u:system_r:svirt_lxc_net_t:s0:c163,c244 tcontext=system_u:object_r:svirt_sandbox_file_t:s0:c163,c244 tclass=blk_file permissive=1

Expected results:

No AVC denial.

Additional info:

This is a regression against fedora:24:

docker.io/fedora 24 11a5107645d4 3 weeks ago 204.4 MB

Filing against docker as an initial estimate -- it is possible that the problem is in kernel, SELinux policy, systemd in the container, or the base image which enables something in the container which makes systemd do that write.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9685209</commentid>
    <comment_count>1</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-09-07 02:47:30 -0400</bug_when>
    <thetext>Also note 1373780. There is not progress/status shown with fedora:rawhide image so it&apos;s hard to say what the container actually does.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9685227</commentid>
    <comment_count>2</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-09-07 02:54:01 -0400</bug_when>
    <thetext>I also see this on Fedora 23 host with

selinux-policy-3.13.1-158.21.fc23.noarch
docker-1.10.3-24.gitf476348.fc23.x86_64
kernel-4.7.2-101.fc23.x86_64
systemd-222-16.fc23.x86_64

running fedora:rawhide.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9686488</commentid>
    <comment_count>3</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-09-07 08:25:45 -0400</bug_when>
    <thetext>I think systemd is creating blk and chr files during boot up.
If you take away the mknod capability does this problem go away?

--cap-drop=mknod</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9686934</commentid>
    <comment_count>4</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-09-07 10:12:44 -0400</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #3)
&gt; I think systemd is creating blk and chr files during boot up.
&gt; If you take away the mknod capability does this problem go away?
&gt; 
&gt; --cap-drop=mknod

Yes, it does, thank you. Does it mean that going forward this will be a mandatory option for unprivileged containers with systemd? Should systemd be able to detect if it is able to run the operation?

Also, the bug 1373780 is still present though -- no status. Is that related?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9687236</commentid>
    <comment_count>5</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-09-07 11:28:35 -0400</bug_when>
    <thetext>No I was just wondering if systemd would realize it does not have mknod so that it can work properly.  This is a fundamental difference between docker and me.  I don&apos;t believe we should allow containers to have mknod capabilities. Docker believes that trusting the devices cgroup to control which devices are able to be created in a container.

If you have control of your dockerfile, you should remove the capability.  The question I have to figure out is whether I want to allow or dontaudit this access.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990247</commentid>
    <comment_count>6</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-15 10:16:24 -0500</bug_when>
    <thetext>The issue is also present on Fedora 25, with docker-1.12.4-6.git1b5971a.fc25.x86_64 and container-selinux-1.12.4-6.git1b5971a.fc25.x86_64.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10033621</commentid>
    <comment_count>7</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-01-04 07:32:46 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #5)
&gt; The question I have to figure out is whether I want to allow or dontaudit
&gt; this access.

Dan, could we make the decision one way or another? Now that Fedora 25 is released and is our main version we test on, the AVC denial adds unnecessary noise to test results.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10034401</commentid>
    <comment_count>8</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-01-04 09:45:09 -0500</bug_when>
    <thetext>Jan can you make your container drop the mknod capability by default.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10034563</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-01-04 10:23:18 -0500</bug_when>
    <thetext>You mean in our tests? I don&apos;t see a way to specify that in the Dockerfile to make sure it is dropped by every user of the container image.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10035009</commentid>
    <comment_count>10</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-01-04 12:39:31 -0500</bug_when>
    <thetext>I have allowed the access in the last push to container-selinux.

513572d0fff7899196d57721ed81577ee3dc8414

Lokesh can you put out a new build of docker to include this fix?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10035241</commentid>
    <comment_count>11</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2017-01-04 14:04:03 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #10)
&gt; I have allowed the access in the last push to container-selinux.
&gt; 
&gt; 513572d0fff7899196d57721ed81577ee3dc8414
&gt; 
&gt; Lokesh can you put out a new build of docker to include this fix?

Talked to Lokesh, since I&apos;m already updating docker in Fedora I&apos;ll take care of this soon(ish).

Dan, this bugzilla is against F24 which still has docker-1.10.3. Should we update it in F24 then? Or, should we just update container-selinux for docker-1.12.x in F25 and Rawhide?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10035245</commentid>
    <comment_count>12</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-01-04 14:05:41 -0500</bug_when>
    <thetext>Lets just do it for F25 for now.  I am not sure container-selinux wold work with docker-1.10.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10036779</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-05 04:59:29 -0500</bug_when>
    <thetext>docker-1.12.5-4.git03508cc.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-e856fcc7db</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10038833</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-05 15:22:24 -0500</bug_when>
    <thetext>docker-1.12.5-4.git03508cc.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>