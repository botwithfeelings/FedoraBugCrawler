<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1402548</bug_id>
          
          <creation_ts>2016-12-07 14:24:00 -0500</creation_ts>
          <short_desc>Docker storage setup packaging seems to be wrong</short_desc>
          <delta_ts>2016-12-16 17:22:47 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Vivek Goyal">vgoyal</reporter>
          <assigned_to name="Antonio Murdaca">amurdaca</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>smahajan</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.10.3-55.gite03ddb8.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-16 17:22:47</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9965836</commentid>
    <comment_count>0</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:24:49 -0500</bug_when>
    <thetext>Description of problem:

Packaging of docker-storage-setup seems to be wrong. Looks like /usr/bin/docker-storage-setup is older while /usr/lib/docker-storage-setup/dss-child-read-write is newer.

And this breaks docker-storage-setup.


Version-Release number of selected component (if applicable):

docker-1.10.3

How reproducible:

Always

Steps to Reproduce:
1.
2.
3.

Actual results:


Expected results:


Additional info:</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965838</commentid>
    <comment_count>1</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 14:27:06 -0500</bug_when>
    <thetext>Vivek can you provide the correct versions you&apos;re expecting to have installed with docker-1.10.3? Like which commit exactly.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965840</commentid>
    <comment_count>2</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:28:21 -0500</bug_when>
    <thetext>To be specific, following commit had changed both the files. But we are seeing changes only in one file and other file does not have the corresponding changes.

commit ba0dcf3f02bee36f188164517911b20f8798a160
Author: Vivek Goyal &lt;vgoyal@redhat.com&gt;
Date:   Wed Nov 2 09:23:15 2016 -0400

    Create temporary mount in child process mount namespace</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965844</commentid>
    <comment_count>3</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:28:58 -0500</bug_when>
    <thetext>Version     : 1.10.3
Release     : 54.gite03ddb8.fc24</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965849</commentid>
    <comment_count>4</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:31:38 -0500</bug_when>
    <thetext>Antonio, wait a second. may be my observation is not right. We faced this on Shishir&apos;s system and I am not seeing it on my system. Let me figure out why this discrepancy is there.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965854</commentid>
    <comment_count>5</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:35:00 -0500</bug_when>
    <thetext>Shishir, I installed docker rpm on my F24 VM and I did not face this issue.

I am not sure why did you face this issue. Did you ever install newer /usr/lib/docker-storage-setup/dss-child-read-write on your system?

I know that you removed docker package and installed it fresh. And that should have take care of it.

So not sure what&apos;s going on.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965862</commentid>
    <comment_count>6</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:40:10 -0500</bug_when>
    <thetext>Ok, one problem I see is that /usr/lib/docker-storage-setup/dss-child-read-write did not even get installed on my system after docker installation.

I suspect that Shishir might have copied it manually on his system and that will explain the difference.

So core of the problem is that /usr/lib/docker-storage-setup/dss-child-read-write did not get installed on system while /usr/lib/docker-storage-setup is looking for that file.

unshare -m /usr/lib/docker-storage-setup/dss-child-read-write $PIPE1 $PIPE2 &amp;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965868</commentid>
    <comment_count>7</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:45:23 -0500</bug_when>
    <thetext>Side effect of this is that deferred deletion does not get enabled by default, despite the fact that kernel supports it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965872</commentid>
    <comment_count>8</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 14:46:23 -0500</bug_when>
    <thetext>Are you sure that that file should be installed with the commit of dss shipped with F24? This will become an update for F24 otherwise. 

I&apos;ll explain better. It could be that that file is missing because the dss shipped with Docker in F24 doesn&apos;t have that file. You could check the dss commit in the spec file for instance.

Otherwise I&apos;ll fix this by updating Docker in F24 (I wouldn&apos;t do this anymore for F24 but if it&apos;s necessary that&apos;s fine)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965883</commentid>
    <comment_count>9</comment_count>
    <who name="Vivek Goyal">vgoyal</who>
    <bug_when>2016-12-07 14:55:19 -0500</bug_when>
    <thetext>Antonio, This file is present in upstream commit.

I did &quot;fedpkg prep&quot; and then opened docker-storage-setup-ba0dcf3.tar.gz and it has dss-child-read-write.sh file.

So it is a packaging issue and requires adding this file in docker.spec.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9965888</commentid>
    <comment_count>10</comment_count>
    <who name="smahajan@redhat.com">smahajan</who>
    <bug_when>2016-12-07 14:59:59 -0500</bug_when>
    <thetext>I think this file (/usr/lib/docker-storage-setup/dss-child-read-write) was never part of the rpm install. I had build docker-storage-setup from the source, hence I got this file. and when I did rpm install of docker {docker-storage-setup}, /usr/lib/docker-storage-setup/docker-storage-setup was overwritten with the rpm version, however dss-child-read-write was never installed as part of the rpm install.

Just to double check, I did a `rpm remove docker` and `/usr/lib/docker-storage-setup/dss-child-read-write` was not removed {since it was not part of the install, `rpm remove` didn&apos;t cleaned it}.

Shishir</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966009</commentid>
    <comment_count>11</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 16:07:41 -0500</bug_when>
    <thetext>Vivek, the commit used in the spec for F24 is:

ba0dcf3f02bee36f188164517911b20f8798a160

The spec file already use &quot;make install&quot; to install this.

If you&apos;re getting a different /usr/bin/docker-storage-setup there must be something wrong in the repo or the commit used because, as said, the spec uses the Makefile.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966014</commentid>
    <comment_count>12</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 16:11:12 -0500</bug_when>
    <thetext>Specifically at that exact commit, I can see in the Makefile the following:

 13 .PHONY: install
 14 install:
 15
 16         install -D -m 755 docker-storage-setup.sh ${BINDIR}/docker-storage-setup


So, I would say it&apos;s very unlikely that the spec is messing something</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966023</commentid>
    <comment_count>13</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 16:15:22 -0500</bug_when>
    <thetext>(In reply to Vivek Goyal from comment #6)
&gt; Ok, one problem I see is that
&gt; /usr/lib/docker-storage-setup/dss-child-read-write did not even get
&gt; installed on my system after docker installation.
&gt; 
&gt; I suspect that Shishir might have copied it manually on his system and that
&gt; will explain the difference.
&gt; 
&gt; So core of the problem is that
&gt; /usr/lib/docker-storage-setup/dss-child-read-write did not get installed on
&gt; system while /usr/lib/docker-storage-setup is looking for that file.
&gt; 
&gt; unshare -m /usr/lib/docker-storage-setup/dss-child-read-write $PIPE1 $PIPE2 &amp;

On F25:

22:14:49 [~/koding/docker-storage-setup] ‹ba0dcf3› rpm -qf /usr/lib/docker-storage-setup/dss-child-read-write
docker-1.12.3-12.git97974ae.fc25.x86_64

I&apos;ll try on F24 as well but the spec hasn&apos;t changed anything between F24 and F25 wrt docker-storage-setup...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966024</commentid>
    <comment_count>14</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 16:16:58 -0500</bug_when>
    <thetext>(In reply to Vivek Goyal from comment #9)
&gt; Antonio, This file is present in upstream commit.
&gt; 
&gt; I did &quot;fedpkg prep&quot; and then opened docker-storage-setup-ba0dcf3.tar.gz and
&gt; it has dss-child-read-write.sh file.
&gt; 
&gt; So it is a packaging issue and requires adding this file in docker.spec.

this file is rightly included from what I can see on F24 spec:

 758 %dir %{dss_libdir}
 759 %{dss_libdir}/*

That means that everything under /usr/lib/docker-storage-setup/* gets included (because &quot;make install&quot; installed stuff under that...)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966033</commentid>
    <comment_count>15</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 16:25:04 -0500</bug_when>
    <thetext>I see what&apos;s happening, I&apos;m releasing an update (we did not release an update to include the fixed dss installation via make install...)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966034</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-07 16:25:39 -0500</bug_when>
    <thetext>docker-1.10.3-55.gite03ddb8.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-6e972cb2cf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966100</commentid>
    <comment_count>17</comment_count>
    <who name="smahajan@redhat.com">smahajan</who>
    <bug_when>2016-12-07 17:15:27 -0500</bug_when>
    <thetext>@runcom, 

sh-4.3# docker version
Client:
 Version:         1.10.3
 API version:     1.22
 Package version: docker-common-1.10.3-54.gite03ddb8.fc24.x86_64
 Go version:      go1.6.3
 Git commit:      e03ddb8/1.10.3
 Built:           
 OS/Arch:         linux/amd64

Server:
 Version:         1.10.3
 API version:     1.22
 Package version: docker-common-1.10.3-54.gite03ddb8.fc24.x86_64
 Go version:      go1.6.3
 Git commit:      e03ddb8/1.10.3
 Built:           
 OS/Arch:         linux/amd64


Shishir</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966104</commentid>
    <comment_count>18</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 17:17:16 -0500</bug_when>
    <thetext>Shishir, alright, please install https://bodhi.fedoraproject.org/updates/FEDORA-2016-6e972cb2cf as soon as it&apos;s in updates-testing - I&apos;m testing it right now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9966122</commentid>
    <comment_count>19</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-07 17:26:08 -0500</bug_when>
    <thetext>I can confirm the update I did in https://bodhi.fedoraproject.org/updates/FEDORA-2016-6e972cb2cf fixes this issue:

[root@fedora ~]# rpm -qf /usr/lib/docker-storage-setup/dss-child-read-write
docker-1.10.3-55.gite03ddb8.fc24.x86_64

Vivek please test it out and give karma if it&apos;s ok.
Thanks guys.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9969291</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-08 14:23:36 -0500</bug_when>
    <thetext>docker-1.10.3-55.gite03ddb8.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-6e972cb2cf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9995001</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-16 17:22:47 -0500</bug_when>
    <thetext>docker-1.10.3-55.gite03ddb8.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>