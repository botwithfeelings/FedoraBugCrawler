<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1382988</bug_id>
          
          <creation_ts>2016-10-08 17:52:00 -0400</creation_ts>
          <short_desc>Mariadb server fail to start</short_desc>
          <delta_ts>2016-12-13 18:10:32 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>mariadb</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter>vadim</reporter>
          <assigned_to name="Michal Schorm">mschorm</assigned_to>
          <cc>dciabrin</cc>
    
    
    <cc>hhorak</cc>
    
    
    <cc>jstanek</cc>
    
    
    <cc>mmuzila</cc>
    
    
    <cc>mschorm</cc>
    
    
    <cc>praiskup</cc>
    
    
    <cc>tflink</cc>
    
    
    <cc>vadim</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-13 18:10:32</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9775539</commentid>
    <comment_count>0</comment_count>
    <who name="">vadim</who>
    <bug_when>2016-10-08 17:52:36 -0400</bug_when>
    <thetext>Description of problem:
Mariadb server fail to start after fresh install

Version-Release number of selected component (if applicable):
mariadb-server-10.1.17-1.fc24.x86_64

How reproducible:
Always Reproduceble

Steps to Reproduce:
1. Install Fedora 24
2. Install mariadb-server
3. make &quot;systemctl start mariadb&quot;

Actual results:
Job for mariadb.service failed because the control process exited with error code. See &quot;systemctl status mariadb.service&quot; and &quot;journalctl -xe&quot; for details.

Expected results:
The service is started

Additional info:
/usr/lib/systemd/system/mariadb.service has ExecStartPre=/usr/libexec/mysql-prepare-db-dir

/usr/libexec/mysql-prepare-db-dir failed.

How to fix:

--- /usr/libexec/mysql-prepare-db-dir.orig      2016-10-09 00:27:56.258271675 +0300
+++ /usr/libexec/mysql-prepare-db-dir   2016-10-09 00:26:32.261895113 +0300
@@ -20,7 +20,7 @@
 should_initialize ()
 {
     case `ls_check_datadir &quot;$1&quot;` in
-    &quot;&quot;|lost+found) true ;;
+    &quot;&quot;|lost+found|*.err) true ;;
     *) false ;;
     esac
 }</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9784836</commentid>
    <comment_count>1</comment_count>
    <who name="Honza Horak">hhorak</who>
    <bug_when>2016-10-12 09:59:10 -0400</bug_when>
    <thetext>It works in my case on really fresh machine, so your machine was not as clear as mine :) Is it the reason of failing  that there has been some log file from previous run, in the /var/lib/mysql directory?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9785685</commentid>
    <comment_count>2</comment_count>
    <who name="">vadim</who>
    <bug_when>2016-10-12 14:18:02 -0400</bug_when>
    <thetext>This error is happens when /var/lib/mysql is empty.

You can look into /usr/libexec/mysql-prepare-db-dir

1. The script creates errorlog at line 59

# Set up the errlogfile with appropriate permissions
touch &quot;$errlogfile&quot;
ret=$?

2. The script calls should_initialize() at line 79

=====
unpatched variant at line 20

should_initialize ()
{
    case `ls_check_datadir &quot;$1&quot;` in
    &quot;&quot;|lost+found) true ;;
    *) false ;;
    esac
}
====

3. should_initialize return false, because error log is created at step 1

4. The script skip lines 80..122 (&quot;Initializing MariaDB database&quot;) and jumps to line 124 (&quot;Database MariaDB is probably initialized in $datadir already, nothing is done.&quot;). But database is NOT initialized, only error log was created.

My package is mariadb-server-10.1.17-1.fc24.x86_64

Your installation works, because your error log file is placed outside /var/lib/mysql via option log-error=/var/log/mariadb/mariadb.log
 in /etc/my.cnf.d/mariadb-server.cnf

I use config file, based on /usr/share/mariadb/my-innodb-heavy-4G.cnf, without this option.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9891959</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2016-11-15 05:32:37 -0500</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9896151</commentid>
    <comment_count>4</comment_count>
    <who name="Michal Schorm">mschorm</who>
    <bug_when>2016-11-16 05:45:36 -0500</bug_when>
    <thetext>You are right.

It is unusual use-case, but it seems, nothing else should be impacted by your patch.

I&apos;ll work on moving this patch into Rawhide. It should be released with 10.1.19.2, but I will notice you, when it comes live.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9898013</commentid>
    <comment_count>5</comment_count>
    <who name="">vadim</who>
    <bug_when>2016-11-16 14:21:10 -0500</bug_when>
    <thetext>There is /usr/share/mariadb/my-innodb-heavy-4G.cnf in the mariadb package.

Use case:
1. Install
2. Make config from my-innodb-heavy-4G.cnf

I think, that log-error=/var/log/mariadb/mariadb.log option must be added into all config examples  /usr/share/mariadb/*</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9941708</commentid>
    <comment_count>6</comment_count>
    <who name="Tim Flink">tflink</who>
    <bug_when>2016-11-30 02:38:01 -0500</bug_when>
    <thetext>I&apos;m hitting the same problem in F25 because I&apos;m also using a custom config with the log file in /var/lib/mysql/

Are there plans to get this patch into more than just rawhide or do I need to be fixing my config so that initialization doesn&apos;t blow up?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9941912</commentid>
    <comment_count>7</comment_count>
    <who name="Tim Flink">tflink</who>
    <bug_when>2016-11-30 03:45:22 -0500</bug_when>
    <thetext>(In reply to Tim Flink from comment #6)
&gt; I&apos;m hitting the same problem in F25 because I&apos;m also using a custom config
&gt; with the log file in /var/lib/mysql/
&gt; 
&gt; Are there plans to get this patch into more than just rawhide or do I need
&gt; to be fixing my config so that initialization doesn&apos;t blow up?

Reading that again, it sounds a bit more combative and less productive than I intended. I&apos;ve already changed my config to move the log files in question.

This took a bit longer to debug than I&apos;d like to admit, though and it&apos;d be nice to see the patch from the description applied to F24 and F25 and/or the example configs changed to move the log file. I also based my config off of an example from a past Fedora and I suspect that there are more of two of us who have.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9943211</commentid>
    <comment_count>8</comment_count>
    <who name="Michal Schorm">mschorm</who>
    <bug_when>2016-11-30 09:14:33 -0500</bug_when>
    <thetext>I confirm that I plan to get this patch to all Fedora branches that use mariadb-10.1.*

Actually, the suggested patch from [comment 1] is pushed to all - f24, f25, f26, but waiting to build.

I would like to add missing options to all config examples in [comment 5], but it could take some time to find them all and test them.

I can build current f25 branch for you, to have the patch faster, if you are interested.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9943296</commentid>
    <comment_count>9</comment_count>
    <who name="Michal Schorm">mschorm</who>
    <bug_when>2016-11-30 09:33:52 -0500</bug_when>
    <thetext>I do most of my testing in COPR.
Those builds could be what you are looking for:

https://copr.fedorainfracloud.org/coprs/mschorm/MariaDB-F25/build/482243/
https://copr.fedorainfracloud.org/coprs/mschorm/MariaDB-F24/build/482244/

Those builds should contain patch in [comment 1], but not updated example config files. They are builded directly from content pushed in mariadb branches.

Take a look, this could give me time to release this bugfix as a one.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9963489</commentid>
    <comment_count>10</comment_count>
    <who name="Michal Schorm">mschorm</who>
    <bug_when>2016-12-07 03:04:18 -0500</bug_when>
    <thetext>https://bodhi.fedoraproject.org/updates/FEDORA-2016-a4879d8f3a
https://bodhi.fedoraproject.org/updates/FEDORA-2016-96c333c654</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9982634</commentid>
    <comment_count>11</comment_count>
    <who name="Michal Schorm">mschorm</who>
    <bug_when>2016-12-13 18:10:32 -0500</bug_when>
    <thetext>Both builds has been successfully pushed to the stable repository.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>