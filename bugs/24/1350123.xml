<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1350123</bug_id>
          
          <creation_ts>2016-06-25 16:05:00 -0400</creation_ts>
          <short_desc>Python 3.5 is being built with the getrandom() syscall disabled</short_desc>
          <delta_ts>2016-10-10 12:07:44 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>python3</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1293703</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Nick Coghlan">ncoghlan</reporter>
          <assigned_to name="Tomas Orsava">torsava</assigned_to>
          <cc>bkabrda</cc>
    
    
    <cc>cstratak</cc>
    
    
    <cc>mhroncok</cc>
    
    
    <cc>pviktori</cc>
    
    
    <cc>rkuska</cc>
    
    
    <cc>tomspur</cc>
    
    
    <cc>torsava</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>python3-3.5.1-17.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-23 12:19:18</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9452560</commentid>
    <comment_count>0</comment_count>
    <who name="Nick Coghlan">ncoghlan</who>
    <bug_when>2016-06-25 16:05:19 -0400</bug_when>
    <thetext>Description of problem:

Python 3.5 doesn&apos;t use the getrandom() syscall, even though the Fedora kernel provides it.

As a first guess, I&apos;d expect this might be due to the Koji buildroots running on a RHEL kernel rather than a Fedora one.

Version-Release number of selected component (if applicable):

python3-3.5.1-8.fc24.x86_64

How reproducible:

Always

Steps to Reproduce:

python3 -c &apos;import sysconfig; print(sysconfig.get_config_vars()[&quot;HAVE_GETRANDOM_SYSCALL&quot;])&apos;

Actual results:

Prints 0

Expected results:

Prints 1

Additional info:

I confirmed a locally built Python 3.5 prints 1 as expected.

This means Fedora&apos;s system Python 3 package is currently still reading directly from /dev/urandom, and hence wasn&apos;t affected by the potentially blocking call to the getrandom() API introduced in Python 3.5.0 and 3.5.1 (which is being reverted to non-blocking behaviour in 3.5.2).

This is likely to prove a more significant problem in Python 3.6, as we&apos;re looking to use the getrandom() syscall to improve the security guarantees offered by the os.urandom() API on newer kernels, and it would be unfortunate if Fedora&apos;s build process disabled those enhanced guarantees.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9452580</commentid>
    <comment_count>1</comment_count>
    <who name="Nick Coghlan">ncoghlan</who>
    <bug_when>2016-06-25 16:38:22 -0400</bug_when>
    <thetext>Upstream query regarding this behaviour where the getrandom() syscall being missing at build time means it isn&apos;t tried at runtime either: https://mail.python.org/pipermail/security-sig/2016-June/000060.html</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9453531</commentid>
    <comment_count>2</comment_count>
    <who name="Miro Hrončok">mhroncok</who>
    <bug_when>2016-06-26 17:54:32 -0400</bug_when>
    <thetext>If we hard-code enable it on Fedora builds, could that be dangerous? I.e. can we say that on Fedora is should *always* be enabled? Or should we focus on run-time querying?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9454640</commentid>
    <comment_count>3</comment_count>
    <who name="Miro Hrončok">mhroncok</who>
    <bug_when>2016-06-27 06:02:27 -0400</bug_when>
    <thetext>(In reply to Miro Hrončok from comment #2)
&gt; If we hard-code enable it on Fedora builds, could that be dangerous? I.e.
&gt; can we say that on Fedora is should *always* be enabled? Or should we focus
&gt; on run-time querying?

After giving it a bit thinking, I guess Fedora can be run in a container on any kernel (including the one that is used on Koji), so run-time check is a must.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9454673</commentid>
    <comment_count>4</comment_count>
    <who name="Petr Viktorin">pviktori</who>
    <bug_when>2016-06-27 06:12:10 -0400</bug_when>
    <thetext>Python 3.5 does check at runtime. It only needs SYS_getrandom and GRND_NONBLOCK constants.

More specifically, the configure script reports &quot;checking for the Linux getrandom() syscall... no&quot;, which would mean the C code for checking HAVE_GETRANDOM_SYSCALL doesn&apos;t build &amp; run: https://paste.fedoraproject.org/385405/22064146/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9454816</commentid>
    <comment_count>5</comment_count>
    <who name="Petr Viktorin">pviktori</who>
    <bug_when>2016-06-27 06:56:46 -0400</bug_when>
    <thetext>Hm, Miro tells me it does run. So I&apos;d guess the problem is somewhere in the config machinery.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9455133</commentid>
    <comment_count>6</comment_count>
    <who name="Petr Viktorin">pviktori</who>
    <bug_when>2016-06-27 08:20:25 -0400</bug_when>
    <thetext>Interestingly, by itself the SYS_getrandom syscall actually works on the Koji builder.

Task: http://koji.fedoraproject.org/koji/taskinfo?taskID=14672074
Log: https://kojipkgs.fedoraproject.org//work/tasks/2074/14672074/build.log
Source: https://paste.fedoraproject.org/385449/29814146/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9714686</commentid>
    <comment_count>7</comment_count>
    <who name="Tomas Orsava">torsava</who>
    <bug_when>2016-09-16 10:34:41 -0400</bug_when>
    <thetext>Update: The assumption that the buildtime check for the `getrandom` syscall fails in Koji is false.

Here&apos;s the latest build of Python 3.5: http://koji.fedoraproject.org/koji/buildinfo?buildID=801062

And here&apos;s the oldest, first build of Python 3.5 from a year ago:
http://koji.fedoraproject.org/koji/buildinfo?buildID=687298

Both have in their logs (for all architectures):
&quot;checking for the Linux getrandom() syscall... yes&quot;

I&apos;ll try to investigate further.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9714975</commentid>
    <comment_count>8</comment_count>
    <who name="Tomas Orsava">torsava</who>
    <bug_when>2016-09-16 12:14:24 -0400</bug_when>
    <thetext>Apologies, the assumption was indeed not false: The build time check fails on builds of Python 3.5.1.
However, it succeeds on Python 3.5.0 and 3.5.2 builds, that&apos;s why both the builds from my previous message had it succeed.

That means that Fedoras 25 and up don&apos;t suffer from this issue, as they are already on Python 3.5.2. I&apos;ll try to figure out a patch for 3.5.1 so it works in F24 as well.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9720974</commentid>
    <comment_count>9</comment_count>
    <who name="Tomas Orsava">torsava</who>
    <bug_when>2016-09-19 07:49:35 -0400</bug_when>
    <thetext>I have made a patch for Fedora 24 (the only affected Fedora version) and verified using strace that it indeed works and Python uses the new `getrandom` sys call. Bodhi will spam this bug shortly.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9720996</commentid>
    <comment_count>10</comment_count>
    <who name="Tomas Orsava">torsava</who>
    <bug_when>2016-09-19 07:54:00 -0400</bug_when>
    <thetext>In the patch, I backported the build-time check for the getrandom syscall from Python 3.5.2 to Python 3.5.1 which is in Fedora 24. The build-time check that was there previously had several issues, most importantly it did not include the proper headers.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9721217</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-19 08:52:23 -0400</bug_when>
    <thetext>python3-3.5.1-17.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-8153676cf1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9732303</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-21 21:26:46 -0400</bug_when>
    <thetext>python3-3.5.1-17.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-8153676cf1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9738355</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-23 12:19:18 -0400</bug_when>
    <thetext>python3-3.5.1-17.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9778642</commentid>
    <comment_count>14</comment_count>
    <who name="Petr Viktorin">pviktori</who>
    <bug_when>2016-10-10 10:34:24 -0400</bug_when>
    <thetext>This probably caused bug #1383060 to appear. Tomáš, do you have cycles to help there?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9778934</commentid>
    <comment_count>15</comment_count>
    <who name="Tomas Orsava">torsava</who>
    <bug_when>2016-10-10 12:07:44 -0400</bug_when>
    <thetext>I&apos;ll look into it.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>