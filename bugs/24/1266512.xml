<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1266512</bug_id>
          
          <creation_ts>2015-09-25 09:03:00 -0400</creation_ts>
          <short_desc>Restarting firewalld.service should restart fail2ban.service</short_desc>
          <delta_ts>2016-08-29 14:55:25 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>fail2ban</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          <dependson>1317240</dependson>
    
    
    <dependson>1317243</dependson>
    
    
    <dependson>1317244</dependson>
    
    
    <dependson>1317246</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Marcos Mello">marcosfrm</reporter>
          <assigned_to name="Orion Poplawski">orion</assigned_to>
          <cc>athmanem</cc>
    
    
    <cc>axel.thimm</cc>
    
    
    <cc>jonathan.underwood</cc>
    
    
    <cc>michele</cc>
    
    
    <cc>orion</cc>
    
    
    <cc>vonsch</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>fail2ban-0.9.4-5.fc24</cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-08-29 14:55:25</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>8669160</commentid>
    <comment_count>0</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2015-09-25 09:03:27 -0400</bug_when>
    <thetext>This way fail2ban will reblock its previous database IPs.

Possible solution: put into fail2ban-firewalld a systemd snippet for the ordering/binding.

/usr/lib/systemd/system/fail2ban.service.d/firewalld.conf
---
[Unit]
Wants=firewalld.service
PartOf=firewalld.service
---

(&apos;Wants=&apos; is to enforce ordering making firewalld.service start if it is not running)

Then, add %systemd_postun to fail2ban-firewalld %post and %postun to tell systemd reload its configuration.

Btw, /usr/lib/systemd/system/fail2ban.service has firewalld.service duplicated.

Please backport this to EPEL 7.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670151</commentid>
    <comment_count>1</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2015-09-25 13:45:58 -0400</bug_when>
    <thetext>If firewalld fails to start, fail2ban cannot work. We must use Requires instead of Wants.

Updated snippet:

/usr/lib/systemd/system/fail2ban.service.d/firewalld.conf
---
[Unit]
Requires=firewalld.service
PartOf=firewalld.service
---</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670629</commentid>
    <comment_count>2</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2015-09-25 18:26:18 -0400</bug_when>
    <thetext>What if the machine in question isn&apos;t using the firewalld ban action?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670644</commentid>
    <comment_count>3</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2015-09-25 18:34:30 -0400</bug_when>
    <thetext>It will not have fail2ban-firewalld installed. No changes then.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670653</commentid>
    <comment_count>4</comment_count>
    <who name="Orion Poplawski">orion</who>
    <bug_when>2015-09-25 18:49:40 -0400</bug_when>
    <thetext>Marcos - can you file this upstream as well?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670672</commentid>
    <comment_count>5</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2015-09-25 19:06:35 -0400</bug_when>
    <thetext>(In reply to Marcos Mello from comment #3)
&gt; It will not have fail2ban-firewalld installed. No changes then.

This seems fragile... It&apos;s possible to have fail2ban-firewalld installed, but not actually be using any firewalld ban actions in the active jails. In which case, we don&apos;t need firewalld to be running.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8670936</commentid>
    <comment_count>6</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2015-09-26 06:08:18 -0400</bug_when>
    <thetext>(In reply to Orion Poplawski from comment #4)
&gt; Marcos - can you file this upstream as well?

I am not sure this is upstream material. They already have After=firewalld.service there and if they want all distro-specific firewall solutions can be added. After= is a &quot;weak&quot; ordering dependency. If the units listed are not running or missing systemd will not bother. Things are different when we add requirement deps. A missing one will cause a warning (Wants=) or refuse unit start (Requires=). Upstreaming will demand an ifdefery mess I am not willing to do.

(In reply to Jonathan Underwood from comment #5)
&gt; (In reply to Marcos Mello from comment #3)
&gt; &gt; It will not have fail2ban-firewalld installed. No changes then.
&gt; 
&gt; This seems fragile... It&apos;s possible to have fail2ban-firewalld installed,
&gt; but not actually be using any firewalld ban actions in the active jails. In
&gt; which case, we don&apos;t need firewalld to be running.

Not fragile at all. The current setup is fragile, buggy, for people running firewalld. When you install fail2ban-firewalld, you tell it you will use firewalld and the system should behave correctly.

If you do not intend to use firewalld, simply uninstall fail2ban-firewalld. You still can test firewalld actions putting the right configuration in jails.local. fail2ban-firewalld is just a configuration file. All ban actions are still there in main package fail2ban-server.

fail2ban-firewalld description could be extended to explain better the situation. Something like:

This package enables support for manipulating firewalld rules. This is the
default firewall service in Fedora. It also enforces that firewalld will
start before fail2ban.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8689021</commentid>
    <comment_count>7</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2015-10-03 06:45:49 -0400</bug_when>
    <thetext>https://github.com/fail2ban/fail2ban/issues/1005

If implemented, it will allow us drop the &apos;PartOf=&apos; part.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9010190</commentid>
    <comment_count>8</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2016-01-26 05:50:21 -0500</bug_when>
    <thetext>Upstream decided for adding PartOf=firewalld.service instead of firewall-cmd --permanent approach (will be in 0.9.4).

https://github.com/fail2ban/fail2ban/commit/9905396eb8bf0563a67ea9dc1d09d31a8af7e077
https://github.com/fail2ban/fail2ban/commit/dfaf82d68a39662e475b3a0403a64de04fda7e76

We still need a requirement dep as I explained in comment 6.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9092311</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-02-24 08:47:35 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 24 development cycle.
Changing version to &apos;24&apos;.

More information and reason for this action is here:
https://fedoraproject.org/wiki/Fedora_Program_Management/HouseKeeping/Fedora24#Rawhide_Rebase</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9135498</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-03-09 16:35:56 -0500</bug_when>
    <thetext>fail2ban-0.9.4-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-478f5063bc</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9135499</commentid>
    <comment_count>11</comment_count>
    <who name="Orion Poplawski">orion</who>
    <bug_when>2016-03-09 16:36:16 -0500</bug_when>
    <thetext>(In reply to Marcos Mello from comment #8)
&gt; We still need a requirement dep as I explained in comment 6.

I&apos;m not sure I follow this.  What is still needed?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9135588</commentid>
    <comment_count>12</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2016-03-09 17:26:32 -0500</bug_when>
    <thetext>Add a requirement dependency (Requires=) between fail2ban.service and firewalld.service when fail2ban-firewalld is installed.

After= is just an ordering dependency. systemd *does not* guarantee units listed there will be started. Because fail2ban *will not* work out-of-box if firewalld is not running, we must enforce this via systemd. I proposed using a snippet config file:

/usr/lib/systemd/system/fail2ban.service.d/firewalld.conf
---
[Unit]
Requires=firewalld.service
---

(PartOf=firewalld.service is not needed as per comment 8)

Then add %systemd_postun to fail2ban-firewalld %post and %postun to tell systemd reload its configuration. Note: I am not following recent switch to RPM file triggers in systemd macros (it is v228+ stuff I think).

Requires=firewalld.service will:

- start firewalld.service even if it is disabled (only masked services are not started in this scenario)
- abort fail2ban start if firewalld start has failed (it cannot work in this case)

The objection so far is that systems not using firewalld would have it started anyway. Well, if you have fail2ban-firewalld installed, you already have fail2ban configured to use by default the firewalld actions. You should uninstall fail2ban-firewalld in this case. The snippet will be gone and you will be free to use any other firewall solution you want.

You can argue that it is admin responsibility certify that firewalld.service is enabled at least. I still think though we should use systemd features to bring us robustness.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9135721</commentid>
    <comment_count>13</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2016-03-09 17:59:34 -0500</bug_when>
    <thetext>(In reply to Marcos Mello from comment #12)
&gt; Add a requirement dependency (Requires=) between fail2ban.service and
&gt; firewalld.service when fail2ban-firewalld is installed.
&gt; 
&gt; After= is just an ordering dependency. systemd *does not* guarantee units
&gt; listed there will be started. Because fail2ban *will not* work out-of-box if
&gt; firewalld is not running, we must enforce this via systemd. I proposed using
&gt; a snippet config file:
&gt; 
&gt; /usr/lib/systemd/system/fail2ban.service.d/firewalld.conf
&gt; ---
&gt; [Unit]
&gt; Requires=firewalld.service
&gt; ---
&gt; 
&gt; (PartOf=firewalld.service is not needed as per comment 8)
&gt; 
&gt; Then add %systemd_postun to fail2ban-firewalld %post and %postun to tell
&gt; systemd reload its configuration. Note: I am not following recent switch to
&gt; RPM file triggers in systemd macros (it is v228+ stuff I think).
&gt; 
&gt; Requires=firewalld.service will:
&gt; 
&gt; - start firewalld.service even if it is disabled (only masked services are
&gt; not started in this scenario)
&gt; - abort fail2ban start if firewalld start has failed (it cannot work in this
&gt; case)
&gt; 
&gt; The objection so far is that systems not using firewalld would have it
&gt; started anyway. Well, if you have fail2ban-firewalld installed, you already
&gt; have fail2ban configured to use by default the firewalld actions. You should
&gt; uninstall fail2ban-firewalld in this case. The snippet will be gone and you
&gt; will be free to use any other firewall solution you want.
&gt; 
&gt; You can argue that it is admin responsibility certify that firewalld.service
&gt; is enabled at least. I still think though we should use systemd features to
&gt; bring us robustness.

I really don&apos;t like the thinking behind this. If I install fail2ban and fail2ban-firewalld and then at some point later decide to configure my jails to not use firewalld, I would be very surprised if restarting fail2ban kicked firewalld into life because I had forgotten to also uninstall the fail2ban-firewalld package. 

None of what you propose is needed at all. With the upstream change, if firewalld is running and is restarted, fail2ban will be restarted. That&apos;s really all that&apos;s needed. I see no use case for what you&apos;re proposing, unless I have really misunderstood what you&apos;re proposing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9135836</commentid>
    <comment_count>14</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2016-03-09 19:01:55 -0500</bug_when>
    <thetext>It is similar if I forgot to enable firewalld.service. Or I messed up firewalld config (making it fail to start). My fail2ban service, despite running, would be useless.

We both made our points. I will be happy with Orion&apos;s decision. And I agree the main problem reported in this bug is solved.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9136068</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-03-09 20:54:39 -0500</bug_when>
    <thetext>fail2ban-0.9.4-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-478f5063bc</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9136290</commentid>
    <comment_count>16</comment_count>
    <who name="Orion Poplawski">orion</who>
    <bug_when>2016-03-09 22:50:45 -0500</bug_when>
    <thetext>We seem to be in an area of marginal utility.  For the default case, fail2ban is installed with firewalld and firewalld is enabled by default.

So if we add the systemd requires statement, then if firewalld fails to start, fail2ban would fail to start as well.  I suppose having two failed services rather than one might have a better chance of getting attention, but I don&apos;t see it as critical.  And if someone disabled firewalld for whatever reason, and then decided to use fail2ban, it would work by default by starting firewalld.  This might be more useful, but hard to say.

The downside seems to be if someone switches to bare iptables by disabling firewalld (and not removing it), and then specifying a new banaction in jail.local (overriding the 00-firewalld.conf setting) rather than removing fail2ban-firewalld, then firewalld service would continue to be started.  I have no sense if this is a common way of working around the default configuration or not.

At this point I think I&apos;m going to leave things as they are.  If problem reports start to surface about people complaining about fail2ban not working because firewalld was not started I&apos;ll reconsider.

Thank you Marcos for the detailed description, it was very helpful.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9138216</commentid>
    <comment_count>17</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2016-03-10 08:51:32 -0500</bug_when>
    <thetext>Unfortunately, the new packages actually have a problem:

# systemctl restart firewalld
Failed to restart firewalld.service: Transaction contains conflicting jobs &apos;restart&apos; and &apos;stop&apos; for fail2ban.service. Probably contradicting requirement dependencies configured.


# rpm -qa | grep fail2ban
fail2ban-0.9.4-2.fc23.noarch
fail2ban-server-0.9.4-2.fc23.noarch
fail2ban-firewalld-0.9.4-2.fc23.noarch
fail2ban-sendmail-0.9.4-2.fc23.noarch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9138275</commentid>
    <comment_count>18</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2016-03-10 09:02:59 -0500</bug_when>
    <thetext>Ah, I see that&apos;s fixed in the next commit - I guess the update will need editing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9138443</commentid>
    <comment_count>19</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2016-03-10 09:43:33 -0500</bug_when>
    <thetext>Orion just removed a duplicated After=firewalld.service entry in that commit.

Hmmm, I cannot reproduce it on CentOS 7. What firewalld version do you have?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9138563</commentid>
    <comment_count>20</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2016-03-10 10:02:52 -0500</bug_when>
    <thetext>Ah, yes, good point.

$ rpm -qa | grep firewalld
firewalld-filesystem-0.4.0-2.fc23.noarch
fail2ban-firewalld-0.9.4-2.fc23.noarch
firewalld-0.4.0-2.fc23.noarch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9142499</commentid>
    <comment_count>21</comment_count>
    <who name="Marcos Mello">marcosfrm</who>
    <bug_when>2016-03-11 14:14:06 -0500</bug_when>
    <thetext>(I can reproduce it now, I was using outdated fail2ban package, sorry for the noise)

Thanks for raising the issue on systemd-devel.

https://lists.freedesktop.org/archives/systemd-devel/2016-March/036010.html</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9144174</commentid>
    <comment_count>22</comment_count>
    <who name="Jonathan Underwood">jonathan.underwood</who>
    <bug_when>2016-03-13 06:07:49 -0400</bug_when>
    <thetext>I&apos;ve filed a bunch of dependent RFE bugs to implement the suggested firewall.target approach outlined on systemd-devel (see the blockers of this bug).

For F23 and earlier I think we&apos;re going to need an imperfect compromise solution though. What I would favour is dropping the PartOf entry for iptables for fail2ban, so at least the fail2ban service is restarted correctly with the Fedora default firewall implementation.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9208984</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-04-05 11:47:55 -0400</bug_when>
    <thetext>fail2ban-0.9.4-5.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-478f5063bc</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9213106</commentid>
    <comment_count>24</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-04-06 13:54:26 -0400</bug_when>
    <thetext>fail2ban-0.9.4-5.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-478f5063bc</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9660575</commentid>
    <comment_count>25</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-29 14:55:17 -0400</bug_when>
    <thetext>fail2ban-0.9.4-5.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>