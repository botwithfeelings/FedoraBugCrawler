<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1359398</bug_id>

    <creation_ts>2016-07-23 14:20:00 -0400</creation_ts>
    <short_desc>Domain login no longer works after F22 -&gt; F23 upgrade</short_desc>
    <delta_ts>2017-05-24 05:22:48 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>samba</component>
    <version>24</version>
    <rep_platform>x86_64</rep_platform>
    <op_sys>Linux</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>CURRENTRELEASE</resolution>

    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords></keywords>
    <priority>unspecified</priority>
    <bug_severity>high</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter name="Martin Vuille">jpmv27</reporter>
    <assigned_to name="Orphan Owner">extras-orphan</assigned_to>
    <cc>abokovoy</cc>

    <cc>anoopcs</cc>

    <cc>asn</cc>

    <cc>extras-orphan</cc>

    <cc>gdeschner</cc>

    <cc>jpmv27</cc>

    <cc>jrivera</cc>

    <cc>lists</cc>

    <cc>lmohanty</cc>

    <cc>madam</cc>

    <cc>milan.kerslager</cc>

    <cc>sbose</cc>

    <cc>ssorce</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in></cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2017-05-24 05:22:48</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>9543209</commentid>
<comment_count>0</comment_count>
<who name="Martin Vuille">jpmv27</who>
<bug_when>2016-07-23 14:20:28 -0400</bug_when>
<thetext>Description of problem: Computer is a member of NT domain. DC is samba 3.6.12 Since upgrading from F22 -&gt; F23, domain logins no longer work: &quot;Domain Controller unreachable, using cached credentials instead.&quot; I&apos;m seeing the
following errors in log.winbindd-idmap: [2016/07/22 11:23:28.791764, 10, pid=1153, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_cm.c:1917(cm_open_connection) cm_open_connection: dcname is &apos;MIMIR&apos; for domain
YGGDRASIL [2016/07/22 11:23:28.793277, 10, pid=1153, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_cm.c:1023(cm_prepare_connection) cm_prepare_connection: connecting to DC MIMIR for domain YGGDRASIL ldb: unable to stat
module /usr/lib64/samba/ldb : No such file or directory [2016/07/22 11:23:28.794755, 5, pid=1153, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_cm.c:1142(cm_prepare_connection) connecting to MIMIR from THOR using NTLMSSP
with username [YGGDRASIL]\[THOR$] [2016/07/22 11:23:28.798607, 0] ../libcli/smb/smb_signing.c:138(smb_signing_good) smb_signing_good: BAD SIG: seq 1 [2016/07/22 11:23:28.798690, 4, pid=1153, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cm.c:1184(cm_prepare_connection) authenticated session setup failed with NT_STATUS_ACCESS_DENIED and I am also seeing SELinux errors for winbindd: time-&gt;Fri Jul 22 09:45:06 2016 type=PROCTITLE
msg=audit(1469195106.880:3563): proctitle=&quot;/usr/sbin/winbindd&quot; type=PATH msg=audit(1469195106.880:3563): item=0 name=&quot;/var/lib/samba/private/msg.sock/1207&quot; inode=2502647 dev=fd:00 mode=0140777 ouid=0 ogid=0 rdev=00:00
obj=system_u:object_r:samba_var_t:s0 nametype=NORMAL type=CWD msg=audit(1469195106.880:3563): cwd=&quot;/&quot; type=SOCKADDR msg=audit(1469195106.880:3563):
saddr=01002F7661722F6C69622F73616D62612F707269766174652F6D73672E736F636B2F31323037000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 type=SYSCALL
msg=audit(1469195106.880:3563): arch=c000003e syscall=46 success=no exit=-13 a0=7 a1=7fff67c8aaa0 a2=0 a3=0 items=1 ppid=1137 pid=1139 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295
comm=&quot;winbindd&quot; exe=&quot;/usr/sbin/winbindd&quot; subj=system_u:system_r:winbind_t:s0 key=(null) type=AVC msg=audit(1469195106.880:3563): avc: denied { sendto } for pid=1139 comm=&quot;winbindd&quot;
path=&quot;/var/lib/samba/private/msg.sock/1207&quot; scontext=system_u:system_r:winbind_t:s0 tcontext=system_u:system_r:nmbd_t:s0 tclass=unix_dgram_socket permissive=0 Version-Release number of selected component (if applicable): samba 4.3.11-1.fc23
How reproducible: 100% reproducible Steps to Reproduce: 1.Login to domain member using domain account Actual results: Login fails: &quot;Domain Controller unreachable, using cached credentials instead.&quot; Expected results: Login succeeds
Additional info: This ticket https://bugzilla.redhat.com/show_bug.cgi?id=1337569 seems to be the same issue (at least &quot;unable to stat&quot; part) and suggests there is a fix in samba 4.4.3-6</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9574099</commentid>
<comment_count>1</comment_count>
<who name="Martin Vuille">jpmv27</who>
<bug_when>2016-08-01 14:37:35 -0400</bug_when>
<thetext>Changed component from samba4 (which seems to be obsolete) to samba</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9574119</commentid>
<comment_count>2</comment_count>
<who name="Martin Vuille">jpmv27</who>
<bug_when>2016-08-01 14:45:20 -0400</bug_when>
<thetext>Upgraded samba to 4.4.5-1 from fedora24-updates, issue still present log.winbindd-idmap has changed slightly, no longer seeing &quot;unable to stat module&quot; Still seeing SELinux errors as above 2016/08/01 14:38:37.794851, 10, pid=1161,
effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_cm.c:1924(cm_open_connection) cm_open_connection: dcname is &apos;MIMIR&apos; for domain YGGDRASIL [2016/08/01 14:38:37.798119, 10, pid=1161, effective(0, 0), real(0, 0),
class=winbind] ../source3/winbindd/winbindd_cm.c:1030(cm_prepare_connection) cm_prepare_connection: connecting to DC MIMIR for domain YGGDRASIL [2016/08/01 14:38:37.799741, 5, pid=1161, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cm.c:1149(cm_prepare_connection) connecting to MIMIR from THOR using NTLMSSP with username [YGGDRASIL]\[THOR$] [2016/08/01 14:38:37.803687, 0] ../libcli/smb/smb_signing.c:138(smb_signing_good) smb_signing_good: BAD SIG:
seq 1 [2016/08/01 14:38:37.803758, 4, pid=1161, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_cm.c:1191(cm_prepare_connection) authenticated session setup failed with NT_STATUS_ACCESS_DENIED</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9674449</commentid>
<comment_count>3</comment_count>
<who name="Milan Kerslager">milan.kerslager</who>
<bug_when>2016-09-02 04:58:43 -0400</bug_when>
<thetext>The problem is still present in Fedora 24. Joing to classic NT4 style domain fails inf Fedora 24, but works in Fedora 20. $ net join -w oalib.cz -U root Failed to join domain: failed to find DC for domain OALIB.CZ $ net rpc oldjoin -w
oalib.cz -U root Failed to join domain: failed to find DC for domain OALIB.CZ When trying to debug problem, it seem like net command is trying to join AD instead of classic domain: net join -w oalib.cz -U root -d3 lp_load_ex: refreshing parameters
Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384) Processing section &quot;[global]&quot; Registered MSG_REQ_POOL_USAGE Registered MSG_REQ_DMALLOC_MARK and LOG_CHANGED lp_load_ex: refreshing
parameters Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384) Processing section &quot;[global]&quot; added interface enp8s0 ip=10.0.0.35 bcast=10.0.255.255 netmask=255.255.0.0 get_dc_list:
preferred server list: &quot;, *&quot; ads_find_dc: name resolution for realm &apos;&apos; (domain &apos;OALIB.CZ&apos;) failed: NT_STATUS_NO_LOGON_SERVERS libnet_Join: libnet_JoinCtx: struct libnet_JoinCtx in: struct libnet_JoinCtx dc_name : NULL
machine_name : &apos;PITOMA&apos; domain_name : * domain_name : &apos;OALIB.CZ&apos; domain_name_type : JoinDomNameTypeUnknown (0) account_ou : NULL admin_account : &apos;&apos; admin_domain : NULL machine_password : NULL join_flags : 0x000000c1
(193) 0: WKSSVC_JOIN_FLAGS_IGNORE_UNSUPPORTED_FLAGS 0: WKSSVC_JOIN_FLAGS_JOIN_WITH_NEW_NAME 0: WKSSVC_JOIN_FLAGS_JOIN_DC_ACCOUNT 0: WKSSVC_JOIN_FLAGS_DEFER_SPN 1: WKSSVC_JOIN_FLAGS_MACHINE_PWD_PASSED 1: WKSSVC_JOIN_FLAGS_JOIN_UNSECURE 0:
WKSSVC_JOIN_FLAGS_DOMAIN_JOIN_IF_JOINED 0: WKSSVC_JOIN_FLAGS_WIN9X_UPGRADE 0: WKSSVC_JOIN_FLAGS_ACCOUNT_DELETE 0: WKSSVC_JOIN_FLAGS_ACCOUNT_CREATE 1: WKSSVC_JOIN_FLAGS_JOIN_TYPE os_version : NULL os_name : NULL os_servicepack : NULL create_upn : 0x00
(0) upn : NULL modify_config : 0x00 (0) ads : NULL debug : 0x01 (1) use_kerberos : 0x00 (0) secure_channel_type : SEC_CHAN_WKSTA (2) desired_encryption_types : 0x0000001f (31) dns_send_req: Failed to resolve _ldap._tcp.dc._msdcs.OALIB.CZ (Success)
ads_dns_lookup_srv: Failed to send DNS query (NT_STATUS_UNSUCCESSFUL) libnet_Join: libnet_JoinCtx: struct libnet_JoinCtx out: struct libnet_JoinCtx account_name : NULL netbios_domain_name : NULL dns_domain_name : NULL forest_name : NULL dn : NULL
domain_sid : NULL domain_sid : (NULL SID) modified_config : 0x00 (0) error_string : &apos;failed to find DC for domain OALIB.CZ&apos; domain_is_ad : 0x00 (0) set_encryption_types : 0x00000000 (0) result : WERR_DCNOTFOUND Enter root&apos;s password:
libnet_Join: libnet_JoinCtx: struct libnet_JoinCtx in: struct libnet_JoinCtx dc_name : NULL machine_name : &apos;PITOMA&apos; domain_name : * domain_name : &apos;OALIB.CZ&apos; domain_name_type : JoinDomNameTypeUnknown (0) account_ou : NULL
admin_account : &apos;root&apos; admin_domain : NULL machine_password : NULL join_flags : 0x00000023 (35) 0: WKSSVC_JOIN_FLAGS_IGNORE_UNSUPPORTED_FLAGS 0: WKSSVC_JOIN_FLAGS_JOIN_WITH_NEW_NAME 0: WKSSVC_JOIN_FLAGS_JOIN_DC_ACCOUNT 0:
WKSSVC_JOIN_FLAGS_DEFER_SPN 0: WKSSVC_JOIN_FLAGS_MACHINE_PWD_PASSED 0: WKSSVC_JOIN_FLAGS_JOIN_UNSECURE 1: WKSSVC_JOIN_FLAGS_DOMAIN_JOIN_IF_JOINED 0: WKSSVC_JOIN_FLAGS_WIN9X_UPGRADE 0: WKSSVC_JOIN_FLAGS_ACCOUNT_DELETE 1:
WKSSVC_JOIN_FLAGS_ACCOUNT_CREATE 1: WKSSVC_JOIN_FLAGS_JOIN_TYPE os_version : NULL os_name : NULL os_servicepack : NULL create_upn : 0x00 (0) upn : NULL modify_config : 0x00 (0) ads : NULL debug : 0x01 (1) use_kerberos : 0x00 (0) secure_channel_type :
SEC_CHAN_WKSTA (2) desired_encryption_types : 0x0000001f (31) dns_send_req: Failed to resolve _ldap._tcp.dc._msdcs.OALIB.CZ (Success) ads_dns_lookup_srv: Failed to send DNS query (NT_STATUS_UNSUCCESSFUL) libnet_Join: libnet_JoinCtx: struct
libnet_JoinCtx out: struct libnet_JoinCtx account_name : NULL netbios_domain_name : NULL dns_domain_name : NULL forest_name : NULL dn : NULL domain_sid : NULL domain_sid : (NULL SID) modified_config : 0x00 (0) error_string : &apos;failed to find DC
for domain OALIB.CZ&apos; domain_is_ad : 0x00 (0) set_encryption_types : 0x00000000 (0) result : WERR_DCNOTFOUND Failed to join domain: failed to find DC for domain OALIB.CZ Enter root&apos;s password: &lt;password entered&gt; return code = -1 $ net
rpc oldjoin -w oalib.cz -U root -d3 lp_load_ex: refreshing parameters Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384) Processing section &quot;[global]&quot; Registered MSG_REQ_POOL_USAGE
Registered MSG_REQ_DMALLOC_MARK and LOG_CHANGED lp_load_ex: refreshing parameters Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384) Processing section &quot;[global]&quot; added interface enp8s0
ip=10.0.0.35 bcast=10.0.255.255 netmask=255.255.0.0 libnet_Join: libnet_JoinCtx: struct libnet_JoinCtx in: struct libnet_JoinCtx dc_name : NULL machine_name : &apos;PITOMA&apos; domain_name : * domain_name : &apos;OALIB.CZ&apos; domain_name_type :
JoinDomNameTypeUnknown (0) account_ou : NULL admin_account : &apos;&apos; admin_domain : NULL machine_password : NULL join_flags : 0x000000c1 (193) 0: WKSSVC_JOIN_FLAGS_IGNORE_UNSUPPORTED_FLAGS 0: WKSSVC_JOIN_FLAGS_JOIN_WITH_NEW_NAME 0:
WKSSVC_JOIN_FLAGS_JOIN_DC_ACCOUNT 0: WKSSVC_JOIN_FLAGS_DEFER_SPN 1: WKSSVC_JOIN_FLAGS_MACHINE_PWD_PASSED 1: WKSSVC_JOIN_FLAGS_JOIN_UNSECURE 0: WKSSVC_JOIN_FLAGS_DOMAIN_JOIN_IF_JOINED 0: WKSSVC_JOIN_FLAGS_WIN9X_UPGRADE 0:
WKSSVC_JOIN_FLAGS_ACCOUNT_DELETE 0: WKSSVC_JOIN_FLAGS_ACCOUNT_CREATE 1: WKSSVC_JOIN_FLAGS_JOIN_TYPE os_version : NULL os_name : NULL os_servicepack : NULL create_upn : 0x00 (0) upn : NULL modify_config : 0x00 (0) ads : NULL debug : 0x01 (1)
use_kerberos : 0x00 (0) secure_channel_type : SEC_CHAN_WKSTA (2) desired_encryption_types : 0x0000001f (31) dns_send_req: Failed to resolve _ldap._tcp.dc._msdcs.OALIB.CZ (Success) ads_dns_lookup_srv: Failed to send DNS query (NT_STATUS_UNSUCCESSFUL)
libnet_Join: libnet_JoinCtx: struct libnet_JoinCtx out: struct libnet_JoinCtx account_name : NULL netbios_domain_name : NULL dns_domain_name : NULL forest_name : NULL dn : NULL domain_sid : NULL domain_sid : (NULL SID) modified_config : 0x00 (0)
error_string : &apos;failed to find DC for domain OALIB.CZ&apos; domain_is_ad : 0x00 (0) set_encryption_types : 0x00000000 (0) result : WERR_DCNOTFOUND Failed to join domain: failed to find DC for domain OALIB.CZ return code = -1 Debug output from
Fedora 20 working setup for comparsion: ========================================================= $ net join -w pslib.cz -U root -d3 lp_load_ex: refreshing parameters Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum
Windows limit (16384) params.c:pm_process() - Processing configuration file &quot;/etc/samba/smb.conf&quot; Processing section &quot;[global]&quot; added interface p4p1 ip=10.0.50.4 bcast=10.0.255.255 netmask=255.255.0.0 Registered MSG_REQ_POOL_USAGE
Registered MSG_REQ_DMALLOC_MARK and LOG_CHANGED get_dc_list: preferred server list: &quot;, *&quot; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1c&gt; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1c&gt;
resolve_wins: using WINS server 10.0.0.2 and tag &apos;*&apos; Got a positive name query response from 10.0.0.2 ( 10.0.0.2 ) ads_cldap_netlogon: did not get a reply ads_try_connect: CLDAP request 10.0.0.2 failed. resolve_lmhosts: Attempting lmhosts
lookup for name OALIB.CZ&lt;0x1b&gt; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1b&gt; resolve_wins: using WINS server 10.0.0.2 and tag &apos;*&apos; Got a positive name query response from 10.0.0.2 ( 10.0.0.2 ) Connecting to
10.0.0.2 at port 445 rpccli_netlogon_set_trust_password: unable to setup creds (NT_STATUS_ACCESS_DENIED)! rpc command function failed! (NT_STATUS_ACCESS_DENIED) Enter root&apos;s password:</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9674462</commentid>
<comment_count>4</comment_count>
<who name="Milan Kerslager">milan.kerslager</who>
<bug_when>2016-09-02 05:02:59 -0400</bug_when>
<thetext>I made a mistake in previous post. Working F20 setup for joining NT4 domain: $ net join -w oalib.cz -U root -d3 lp_load_ex: refreshing parameters Initialising global parameters rlimit_max: increasing rlimit_max (1024) to minimum Windows
limit (16384) params.c:pm_process() - Processing configuration file &quot;/etc/samba/smb.conf&quot; Processing section &quot;[global]&quot; added interface p4p1 ip=10.0.50.4 bcast=10.0.255.255 netmask=255.255.0.0 Registered MSG_REQ_POOL_USAGE
Registered MSG_REQ_DMALLOC_MARK and LOG_CHANGED get_dc_list: preferred server list: &quot;, *&quot; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1c&gt; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1c&gt;
resolve_wins: using WINS server 10.0.0.2 and tag &apos;*&apos; Got a positive name query response from 10.0.0.2 ( 10.0.0.2 ) ads_cldap_netlogon: did not get a reply ads_try_connect: CLDAP request 10.0.0.2 failed. resolve_lmhosts: Attempting lmhosts
lookup for name OALIB.CZ&lt;0x1b&gt; resolve_lmhosts: Attempting lmhosts lookup for name OALIB.CZ&lt;0x1b&gt; resolve_wins: using WINS server 10.0.0.2 and tag &apos;*&apos; Got a positive name query response from 10.0.0.2 ( 10.0.0.2 ) Connecting to
10.0.0.2 at port 445 rpccli_netlogon_set_trust_password: unable to setup creds (NT_STATUS_ACCESS_DENIED)! rpc command function failed! (NT_STATUS_ACCESS_DENIED) Enter root&apos;s password: Connecting to 10.0.0.2 at port 445 Doing spnego session setup
(blob length=42) got OID=1.3.6.1.4.1.311.2.2.10 got principal=NONE Got challenge flags: Got NTLMSSP neg_flags=0x60898215 NTLMSSP: Set final flags: Got NTLMSSP neg_flags=0x60088215 NTLMSSP Sign/Seal - Initialising with flags: Got NTLMSSP
neg_flags=0x60088215 Connecting to 10.0.0.2 at port 445 Joined domain OALIB.CZ. return code = 0</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9674469</commentid>
<comment_count>5</comment_count>
<who name="Alexander Bokovoy">abokovoy</who>
<bug_when>2016-09-02 05:06:25 -0400</bug_when>
<thetext>Can you provide these logs with -d10 ?</thetext>
</long_desc>

</bug>

</bugzilla>
