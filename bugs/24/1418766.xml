<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1418766</bug_id>
          
          <creation_ts>2017-02-02 11:42:00 -0500</creation_ts>
          <short_desc>failed to compile kernel.data() example</short_desc>
          <delta_ts>2017-02-07 20:42:46 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>systemtap</component>
          <version>24</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="masanari iida">masanari.iida</reporter>
          <assigned_to name="Frank Ch. Eigler">fche</assigned_to>
          <cc>brolley</cc>
    
    
    <cc>dsmith</cc>
    
    
    <cc>fche</cc>
    
    
    <cc>jistone</cc>
    
    
    <cc>lberk</cc>
    
    
    <cc>mjw</cc>
    
    
    <cc>scox</cc>
    
    
    <cc>wcohen</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-02-07 20:42:46</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10116542</commentid>
    <comment_count>0</comment_count>
    <who name="masanari iida">masanari.iida</who>
    <bug_when>2017-02-02 11:42:02 -0500</bug_when>
    <thetext>Description of problem:
Systemtap on Fedora 24(x86_64) failed to compile kernel.data() example.
Using upstream&apos;s systemtap, it works.

Version-Release number of selected component (if applicable):
systemtap-3.0-4.fc24
kernel-4.9.5-100.fc24

How reproducible:
Always.

Steps to Reproduce:
1.  The exampe script.
 
#! /usr/bin/env stap
probe kernel.data(&quot;vm_dirty_ratio&quot;).rw
{
  print_backtrace();
}

2. compile the script.

# stap -v ./dirty_ratio.stp Pass 1: parsed user script and 132 library scripts using 154672virt/64652res/7000shr/57636data kb, in 300usr/30sys/327real ms.
Pass 2: analyzed script: 1 probe, 1 function, 0 embeds, 0 globals using 156916virt/67208res/7192shr/59880data kb, in 20usr/0sys/23real ms.
Pass 3: translated to C into &quot;/tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c&quot; using 157048virt/67208res/7192shr/60012data kb, in 0usr/0sys/0real ms.
In file included from /usr/share/systemtap/runtime/linux/runtime.h:209:0,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
/usr/share/systemtap/runtime/linux/access_process_vm.h: In function &apos;__access_process_vm_&apos;:
/usr/share/systemtap/runtime/linux/access_process_vm.h:36:61: error: passing argument 6 of &apos;get_user_pages_remote&apos; makes pointer from integer without a cast [-Werror=int-conversion]
    ret = get_user_pages_remote (tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);
                                                          ^
In file included from ./include/linux/pid_namespace.h:6:0,
                 from ./include/linux/ptrace.h:8,
                 from ./include/linux/ftrace.h:13,
                 from ./include/linux/kprobes.h:42,
                 from /usr/share/systemtap/runtime/linux/runtime.h:21,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
./include/linux/mm.h:1276:6: note: expected &apos;struct page **&apos; but argument is of type &apos;int&apos;
 long get_user_pages_remote(struct task_struct *tsk, struct mm_struct *mm,
      ^~~~~~~~~~~~~~~~~~~~~
In file included from /usr/share/systemtap/runtime/linux/runtime.h:209:0,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
/usr/share/systemtap/runtime/linux/access_process_vm.h:36:64: error: passing argument 7 of &apos;get_user_pages_remote&apos; from incompatible pointer type [-Werror=incompatible-pointer-types]
 ret = get_user_pages_remote (tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);
                                                          ^
In file included from ./include/linux/pid_namespace.h:6:0,
                 from ./include/linux/ptrace.h:8,
                 from ./include/linux/ftrace.h:13,
                 from ./include/linux/kprobes.h:42,
                 from /usr/share/systemtap/runtime/linux/runtime.h:21,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
./include/linux/mm.h:1276:6: note: expected &apos;struct vm_area_struct **&apos; but argument is of type &apos;struct page **&apos;
 long get_user_pages_remote(struct task_struct *tsk, struct mm_struct *mm,
      ^~~~~~~~~~~~~~~~~~~~~
In file included from /usr/share/systemtap/runtime/linux/runtime.h:209:0,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
/usr/share/systemtap/runtime/linux/access_process_vm.h:36:13: error: too many arguments to function &apos;get_user_pages_remote&apos;
       ret = get_user_pages_remote (tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);
             ^~~~~~~~~~~~~~~~~~~~~
In file included from ./include/linux/pid_namespace.h:6:0,
                 from ./include/linux/ptrace.h:8,
                 from ./include/linux/ftrace.h:13,
                 from ./include/linux/kprobes.h:42,
                 from /usr/share/systemtap/runtime/linux/runtime.h:21,
                 from /usr/share/systemtap/runtime/runtime.h:24,
                 from /tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.c:26:
./include/linux/mm.h:1276:6: note: declared here
 long get_user_pages_remote(struct task_struct *tsk, struct mm_struct *mm,
      ^~~~~~~~~~~~~~~~~~~~~
cc1: all warnings being treated as errors
scripts/Makefile.build:293: recipe for target &apos;/tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.o&apos; failed
make[1]: *** [/tmp/stapx8nwAX/stap_2415c6268f17cdbfbde2ca42b597704b_1032_src.o] Error 1
Makefile:1494: recipe for target &apos;_module_/tmp/stapx8nwAX&apos; failed
make: *** [_module_/tmp/stapx8nwAX] Error 2
WARNING: kbuild exited with status: 2
Pass 4: compiled C into &quot;stap_2415c6268f17cdbfbde2ca42b597704b_1032.ko&quot; in 10940usr/1610sys/12511real ms.
Pass 4: compilation failed.  [man error::pass4]

Additional info:
With upstream systemtap,(commit 575fe913f6b6b81421f7bfda7c72ab8c15ecb8e3)
the systemtap script compile and work as expected.

# /home/iida/systemtap/bin/stap -v ./dirty_ratio.stp 
Pass 1: parsed user script and 119 library scripts using 72692virt/42000res/5028shr/37504data kb, in 180usr/10sys/195real ms.
Pass 2: analyzed script: 1 probe, 1 function, 0 embeds, 0 globals using 73352virt/42912res/5156shr/38164data kb, in 10usr/0sys/5real ms.
Pass 3: using cached /root/.systemtap/cache/d4/stap_d41c819372acfec776748c14cfeb0134_1138.c
Pass 4: using cached /root/.systemtap/cache/d4/stap_d41c819372acfec776748c14cfeb0134_1138.ko
Pass 5: starting run.
WARNING: Missing unwind data for a module, rerun with &apos;stap -d kernel&apos;
 0xffffffffaf1cef8c
 0x0 (inexact)
 0xffffffffaf1cef8c
 0x0 (inexact)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10116582</commentid>
    <comment_count>1</comment_count>
    <who name="David Smith">dsmith</who>
    <bug_when>2017-02-02 11:53:56 -0500</bug_when>
    <thetext>That was probably fixed by either of the following 2 upstream commits:

====
commit 2676bba61284109b8f6f96921667613c15398a07
Author: Frank Ch. Eigler &lt;fche@redhat.com&gt;
Date:   Mon Dec 26 10:39:09 2016 -0500

    Fix get_user_pages_remote() test for 4.10-rc0 kernels.
    
    This kernel API is undergoing considerable flux.

commit 00960517fb4a4d8388854b470da30e0c886b0e89
Author: David Smith &lt;dsmith@redhat.com&gt;
Date:   Fri Dec 9 11:41:35 2016 -0600

    Fix BZ1386120 by updating systemtap to handle the 4.9 kernel.
    
    * runtime/linux/access_process_vm.h (__access_process_vm_): Use
      STAPCONF_GET_USER_PAGES_REMOTE_FLAGS to handle get_user_pages_remote()
      kernel function API change.
    * runtime/transport/procfs.c (_stp_proc_read): Use _stp_get_rchan_subbuf()
      macro to handle kernel relayfs rchan-&gt;buf changes.
    * runtime/transport/relay_v2.c (__stp_relay_wakeup_timer): Ditto.
      (_stp_data_write_reserve): Ditto.
    * runtime/transport/symbols.c (_stp_module_panic_notifier): Ditto.
    * buildrun.cxx (compile_pass): Add autoconf-style tests.
    * runtime/linux/autoconf-get_user_pages_remote-flags.c: New file.
    * runtime/linux/autoconf-relay_buf-per_cpu_ptr.c: New file.
    * runtime/transport/relay_compat.h: New file.
====

Since Fedora 24 has switched to a 4.9 kernel, this puts additional pressure on us to get a new systemtap release out. I&apos;ll try to update this bug when we&apos;ve finalized our release plans.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10129430</commentid>
    <comment_count>2</comment_count>
    <who name="masanari iida">masanari.iida</who>
    <bug_when>2017-02-07 19:21:31 -0500</bug_when>
    <thetext>After update to following version, systemtap can compie the script again.

systemtap-sdt-devel-3.1-0.20170125gite81970274b46.fc24.x86_64
systemtap-devel-3.1-0.20170125gite81970274b46.fc24.x86_64
systemtap-3.1-0.20170125gite81970274b46.fc24.x86_64
systemtap-client-3.1-0.20170125gite81970274b46.fc24.x86_64

[root@masabert kernel]# stap -v ./dirty_ratio.stp 
Pass 1: parsed user script and 138 library scripts using 157744virt/69864res/7028shr/62740data kb, in 360usr/30sys/384real ms.
Pass 2: analyzed script: 1 probe, 1 function, 0 embeds, 0 globals using 159988virt/72096res/7156shr/64984data kb, in 20usr/0sys/25real ms.
Pass 3: using cached /root/.systemtap/cache/fc/stap_fca4a8f062693ede3a4d82a57fc5a41f_1050.c
Pass 4: using cached /root/.systemtap/cache/fc/stap_fca4a8f062693ede3a4d82a57fc5a41f_1050.ko
Pass 5: starting run.
WARNING: Missing unwind data for a module, rerun with &apos;stap -d kernel&apos;
 0xffffffffaf1cef8c

Thank you.
You may close this case.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10129545</commentid>
    <comment_count>3</comment_count>
    <who name="Frank Ch. Eigler">fche</who>
    <bug_when>2017-02-07 20:42:46 -0500</bug_when>
    <thetext>thanks for testing!</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>