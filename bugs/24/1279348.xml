<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1279348</bug_id>
          
          <creation_ts>2015-11-09 04:06:00 -0500</creation_ts>
          <short_desc>libvirtd systemd socket unit cannot be enabled</short_desc>
          <delta_ts>2016-05-08 20:03:39 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt</component>
          <version>24</version>
          <rep_platform>All</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Daniel Miranda">danielkza2</reporter>
          <assigned_to name="Libvirt Maintainers">libvirt-maint</assigned_to>
          <cc>agedosier</cc>
    
    
    <cc>berrange</cc>
    
    
    <cc>clalancette</cc>
    
    
    <cc>crobinso</cc>
    
    
    <cc>dyuan</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>jforbes</cc>
    
    
    <cc>laine</cc>
    
    
    <cc>libvirt-maint</cc>
    
    
    <cc>mkletzan</cc>
    
    
    <cc>mzhan</cc>
    
    
    <cc>nefelim4ag</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>libvirt-1.3.3.1-1.fc24</cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-05-08 20:03:39</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>8802641</commentid>
    <comment_count>0</comment_count>
    <who name="Daniel Miranda">danielkza2</who>
    <bug_when>2015-11-09 04:06:43 -0500</bug_when>
    <thetext>Description of problem:

The libvirtd.socket systemd unit does not include a [Install] section. This means it cannot be enabled to allow libvirtd to be socket activated as needed (without starting the service beforehand).

Since there is no other reference to libvirtd.socket in any other service file I assume this is a mistake and not deliberate. Or is there something else that activates it that I missed?

The unit probably should include the following (but it currently doesn&apos;t):

 [Install]
 WantedBy=sockets.target


Version-Release number of selected component (if applicable):

libvirt 1.2.13.1

Looking at the upstream sources it seems it also applies to all current versions, up to 1.2.21


How reproducible:

Always


Steps to Reproduce:

1. Run `systemctl enable libvirtd.socket`


Actual results:

Failure with the following message:

 The unit files have no [Install] section. They are not meant to be enabled
 using systemctl.
 Possible reasons for having this kind of units are:
 1) A unit may be statically enabled by being symlinked from another unit&apos;s
    .wants/ or .requires/ directory.
 2) A unit&apos;s purpose may be to act as a helper for some other unit which has
    a requirement dependency on it.
 3) A unit may be started when needed via activation (socket, path, timer,
    D-Bus, udev, scripted systemctl call, ...).


Expected results:

Success.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8808874</commentid>
    <comment_count>1</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2015-11-10 16:31:44 -0500</bug_when>
    <thetext>Martin it looks like you added the .socket file to libvirt.git... thoughts on this?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8811179</commentid>
    <comment_count>2</comment_count>
    <who name="Martin Kletzander">mkletzan</who>
    <bug_when>2015-11-11 10:08:38 -0500</bug_when>
    <thetext>I&apos;m not that familiar with systemd, but I checked with a colleague and yeah, we should do that.  I&apos;m taking the BZ and will post a patch soon.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8811218</commentid>
    <comment_count>3</comment_count>
    <who name="Daniel Berrange">berrange</who>
    <bug_when>2015-11-11 10:21:27 -0500</bug_when>
    <thetext>We actually omitted the [Install] section because if you try to use socket activation with libvirtd.service, it&apos;ll mean that VMs marked as autostart, don&apos;t get autostarted on system boot.  The way to solve this is to make libvirtd create persistent units for VMs which need autostarting, so that systemd takes control of autostarting the VMs, which in turn then triggers autostarting libvirtd.  Until then, I don&apos;t think we should encourage use of socket activation for libvirtd.service.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8811229</commentid>
    <comment_count>4</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2015-11-11 10:23:55 -0500</bug_when>
    <thetext>Maybe we just add a comment to the .socket file to that affect then</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8811262</commentid>
    <comment_count>5</comment_count>
    <who name="Martin Kletzander">mkletzan</who>
    <bug_when>2015-11-11 10:34:08 -0500</bug_when>
    <thetext>I completely forgot about the fact that we talked about it already.  You&apos;re right.  I am wondering why we keep that file in that case, though.  Dan, I just remember I added the support to libvirtd based on your suggestion, so you&apos;ll be the proper one to answer and/or decide on the whole libvirtd.socket file existence.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8811271</commentid>
    <comment_count>6</comment_count>
    <who name="Daniel Berrange">berrange</who>
    <bug_when>2015-11-11 10:38:23 -0500</bug_when>
    <thetext>I guess it is really a placeholder to remind us we should make it work</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8817871</commentid>
    <comment_count>7</comment_count>
    <who name="Daniel Berrange">berrange</who>
    <bug_when>2015-11-13 06:34:33 -0500</bug_when>
    <thetext>I guess we *could* add the [Install] section, if we also add a comment to the .socket file warning people that socket activation means that autostarted guests won&apos;t run at boot. That gives them the choice as to which feature they prefer</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>8817993</commentid>
    <comment_count>8</comment_count>
    <who name="Martin Kletzander">mkletzan</who>
    <bug_when>2015-11-13 07:24:27 -0500</bug_when>
    <thetext>I don&apos;t think anyone would read that.  I&apos;d rather remove it as libvirt daemon is just not suited for socket activation and I doubt it will be.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9227327</commentid>
    <comment_count>9</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2016-04-11 18:20:58 -0400</bug_when>
    <thetext>*** Bug 1192719 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9227393</commentid>
    <comment_count>10</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2016-04-11 19:09:32 -0400</bug_when>
    <thetext>I sent a patch removing the .socket file as Martin suggested:

http://www.redhat.com/archives/libvir-list/2016-April/msg00537.html</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9254605</commentid>
    <comment_count>11</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2016-04-20 09:01:39 -0400</bug_when>
    <thetext>Socket file removed upstream:

commit 3b9100a4d255fdb5f731fcfa49326746d371894a
Author: Cole Robinson &lt;crobinso@redhat.com&gt;
Date:   Mon Apr 11 18:36:20 2016 -0400

    Revert &quot;daemon: use socket activation with systemd&quot;

I&apos;ll pull it into f24</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9295562</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-05-05 08:52:26 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-1.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-f5b59b4ca5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9298511</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-05-06 07:27:31 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-1.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-f5b59b4ca5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9302554</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-05-08 20:03:09 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-1.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>