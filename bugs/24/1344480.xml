<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1344480</bug_id>
          
          <creation_ts>2016-06-09 15:10:00 -0400</creation_ts>
          <short_desc>glibc: nss_db: get*ent crashes without preceding set*ent</short_desc>
          <delta_ts>2016-09-05 04:40:22 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>glibc</component>
          <version>24</version>
          <rep_platform>All</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>high</priority>
          <bug_severity>medium</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1213603</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Florian Weimer">fweimer</reporter>
          <assigned_to name="Florian Weimer">fweimer</assigned_to>
          <cc>arjun.is</cc>
    
    
    <cc>codonell</cc>
    
    
    <cc>dj</cc>
    
    
    <cc>fweimer</cc>
    
    
    <cc>jakub</cc>
    
    
    <cc>law</cc>
    
    
    <cc>mfabian</cc>
    
    
    <cc>pfrankli</cc>
    
    
    <cc>sid</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>glibc-2.22-18.fc23, glibc-2.23.1-10.fc24, glibc-2.23.90-21.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          <cf_clone_of>1213603</cf_clone_of>
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-05 04:40:22</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          <external_bugs name="Sourceware">20237</external_bugs>
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9402188</commentid>
    <comment_count>0</comment_count>
    <who name="Florian Weimer">fweimer</who>
    <bug_when>2016-06-09 15:10:27 -0400</bug_when>
    <thetext>+++ This bug was initially created as a clone of Bug #1213603 +++

Description of problem:
Baseline, with nsswitch set to use db, but no .db files. This works:

&lt;snip&gt;
root@garabaldi ~]# grep services /etc/nsswitch.conf | grep -v &apos;^#&apos;
services:   db files sss
[root@garabaldi ~]# rm -f /var/db/*
rm: cannot remove ‘/var/db/sudo’: Is a directory
[root@garabaldi ~]# perl -e getservent
[root@garabaldi ~]# 
&lt;snip&gt;

Now let;s build a default db file set (this is a clean install):

&lt;snip&gt;
[root@garabaldi ~]# perl -e getservent
[root@garabaldi ~]# cd /var/db/; make; cd -
passwd... done.
group... done.
protocols... done.
rpc... done.
services... done.
shadow... done.

Warning: The shadow password database /var/db/shadow.db
has been set to be readable only by root.  You may want
to make it readable by the `shadow&apos; group depending
on your configuration.

gshadow... done.

Warning: The shadow group database /var/db/gshadow.db
has been set to be readable only by root.  You may want
to make it readable by the `shadow&apos; group depending
on your configuration.

/root
[root@garabaldi ~]# perl -e getservent
Segmentation fault
&lt;snip&gt;
Core was generated by `perl -e getservent&apos;.
Program terminated with signal 11, Segmentation fault.
#0  0x00007f90955685bf in __rawmemchr_sse2 () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install perl-5.16.3-285.el7.x86_64
(gdb) bt
#0  0x00007f90955685bf in __rawmemchr_sse2 () from /lib64/libc.so.6
#1  0x00007f908eba81c1 in _nss_db_getservent_r () from /lib64/libnss_db.so.2
#2  0x00007f90955e0c11 in __nss_getent_r () from /lib64/libc.so.6
#3  0x00007f90955e983a in getservent_r@@GLIBC_2.2.5 () from /lib64/libc.so.6
#4  0x00007f9096931a96 in Perl_pp_gservent () from /usr/lib64/perl5/CORE/libperl.so
#5  0x00007f90968dca46 in Perl_runops_standard ()
   from /usr/lib64/perl5/CORE/libperl.so
#6  0x00007f9096879855 in perl_run () from /usr/lib64/perl5/CORE/libperl.so
#7  0x0000000000400d99 in main ()
&lt;snip&gt;

Version-Release number of selected component (if applicable):
glibc-2.17-78.el7.x86_64

How reproducible:


Steps to Reproduce:
1. Set nsswitch to use &apos;db&apos; for services
    &gt; grep services /etc/nsswitch.conf | grep -v &apos;^#&apos;
    &gt; services:   db files sss
2. cd /var/db/; make; cd -
3. perl -e getservent

Actual results:
Segfault

Expected results:
No Segfault

Additional info:

--- Additional comment from Florian Weimer on 2015-12-15 19:14:49 CET ---

It appears the cause is that that implicit initialization of the service by get*ent (without a preceding set*ent) does not cause initialization of the entidex variable.  _nss_db_get*_r does this:

   247	  if (state.header == NULL)
   248	    {
   249	      status = internal_setent (DBFILE, &amp;state);
   250	      if (status != NSS_STATUS_SUCCESS)
   251		{
   252		  *errnop = errno;
   253		  H_ERRNO_SET (NETDB_INTERNAL);
   254		  goto out;
   255		}
   256	    }

While _nss_db_set* has:

    72	  status = internal_setent (DBFILE, &amp;state);
    73	
    74	  if (status == NSS_STATUS_SUCCESS)
    75	    {
    76	      /* Remember STAYOPEN flag.  */
    77	      keep_db |= stayopen;
    78	
    79	      /* Reset the sequential index.  */
    80	      entidx  = (const char *) state.header + state.header-&gt;valstroffset;
    81	    }

As far as I can see, the bug is present upstream as well.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9626904</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 11:17:08 -0400</bug_when>
    <thetext>glibc-2.23.1-10.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-5f050a0a6d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9627580</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 13:32:46 -0400</bug_when>
    <thetext>glibc-2.22-18.fc23 has been submitted as an update to Fedora 23. https://bodhi.fedoraproject.org/updates/FEDORA-2016-87dde780b8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628577</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 20:21:48 -0400</bug_when>
    <thetext>glibc-2.22-18.fc23 has been pushed to the Fedora 23 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-87dde780b8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628680</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 20:58:37 -0400</bug_when>
    <thetext>glibc-2.23.1-10.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-5f050a0a6d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9631590</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-19 15:52:37 -0400</bug_when>
    <thetext>glibc-2.23.1-10.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676396</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-02 19:20:41 -0400</bug_when>
    <thetext>glibc-2.22-18.fc23 has been pushed to the Fedora 23 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>