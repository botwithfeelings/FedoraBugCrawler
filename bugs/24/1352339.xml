<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1352339</bug_id>
          
          <creation_ts>2016-07-03 19:43:00 -0400</creation_ts>
          <short_desc>xinitrc-common should check SSH_AUTH_SOCK, not SSH_AGENT</short_desc>
          <delta_ts>2016-12-16 16:01:02 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>xorg-x11-xinit</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Shivaram Lingamneni">slingamn</reporter>
          <assigned_to name="Hans de Goede">hdegoede</assigned_to>
          <cc>hdegoede</cc>
    
    
    <cc>jbash</cc>
    
    
    <cc>negativo17</cc>
    
    
    <cc>xgl-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>xorg-x11-xinit-1.3.4-12.fc25 xorg-x11-xinit-1.3.4-13.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-16 16:01:02</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9475277</commentid>
    <comment_count>0</comment_count>
      <attachid>1175706</attachid>
    <who name="Shivaram Lingamneni">slingamn</who>
    <bug_when>2016-07-03 19:43:05 -0400</bug_when>
    <thetext>Created attachment 1175706
proposed patch substituting SSH_AUTH_SOCK for SSH_AGENT

Description of problem:

Right now, this is how /etc/X11/xinit/xinitrc-common decides whether to start a new ssh-agent for the X session:

# Prefix launch of session with ssh-agent if available and not already running.
if [ -z &quot;$SSH_AGENT&quot; ] &amp;&amp; [ -z &quot;$SSH_AGENT_PID&quot; ] &amp;&amp; [ -x /usr/bin/ssh-agent ]; then

I&apos;m not clear on what programs, if any, set the SSH_AGENT environment variable that is being tested. The ssh-agent distributed with Fedora sets only SSH_AUTH_SOCK and SSH_AGENT_PID, e.g.,

$ ssh-agent
SSH_AUTH_SOCK=/tmp/ssh-NAIASogdRImN/agent.27732; export SSH_AUTH_SOCK;
SSH_AGENT_PID=27733; export SSH_AGENT_PID;
echo Agent pid 27733;

I think the correct behavior here is to test SSH_AUTH_SOCK instead of SSH_AGENT. A patch is attached.

Version-Release number of selected component (if applicable):

xorg-x11-xinit-1.3.4-11.fc24.x86_64

How reproducible:

If SSH_AUTH_SOCK is set, but SSH_AGENT_PID is not, the xinit scripts will start a new agent instead of using the old one.

Steps to Reproduce:
1. eval $(ssh-agent -a /tmp/my_preferred_socket_location)
2. export SSH_AGENT_PID=
3. startx

Actual results:

A new ssh-agent is started and its SSH_AUTH_SOCK is exported to the new X session.

Expected results:

The X session should not start a new agent, and `/tmp/my_preferred_socket_location` should be exported as its SSH_AUTH_SOCK.

Additional info:</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9659024</commentid>
    <comment_count>1</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2016-08-29 08:08:42 -0400</bug_when>
    <thetext>Thanks, I&apos;m currently preparing an update fixing this using your patch.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9659328</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-29 08:57:51 -0400</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-12.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-383ce09620</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9661231</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-29 18:55:38 -0400</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-12.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-383ce09620</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9680279</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-05 13:54:07 -0400</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-12.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9962572</commentid>
    <comment_count>5</comment_count>
    <who name="jbash">jbash</who>
    <bug_when>2016-12-06 21:09:57 -0500</bug_when>
    <thetext>This was not a bug. The &quot;fix&quot; reintroduced an old bug.

The purpose of the previous behavior was to let the user customize the system to use something other than OpenSSH&apos;s ssh-agent program as the SSH agent. In particular, gpg-agent can handle keys for SSH, and supports things that ssh-agent does not. The variable could be set in a script in xinitrc.d. xinitrc.d scripts are called a couple of lines above the SSH_AGENT test.

With this change, that no longer works.

There&apos;s no point in checking SSH_AUTH_SOCK. No agent is going to be running at this point.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9963581</commentid>
    <comment_count>6</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2016-12-07 03:34:46 -0500</bug_when>
    <thetext>(In reply to jbash from comment #5)
&gt; This was not a bug. The &quot;fix&quot; reintroduced an old bug.
&gt; 
&gt; The purpose of the previous behavior was to let the user customize the
&gt; system to use something other than OpenSSH&apos;s ssh-agent program as the SSH
&gt; agent. In particular, gpg-agent can handle keys for SSH, and supports things
&gt; that ssh-agent does not. The variable could be set in a script in xinitrc.d.
&gt; xinitrc.d scripts are called a couple of lines above the SSH_AGENT test.
&gt; 
&gt; With this change, that no longer works.

I see, so we should test for SSH_AGENT as well ? or maybe for all 3 of:

SSH_AGENT, SSH_AGENT_PID and SSH_AUTH_SOCK

&gt; There&apos;s no point in checking SSH_AUTH_SOCK. No agent is going to be running
&gt; at this point.

That is not necessarily true some people may start ssh-agent from the cmdline (this is not unheard of) and then maybe later do startx. I assume this is what the original SSH_AGENT_PID check was trying to catch, but since consumers of the agent only care about SSH_AUTH_SOCK that seems like the better variable to check,
I guess we should have left the check for SSH_AGENT in place...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9964446</commentid>
    <comment_count>7</comment_count>
    <who name="jbash">jbash</who>
    <bug_when>2016-12-07 07:43:09 -0500</bug_when>
    <thetext>OK, fair enough, there COULD be an ssh-agent running. And checking for all three would fix my own problem.

But checking for whether an agent is already running is different from checking WHAT should be started in the event that something does need to be started. So it may be a symptom of something weird for the check for SSH_AGENT_PID or SSH_AGENT_SOCK to be on the same line as the check for SSH_AGENT. I guess it&apos;s because XSession overloads the setting of the variable that way too...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9964510</commentid>
    <comment_count>8</comment_count>
    <who name="Shivaram Lingamneni">slingamn</who>
    <bug_when>2016-12-07 08:06:18 -0500</bug_when>
    <thetext>Sorry for the misunderstanding.

I agree with this comment:

&gt;since consumers of the agent only care about SSH_AUTH_SOCK that seems like the better variable to check

It seems like if SSH_AUTH_SOCK is set, then no new agent should be started, regardless of the values of the other environment variables. I&apos;m not sure about the other cases.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9984301</commentid>
    <comment_count>9</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2016-12-14 06:26:01 -0500</bug_when>
    <thetext>Ok, I&apos;m currently preparing an update for F25 checking for all 3 environment variables to fix the regression.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9984397</commentid>
    <comment_count>10</comment_count>
    <who name="Shivaram Lingamneni">slingamn</who>
    <bug_when>2016-12-14 06:57:35 -0500</bug_when>
    <thetext>Sorry, to clarify: if any one of the 3 variables is set, a new agent will not be started? That sounds right to me.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9984426</commentid>
    <comment_count>11</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2016-12-14 07:08:54 -0500</bug_when>
    <thetext>(In reply to Shivaram Lingamneni from comment #10)
&gt; Sorry, to clarify: if any one of the 3 variables is set, a new agent will
&gt; not be started? That sounds right to me.

Correct.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9984645</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-14 07:44:28 -0500</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-13.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-130710e1c3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9988400</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-15 00:07:33 -0500</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-13.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-130710e1c3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9994819</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-16 16:01:02 -0500</bug_when>
    <thetext>xorg-x11-xinit-1.3.4-13.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1175706</attachid>
            <date>2016-07-03 19:43:00 -0400</date>
            <delta_ts>2016-07-03 19:43:05 -0400</delta_ts>
            <desc>proposed patch substituting SSH_AUTH_SOCK for SSH_AGENT</desc>
            <filename>xinitrc-common.patch</filename>
            <type>text/plain</type>
            <size>618</size>
            <attacher name="Shivaram Lingamneni">slingamn</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL2V0Yy9YMTEveGluaXQveGluaXRyYy1jb21tb24uYmFrIGIvZXRjL1gxMS94
aW5pdC94aW5pdHJjLWNvbW1vbgppbmRleCA5NTU0YmJiLi5mNDQyMmYxIDEwMDY0NAotLS0gYS9l
dGMvWDExL3hpbml0L3hpbml0cmMtY29tbW9uLmJhaworKysgYi9ldGMvWDExL3hpbml0L3hpbml0
cmMtY29tbW9uCkBAIC01Niw3ICs1Niw3IEBAIGZvciBmaWxlIGluIC9ldGMvWDExL3hpbml0L3hp
bml0cmMuZC8qIDsgZG8KIGRvbmUKIAogIyBQcmVmaXggbGF1bmNoIG9mIHNlc3Npb24gd2l0aCBz
c2gtYWdlbnQgaWYgYXZhaWxhYmxlIGFuZCBub3QgYWxyZWFkeSBydW5uaW5nLgotaWYgWyAteiAi
JFNTSF9BR0VOVCIgXSAmJiBbIC16ICIkU1NIX0FHRU5UX1BJRCIgXSAmJiBbIC14IC91c3IvYmlu
L3NzaC1hZ2VudCBdOyB0aGVuCitpZiBbIC16ICIkU1NIX0FVVEhfU09DSyIgXSAmJiBbIC16ICIk
U1NIX0FHRU5UX1BJRCIgXSAmJiBbIC14IC91c3IvYmluL3NzaC1hZ2VudCBdOyB0aGVuCiAgICAg
aWYgWyAieCRUTVBESVIiICE9ICJ4IiBdOyB0aGVuCiAgICAgICAgIFNTSF9BR0VOVD0iL3Vzci9i
aW4vc3NoLWFnZW50IC9iaW4vZW52IFRNUERJUj0kVE1QRElSIgogICAgIGVsc2UK
</data>

          </attachment>
      

    </bug>

</bugzilla>