<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1341998</bug_id>
          
          <creation_ts>2016-06-02 05:07:00 -0400</creation_ts>
          <short_desc>libvirt returns an error when detaching floppy volume from a running qemu vm</short_desc>
          <delta_ts>2016-06-26 16:55:09 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Andrew Cook">ariscop</reporter>
          <assigned_to name="Libvirt Maintainers">libvirt-maint</assigned_to>
          <cc>agedosier</cc>
    
    
    <cc>berrange</cc>
    
    
    <cc>clalancette</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>laine</cc>
    
    
    <cc>libvirt-maint</cc>
    
    
    <cc>pkrempa</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>libvirt-1.3.3.1-4.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-06-26 16:55:09</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9380240</commentid>
    <comment_count>0</comment_count>
    <who name="Andrew Cook">ariscop</who>
    <bug_when>2016-06-02 05:07:23 -0400</bug_when>
    <thetext>Description of problem:
libvirt returns an error when detaching floppy volume from a running qemu vm

Version-Release number of selected component (if applicable):
Version     : 1.3.3.1
Release     : 2.fc24

How reproducible:
Always

Steps to Reproduce:
From either virsh or virt-manager
1. Add floppy drive to domain with a backing volume
2. Start domain
3. detach the volume from the floppy drive

Actual results:
Fails with &quot;Error: An error occurred, but the cause is unknown

Expected results:
Volume is detached

Additional info:
The volume actually detaches in qemu (confirmed via qemu-monitor-command) but libvirt seems to be waiting for an event from the floppy device, which isn&apos;t sent by qemu.

Successful detach of a cdrom (captured via strace):
write(25, &quot;{&quot;execute&quot;:&quot;eject&quot;,&quot;arguments&quot;:{&quot;device&quot;:&quot;drive-ide0-0-1&quot;,&quot;force&quot;:false},&quot;id&quot;:&quot;libvirt-672&quot;}\r\n&quot;, 94)
read(25, &quot;{&quot;timestamp&quot;: {&quot;seconds&quot;: 1464848422, &quot;microseconds&quot;: 600129}, &quot;event&quot;: &quot;DEVICE_TRAY_MOVED&quot;, &quot;data&quot;: {&quot;device&quot;: &quot;drive-ide0-0-1&quot;, &quot;tray-open&quot;: true}}\r\n&quot;, 1023)
read(25, &quot;{&quot;return&quot;: {}, &quot;id&quot;: &quot;libvirt-672&quot;}\r\n&quot;, 1023)

Unsuccessful detach of a floppy:
write(25, &quot;{&quot;execute&quot;:&quot;eject&quot;,&quot;arguments&quot;:{&quot;device&quot;:&quot;drive-fdc0-0-0&quot;,&quot;force&quot;:false},&quot;id&quot;:&quot;libvirt-791&quot;}\r\n&quot;, 94)
read(25, &quot;{&quot;return&quot;: {}, &quot;id&quot;: &quot;libvirt-791&quot;}\r\n&quot;, 1023)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9380250</commentid>
    <comment_count>1</comment_count>
    <who name="Andrew Cook">ariscop</who>
    <bug_when>2016-06-02 05:08:35 -0400</bug_when>
    <thetext>qemu version:
Name        : qemu-system-x86
Version     : 2.6.0
Release     : 3.fc24</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9380507</commentid>
    <comment_count>2</comment_count>
    <who name="Peter Krempa">pkrempa</who>
    <bug_when>2016-06-02 06:14:12 -0400</bug_when>
    <thetext>This was already fixed in upstream libvirt:

$ git desc 72a7ff6b507bcf389cc493ac0ba07d32de266d6e
v1.3.4-465-g72a7ff6

It will be included in the upcomming 1.3.5 release.

commit 72a7ff6b507bcf389cc493ac0ba07d32de266d6e
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Thu May 19 15:30:12 2016 +0200

    qemu: hotplug: wait for the tray to eject only for drives with a tray
    
    Use the detected tray presence flag to trigger the tray waiting code
    only if the given storage device in qemu reports to have a tray.
    
    This is necessary as the floppy device lost it&apos;s tray as of qemu commit:
    
    commit abb3e55b5b718d6392441f56ba0729a62105ac56
    Author: Max Reitz &lt;mreitz@redhat.com&gt;
    Date:   Fri Jan 29 20:49:12 2016 +0100
    
        Revert &quot;hw/block/fdc: Implement tray status&quot;

commit 2e75da42e41af0cd48ca6f75d0606b40a366cc54
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Mon May 23 16:32:06 2016 +0200

    qemu: hotplug: Fix error reported when cdrom tray is locked
    
    Commit 1fad65d49aae364576bd91352a001249510f8d4e used a really big hammer
    and overwrote the error message that might be reported by qemu if the
    tray is locked. Fix it by reporting the error only if no error is
    currently set.
    
    Error after commit mentioned above:
    error: internal error: timed out waiting for disk tray status update
    
    New error:
    error: internal error: unable to execute QEMU command &apos;eject&apos;: Tray of
    device &apos;drive-ide0-0-0&apos; is not open

commit 0aa19f35e0f3c1712f2569986d4d0a93b488c35c
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Mon May 23 14:50:17 2016 +0200

    qemu: hotplug: Extract code for waiting for tray eject
    
    The code grew rather convoluted. Extract it to a separate function.

commit 894dc85fd1ebcd63d8c897b355c550e68a5f432d
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Thu May 19 15:29:02 2016 +0200

    qemu: process: Fix and improve disk data extraction
    
    Extract information for all disks and update tray state and source only
    for removable drives. Additionally store whether a drive is removable
    and whether it has a tray.

commit d9bee413ade28e1e43ef222c7aaaa3c6d6fda0f1
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Mon May 23 14:00:35 2016 +0200

    qemu: Move and rename qemuDomainCheckEjectableMedia to qemuProcessRefreshDisks
    
    Move it to a more sane place since it&apos;s refreshing data about disks.

commit f1690dc3d7934bf70f4fbc84d55bf210276c6f27
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Thu May 19 14:57:41 2016 +0200

    qemu: Extract more information about qemu drives
    
    Extract whether a given drive has a tray and whether there is no image
    inserted.
    
    Negative logic for the image insertion is chosen so that the flag is set
    only if we are certain of the fact.

commit 5f963d89b1220460fadb1bf6fc347d26b311c1b2
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Fri May 20 07:21:04 2016 +0200

    qemu: Move struct qemuDomainDiskInfo to qemu_domain.h

Patches above depend on:
commit 833ae6b4356934e7b779c4be01bd2bf051930dde
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Fri Apr 29 13:49:13 2016 +0200

    qemu: hotplug: Skip waiting for tray opening if qemu doesn&apos;t notify us
    
    If qemu doesn&apos;t support DEVICE_TRAY_MOVED event the code that attempts
    to change media would attempt to re-eject the tray even if it wouldn&apos;t
    be notified when the tray opened. Add a capability bit and skip retrying
    for old qemus.

commit a34faf33011c5c0d7b47ee0849bf1e11635e17c5
Author: Peter Krempa &lt;pkrempa@redhat.com&gt;
Date:   Fri Apr 29 13:38:51 2016 +0200

    qemu: process: Refresh ejectable media tray state on VM start
    
    Empty floppy drives start with tray in &quot;open&quot; state and libvirt did not
    refresh it after startup. The code that inserts media into the tray then
    waited until the tray was open before inserting the media and thus
    floppies could not be inserted.
    
    Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=1326660</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9448510</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-23 18:32:00 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-4.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-b2f402a414</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451988</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-24 20:32:03 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-4.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-b2f402a414</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9453496</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-26 16:54:54 -0400</bug_when>
    <thetext>libvirt-1.3.3.1-4.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>