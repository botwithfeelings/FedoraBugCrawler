<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1364730</bug_id>
          
          <creation_ts>2016-08-06 13:45:00 -0400</creation_ts>
          <short_desc>DKIM signing of originating mail stopped working after upgrade from 2.10.1-5 to 2.11.0-3</short_desc>
          <delta_ts>2016-08-27 06:23:12 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>amavisd-new</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Dirk Cummings">matt</reporter>
          <assigned_to name="Juan Orti">j.orti.alcaine</assigned_to>
          <cc>j.orti.alcaine</cc>
    
    
    <cc>perl-devel</cc>
    
    
    <cc>steve</cc>
    
    
    <cc>vanmeeuwen+fedora</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>amavisd-new-2.11.0-4.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-08-26 06:22:14</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9590776</commentid>
    <comment_count>0</comment_count>
      <attachid>1188215</attachid>
    <who name="Dirk Cummings">matt</who>
    <bug_when>2016-08-06 13:45:18 -0400</bug_when>
    <thetext>Created attachment 1188215
Patch file from https://lists.amavis.org/pipermail/amavis-users/2016-July/004428.html

Description of problem:

Hello, after updating to the latest amavisd-new package I noticed that DKIM signing no longer works with existing configs.

Running amavisd-new in debug mode, I can confirm that locally generated mail (in this example sent from root to another local user) is getting routed to the corrected port for the ORIGINATING policy bank (10026):

Aug  6 18:36:05.865 cipixia.com /usr/sbin/amavisd[2709]: (02709-01) LMTP :10026 /var/spool/amavisd/tmp/amavis-20160806T183605-02709-mYQagKcY: &lt;root@cipixia.com&gt; -&gt; &lt;matt@localhost.com&gt; Received: from cipixia.com ([127.0.0.1]) by localhost (cipixia.com [127.0.0.1]) (amavisd-new, port 10026) with LMTP for &lt;matt@localhost.com&gt;; Sat,  6 Aug 2016 18:36:05 +0200 (CEST)

but then a little bit later it decides that the mail is not considered originating (relevant bits pasted from log):

Aug  6 18:36:05.905 cipixia.com /usr/sbin/amavisd[2709]: (02709-01) Checking: wVqqBSZuYzR0 ORIGINATING [127.0.0.1] &lt;root@cipixia.com&gt; -&gt; &lt;matt@localhost.com&gt;
...
...
Aug  6 18:36:05.906 cipixia.com /usr/sbin/amavisd[2709]: (02709-01) Open relay? Nonlocal recips but not originating: matt@localhost.com
...
...
Aug  6 18:36:05.931 cipixia.com /usr/sbin/amavisd[2709]: (02709-01) dkim: not signing mail which is not originating from our site


I Googled around and found this relevant post on the amavisd-new mailing list, which actually solved my problem:
https://lists.amavis.org/pipermail/amavis-users/2016-July/004428.html

In the related message, Giovanni provides a simple patch for /usr/sbin/amavisd that restores expected functionality.

I tested this patch against my current amavisd-new install by applying it like so:
patch -b /usr/sbin/amavisd &lt; /tmp/amavisd_dkim_fix.patch 

I then reran the the same test as before by sending an email from root to another localhost user with amavisd-new in debug mode, and the output now shows the expected behavior:

Aug  6 18:44:48.246 cipixia.com /usr/sbin/amavisd[2882]: (02882-01) LMTP :10026 /var/spool/amavisd/tmp/amavis-20160806T184448-02882-LhR01zY9: &lt;root@cipixia.com&gt; -&gt; &lt;matt@localhost.com&gt; Received: from cipixia.com ([127.0.0.1]) by localhost (cipixia.com [127.0.0.1]) (amavisd-new, port 10026) with LMTP for &lt;matt@localhost.com&gt;; Sat,  6 Aug 2016 18:44:48 +0200 (CEST)
...
...
Aug  6 18:44:48.286 cipixia.com /usr/sbin/amavisd[2882]: (02882-01) Checking: r89s629QBf_0 ORIGINATING [127.0.0.1] &lt;root@cipixia.com&gt; -&gt; &lt;matt@localhost.com&gt;
...
...
Aug  6 18:44:48.309 cipixia.com /usr/sbin/amavisd[2882]: (02882-01) dkim: candidate originators: From:&lt;root@cipixia.com&gt;
..
..
Aug  6 18:44:48.310 cipixia.com /usr/sbin/amavisd[2882]: (02882-01) dkim: signing (author), From: &lt;root@cipixia.com&gt; (From:&lt;root@cipixia.com&gt;), KEY.key_ind=&gt;0, a=&gt;rsa-sha256, c=&gt;relaxed/simple, d=&gt;cipixia.com, s=&gt;dkimkey, ttl=&gt;1814400, x=&gt;1472316289

and so on.

I am not subscribed to the amavisd user&apos;s mailing list so I&apos;m not sure if the upstream developers have responded to or acknowledged Giovanni&apos;s message, but his patch worked for me and solved the issue.


Version-Release number of selected component (if applicable):
amavisd-new-2.11.0-3.fc24.noarch

How reproducible:
Always


Steps to Reproduce:
1.  Setup dkim signing for the originating policy bank
2.  Verify in the logs that your test mail is being routed to the correct port
3.  Observe that dkim signing is not performed and the message is not considered &quot;local&quot;, despite being in the right policy bank

Actual results:
No dkim signing, log messages indicate local mail is not considered as originating.


Expected results:
Dkim signing performed and triggered by ORIGINATING mail


Additional info:
I&apos;ve attached the patch from the mailing list to this bug, for convenience</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9625823</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 05:48:31 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-0ff4ff1572</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9625853</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 05:58:50 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-e2ac9d7455</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9625874</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 06:06:24 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc23 has been submitted as an update to Fedora 23. https://bodhi.fedoraproject.org/updates/FEDORA-2016-6c44ba32a8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9627309</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 12:54:16 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-0ff4ff1572</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628600</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 20:23:32 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc23 has been pushed to the Fedora 23 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-6c44ba32a8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628694</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 20:59:30 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-e2ac9d7455</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9636410</commentid>
    <comment_count>7</comment_count>
    <who name="Dirk Cummings">matt</who>
    <bug_when>2016-08-22 11:11:22 -0400</bug_when>
    <thetext>Hello,

I just upgraded to amavisd-new-2.11.0-4.fc24.noarch via the updates-testing repo and verified that I was able to verify that dkim signing works again for ORIGINATING mail.

This issue is fixed for me - thank you!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9652431</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-26 06:22:11 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9652815</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-26 08:49:17 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc23 has been pushed to the Fedora 23 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9655487</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-27 06:23:12 -0400</bug_when>
    <thetext>amavisd-new-2.11.0-4.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1188215</attachid>
            <date>2016-08-06 13:45:00 -0400</date>
            <delta_ts>2016-08-06 13:45:18 -0400</delta_ts>
            <desc>Patch file from https://lists.amavis.org/pipermail/amavis-users/2016-July/004428.html</desc>
            <filename>amavisd_dkim_fix.patch</filename>
            <type>text/plain</type>
            <size>432</size>
            <attacher name="Dirk Cummings">matt</attacher>
            
              <data encoding="base64">LS0tIGFtYXZpc2Qub3JpZwlUdWUgQXByIDI2IDIxOjI0OjMzIDIwMTYKKysrIGFtYXZpc2QJRnJp
IEp1bCAgMSAwMTowMzoxNSAyMDE2CkBAIC0zNDMzOCw2ICszNDMyOSw3IEBAIHN1YiBjb2xsZWN0
X3NvbWVfZGtpbV9pbmZvKCQpIHsKICAgICAkc2lnX2luZCsrOwogICB9CiAgIEFtYXZpczo6bG9h
ZF9wb2xpY3lfYmFuaygkXywkbXNnaW5mbykgZm9yIEBiYW5rX25hbWVzOworICAkbXNnaW5mby0+
b3JpZ2luYXRpbmcoYygnb3JpZ2luYXRpbmcnKSk7CiAgICRtc2dpbmZvLT5ka2ltX3NpZ25hdHVy
ZXNfdmFsaWQoXEBzaWduYXR1cmVzX3ZhbGlkKSAgaWYgQHNpZ25hdHVyZXNfdmFsaWQ7CiAjIGlm
IChsbCg1KSAmJiAkc2lnX2luZCA+IDApIHsKICMgICAjIHNob3cgd2hpY2ggaGVhZGVyIGZpZWxk
cyBhcmUgY292ZXJlZCBieSB3aGljaCBzaWduYXR1cmUK
</data>

          </attachment>
      

    </bug>

</bugzilla>