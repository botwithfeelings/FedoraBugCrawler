<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1395288</bug_id>
          
          <creation_ts>2016-11-15 10:55:00 -0500</creation_ts>
          <short_desc>Krb5 using futex breaks GSSAPI key exchange in OpenSSH</short_desc>
          <delta_ts>2017-01-06 15:21:42 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>openssh</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jakub Jelen">jjelen</reporter>
          <assigned_to name="Jakub Jelen">jjelen</assigned_to>
          <cc>abokovoy</cc>
    
    
    <cc>cjwatson</cc>
    
    
    <cc>jjelen</cc>
    
    
    <cc>mattias.ellert</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>npmccallum</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>rharwood</cc>
    
    
    <cc>tibbs</cc>
    
    
    <cc>tmraz</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>openssh-7.2p2-14.fc24 openssh-7.3p1-6.fc25 openssh-7.4p1-1.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-01-06 15:21:42</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9893237</commentid>
    <comment_count>0</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-11-15 10:55:32 -0500</bug_when>
    <thetext>Description of problem:
Some of the recent version of krb5 brought the usage of threads and futexes in the function gss_indicate_mechs() which breaks GSSAPI key exchange with seccomp filter enabled.

We call  gss_indicate_mechs()  in the privsep child (limited by seccomp filter), but system call futex() is not in our current whitelist in this limited environment. 

Does this function really need to fully initialize krb5, threads and futexes? Do the futexes need to succeed? Is it considered safe to call this method from such limited process?

If it is expected change, feel free to reassign back on me for to openssh. I can either whitelist futex() syscall, if it is safe, or we can move this call back to the privileged monitor process.

Version-Release number of selected component (if applicable):
krb5-devel-1.14.4-4.fc24.x86_64
openssh-7.3p1-3.fc26.x86_64

How reproducible:
deterministic

Steps to Reproduce:
1. Set up GSSAPI authentication and GSSAPI key exchange in OpenSSH with explicit algorithm (eg. gss-group1-sha1-)
2. Try to connect to this server using the same algorithm

Actual results:
The connection fails (exit code 255), server reports failed privsep child.

Expected results:
The connection works.

Additional info:
Thread 2.1 &quot;sshd&quot; received signal SIGSYS, Bad system call.
#0  0x00007ffff3c6b340 in __pthread_once_slow () from /lib64/libpthread.so.0
#1  0x00007ffff384e6c9 in krb5int_pthread_loaded () from /lib64/libkrb5support.so.0
#2  0x00007ffff5e113a9 in gssint_mechglue_initialize_library () from /lib64/libgssapi_krb5.so.2
#3  0x00007ffff5e114ec in gss_indicate_mechs () from /lib64/libgssapi_krb5.so.2
#4  0x000000000042d125 in ssh_gssapi_supported_oids (oidset=oidset@entry=0x7fffffffd920)
    at gss-serv.c:180
#5  0x000000000042d25c in ssh_gssapi_server_mechanisms () at gss-serv.c:151
#6  0x000000000040c111 in do_ssh2_kex () at sshd.c:2833
#7  main (ac=&lt;optimized out&gt;, av=&lt;optimized out&gt;) at sshd.c:2420</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9893633</commentid>
    <comment_count>1</comment_count>
    <who name="Robbie Harwood">rharwood</who>
    <bug_when>2016-11-15 12:36:00 -0500</bug_when>
    <thetext>(In reply to Jakub Jelen from comment #0)
&gt; Description of problem:
&gt; Some of the recent version of krb5 brought the usage of threads and futexes
&gt; in the function gss_indicate_mechs() which breaks GSSAPI key exchange with
&gt; seccomp filter enabled.
&gt; 
&gt; We call  gss_indicate_mechs()  in the privsep child (limited by seccomp
&gt; filter), but system call futex() is not in our current whitelist in this
&gt; limited environment. 
&gt; 
&gt; Does this function really need to fully initialize krb5, threads and
&gt; futexes? Do the futexes need to succeed? Is it considered safe to call this
&gt; method from such limited process?
&gt;
&gt; If it is expected change, feel free to reassign back on me for to openssh. I
&gt; can either whitelist futex() syscall, if it is safe, or we can move this
&gt; call back to the privileged monitor process.

futex() is widely considered a safe syscall, and is used for synchronization.  I don&apos;t see why one would want it blocked.

Please note that we are not calling this function directly; it is being called as part of (setting up) pthreads.  To my knowledge, calling into libpthread here is not new, so if futex() is an issue for some reason of which I&apos;m not aware, the pthread (libc) people would be better to ask than me if it needs changed.

Almost every call into GSSAPI needs to have GSSAPI fully initialized in order to know what mechanisms are available (because they&apos;re configurable at runtime).  This means that it needs to initialize the krb5 mechanism, which is what you&apos;re seeing here.

Hope that helps!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9896665</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-16 08:10:27 -0500</bug_when>
    <thetext>openssh-7.3p1-6.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-6d0ee59e4e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9896666</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-16 08:10:40 -0500</bug_when>
    <thetext>openssh-7.3p1-6.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-6d0ee59e4e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9896748</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-16 08:32:34 -0500</bug_when>
    <thetext>openssh-7.2p2-14.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-48f5186dfb</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9896770</commentid>
    <comment_count>5</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-11-16 08:38:45 -0500</bug_when>
    <thetext>OK. Thank you. I added the exception to the seccomp filter.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9898177</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-16 15:24:04 -0500</bug_when>
    <thetext>openssh-7.3p1-6.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-6d0ee59e4e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9898987</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-16 22:58:02 -0500</bug_when>
    <thetext>openssh-7.2p2-14.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-48f5186dfb</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9905524</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-19 12:25:31 -0500</bug_when>
    <thetext>openssh-7.2p2-14.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9905853</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-11-19 16:13:08 -0500</bug_when>
    <thetext>openssh-7.3p1-6.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10023153</commentid>
    <comment_count>10</comment_count>
    <who name="Colin Watson">cjwatson</who>
    <bug_when>2016-12-28 15:07:30 -0500</bug_when>
    <thetext>I think this is probably the wrong fix, given the changes in response to https://bugzilla.mindrot.org/show_bug.cgi?id=2107.  Consider this patch instead (sorry, split into multiple links for reasons, but should be clear enough):

  https://anonscm.debian.org/cgit/pkg-ssh/openssh.git/diff/gss-serv.c?id=31ed1f715e4c1dd986c32b8c5e6687c185258db9
  https://anonscm.debian.org/cgit/pkg-ssh/openssh.git/diff/sshd.c?id=31ed1f715e4c1dd986c32b8c5e6687c185258db9</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10025671</commentid>
    <comment_count>11</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-12-31 06:42:50 -0500</bug_when>
    <thetext>Thank you Colin for a notice. Your fix looks much better (does not open more switches in the seccomp). I still miss some connections in the gssapi code.

I will fix that after I will be done with rebase.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10030795</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-03 09:50:51 -0500</bug_when>
    <thetext>openssh-7.4p1-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-4767e2991d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10031881</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-03 17:21:55 -0500</bug_when>
    <thetext>openssh-7.4p1-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-4767e2991d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10041705</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-06 15:21:42 -0500</bug_when>
    <thetext>openssh-7.4p1-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>