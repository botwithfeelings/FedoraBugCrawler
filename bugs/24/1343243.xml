<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1343243</bug_id>
          
          <creation_ts>2016-06-06 18:28:00 -0400</creation_ts>
          <short_desc>lxc-net.service is not started during boot because of missing /etc/resolv.conf</short_desc>
          <delta_ts>2016-12-13 19:51:25 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>lxc</component>
          <version>24</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Andrej">adundovi</reporter>
          <assigned_to name="Thomas Moschny">thomas.moschny</assigned_to>
          <cc>karlthered</cc>
    
    
    <cc>pokorra.mailinglists</cc>
    
    
    <cc>sagarun</cc>
    
    
    <cc>thomas.moschny</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>lxc-2.0.6-2.fc25 lxc-2.0.6-2.fc24 lxc-2.0.6-2.fc23</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-13 15:27:19</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9391969</commentid>
    <comment_count>0</comment_count>
    <who name="Andrej">adundovi</who>
    <bug_when>2016-06-06 18:28:35 -0400</bug_when>
    <thetext>Description of problem:
lxc-net.service should provide a bridge device and a dhcp server for linux containers but it fails to start during the boot process thus blocking containers to start.

Version-Release number of selected component (if applicable):
lxc-2.0.0-1.fc24.x86_64
lxc-libs-2.0.0-1.fc24.x86_64
lxc-templates-2.0.0-1.fc24.x86_64

Steps to Reproduce:
1. Install lxc and set-up one container inside of the fresh installation of Fedora 24 (beta/KDE/x64_86);
2. enable lxc-net service (systemctl enable lxc-net.service);
3. make the container starts on boot:
lxc.start.auto = 1
lxc.group = onboot
4. reboot

Actual results:
Jun 06 23:52:35 localhost lxc-net[1082]: dnsmasq: directory /etc/resolv.conf for resolv-file is missing, cannot poll
Jun 06 23:52:35 localhost dnsmasq[1194]: directory /etc/resolv.conf for resolv-file is missing, cannot poll
Jun 06 23:52:35 localhost dnsmasq[1194]: FAILED to start up

Container didn&apos;t start because lxc-net.service failed to start up.

Expected results:
To have containers up and running after booting Fedora.

Additional info:
/etc/resolv.conf is created by NetworkManager during the boot sequence (/etc/resolv.conf -&gt; /var/run/NetworkManager/resolv.conf), hence I assume that this is an issue of service ordering in systemd, but I don&apos;t see how exactly.
lxc-net.service is waiting for network-online.target and network-online.target
is depending on NetworkManager-wait-online.service, i.e. when NetworkManager is ready.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9391980</commentid>
    <comment_count>1</comment_count>
    <who name="Andrej">adundovi</who>
    <bug_when>2016-06-06 18:47:02 -0400</bug_when>
    <thetext>I would also note that the machine where I encounter this issue is a laptop which usually acquire network connection after I log in.

Working workaround is to put &quot;NetworkManager.service&quot; as a dependency in lxc-net.service:
[Unit]
After=network-online.target NetworkManager.service

Then it works as expected.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9940386</commentid>
    <comment_count>2</comment_count>
    <who name="Thomas Moschny">thomas.moschny</who>
    <bug_when>2016-11-29 14:49:41 -0500</bug_when>
    <thetext>In theory, having

  After=network-online.target

should already be enough, to ensure (as the name says) that the network is online.

But (afaict) network-online.target currently only works reliably if systemd-networkd is used.

On the other hand, depending on NetworkManager as you proposed is also not an option, as not everyone is using NM.

So, this is something we cannot fix in lxc. Someone has to repair the network-online.target for NM.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954312</commentid>
    <comment_count>3</comment_count>
    <who name="Andrej">adundovi</who>
    <bug_when>2016-12-04 08:01:03 -0500</bug_when>
    <thetext>Can you please explain more what would be expected behaviour of network-online for this case so that I can open a new bug report?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954441</commentid>
    <comment_count>4</comment_count>
    <who name="Thomas Moschny">thomas.moschny</who>
    <bug_when>2016-12-04 12:46:19 -0500</bug_when>
    <thetext>So, network-online depends on, and is scheduled after NetworkManager-wait-online (reversely, by setting Before in NM-wait-online). The NM-wait-online service calls /usr/bin/nm-online -s --timeout 30, and the man page says for -s: &quot;Wait for NetworkManager startup to complete, rather than waiting for network connectivity specifically.&quot;

To me, this looks reasonable. However, there must be a reason it doesn&apos;t work for you. Is NetworkManager-wait-online enabled?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954462</commentid>
    <comment_count>5</comment_count>
    <who name="Thomas Moschny">thomas.moschny</who>
    <bug_when>2016-12-04 14:13:14 -0500</bug_when>
    <thetext>Wait, I&apos;ve read some of the systemd docs again. For network-online to have effect, we might need to add a Wants= dependency to lxc-net.

Also, ignore my comment about NetworkManager-wait-online being enabled, that shouldn&apos;t be necessary.

Could you try and see if adding Wants=network-online.target to the [Unit] section of lxc-net helps?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954478</commentid>
    <comment_count>6</comment_count>
    <who name="Andrej">adundovi</who>
    <bug_when>2016-12-04 15:15:18 -0500</bug_when>
    <thetext>Yep, that works. Thanks.

Thus, this is my lxc-net.service:

[Unit]
Description=LXC network bridge setup
Wants=network-online.target
Before=lxc.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/libexec/lxc/lxc-net start
ExecStop=/usr/libexec/lxc/lxc-net stop

[Install]
WantedBy=multi-user.targe</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955636</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:45:31 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-b4dd1db1e7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955638</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:45:39 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-b4dd1db1e7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955648</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:48:49 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-868350fe5a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955649</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:48:55 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-868350fe5a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955659</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:51:02 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc23 has been submitted as an update to Fedora 23. https://bodhi.fedoraproject.org/updates/FEDORA-2016-e5ff0ed40c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9955660</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 06:51:07 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc23 has been submitted as an update to Fedora 23. https://bodhi.fedoraproject.org/updates/FEDORA-2016-e5ff0ed40c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9958394</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 22:24:15 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-868350fe5a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9958450</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 22:56:41 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc23 has been pushed to the Fedora 23 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-e5ff0ed40c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9958477</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-05 22:59:22 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-b4dd1db1e7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9982266</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 15:27:19 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9982600</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 17:53:27 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9982820</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 19:51:25 -0500</bug_when>
    <thetext>lxc-2.0.6-2.fc23 has been pushed to the Fedora 23 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>