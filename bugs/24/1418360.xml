<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1418360</bug_id>
          
          <creation_ts>2017-02-01 11:08:00 -0500</creation_ts>
          <short_desc>grub2 incorrectly initialises the boot_params from the kernel image</short_desc>
          <delta_ts>2017-06-29 19:28:25 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>grub2</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1451071</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>AcceptedFreezeException</status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1349188</blocked>
    
    
    <blocked>1349189</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="David Howells">dhowells</reporter>
          <assigned_to name="Peter Jones">pjones</assigned_to>
          <cc>awilliam</cc>
    
    
    <cc>bugzilla</cc>
    
    
    <cc>dominik</cc>
    
    
    <cc>hanishkvc</cc>
    
    
    <cc>lkundrak</cc>
    
    
    <cc>mikhail.v.gavrilov</cc>
    
    
    <cc>pjones</cc>
    
    
    <cc>pomidorabelisima</cc>
    
    
    <cc>robatino</cc>
    
    
    <cc>thomas</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>grub-2.02-0.40.fc26 grub2-2.02-0.40.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-29 19:28:25</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10113216</commentid>
    <comment_count>0</comment_count>
    <who name="David Howells">dhowells</who>
    <bug_when>2017-02-01 11:08:49 -0500</bug_when>
    <thetext>Description of problem:

To quote Matt Fleming:

  grub2 memcpy()&apos;s 1024 bytes from the start of kernel image header
  into the allocated (and zeroed) boot_params object. Unfortunately,
  it should only be copying the second 512-byte chunk, not the first
  too.

  The boot loader should only fill out those fields in the first 512
  bytes that it understands. Everything else should be zero, which
  allows us to add fields (and give them default non-zero values in
  the header) in the future without breaking old boot loaders.

In grub-core/loader/i386/efi/linux.c is the following line:

   grub_memcpy (params, &amp;lh, 2 * 512);

But this should be something like:

   grub_memcpy ((grub_uint8_t *)params + 512, (grub_uint8_t *)&amp;lh[512], 512);

The problem with copying 1024 bytes is that it sets the sentinel byte to 0xff rather than leaving it as 0 - and this triggers sanitize_boot_params() to clear various parts of the boot_params struct.

This is what the comment in the definition of struct boot_params says:

 * A bootloader is supposed to only take setup_header and put
 * it into a clean boot_params buffer. If it turns out that
 * it is clumsy or too generous with the buffer, it most
 * probably will pick up the sentinel variable too. The fact
 * that this variable then is still 0xff will let kernel
 * know that some variables in boot_params are invalid and
 * kernel should zero out certain portions of boot_params.

Now, one could argue that this means that only boot_params-&gt;hdr should be copied (offset 0x1f1 up to 0x290).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10113249</commentid>
    <comment_count>1</comment_count>
    <who name="David Howells">dhowells</who>
    <bug_when>2017-02-01 11:14:41 -0500</bug_when>
    <thetext>&gt; Now, one could argue that this means that only boot_params-&gt;hdr
&gt; should be copied (offset 0x1f1 up to 0x290).

Actually, 0x1f1 for 119 bytes.  I don&apos;t know if the subsequent padding is meant for struct setup_header to grow into.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10113256</commentid>
    <comment_count>2</comment_count>
    <who name="David Howells">dhowells</who>
    <bug_when>2017-02-01 11:16:49 -0500</bug_when>
    <thetext>The problem with the triggered sanitization is that it clobbers the secure-boot mode parameter calculated in the EFI boot wrapper and passed through boot_params to the core kernel.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10302794</commentid>
    <comment_count>3</comment_count>
    <who name="poma">pomidorabelisima</who>
    <bug_when>2017-04-04 10:35:53 -0400</bug_when>
    <thetext>(In reply to David Howells from comment #0)
[...]
&gt; In grub-core/loader/i386/efi/linux.c is the following line:
&gt; 
&gt;    grub_memcpy (params, &amp;lh, 2 * 512);
&gt; 
&gt; But this should be something like:
&gt; 
&gt;    grub_memcpy ((grub_uint8_t *)params + 512, (grub_uint8_t *)&amp;lh[512], 512);
[...]

diff --git a/grub-core/loader/i386/efi/linux.c b/grub-core/loader/i386/efi/linux.c
index 010bf98..02b1327 100644
--- a/grub-core/loader/i386/efi/linux.c
+++ b/grub-core/loader/i386/efi/linux.c
@@ -269,7 +269,7 @@ grub_cmd_linux (grub_command_t cmd __attribute__ ((unused)),
   loaded=1;
 
   lh.code32_start = (grub_uint32_t)(grub_uint64_t) kernel_mem;
-  grub_memcpy (params, &amp;lh, 2 * 512);
+  grub_memcpy ((grub_uint8_t *)params + 512, (grub_uint8_t *)&amp;lh[512], 512);
 
   params-&gt;type_of_loader = 0x21;
 

make
...
loader/i386/efi/linux.c: In function ‘grub_cmd_linux’:
loader/i386/efi/linux.c:272:65: error: subscripted value is neither array nor pointer nor vector
   grub_memcpy ((grub_uint8_t *)params + 512, (grub_uint8_t *)&amp;lh[512], 512);
                                                                 ^
...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10302811</commentid>
    <comment_count>4</comment_count>
    <who name="poma">pomidorabelisima</who>
    <bug_when>2017-04-04 10:38:44 -0400</bug_when>
    <thetext>*** Bug 1438397 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10477297</commentid>
    <comment_count>5</comment_count>
    <who name="hanishkvc">hanishkvc</who>
    <bug_when>2017-06-05 09:15:31 -0400</bug_when>
    <thetext>Any specific reason why this bug is still not resolved? Also isn&apos;t there a bug in kernel also.

Looking at the note given in struct boot_param, as well as how the efi boot wrapper within in the kernel is using some part of the boot_param to set its own parameters, after it has got control from the original bootloader, why is the sanitize_boot_params WRONGLY reseting parameters which are (or can be as is the case here) set outside/after the bootloader.

Other than fixing the blind and potentially wrong copying of parameters area into boot_param by grub. The kernel should also be fixed to have some additional parameter to check if bootloader has set the secure boot related params or the kernel&apos;s efi boot wrapper has set it, and then sanitize only if required.

OR am I missing something here?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10541831</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-26 17:27:47 -0400</bug_when>
    <thetext>grub2-2.02-0.40.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-01b07bc086</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10541837</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Blocker Bugs Application">blockerbugs</who>
    <bug_when>2017-06-26 17:33:51 -0400</bug_when>
    <thetext>Proposed as a Blocker and Freeze Exception for 26-final by Fedora user pjones using the blocker tracking app because:

 Without this we can&apos;t verify from inside the OS that Secure Boot is enabled.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10543548</commentid>
    <comment_count>8</comment_count>
    <who name="Dominik &apos;Rathann&apos; Mierzejewski">dominik</who>
    <bug_when>2017-06-27 06:16:39 -0400</bug_when>
    <thetext>(In reply to Fedora Update System from comment #6)
&gt; grub2-2.02-0.40.fc26 has been submitted as an update to Fedora 26.
&gt; https://bodhi.fedoraproject.org/updates/FEDORA-2017-01b07bc086

Please fix on F25 as well and possibly on F24, as originally reported.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10545647</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-27 16:24:54 -0400</bug_when>
    <thetext>grub2-2.02-0.40.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-01b07bc086</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10545787</commentid>
    <comment_count>10</comment_count>
    <who name="David Howells">dhowells</who>
    <bug_when>2017-06-27 17:26:15 -0400</bug_when>
    <thetext>The new grub works for me.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10551210</commentid>
    <comment_count>11</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-06-28 17:50:17 -0400</bug_when>
    <thetext>Would the fix for this take effect after a normal update of grub2, or is there some reason the fix for this needs to appear in the frozen release package set?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10554694</commentid>
    <comment_count>12</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2017-06-29 15:10:36 -0400</bug_when>
    <thetext>For the record, pjones added further information by email:

&quot;basically Secure Boot doesn&apos;t trigger kmod signature checking, read-only /dev/mem, etc., in the current trees. This update fixes a grub bug that&apos;s triggering that behavior in the newer kernels, but was not triggering it in the older ones.&quot;

AIUI, &quot;kmod signature checking, read-only /dev/mem, etc.&quot; refers to various measures that are taken by the kernel when SB is known to be enabled, intended to defeat attempts to circumvent SB by e.g. loading a nefarious kernel module. So if I understand correctly, this is effectively a security issue (as it reduces the effectiveness of SB protections on systems which are using SB).

With that in mind: Discussed at 2017-06-29 blocker review meeting: https://meetbot-raw.fedoraproject.org/fedora-blocker-review/2017-06-29/f26-blocker-review.2017-06-29-16.00.html . We agreed to at least accept this (and the companion bug #1451071) as freeze exception issues, which should be sufficient to ensure they&apos;re resolved in Final as the fixes are already available. We considered also accepting them as blockers under the &quot;The release must contain no known security bugs of &apos;important&apos; or higher impact according to the Red Hat severity classification scale which cannot be satisfactorily resolved by a package update (e.g. issues during installation).&quot; criterion, but as this issue isn&apos;t *formally* a security issue at least yet, and doesn&apos;t have a formal security evaluation, and FE status should be sufficient to get the fixes in anyhow, we decided to leave blocker status undetermined for now. FESCo may choose to make these bugs blockers by fiat.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10555079</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-29 19:28:25 -0400</bug_when>
    <thetext>grub2-2.02-0.40.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>