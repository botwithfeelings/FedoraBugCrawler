<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1368477</bug_id>
          
          <creation_ts>2016-08-19 10:01:00 -0400</creation_ts>
          <short_desc>postgresql-setup does not work with umask 0027 because pg_hba.conf cannot be read by postgres user</short_desc>
          <delta_ts>2017-03-14 03:11:49 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>postgresql</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>NEXTRELEASE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>medium</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Edgar Hoch">edgar.hoch</reporter>
          <assigned_to name="Pavel Raiskup">praiskup</assigned_to>
          <cc>devrim</cc>
    
    
    <cc>hhorak</cc>
    
    
    <cc>jmlich83</cc>
    
    
    <cc>jstanek</cc>
    
    
    <cc>pkajaba</cc>
    
    
    <cc>pkubat</cc>
    
    
    <cc>praiskup</cc>
    
    
    <cc>tgl</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-14 03:11:49</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9630676</commentid>
    <comment_count>0</comment_count>
      <attachid>1192149</attachid>
    <who name="Edgar Hoch">edgar.hoch</who>
    <bug_when>2016-08-19 10:01:58 -0400</bug_when>
    <thetext>Created attachment 1192149
Patch for postgresql-setup.in to set owner, group and mode of temporary pg_hba.conf

Description of problem:

/usr/bin/postgresql-setup should set owner, group and mode of pg_hba.conf file it creates to ensure it is readable by user postgres.

The script fails im umask is set to not allow read by others.

I provide a patch which solves the problem.


Details:

I tried to upgrade postgresql from 9.4 to 9.5 using
/usr/bin/postgresql-setup --upgrade

since I have upgraded the postgresql server from Fedora 23 to Fedora 24 (complete new installation using kickstart).

postgresql-setup failed with the following message:
ERROR: pg_upgrade tool failed
ERROR: Upgrade failed.
 * See /var/lib/pgsql/upgrade_postgresql.log for details.

But neither log file tells me the reason, even when called with --debug and setting environment variables as described in postgresql-setup. But I found that the following command has failed:

/usr/sbin/runuser -s /bin/sh -l postgres -c &apos;&quot;/usr/lib64/pgsql/postgresql-9.4/bin/pg_ctl&quot; -w -l &quot;pg_upgrade_server.log&quot; -D &quot;/fs/database/postgresql/9.5-old&quot; -o &quot;-p 5432 -b  -c listen_addresses=&apos;&apos; -c unix_socket_permissions=0700 -c unix_socket_directories=&apos;/var/lib/pgsql&apos;&quot; start&apos;

Then I have added &apos;-d 2&apos; to the &quot;-o&quot; option in the command above, and then I got an error message that has pointed me to the reason of the failure:

/fs/database/postgresql/9.5-old/pg_log/postgresql-Fri.log contains:

LOG:  could not open configuration file &quot;/fs/database/postgresql/9.5-old/pg_hba.conf&quot;: Permission denied
FATAL:  could not load pg_hba.conf

I checked the file:

-rw-r-----. 1 root root 25 19. Aug 15:30 /fs/database/postgresql/9.5-old/pg_hba.conf

The reason is that /usr/bin/postgresql-setup creates this file but does not set access permissions.

I have set umask to 0027 for root as default (because I think root files (for example log files) may contains sensitive information and they should not be readable by everyone without explicit set), and so the file is created without read permission for others than root.


Version-Release number of selected component (if applicable):
postgresql-9.5.4-1.fc24.x86_64
postgresql-server-9.5.4-1.fc24.x86_64
postgresql-upgrade-9.5.4-1.fc24.x86_64


How reproducible:
Always

Steps to Reproduce:
1. Have a database from postgresql 9.4.x (for example, from Fedora 23).
2. Have postgresql 9.5.x installed (for example, using Fedora 24).
   See versions and packages listed above.
3. Make a backup of the database files.
4. Try upgrade the database files with umask 0027:
   ( umask 0027; PGSETUP_DEBUG=1 PGSETUP_PGUPGRADE_OPTIONS=&apos;-v&apos; /usr/bin/postgresql-setup --debug --upgrade )
5. If the command above has modified the database files (for example, if it has succeeded in a patched version of the script), remove them and restore from backup.
6. Try upgrade the database files with umask 0022:
   ( umask 0027; PGSETUP_DEBUG=1 PGSETUP_PGUPGRADE_OPTIONS=&apos;-v&apos; /usr/bin/postgresql-setup --debug --upgrade )


Actual results:
Step 4 fails, step 6 succeeds.

Expected results:
Steps 4 and 6 succeeds.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9634352</commentid>
    <comment_count>1</comment_count>
    <who name="Pavel Raiskup">praiskup</who>
    <bug_when>2016-08-22 00:07:31 -0400</bug_when>
    <thetext>Edgar, indeed, thanks for the patch!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9674423</commentid>
    <comment_count>2</comment_count>
    <who name="Pavel Raiskup">praiskup</who>
    <bug_when>2016-09-02 04:50:56 -0400</bug_when>
    <thetext>Applied upstream:
https://github.com/devexp-db/postgresql-setup/commit/8c77c8062dbf1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10074859</commentid>
    <comment_count>3</comment_count>
    <who name="Pavel Raiskup">praiskup</who>
    <bug_when>2017-01-18 01:54:15 -0500</bug_when>
    <thetext>Edgar, this has been fixed in f26 -- is it OK or should we patch f24+?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10236240</commentid>
    <comment_count>4</comment_count>
    <who name="Pavel Raiskup">praiskup</who>
    <bug_when>2017-03-14 03:11:49 -0400</bug_when>
    <thetext>Fixed in F26+.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1192149</attachid>
            <date>2016-08-19 10:01:00 -0400</date>
            <delta_ts>2016-08-19 10:01:58 -0400</delta_ts>
            <desc>Patch for postgresql-setup.in to set owner, group and mode of temporary pg_hba.conf</desc>
            <filename>postgresql-setup-4.0-pg_hba.conf.patch</filename>
            <type>text/plain</type>
            <size>684</size>
            <attacher name="Edgar Hoch">edgar.hoch</attacher>
            
              <data encoding="base64">ZGlmZiAtcnUgYS9wb3N0Z3Jlc3FsLXNldHVwLTQuMC9wb3N0Z3Jlc3FsLXNldHVwLmluIGIvcG9z
dGdyZXNxbC1zZXR1cC00LjAvcG9zdGdyZXNxbC1zZXR1cC5pbgotLS0gYS9wb3N0Z3Jlc3FsLXNl
dHVwLTQuMC9wb3N0Z3Jlc3FsLXNldHVwLmluCTIwMTYtMDEtMDYgMjM6NTQ6MzEuMDAwMDAwMDAw
ICswMTAwCisrKyBiL3Bvc3RncmVzcWwtc2V0dXAtNC4wL3Bvc3RncmVzcWwtc2V0dXAuaW4JMjAx
Ni0wOC0xOSAxNDo1Njo1NC4wMjc3MDA5ODIgKzAyMDAKQEAgLTI0MSw2ICsyNDEsOSBAQAogICAg
ICAgICAjIHRvIGFueSBkYXRhYmFzZSB3aXRob3V0IHBhc3N3b3JkLiAgVGVtcG9yYXJpbHksIG5v
IG90aGVyIHR5cGUKICAgICAgICAgIyBvZiBjb25uZWN0aW9uIGlzIG5lZWRlZC4KICAgICAgICAg
ZWNobyAibG9jYWwgYWxsIHBvc3RncmVzIGlkZW50IiA+ICIkcGdkYXRhb2xkL3BnX2hiYS5jb25m
IgorICAgICAgICBjaG93biBwb3N0Z3Jlczpwb3N0Z3JlcyAiJHBnZGF0YW9sZC9wZ19oYmEuY29u
ZiIKKyAgICAgICAgY2htb2QgZ28tcnd4ICIkcGdkYXRhb2xkL3BnX2hiYS5jb25mIgorICAgICAg
ICBbIC14IC9zYmluL3Jlc3RvcmVjb24gXSAmJiAvc2Jpbi9yZXN0b3JlY29uICIkcGdkYXRhb2xk
L3BnX2hiYS5jb25mIgogICAgIGZpCiAKICAgICBpbmZvICQiVXBncmFkaW5nIGRhdGFiYXNlLiIK
</data>

          </attachment>
      

    </bug>

</bugzilla>