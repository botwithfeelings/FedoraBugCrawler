<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1339535</bug_id>
          
          <creation_ts>2016-05-25 05:31:00 -0400</creation_ts>
          <short_desc>getAllDomainStats returns a corrupted array which leads to a segfault</short_desc>
          <delta_ts>2016-06-27 14:27:37 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt-python</component>
          <version>24</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Roman Mohr">rmohr</reporter>
          <assigned_to name="Daniel Berrange">berrange</assigned_to>
          <cc>berrange</cc>
    
    
    <cc>crobinso</cc>
    
    
    <cc>rmohr</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>libvirt-python-1.3.3-3.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-06-27 14:27:37</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9356983</commentid>
    <comment_count>0</comment_count>
    <who name="Roman Mohr">rmohr</who>
    <bug_when>2016-05-25 05:31:53 -0400</bug_when>
    <thetext>Description of problem:
The array returning getAllDomainStats, which contains pairs of (domain, stats dict) seems to return a corrupt array. I get a segfault when iterating over it.

Version-Release number of selected component (if applicable):
libvirt.x86_64                           1.2.18.3-1.fc23           @updates     
libvirt-client.x86_64                    1.2.18.3-1.fc23           @updates
libvirt-python.x86_64                    1.2.18-1.fc23             @@commandline

How reproducible:
Always on my machine.

Steps to Reproduce:
1. Start at least on VM
2. Try to access the stats 
3.

Actual results:
The code iterates over the end of the stats array.
Maybe the StopIterator is not thrown after the end of the array?

Expected results:
Stop iterating over stats when we are at the end of the array.

Additional info:
#!/bin/python

import libvirt

conn = libvirt.openReadOnly(None)
s = conn.getAllDomainStats(libvirt.VIR_DOMAIN_STATS_CPU_TOTAL |
                           libvirt.VIR_DOMAIN_STATS_BALLOON |
                           libvirt.VIR_DOMAIN_STATS_VCPU |
                           libvirt.VIR_DOMAIN_STATS_INTERFACE |
                           libvirt.VIR_DOMAIN_STATS_BLOCK,
                           libvirt.VIR_CONNECT_GET_ALL_DOMAINS_STATS_ACTIVE)


print(s) # this works
print(len(s)) # this reports in my case the correct length of 1
for domain, stats in s: # this does not stop after the first element
    print(stats) # when accessing the second element I get the segfault</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9362509</commentid>
    <comment_count>1</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2016-05-26 11:38:51 -0400</bug_when>
    <thetext>Should be fixed by:

commit e9c4e2abffef007a28112ebb40a9586b0128f10b
Author: Pavel Hrdina &lt;phrdina@redhat.com&gt;
Date:   Mon Apr 18 16:53:50 2016 +0200

    fix crash in getAllDomainStats
    
    Commits 1d39dbaf and 827ed9b4 broke the libvirt-python API by removing
    virDomainRef() and virDomainFree().  virDomainStatsRecordListFree() will
    free that domain pointer and later when virDomain (python object) call
    its destructor and tries to free that same pointer again.
    
    Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=1326839
    
    Signed-off-by: Pavel Hrdina &lt;phrdina@redhat.com&gt;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9438646</commentid>
    <comment_count>2</comment_count>
    <who name="Cole Robinson">crobinso</who>
    <bug_when>2016-06-21 20:22:25 -0400</bug_when>
    <thetext>Hmm, are you definitely using packaged libvirt, and not a version from pip or similar? That issue exists with f24 era libvirt-python bug I can&apos;t reproduce it with f23</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9445865</commentid>
    <comment_count>3</comment_count>
    <who name="Roman Mohr">rmohr</who>
    <bug_when>2016-06-23 07:05:20 -0400</bug_when>
    <thetext>(In reply to Cole Robinson from comment #2)
&gt; Hmm, are you definitely using packaged libvirt, and not a version from pip
&gt; or similar? That issue exists with f24 era libvirt-python bug I can&apos;t
&gt; reproduce it with f23

Hm, seems like I can&apos;t reliably reproduce it anymore. For instance I had it yesterday but not today. I checked that it was not from pip. I even rebuilt the packages from the latest release back then and I had the same issue there too.

I will try to create a stacktrace with gdb when it happens again (if that helps).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9445973</commentid>
    <comment_count>4</comment_count>
    <who name="Roman Mohr">rmohr</who>
    <bug_when>2016-06-23 07:49:15 -0400</bug_when>
    <thetext>(In reply to Cole Robinson from comment #2)
&gt; Hmm, are you definitely using packaged libvirt, and not a version from pip
&gt; or similar?
Oh now I have it. I still had libvirt-python from pip for Python3. Seems like I only removed it for python2 from pip.

 That issue exists with f24 era libvirt-python bug I can&apos;t
&gt; reproduce it with f23

Tested it again. Everything is working now.
Thanks for following up.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9446376</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-23 09:10:09 -0400</bug_when>
    <thetext>libvirt-python-1.3.3-3.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-f9336762ec</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9456562</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-27 14:27:33 -0400</bug_when>
    <thetext>libvirt-python-1.3.3-3.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>