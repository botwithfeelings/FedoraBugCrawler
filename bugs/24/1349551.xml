<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1349551</bug_id>
          
          <creation_ts>2016-06-23 12:21:00 -0400</creation_ts>
          <short_desc>OpenSSH complaining on file permissions of .ssh/authorized_keys</short_desc>
          <delta_ts>2016-06-25 15:22:14 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>openssh</component>
          <version>24</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Leif Hedstrom">leif</reporter>
          <assigned_to name="Jakub Jelen">jjelen</assigned_to>
          <cc>jjelen</cc>
    
    
    <cc>kdudka</cc>
    
    
    <cc>mattias.ellert</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>tmraz</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>openssh-7.2p2-8.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-06-25 15:22:14</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9447329</commentid>
    <comment_count>0</comment_count>
    <who name="Leif Hedstrom">leif</who>
    <bug_when>2016-06-23 12:21:45 -0400</bug_when>
    <thetext>After upgrading from F23 to F24, I&apos;m having an issue with sudo and OpenSSH / ssh-agent based authentication. Whereas before, I&apos;d be able to sudo without password with my ssh-agent credentials and ~/.ssh/authorized_keys (as setup in PAM), I&apos;m now unable to do so.

The logs show:

Jun 23 10:18:57 loki sudo[4843]: Authentication refused: bad ownership or modes for file /home/leif/.ssh/authorized_keys
Jun 23 10:18:57 loki sudo[4843]: Authentication refused: bad ownership or modes for file /home/leif/.ssh/authorized_keys
Jun 23 10:18:57 loki sudo[4843]: Authentication refused: bad ownership or modes for file /home/leif/.ssh/authorized_keys
Jun 23 10:18:57 loki sudo[4843]: Authentication refused: bad ownership or modes for file /home/leif/.ssh/authorized_keys


However, my dir and files are correct, I&apos;m pretty sure:

loki (10:19) 273/0 $ pwd
/home/leif
loki (10:19) 274/0 $ ls -ld .
drwxr-xr-x 1 leif users 2910 Jun 21 23:35 ./
loki (10:19) 275/0 $ ls -ld .ssh
drwx------ 1 leif users 322 Jun 22 18:54 .ssh/
loki (10:19) 276/0 $ ls -l .ssh/authorized_keys
-rw------- 1 leif users 740 Dec 15  2010 .ssh/authorized_keys

My config for sudo in PAM is

#%PAM-1.0
auth       sufficient   pam_ssh_agent_auth.so file=~/.ssh/authorized_keys

auth       include      system-auth
account    include      system-auth
password   include      system-auth
session    optional     pam_keyinit.so revoke
session    required     pam_limits.so
session    include      system-auth</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9449304</commentid>
    <comment_count>1</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2016-06-24 03:10:48 -0400</bug_when>
    <thetext>This looks like pretty insecure setup. Do I see right, that every user, who stores his public key in his home directory can sudo? Nah ... there might be some more restriction in sudoers file, but still ...

Never mind. This should certainly work according to manual page, regardless the option  allow_user_owned_authorized_keys_file. I see the same behavior and it looks like a bug. It is trying to check twice against the same user (root). Probably another use case we don&apos;t have regression test yet.

Jun 24 08:50:44 f24 sudo[17756]: trying public key file /home/user/.ssh/authorized_keys
Jun 24 08:50:44 f24 sudo[17756]: auth_secure_filename: checking for uid: 0
Jun 24 08:50:44 f24 sudo[17756]: Authentication refused: bad ownership or modes for file /home/user/.ssh/authorized_keys
Jun 24 08:50:44 f24 sudo[17756]: trying public key file /home/user/.ssh/authorized_keys
Jun 24 08:50:44 f24 sudo[17756]: auth_secure_filename: checking for uid: 0
Jun 24 08:50:44 f24 sudo[17756]: Authentication refused: bad ownership or modes for file /home/user/.ssh/authorized_keys

Reverting commit [1] will make it work again. Seems like there is some magic between the lines. I will check how can we do that better and issue update soon. Thank you for the report.

[1] http://pkgs.fedoraproject.org/cgit/rpms/openssh.git/commit/?id=ea9421342eb381aa43eafd95bef298cbc8979368</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9449694</commentid>
    <comment_count>2</comment_count>
    <who name="Tomas Mraz">tmraz</who>
    <bug_when>2016-06-24 05:42:29 -0400</bug_when>
    <thetext>This is bug in the patch [1] - you cannot call getpwuid twice and expect that the struct passwd returned from the first call will not be overwritten by the second call.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9450169</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-24 07:41:33 -0400</bug_when>
    <thetext>openssh-7.2p2-8.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-75bde9f07a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9450802</commentid>
    <comment_count>4</comment_count>
    <who name="Leif Hedstrom">leif</who>
    <bug_when>2016-06-24 10:36:48 -0400</bug_when>
    <thetext>Thanks! And yes, I&apos;m not recommending this setup, but in my case, this box has only one user in /home, me :).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9450811</commentid>
    <comment_count>5</comment_count>
    <who name="Leif Hedstrom">leif</who>
    <bug_when>2016-06-24 10:38:58 -0400</bug_when>
    <thetext>Oh, and of course sudoers ACLs are still in place (I hope / assume), restricting who can sudo in the first place (I use the wheel group membership, that&apos;s how old I am).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451972</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-24 20:31:08 -0400</bug_when>
    <thetext>openssh-7.2p2-8.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-75bde9f07a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9452524</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-06-25 15:22:09 -0400</bug_when>
    <thetext>openssh-7.2p2-8.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>