<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1303543</bug_id>
          
          <creation_ts>2016-02-01 04:20:00 -0500</creation_ts>
          <short_desc>varnish-agent needs update after varnish-4.1.1 was pushed to rawhide</short_desc>
          <delta_ts>2016-12-05 17:28:10 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>varnish-agent</component>
          <version>24</version>
          <rep_platform>All</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Ingvar Hagelund">ingvar</reporter>
          <assigned_to name="Dridi Boukelmoune">dridi.boukelmoune</assigned_to>
          <cc>carl</cc>
    
    
    <cc>dridi.boukelmoune</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>varnish-agent-4.1.1-1.fc25 varnish-agent-4.1.1-1.fc24</cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-05 13:51:42</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9025332</commentid>
    <comment_count>0</comment_count>
    <who name="Ingvar Hagelund">ingvar</who>
    <bug_when>2016-02-01 04:20:48 -0500</bug_when>
    <thetext>Description of problem:
varnish-agent needs update after varnish-4.1.1 was pushed to rawhide

Version-Release number of selected component (if applicable):
4.0.0

How reproducible:


Steps to Reproduce:
1. Iinstall varnish-4.1.1-libs-devel with deps from rawhide
2. Rebuild varnish-agent-4.0.0-0.4.RC2.fc22.src.rpm

Actual results:
Build fails as varnish-agent-4.0.0 is not compatible with varnish-4.1.1

Expected results:
Working build of varnish-agent

Additional info:
Update to git commit c07aae6630d85887333349d3a5cdb414aac376e5. I got Kristian to fix a build error on fedora, so it runs the whole test suite.

Working .src.rpm here: https://ingvar.fedorapeople.org/varnish/varnish-agent-4.1.0-0.1.20160201gitc07aae6.fc22.src.rpm</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9026461</commentid>
    <comment_count>1</comment_count>
    <who name="Ingvar Hagelund">ingvar</who>
    <bug_when>2016-02-01 10:34:40 -0500</bug_when>
    <thetext>Got Kristian to add a couple of more fixes, please check out upstream git commit 28eacbb0ef5df7ea274bccbaca5a4a6ce5eda916

Working .src.rpm here: https://ingvar.fedorapeople.org/varnish/varnish-agent-4.1.0-0.4.20160201git28eacbb.fc22.src.rpm

Specfile: https://ingvar.fedorapeople.org/varnish/varnish-agent.spec

It includes som fixes that makes it compile on epel5,6,7.

To build on epel5, autogen.sh needs to be ran before creating the dist tarball, as el5&apos;s autoconf is too old for this project, see the comments in the specfile.

copr builds: https://copr.fedorainfracloud.org/coprs/ingvar/varnish41/

Ingvar</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9036742</commentid>
    <comment_count>2</comment_count>
    <who name="Dridi Boukelmoune">dridi.boukelmoune</who>
    <bug_when>2016-02-04 11:49:14 -0500</bug_when>
    <thetext>Hi Ingvar,

Thank you for the update, I will merge the spec you derived from upstream&apos;s with our current spec (to remove things like buildrequires: gcc) and keep you updated.

I&apos;m glad to learn that we have 4.1 in rawhide!

Dridi</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9038466</commentid>
    <comment_count>3</comment_count>
    <who name="Dridi Boukelmoune">dridi.boukelmoune</who>
    <bug_when>2016-02-05 05:12:43 -0500</bug_when>
    <thetext>I have a spec ready for testing but for some reason I still see Varnish 4.1.0 in rawhide:

$ mock -r fedora-rawhide-x86_64 --dnf-cmd info varnish
[...]
Last metadata expiration check performed 0:00:18 ago on Fri Feb  5 11:00:52 2016.
Installed Packages
Name        : varnish
Arch        : x86_64
Epoch       : 0
Version     : 4.1.0
Release     : 1.fc24
[...]

$ mock -r fedora-rawhide-x86_64 --chroot &apos;rpm -q --provides varnish&apos;
[...]
config(varnish) = 4.1.0-1.fc24
varnish = 4.1.0-1.fc24
varnish(x86-64) = 4.1.0-1.fc24
varnishabi-3.0
varnishabi-strict-3041728
Finish: chroot [&apos;rpm -q --provides varnish&apos;]
Finish: run

Also I found a couple mistakes in your spec, like for instance in %preun:

%systemd_preun varnish.service

I suspect you/upstream meant to stop the agent instead.

I&apos;ll try again later.

Dridi</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9038894</commentid>
    <comment_count>4</comment_count>
    <who name="Ingvar Hagelund">ingvar</who>
    <bug_when>2016-02-05 08:11:26 -0500</bug_when>
    <thetext>(In reply to Dridi Boukelmoune from comment #3)
&gt; I have a spec ready for testing but for some reason I still see Varnish
&gt; 4.1.0 in rawhide: (...)

It probably hasn&apos;t reached the mirrors yet. Use git.

$ mkdir /var/tmp/varnish-rawhide; cd /var/tmp/varnish-rawhide
$ fedpkg clone varnish

$ egrep &apos;^Version|^Release&apos; varnish/varnish.spec
Version: 4.1.1
Release: 3%{?v_rc}%{?dist}

$ grep -A4 &apos;%changelog&apos; varnish/varnish.spec
%changelog
* Thu Feb 04 2016 Ingvar Hagelund &lt;ingvar@redpill-linpro.com&gt; 4.1.1-3
- Added &quot;-ffloat-store -fexcess-precision=standard&quot; to CFLAGS on i386
  to work around a bug in gcc6, see
  https://github.com/dhobsd/Varnish-Cache/commit/9f1035d 

&gt; Also I found a couple mistakes in your spec, like for instance in %preun:
&gt; 
&gt; %systemd_preun varnish.service
&gt; 
&gt; I suspect you/upstream meant to stop the agent instead.

Yes, that is a typo, thanks, I&apos;ll update the copr build.

What was the other mistake?

Ingvar</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9039017</commentid>
    <comment_count>5</comment_count>
    <who name="Dridi Boukelmoune">dridi.boukelmoune</who>
    <bug_when>2016-02-05 09:03:09 -0500</bug_when>
    <thetext>&gt; What was the other mistake?

I&apos;m not sure it&apos;s a problem but systemd handling in general. I haven&apos;t looked into this for quite a while but those look odd to me:

&gt; /bin/systemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :

I believe we should be using this instead:

&gt; %systemd_post %{name}.service

In %preun the %systemd_preun is used inside the surrounding &quot;shell if&quot;, but I think it should look more like this:

&gt; %preun
&gt; %if 0%{?fedora} || 0%{?rhel} &gt;= 7
&gt; %systemd_preun %{name}.service
&gt; %else
&gt; if [ $1 -lt 1 ]
&gt; then
&gt;     /sbin/service %{name} stop &gt;/dev/null
&gt;     /sbin/chkconfig --del %{name}
&gt; fi
&gt; %endif

Essentially because of the first issue I reported to you, you may notice I now use %{name} everywhere to avoid making typos myself.

I think we can also reliably BuildRequires: curl-devel, since post-el5 environments seem to provide it as well despite a different package name. That needs testing I haven&apos;t done yet because I want to update rawhide first.

Dridi</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9046159</commentid>
    <comment_count>6</comment_count>
    <who name="Dridi Boukelmoune">dridi.boukelmoune</who>
    <bug_when>2016-02-09 08:55:43 -0500</bug_when>
    <thetext>Hi Ingvar,

I have updated the agent to 4.1.0 on rawhide, so please test it on rawhide and el. If it goes well I will request el branches for this package too.

Please have a look at the spec [1] file, I think it&apos;s a bit less complicated than upstream&apos;s and in any case a lot more compliant with Fedora&apos;s guidelines. If it looks good to you I will submit it upstream. But I think something&apos;s missing in %postun for non-systemd platforms...

On the varnish package there&apos;s one thing that bothers me with the new provides:

Requires:       varnish = %varnishver
Requires:       varnishabi-%vabi
Requires:       varnishabi-strict-%vabistrict

Wouldn&apos;t it be cleaner to do this instead for f24?

Requires:       varnish = %varnishver
Requires:       varnish(abi) = %vabi
Requires:       varnish(abi-strict) = %vabistrict

(and of course keep the current provides, for instance until the next major varnish release)

Thanks,
Dridi

[1] http://pkgs.fedoraproject.org/cgit/rpms/varnish-agent.git/plain/varnish-agent.spec?id=ebf377f</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9046647</commentid>
    <comment_count>7</comment_count>
    <who name="Dridi Boukelmoune">dridi.boukelmoune</who>
    <bug_when>2016-02-09 11:28:24 -0500</bug_when>
    <thetext>Ingvar,

Clarifying my previous remark on ABI, this would allow actual non-strict ABI to work if upstream documents its ABI requirements:

Requires:       varnish(abi) &gt;= 3.1
Requires:       varnish(abi) &lt;  4

This is essentially useful for varnish modules, not really for companions like the varnish-agent. Probably also the point of the loose ABI, you can keep the same vmod binary as long as Varnish doesn&apos;t break its promise of stability.

Cheers,
Dridi</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9092991</commentid>
    <comment_count>8</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-02-24 09:23:06 -0500</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 24 development cycle.
Changing version to &apos;24&apos;.

More information and reason for this action is here:
https://fedoraproject.org/wiki/Fedora_Program_Management/HouseKeeping/Fedora24#Rawhide_Rebase</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9432122</commentid>
    <comment_count>9</comment_count>
    <who name="Ingvar Hagelund">ingvar</who>
    <bug_when>2016-06-20 04:52:29 -0400</bug_when>
    <thetext>(In reply to Dridi Boukelmoune from comment #6)
&gt; I have updated the agent to 4.1.0 on rawhide, so please test it on rawhide
&gt; and el. If it goes well I will request el branches for this package too.
&gt; 
&gt; Please have a look at the spec [1] file, I think it&apos;s a bit less complicated
&gt; than upstream&apos;s and in any case a lot more compliant with Fedora&apos;s
&gt; guidelines. If it looks good to you I will submit it upstream. But I think
&gt; something&apos;s missing in %postun for non-systemd platforms...
&gt; 
&gt; On the varnish package there&apos;s one thing that bothers me with the new
&gt; provides:
&gt; 
&gt; Requires:       varnish = %varnishver
&gt; Requires:       varnishabi-%vabi
&gt; Requires:       varnishabi-strict-%vabistrict
&gt; 
&gt; Wouldn&apos;t it be cleaner to do this instead for f24?
&gt; 
&gt; Requires:       varnish = %varnishver
&gt; Requires:       varnish(abi) = %vabi
&gt; Requires:       varnish(abi-strict) = %vabistrict

Sure, this would be better. It would need some changes in the script that generates these variables, though. At the moment, this is done by redhat/find-provides, provided upstream, so I&apos;d have to patch that, and make upstream change it as well.

&gt; (and of course keep the current provides, for instance until the next major
&gt; varnish release)

Yes, that would be necessary.

&gt; Clarifying my previous remark on ABI, this would allow actual non-strict ABI 
&gt; to work if upstream documents its ABI requirements:
&gt; 
&gt; Requires:       varnish(abi) &gt;= 3.1
&gt; Requires:       varnish(abi) &lt;  4

Yes, cleaner, though this would also work:

Requires: varnishabi &gt;= 3.1
Requires: varnishabi &lt; 4
 
&gt; This is essentially useful for varnish modules, not really for companions 
&gt; like the varnish-agent. Probably also the point of the loose ABI, you can 
&gt; keep the same vmod binary as long as Varnish doesn&apos;t break its promise of 
&gt; stability.

Yep. I would need to know for each vmod how close they are bound to the strict abi, and if they would work with just the (non-strict) abi version. Is it some standard for this?

Perhaps we should discuss this on one of the upstream lists.

Ingvar</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9669054</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-31 17:48:56 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2016-c28ffe0655</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9669055</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-31 17:49:02 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-86999dec28</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9672992</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-01 15:52:10 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-c28ffe0655</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9673079</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-01 16:23:41 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-86999dec28</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9680254</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-05 13:51:40 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9695769</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-09 21:48:19 -0400</bug_when>
    <thetext>varnish-agent-4.1.1-1.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>