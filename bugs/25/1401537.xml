<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1401537</bug_id>
          
          <creation_ts>2016-12-05 09:19:00 -0500</creation_ts>
          <short_desc>Cannot build image with --userns-remap set, permission denied</short_desc>
          <delta_ts>2017-07-08 18:20:52 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>oci-systemd-hook</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jan Pazdziora">jpazdziora</reporter>
          <assigned_to name="David Darrah/Red Hat QE">ddarrah</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ebiederm</cc>
    
    
    <cc>eparis</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>jpazdziora</cc>
    
    
    <cc>kai.reichert</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>mpatel</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>pmoore</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>sds</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>oci-systemd-hook-0.1.9-1.gitaa42622.fc26 oci-systemd-hook-0.1.9-1.gitaa42622.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-07-08 12:50:06</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      <flag name="needinfo"
          id="2986694"
          type_id="16"
          status="?"
          setter="dwalsh"
          requestee="mpatel"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9956294</commentid>
    <comment_count>0</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-05 09:19:49 -0500</bug_when>
    <thetext>Description of problem:

In an attempt to harden my docker installation, I&apos;ve set

  OPTIONS=&apos;--icc=false --selinux-enabled --log-driver=journald --userns-remap=default&apos;

appending the --userns-remap option. After restarting the daemon, I can no longer build images.

Version-Release number of selected component (if applicable):

docker-1.12.3-10.git7b5044b.fc25.x86_64

How reproducible:

Deterministic.

Steps to Reproduce:
1. Set /etc/sysconfig/docker option OPTIONS to

OPTIONS=&apos;--icc=false --selinux-enabled --log-driver=journald --userns-remap=default&apos;

2. systemctl restart docker
3. Have test/Dockerfile

FROM fedora:25
RUN dnf install -y /usr/bin/ps

4. docker build -t test ~/test/

Actual results:

# docker build -t test ~/test/
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM fedora:25
 ---&gt; 5bafccc4d5dc
Step 2 : RUN dnf install -y /usr/bin/ps
 ---&gt; Running in e8b291d9d285
invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54: mounting \\\\\\\&quot;tmpfs\\\\\\\&quot; to rootfs \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/ade9f8c36ec7d1328aa42a34bba0be40c482ca5e3da30c1e17410ca196f46941/rootfs\\\\\\\&quot; at \\\\\\\&quot;/dev\\\\\\\&quot; caused \\\\\\\&quot;permission denied\\\\\\\&quot;\\\&quot;\&quot;\n&quot;

Expected results:

No error, image built and usable.

Additional info:</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9956303</commentid>
    <comment_count>1</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-05 09:21:58 -0500</bug_when>
    <thetext>Merely running bash fails as well:

# docker run --rm -ti -e container=docker fedora:25 bash
/usr/bin/docker-current: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54: mounting \\\\\\\&quot;tmpfs\\\\\\\&quot; to rootfs \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/41080130319e94ac09eeafc4e6fe9a405ec8fe1aa769fcadc381f7f12b6bfaaf/rootfs\\\\\\\&quot; at \\\\\\\&quot;/dev\\\\\\\&quot; caused \\\\\\\&quot;permission denied\\\\\\\&quot;\\\&quot;\&quot;\n&quot;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9956310</commentid>
    <comment_count>2</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-05 09:23:22 -0500</bug_when>
    <thetext>For the record, docker-1.10.3-53.el7.x86_64 on fails as well:

# docker run --rm -ti rhel7 bash
docker: Error response from daemon: Cannot start container 184efbed1030c311ff54877bb5a1c86c2b3eac5f564c974cc15ea708e8f1af3d: [9] System error: fork/exec /proc/self/exe: invalid argument.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9956400</commentid>
    <comment_count>3</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-05 09:42:12 -0500</bug_when>
    <thetext>Mrunal do you remember anything about user ns in our projectatomic/docker? I remember there was still something not supported</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957279</commentid>
    <comment_count>4</comment_count>
    <who name="Mrunal Patel">mpatel</who>
    <bug_when>2016-12-05 13:55:04 -0500</bug_when>
    <thetext>Antonio, It looks like this is related to SELinux. If you take out the selinux build tag then it works fine. 
Also, this is reproducible with docker upstream on Fedora 25. 

Dan, could you take a look?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957289</commentid>
    <comment_count>5</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-05 13:59:55 -0500</bug_when>
    <thetext>Is it the /dev/mqueue issue?

Does it work if you run the daemon without --selinux-enabled?

Are there any AVCs?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957293</commentid>
    <comment_count>6</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-05 14:01:28 -0500</bug_when>
    <thetext>I know there is an issue with /dev/mqueu not working correctly with user namespace which prevents the SELinux label being set on /dev/mqueue when running with user namespace.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957296</commentid>
    <comment_count>7</comment_count>
    <who name="Mrunal Patel">mpatel</who>
    <bug_when>2016-12-05 14:03:23 -0500</bug_when>
    <thetext>Dan, this isn&apos;t related to mqueue from what I can tell. Also, it works without --selinux-enabled and I don&apos;t see any AVCs using ausearch -m avc -ts recent.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957551</commentid>
    <comment_count>8</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-05 15:56:09 -0500</bug_when>
    <thetext>This is an issue of mounting a tmpfs while in a user namespace using a context=&quot;container_file_t&quot; issue.

Basically usernamespace is not allowed to put arbitrary SELinux labels on a mount point.

The question is why does the tmpfs have to be mounted within the UserNamespace?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9957553</commentid>
    <comment_count>9</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-05 15:56:54 -0500</bug_when>
    <thetext>Opened an issue with runc.

https://github.com/opencontainers/runc/issues/1215</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9959229</commentid>
    <comment_count>10</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 04:36:58 -0500</bug_when>
    <thetext>(In reply to Mrunal Patel from comment #7)
&gt; Dan, this isn&apos;t related to mqueue from what I can tell. Also, it works
&gt; without --selinux-enabled and I don&apos;t see any AVCs using ausearch -m avc -ts
&gt; recent.

Confirming, removing --selinux-enabled helps. And there are no AVC denials logged.

Do we need another bugzilla for tracking the lack of AVC denials in this situation?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960008</commentid>
    <comment_count>11</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 07:31:48 -0500</bug_when>
    <thetext>Jan this is not an SELinux denial. This is a denial of a user namespace process without SYS_ADMIN attempting to set a label on a tmpfs mount point.  I see this as a runc bug.  Runc can not be mounting the tmpfs&apos;s while under a non root user namespace.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960017</commentid>
    <comment_count>12</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 07:33:20 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #11)
&gt; Jan this is not an SELinux denial.

OK, thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960125</commentid>
    <comment_count>13</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 07:50:55 -0500</bug_when>
    <thetext>For systemd in container, we likely need to be able to mount /sys/fs/cgroup to the container. I&apos;ve disabled oci-systemd-hook (to workaround bug 1401944) but when I try to mount the /sys/fs/cgroup explicitly, it fails:

$ docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:25 bash
/usr/bin/docker-current: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54: mounting \\\\\\\&quot;/sys/fs/cgroup\\\\\\\&quot; to rootfs \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/rootfs\\\\\\\&quot; at \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/rootfs/sys/fs/cgroup\\\\\\\&quot; caused \\\\\\\&quot;operation not permitted\\\\\\\&quot;\\\&quot;\&quot;\n&quot;.

Is it the same issue or would you like separate bugzilla for the /sys/fs/cgroup case?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960142</commentid>
    <comment_count>14</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-06 07:56:05 -0500</bug_when>
    <thetext>(In reply to Jan Pazdziora from comment #13)
&gt; For systemd in container, we likely need to be able to mount /sys/fs/cgroup
&gt; to the container. I&apos;ve disabled oci-systemd-hook (to workaround bug 1401944)
&gt; but when I try to mount the /sys/fs/cgroup explicitly, it fails:
&gt; 
&gt; $ docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:25 bash
&gt; /usr/bin/docker-current: Error response from daemon: invalid header field
&gt; value &quot;oci runtime error: container_linux.go:247: starting container process
&gt; caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54:
&gt; mounting \\\\\\\&quot;/sys/fs/cgroup\\\\\\\&quot; to rootfs
&gt; \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/
&gt; b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/
&gt; rootfs\\\\\\\&quot; at
&gt; \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/
&gt; b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/rootfs/sys/
&gt; fs/cgroup\\\\\\\&quot; caused \\\\\\\&quot;operation not permitted\\\\\\\&quot;\\\&quot;\&quot;\n&quot;.
&gt; 
&gt; Is it the same issue or would you like separate bugzilla for the
&gt; /sys/fs/cgroup case?

This issue is tracked upstream at https://github.com/docker/docker/issues/27202 and here in bugzilla as well https://bugzilla.redhat.com/show_bug.cgi?id=1373780</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960177</commentid>
    <comment_count>15</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 08:04:56 -0500</bug_when>
    <thetext>(In reply to Antonio Murdaca from comment #14)
&gt; (In reply to Jan Pazdziora from comment #13)
&gt; &gt; 
&gt; &gt; $ docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:25 bash
&gt; &gt; /usr/bin/docker-current: Error response from daemon: invalid header field
&gt; &gt; value &quot;oci runtime error: container_linux.go:247: starting container process
&gt; &gt; caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54:
&gt; &gt; mounting \\\\\\\&quot;/sys/fs/cgroup\\\\\\\&quot; to rootfs
&gt; &gt; \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/
&gt; &gt; b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/
&gt; &gt; rootfs\\\\\\\&quot; at
&gt; &gt; \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/
&gt; &gt; b79ef8835182d4ef2ccf8dc0f5ef3dfab9d806d1ee83c1213377f7f7c4913761/rootfs/sys/
&gt; &gt; fs/cgroup\\\\\\\&quot; caused \\\\\\\&quot;operation not permitted\\\\\\\&quot;\\\&quot;\&quot;\n&quot;.
&gt; &gt; 
&gt; &gt; Is it the same issue or would you like separate bugzilla for the
&gt; &gt; /sys/fs/cgroup case?
&gt; 
&gt; This issue is tracked upstream at
&gt; https://github.com/docker/docker/issues/27202 and here in bugzilla as well
&gt; https://bugzilla.redhat.com/show_bug.cgi?id=1373780

That issue is about console, not about /sys/fs/cgroup. Note that the command I run here is

docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:25 bash

-- I specify bash to be run in the container, there is no systemd involved. Of course, I got to this case by minimizing systemd attempts but I believe this is solely about mounting stuff with --userns-remap.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960191</commentid>
    <comment_count>16</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-06 08:09:12 -0500</bug_when>
    <thetext>If you try the upstream issue and the bugzilla I linked you&apos;ll get exactly the same issue you&apos;re having. See also Mrunal&apos;s comment in the upstream issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960228</commentid>
    <comment_count>17</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 08:22:32 -0500</bug_when>
    <thetext>(In reply to Antonio Murdaca from comment #16)
&gt; If you try the upstream issue and the bugzilla I linked you&apos;ll get exactly
&gt; the same issue you&apos;re having. See also Mrunal&apos;s comment in the upstream
&gt; issue.

I that bugzilla https://bugzilla.redhat.com/show_bug.cgi?id=1373780 I point out that the console issue is a regression in fedora:25 and fedora:rawhide against fedora:24 image. That bugzilla setup also does not use --userns-remap.

This issue (from comment 13) I can reproduce on fedora:24:

# docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:24 bash
/usr/bin/docker-current: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux.go:359: container init caused \\\&quot;rootfs_linux.go:54: mounting \\\\\\\&quot;/sys/fs/cgroup\\\\\\\&quot; to rootfs \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/8c7c02a8a7c9d5f36a74540c2001d39be5b4e19c8b930bb5d89a12fe5c285973/rootfs\\\\\\\&quot; at \\\\\\\&quot;/var/lib/docker/886432.886432/devicemapper/mnt/8c7c02a8a7c9d5f36a74540c2001d39be5b4e19c8b930bb5d89a12fe5c285973/rootfs/sys/fs/cgroup\\\\\\\&quot; caused \\\\\\\&quot;operation not permitted\\\\\\\&quot;\\\&quot;\&quot;\n&quot;.

And it only happens when I use --userns-remap. So why the problem from this bugzilla&apos;s comment 0 or comment 13 should be duplicate of bug 1373780 is really not obvious.

It well may be but to an outsider there don&apos;t seem much overlap. Could you elaborate some more?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960232</commentid>
    <comment_count>18</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 08:25:18 -0500</bug_when>
    <thetext>I agree with Jan, that this is a different issue.  Nothing to do with systemd.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960237</commentid>
    <comment_count>19</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 08:27:46 -0500</bug_when>
    <thetext>I see at least two different bugs.

oci-systemd-hook does not work with User Namespace, and volume mounting /sys/fs/cgroup into a container does not work with User Namespace.  (They could be the same issue, since both attempt to mount /sys/fs/cgroup into the container.)

I wonder if mounting other file systems into the container could cause the same issue.

If you volume mount in /sys/fs/selinux does that crash the container also?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960244</commentid>
    <comment_count>20</comment_count>
    <who name="Stephen Smalley">sds</who>
    <bug_when>2016-12-06 08:30:28 -0500</bug_when>
    <thetext>Is this related at all to Linux kernel commit aad82892af261b9903cc11c55be3ecf5f0b0b4f8 (&quot;selinux: Add support for unprivileged mounts from user namespaces&quot;) circa Linux 4.8?  If so, that change does cause SELinux to reject context mounts on user namespace mounts, to prevent unprivileged processes from performing context mounts.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960262</commentid>
    <comment_count>21</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 08:34:13 -0500</bug_when>
    <thetext>Would seem to make sense.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960318</commentid>
    <comment_count>22</comment_count>
    <who name="Stephen Smalley">sds</who>
    <bug_when>2016-12-06 08:51:36 -0500</bug_when>
    <thetext>Why does this need to be a context mount?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960359</commentid>
    <comment_count>23</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 09:03:13 -0500</bug_when>
    <thetext>Interesting find: while

$ docker run -v /sys/fs/cgroup:/sys/fs/cgroup:ro --rm -ti fedora:24 bash

fails, specifying the mount without :ro passes:

$ docker run -v /sys/fs/cgroup:/sys/fs/cgroup --rm -ti fedora:24 bash
[root@3b65038bb538 /]#</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960369</commentid>
    <comment_count>24</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-06 09:04:29 -0500</bug_when>
    <thetext>Mounting /sys/fs/selinux passes both for the :ro and no-ro case:

# docker run -v /sys/fs/selinux:/sys/fs/selinux:ro --rm -ti fedora:24 bash
[root@834a43d4e491 /]# exit
# docker run -v /sys/fs/selinux:/sys/fs/selinux --rm -ti fedora:24 bash
[root@76e49ad37f62 /]# exit</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960438</commentid>
    <comment_count>25</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 09:18:13 -0500</bug_when>
    <thetext>Wow that is weird.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9960487</commentid>
    <comment_count>26</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 09:30:27 -0500</bug_when>
    <thetext>Steven this does not need to be a context mount, the only thing we need is the tmpfs to be labeled with the Container MountLabel.  Theoretically we coould just do a setfilecon(/dev, mountlabel)  But I am not sure this will succeed.  If it should based on SELinux labels, then perhaps the kernel change is wrong.  And a non priv process should be able to label the mount object at mount time, if SELinux policy allows him to set the SELinux label.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9961806</commentid>
    <comment_count>27</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-06 14:26:32 -0500</bug_when>
    <thetext>I think this is wrong.

http://kernel.suse.com/cgit/kernel/commit/?id=aad82892af261b9903cc11c55be3ecf5f0b0b4f8

Why should we be controlling the ability to specify a context mount based on DAC issues,  It should be controlled by MAC.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9963316</commentid>
    <comment_count>28</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-12-07 02:20:20 -0500</bug_when>
    <thetext>So this bugzilla is primarily about the oci-systemd-hook issue, while mounting of /sys/fs/cgroup:/sys/fs/cgroup:ro is explicitly tracked in bug 1401944.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9968141</commentid>
    <comment_count>29</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-08 08:22:31 -0500</bug_when>
    <thetext>Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10230922</commentid>
    <comment_count>30</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-03-12 08:03:49 -0400</bug_when>
    <thetext>Mrunal, just circling back on older bugzillas.  I believe the problem here was runc not matching the options of the mounted file system, when it remounts it read/only.  Do you know if this has been fixed in the latest runc?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10297023</commentid>
    <comment_count>31</comment_count>
    <who name="Tom Sweeney">tsweeney</who>
    <bug_when>2017-04-01 15:20:43 -0400</bug_when>
    <thetext>This looks to be fixed with the latest oci-systemd-hook.  Asking QA to verify my testing.

[root@localhost ~]# vi /etc/sysconfig/docker
[root@localhost ~]# cat /etc/sysconfig/docker
# /etc/sysconfig/docker

# Modify these options if you want to change the way the docker daemon runs
#OPTIONS=&apos;--selinux-enabled --log-driver=journald&apos;
OPTIONS=&apos;--icc=false --selinux-enabled --log-driver=journald --userns-remap=default&apos;
# (Further lines edited out for brevity)
[root@localhost ~]# cat test/Dockerfile
FROM fedora:25
RUN dnf install -y /usr/bin/ps

[root@localhost ~]# systemctl restart docker
[root@localhost ~]# vi Dockerfile
[root@localhost ~]# pwd
/root
[root@localhost ~]# mkdir test
[root@localhost ~]# mv Dockerfile test/
[root@localhost ~]# ls test
Dockerfile
[root@localhost ~]# docker build -t test ~/test/
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM fedora:25
Trying to pull repository docker.io/library/fedora ... 
sha256:b44cdaee0feafc85cab454e2023807f66725c727655b6bef260aa6d21dd2b068: Pulling from docker.io/library/fedora
bc5187a39b05: Pull complete 
Digest: sha256:b44cdaee0feafc85cab454e2023807f66725c727655b6bef260aa6d21dd2b068
Status: Downloaded newer image for docker.io/fedora:25
 ---&gt; 4daa661b467f
Step 2 : RUN dnf install -y /usr/bin/ps
 ---&gt; Running in 16afdaafe1b0
Last metadata expiration check: 0:00:21 ago on Sat Apr  1 19:00:44 2017.
Dependencies resolved.
================================================================================
 Package           Arch           Version                  Repository      Size
================================================================================
Installing:
 procps-ng         x86_64         3.3.10-11.fc24           fedora         389 k

Transaction Summary
================================================================================
Install  1 Package

Total download size: 389 k
Installed size: 873 k
Downloading Packages:
--------------------------------------------------------------------------------
Total                                           684 kB/s | 389 kB     00:00     
warning: /var/cache/dnf/fedora-310f9d37d74ceec1/packages/procps-ng-3.3.10-11.fc24.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID fdb19c98: NOKEY
Importing GPG key 0xFDB19C98:
 Userid     : &quot;Fedora 25 Primary (25) &lt;fedora-25-primary@fedoraproject.org&gt;&quot;
 Fingerprint: C437 DCCD 558A 66A3 7D6F 4372 4089 D8F2 FDB1 9C98
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-25-x86_64
Key imported successfully
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Installing  : procps-ng-3.3.10-11.fc24.x86_64                             1/1 
error: unpacking of archive failed on file /usr/bin/free;58dff8f5: cpio: open
Error unpacking rpm package procps-ng-3.3.10-11.fc24.x86_64
Error unpacking rpm package procps-ng-3.3.10-11.fc24.x86_64
procps-ng-3.3.10-11.fc24.x86_64 was supposed to be installed but is not!
  Verifying   : procps-ng-3.3.10-11.fc24.x86_64                             1/1 

Failed:
  procps-ng.x86_64 3.3.10-11.fc24                                               

Complete!
 ---&gt; 3b27323a5dd8
Removing intermediate container 16afdaafe1b0
Successfully built 3b27323a5dd8
[root@localhost ~]# docker build -t test ~/test/
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM fedora:25
 ---&gt; 4daa661b467f
Step 2 : RUN dnf install -y /usr/bin/ps
 ---&gt; Using cache
 ---&gt; 3b27323a5dd8
Successfully built 3b27323a5dd8

[root@localhost ~]# rpm -qa oci-systemd-hook
oci-systemd-hook-0.1.6-1.gitfe22236.fc25.x86_64[root@localhost ~]# uname -a
Linux localhost.localdomain 4.10.5-200.fc25.x86_64 #1 SMP Wed Mar 22 20:37:08 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux[root@localhost ~]# cat /etc/*release
Fedora release 25 (Twenty Five)
NAME=Fedora
VERSION=&quot;25 (Server Edition)&quot;
ID=fedora
VERSION_ID=25
PRETTY_NAME=&quot;Fedora 25 (Server Edition)&quot;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10302535</commentid>
    <comment_count>32</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-04-04 09:31:27 -0400</bug_when>
    <thetext>(In reply to Tom Sweeney from comment #31)

This

&gt; Transaction test succeeded.
&gt; Running transaction
&gt;   Installing  : procps-ng-3.3.10-11.fc24.x86_64                            
&gt; 1/1 
&gt; error: unpacking of archive failed on file /usr/bin/free;58dff8f5: cpio: open
&gt; Error unpacking rpm package procps-ng-3.3.10-11.fc24.x86_64
&gt; Error unpacking rpm package procps-ng-3.3.10-11.fc24.x86_64
&gt; procps-ng-3.3.10-11.fc24.x86_64 was supposed to be installed but is not!

causes for ps not to be actually installed even if the subsequent docker run passes without error:

&gt; [root@localhost ~]# docker build -t test ~/test/
&gt; Sending build context to Docker daemon 2.048 kB
&gt; Step 1 : FROM fedora:25
&gt;  ---&gt; 4daa661b467f
&gt; Step 2 : RUN dnf install -y /usr/bin/ps
&gt;  ---&gt; Using cache
&gt;  ---&gt; 3b27323a5dd8
&gt; Successfully built 3b27323a5dd8

# docker run --rm -ti test ps axuwwf
/usr/bin/docker-current: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;exec: \\\&quot;ps\\\&quot;: executable file not found in $PATH\&quot;\n&quot;.

Why can&apos;t /usr/bin/free be installed?

OTOH,

   docker run --rm -ti -e container=docker fedora:25 bash

now passes. Do we want separate bugzilla about the installation of /usr/bin/free under --userns-remap?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10302540</commentid>
    <comment_count>33</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-04-04 09:32:49 -0400</bug_when>
    <thetext>(In reply to Jan Pazdziora from comment #32)
&gt;
&gt; causes for ps not to be actually installed even if the subsequent docker run
&gt; passes without error:

I wanted to say &quot;even if the subsequente docker *build* passes&quot;.

The build seemingly passes but docker run then fails.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10309138</commentid>
    <comment_count>34</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-04-06 02:10:11 -0400</bug_when>
    <thetext>Are these errors about oci-systemd-hook or something else?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10309844</commentid>
    <comment_count>35</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-04-06 05:44:19 -0400</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #34)
&gt; Are these errors about oci-systemd-hook or something else?

They don&apos;t seem to be oci-systemd-hook-related, rather a dac_override AVC denial. Filed bug 1439587 for that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10412563</commentid>
    <comment_count>36</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2017-05-15 07:49:50 -0400</bug_when>
    <thetext>I see

docker run --rm -ti -e container=docker fedora:25 bash

passing now with released

oci-systemd-hook-0.1.7-1.git1788cf2.fc25.x86_64

and

docker-1.12.6-6.gitae7d637.fc25.x86_64
container-selinux-2.10-1.fc25.noarch
selinux-policy-3.13.1-225.13.fc25.noarch
kernel-4.10.14-200.fc25.x86_64

Could we get Fixed In Version filled and this bugzilla closed, ideally with an errata?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10554848</commentid>
    <comment_count>38</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-29 16:37:55 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-8c49b86e6c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10554849</commentid>
    <comment_count>39</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-29 16:38:14 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-8b041abf0a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10558385</commentid>
    <comment_count>40</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-30 16:25:41 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-8b041abf0a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10558668</commentid>
    <comment_count>41</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-30 19:22:19 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-8c49b86e6c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10576438</commentid>
    <comment_count>42</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-07-08 12:50:06 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10576561</commentid>
    <comment_count>43</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-07-08 18:20:52 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.9-1.gitaa42622.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>