<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1347436</bug_id>
          
          <creation_ts>2016-06-16 16:59:00 -0400</creation_ts>
          <short_desc>fedora-import-state sets incorrect mode for /dev/shm when dracut places it in /run/initramfs/state (causes various things to break, inc. webkit and Boxes)</short_desc>
          <delta_ts>2016-12-20 01:32:21 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>initscripts</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>AcceptedBlocker AcceptedFreezeException</status_whiteboard>
          <keywords>Patch</keywords>
          <priority>urgent</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1406254</blocked>
    
    
    <blocked>1277285</blocked>
    
    
    <blocked>1277287</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="David Kaspar [Dee&apos;Kej]">dkaspar</assigned_to>
          <cc>amigadave</cc>
    
    
    <cc>dkaspar</cc>
    
    
    <cc>dracut-maint-list</cc>
    
    
    <cc>gmarr</cc>
    
    
    <cc>harald</cc>
    
    
    <cc>jkonecny</cc>
    
    
    <cc>johannbg</cc>
    
    
    <cc>jonathan</cc>
    
    
    <cc>jstpierr</cc>
    
    
    <cc>kevin</cc>
    
    
    <cc>kevin</cc>
    
    
    <cc>klember</cc>
    
    
    <cc>labbott</cc>
    
    
    <cc>lnykryn</cc>
    
    
    <cc>mbarnes</cc>
    
    
    <cc>mcatanzaro</cc>
    
    
    <cc>mclasen</cc>
    
    
    <cc>msekleta</cc>
    
    
    <cc>muadda</cc>
    
    
    <cc>peljasz</cc>
    
    
    <cc>rdieter</cc>
    
    
    <cc>robatino</cc>
    
    
    <cc>satellitgo</cc>
    
    
    <cc>ssahani</cc>
    
    
    <cc>s</cc>
    
    
    <cc>systemd-maint</cc>
    
    
    <cc>tiagomatos</cc>
    
    
    <cc>tpopela</cc>
    
    
    <cc>zbyszek</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>initscripts-9.68-1.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-08-18 22:26:18</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9425462</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 16:59:38 -0400</bug_when>
    <thetext>This is an extremely bizarre bug but I don&apos;t think we can write it off as a glitch...

For the last two days, in both openQA production and staging, the &apos;Welcome&apos; screen - the one run by /usr/libexec/gnome-welcome-tour , which triggers after initial-setup is complete - has failed to display correctly after an install of the Workstation live image to a UEFI test VM. It seems to work OK for a BIOS install.

All that shows up is an empty Yelp window - with the normal title/tool bar, the title &apos;Help&apos;, and a completely empty grey square as the content. See:

https://openqa.fedoraproject.org/tests/22900/modules/_graphical_wait_login/steps/11

on a BIOS install, the expected content shows up - the window title switches to &apos;Getting Started&apos; (subtitle &apos;GNOME Help&apos;) and there&apos;s the expected page with demo videos and Common Tasks links and so on.

In the system journal for the UEFI install, I see a bunch of errors like this:

Jun 16 13:34:11 localhost.localdomain gnome-welcome-tour.desktop[1827]: Failed to create shared memory file /WK2SharedMemory.2546975387: Permission denied

there are a little over 30,000 of those. There is nothing like this in the BIOS boot. I think that message is coming from WebKit?

Example affected image: https://kojipkgs.fedoraproject.org/compose/rawhide/Fedora-Rawhide-20160616.n.0/compose/Workstation/x86_64/iso/Fedora-Workstation-Live-x86_64-Rawhide-20160616.n.0.iso</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425463</commentid>
    <comment_count>1</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 17:01:44 -0400</bug_when>
    <thetext>I seem to be able to trigger the same thing just by trying to open an application&apos;s help screen - I tried with Nautilus, and it did set the window title correctly (&quot;Files, folders &amp; search&quot;), but did not load the actual content (still just a grey space) and another flood of &quot;Permission denied&quot; errors appeared in the logs.

I don&apos;t see any SELinux denials, note.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425474</commentid>
    <comment_count>2</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 17:08:37 -0400</bug_when>
    <thetext>aha, so yes, ultimately this seems to be a general Webkit 2 issue on UEFI: I can trigger the same thing by trying to add a Flickr online account, which causes a webkitgtk4-powered mini-browser to try and load the Yahoo! auth page. On a BIOS install, the page displays correctly. On a UEFI install, the mini-browser gets to displaying a bit of progress bar and the text &apos;Loading &quot;m.flickr.com&quot;...&apos;, but then sticks there, and in the log I see another flood of the same WK2SharedMemory errors, from org.gnome.ControlCenter.SearchProvider .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425481</commentid>
    <comment_count>3</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 17:13:43 -0400</bug_when>
    <thetext>nirik noted that he&apos;d seen odd permissions on /dev/shm , and that does indeed seem to be the problem here!

On the BIOS install, /dev/shm is rwxrwxrwt . On the UEFI install, it&apos;s rwxr-xr-t . If I do &apos;chmod go+w /dev/shm&apos; , the bug goes away - I can open help pages, and the Online Accounts minibrowser starts working properly.

So now I guess the question is, why are the /dev/shm perms different between the BIOS and UEFI installs (and which is correct)?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425534</commentid>
    <comment_count>4</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 17:45:19 -0400</bug_when>
    <thetext>so there&apos;s one other odd wrinkle to this bug: it really only happens with the *live* image. If I install from the Workstation netinst of the same day - https://kojipkgs.fedoraproject.org/compose/rawhide/Fedora-Rawhide-20160616.n.0/compose/Workstation/x86_64/iso/Fedora-Workstation-netinst-x86_64-Rawhide-20160616.n.0.iso - the bug does not happen, /dev/shm is rwxrwxrwt and all the webkit2-based things work fine.

So the bug *only* happens with a UEFI install of the live image.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425579</commentid>
    <comment_count>5</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 18:22:09 -0400</bug_when>
    <thetext>OK, so a bit more data. /dev/shm seems to be systemd&apos;s responsibility; it&apos;s mounted as a tmpfs and I see code in systemd for doing that, so kicking this over one more time to systemd.

I checked that the issue occurs on bare metal as well as in a KVM. I also checked and found that the write access is missing both when running live and after install from the live session. I also checked that the issue also affects KDE live images, so this is not specific to the Workstation live. Basically, it seems write access to /dev/shm is not available when UEFI booting a Rawhide live image, but is available in all other cases (BIOS boots of live images, and network installs regardless whether BIOS or UEFI).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425585</commentid>
    <comment_count>6</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-16 18:28:44 -0400</bug_when>
    <thetext>Finally, I&apos;ve also confirmed this is really new in Rawhide - it&apos;s not that /dev/shm has been like this all along and webkit changed, or anything. I booted the F24 final Workstation live in my UEFI test VM and /dev/shm is rwxrwxrwt . So this is really something new in Rawhide&apos;s systemd, I guess.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9425679</commentid>
    <comment_count>7</comment_count>
    <who name="Zbigniew JÄ™drzejewski-Szmek">zbyszek</who>
    <bug_when>2016-06-16 19:44:27 -0400</bug_when>
    <thetext>I&apos;d guess that this is another instance of some service changing the permissions. I&apos;m pretty sure that systemd initially sets them correctly (there was a small change in this area, I&apos;ll double check the patch, but I don&apos;t think it could be related).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9450717</commentid>
    <comment_count>8</comment_count>
    <who name="Josh Boyer">jwboyer</who>
    <bug_when>2016-06-24 10:16:36 -0400</bug_when>
    <thetext>*** Bug 1349804 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451070</commentid>
    <comment_count>9</comment_count>
    <who name="Laura Abbott">labbott</who>
    <bug_when>2016-06-24 12:14:32 -0400</bug_when>
    <thetext>https://bugzilla.redhat.com/show_bug.cgi?id=1282981 this was the previous instance of the same problem I was thinking of</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451687</commentid>
    <comment_count>10</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 16:25:02 -0400</bug_when>
    <thetext>Looking at Laura&apos;s bug, fedora-import-state could be involved here, I guess. It definitely runs and does something to /dev/shm:

fedora-import-state[938]: &apos;./dev/shm/lldpad.state&apos; -&gt; &apos;/dev/shm/lldpad.state&apos;

fedora-import-state is part of initscripts, so CCing Lukas in case he has any ideas here. initscripts 9.66 is in Rawhide but not F24, so we do have a delta there which matches the bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451726</commentid>
    <comment_count>11</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 17:07:16 -0400</bug_when>
    <thetext>So yeah, fedora-import-state seems to be the culprit here - `systemctl mask fedora-import-state.service` and rebooting gives me a properly-permissioned /dev/shm.

Downgrading initscripts to the F24 build doesn&apos;t help, though. Nor does booting the most recent F24 kernel (4.5.7-300.fc24) instead of a Rawhide kernel. So having trouble triaging this...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451803</commentid>
    <comment_count>12</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 17:50:39 -0400</bug_when>
    <thetext>Oh, OK. So what fedora-import-state actually *does* is important here. It&apos;s a pretty simple script. This is the relevant bit:

# copy state into root
cd /run/initramfs/state
find . -mindepth 1 -maxdepth 1 -exec cp -av -t / {} \;

so, obviously, its impact is dependent on what&apos;s in /run/initramfs/state . And that&apos;s our difference here: when you boot an F24 live, /run/initramfs/state contains etc/ and var/ , but no dev/ .

Interestingly, while checking this, I noticed the bug does actually affect BIOS boots *when running live* - I guess I didn&apos;t check that case before (I&apos;ll boot a few more times in case it&apos;s intermittent or something). When just booting the live on BIOS, there is a dev/ in /run/initramfs/state , and the permissions on /dev are wrong. But after installing and booting the installed system, there is no dev/ in /run/initramfs/state , and /dev permissions are right.

So yeah, it&apos;s definitely the rsync of /dev/shm/lldpad.state by fedora-import-state that causes this.

The difference between BIOS and UEFI cases with the live image appears to be what&apos;s in the initramfs. I ran `lsinitrd /boot/initramfs-4.7.0-0.rc3.git1.1.fc25.x86_64.img | grep lldpad` on both a BIOS install and a UEFI install of the 2016-06-16 live image. On the BIOS install, there are no results. On the UEFI install, there are:

usr/lib/dracut/hooks/pre-trigger/03-lldpad.sh
usr/sbin/lldpad
var/lib/lldpad

so that&apos;s obviously the difference here: for some reason, UEFI live installs and BIOS live installs have this different in their initramfs.

Aha, and now I look, I *do* see a suspicious difference in dracut here: dracut contains a &apos;95fcoe-uefi&apos; module (note the name) which seems to test whether it&apos;s running on UEFI:

check() {
    [[ $hostonly ]] || [[ $mount_needs ]] &amp;&amp; {
        [ -d /sys/firmware/efi ] || return 255
    }
    require_binaries dcbtool fipvlan lldpad ip readlink || return 1
    return 0
}

so that could certainly explain the difference: note the &apos;require_binaries&apos; line, which would result in the inclusion of lldpad binaries in the initramfs when booted under UEFI, but not under BIOS.

Not sure what&apos;s different between 24 and 25 yet, though, nor why this doesn&apos;t happen on network installs. More investigation to come.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451813</commentid>
    <comment_count>13</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 17:55:36 -0400</bug_when>
    <thetext>Aha. I think I see what changed between F24 and F25:

https://git.kernel.org/cgit/boot/dracut/dracut.git/commit?id=b99e72427b517dea0d91d15fe43cf0a37420af36

note that *reverts* a commit that stopped dracut putting lldpad.state in /run/initramfs/state/dev/shm/ - so in other words, it made dracut start doing that again. And also note that it&apos;s this code that stuffs up the permissions, because it does:

mkdir -m 0755 -p /run/initramfs/state/dev/shm

so, I think we can see how to fix that. :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451830</commentid>
    <comment_count>14</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 18:08:03 -0400</bug_when>
    <thetext>https://github.com/dracutdevs/dracut/pull/138</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451839</commentid>
    <comment_count>15</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 18:17:28 -0400</bug_when>
    <thetext>There&apos;s probably a second bug here, btw - I don&apos;t think dracut should be including the fcoe-uefi module in a hostonly initramfs for a UEFI system either, but it clearly *does*, and I&apos;m not sure why it does.

If you compare the journal.log from the BIOS and UEFI installs, the BIOS install one clearly shows that the &apos;fcoe&apos; and &apos;fcoe-uefi&apos; dracut modules are included in the rescue initramfs (which is generic, not hostonly), but aren&apos;t included in the &apos;normal&apos; initramfs (which is hostonly). The UEFI install log shows the modules being included in both initramfs&apos;es. I don&apos;t think it&apos;s as simple as the UEFI initramfs not being properly hostonly, though, as some modules definitely *are* left out.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451846</commentid>
    <comment_count>16</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 18:32:00 -0400</bug_when>
    <thetext>So for that second bug - I&apos;m not 100% confident, but if I understand dracut correctly, I think the problem is this:

each dracut module has a check() section which is used to indicate whether the module can and/or should be included in the initramfs being built. the check() function for the fcoe module does this:

check() {
    [[ $hostonly ]] || [[ $mount_needs ]] &amp;&amp; {
        for c in /sys/bus/fcoe/devices/ctlr_* ; do
            [ -L $c ] || continue
            fcoe_ctlr=$c
        done
        [ -z &quot;$fcoe_ctlr&quot; ] &amp;&amp; return 255
    }

    require_binaries dcbtool fipvlan lldpad ip readlink fcoemon fcoeadm || return 1
    return 0
}

So I think the first part there is basically a &apos;is this module needed&apos; check: if we&apos;re in hostonly mode (or &apos;mount_needs&apos;, dunno what that is), let&apos;s check and see if there are actually any FCoE devices, and if not, return 255, indicating &apos;module isn&apos;t needed&apos;.

The second part means &apos;make sure we can include these binaries in the initramfs, otherwise return 1 indicating the module should be included, but cannot be because some required binaries are missing&apos;.

However, we have this 95fcoe-uefi module, too. How does setup() for that module look?

check() {
    [[ $hostonly ]] || [[ $mount_needs ]] &amp;&amp; {
        [ -d /sys/firmware/efi ] || return 255
    }
    require_binaries dcbtool fipvlan lldpad ip readlink || return 1
    return 0
}

note it doesn&apos;t, AFAICS, include the check from the fcoe module. It just checks whether this is a UEFI boot, and wants to be enabled if it is. It also has this:

depends() {
    echo fcoe uefi-lib
    return 0
}

which obviously indicates a requirement for the &apos;fcoe&apos; module. So I think what happens when you build a &apos;hostonly&apos; initramfs on UEFI is that the fcoe module check() returns 255 (meaning &apos;nope, I don&apos;t need to be enabled&apos;), but the fcoe-uefi module check() returns 0 (meaning &apos;yes, I do want to be enabled!&apos;) and drags fcoe along via dependencies (presumably a dependency beats out a 255 check() return code).

So you wind up with the fcoe module *always* included in initramfs&apos;es built on UEFI systems, even though there are no FCoE mounts.

I dunno what the right way to fix this is - just duplicate the fcoe module&apos;s &apos;are there any FCoE mounts?&apos; check into fcoe-uefi, or if there&apos;s a better way.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451864</commentid>
    <comment_count>17</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 18:57:19 -0400</bug_when>
    <thetext>To fill in the final question - why it only happens on lives - I think it&apos;s probably because some of the required binaries for the fcoe module are missing on a network install (when there&apos;s no FCoE devices) because anaconda knows not to bother installing those packages in that case, so dracut will leave the module out because the binary requirements can&apos;t be satisfied. Whereas live images have to include the required binaries, and installs from live images always include all the stuff that&apos;s in the live image.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9451868</commentid>
    <comment_count>18</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-24 19:15:27 -0400</bug_when>
    <thetext>http://koji.fedoraproject.org/koji/taskinfo?taskID=14639525 is a scratch build of dracut with my patch (for the permissions) applied. I tested and it does indeed appear to resolve the issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9452390</commentid>
    <comment_count>19</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-06-25 10:22:54 -0400</bug_when>
    <thetext>harald says that world-writeable in /run/initramfs is a security hole (though he doesn&apos;t say why) and rejected my patch, saying it needs fixing in fedora-import-state. fine, whatever, someone please just fix this crap.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9549395</commentid>
    <comment_count>20</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-07-26 00:36:22 -0400</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 25 development cycle.
Changing version to &apos;25&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9553444</commentid>
    <comment_count>21</comment_count>
    <who name="Matthias Clasen">mclasen</who>
    <bug_when>2016-07-26 12:03:56 -0400</bug_when>
    <thetext>Can we get this fixed ? It breaks not just webkit, but boxes, and lots of other things.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9572962</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Blocker Bugs Application">blockerbugs</who>
    <bug_when>2016-08-01 08:46:22 -0400</bug_when>
    <thetext>Proposed as a Blocker for 25-beta by Fedora user mclasen using the blocker tracking app because:

 This breaks the functionality of several applications, some of which (boxes) are installed by default.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9590175</commentid>
    <comment_count>23</comment_count>
      <attachid>1188049</attachid>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-05 18:07:00 -0400</bug_when>
    <thetext>Created attachment 1188049
initscripts patch: explicitly set correct mode for /dev/shm after import

So here&apos;s my new proposal. This is a fairly simple-minded patch for initscripts that just explicitly resets the mode of /dev/shm after doing the import, if /run/initramfs/state/dev/shm exists. There&apos;s one obvious drawback to this (if we ever wanted to change the default mode of /dev/shm , we&apos;d have to adjust both systemd *and* initscripts), but it should at least fix the bug, I can&apos;t think of anything better, and no-one else has suggested anything better.

I&apos;ve tested, and this does solve the problem. Lukas, can you please review this? If I don&apos;t hear from Lukas in the next day or two I think I will just send out an initscripts build with this patch applied, since we really ought to fix this bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9591153</commentid>
    <comment_count>24</comment_count>
    <who name="Kevin Kofler">kevin</who>
    <bug_when>2016-08-07 07:45:58 -0400</bug_when>
    <thetext>This bug also breaks QtWebEngine (along with bug #1363914 and bug #1364781 â€“ 3 unrelated bugs hitting 1 component).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9594587</commentid>
    <comment_count>25</comment_count>
    <who name="David Kaspar [Dee&apos;Kej]">dkaspar</who>
    <bug_when>2016-08-08 12:31:38 -0400</bug_when>
    <thetext>Hello guys,

I&apos;ve been assigned to this BZ today. We have almost finished the patch for this, just doing some additional reviews and testing it. We will post more info tomorrow.

Best regards,

Dee&apos;Kej</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9594929</commentid>
    <comment_count>26</comment_count>
    <who name="Geoffrey Marr">gmarr</who>
    <bug_when>2016-08-08 13:35:45 -0400</bug_when>
    <thetext>Discussed during the 2016-08-08 blocker review meeting: [1]

This bug has been classifed as an Accepted Blocker as it violates the following criteria:

&quot;All applications that can be launched using the standard graphical mechanism of a release-blocking desktop after a default installation of that desktop must start successfully and withstand a basic functionality test.&quot; [2]

The consequences of this bug are obvious and serious and so the classification is also made as an AcceptedFreezeException.

[1] https://meetbot.fedoraproject.org/fedora-blocker-review/2016-08-08/f25-blocker-review.2016-08-08-16.01.txt

[2] https://fedoraproject.org/wiki/Fedora_25_Final_Release_Criteria#Default_application_functionality</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9598267</commentid>
    <comment_count>27</comment_count>
      <attachid>1188049</attachid>
    <who name="David Kaspar [Dee&apos;Kej]">dkaspar</who>
    <bug_when>2016-08-09 09:35:06 -0400</bug_when>
    <thetext>Comment on attachment 1188049
initscripts patch: explicitly set correct mode for /dev/shm after import

We have decided to not use this patch, because it was too specific and probably would require some additional maintenance in the future.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9598288</commentid>
    <comment_count>28</comment_count>
      <attachid>1189268</attachid>
    <who name="David Kaspar [Dee&apos;Kej]">dkaspar</who>
    <bug_when>2016-08-09 09:38:31 -0400</bug_when>
    <thetext>Created attachment 1189268
fedora-import-state.patch

This is the patch we will be using for new release for Rawhide and F25. It copies the files as it did before, but does not copy folders if they already exists. In this way, the attributes of already existing folders are not overwritten.

In case the destination folder does not exist, it is created normally.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9598485</commentid>
    <comment_count>29</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-09 10:15:04 -0400</bug_when>
    <thetext>initscripts-9.68-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-17b522dda8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9598774</commentid>
    <comment_count>30</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-09 11:18:24 -0400</bug_when>
    <thetext>Looks to me like if more than one depth of directory needs to be created, the mode for the lower levels won&apos;t be preserved. e.g. say initramfs has:

/run/initramfs/state/foo (0400)
/run/initramfs/state/foo/bar (0400)

and /foo does not exist on the installed system, the script will create /foo/bar with mode 0400, but I don&apos;t believe it&apos;ll set the mode of /foo to 0400.

There&apos;s also obviously a gap between &apos;mkdir&apos; and &apos;chmod&apos; / &apos;chown&apos; during which even the top level directory will have default ownership and permissions...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9598789</commentid>
    <comment_count>31</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-09 11:20:53 -0400</bug_when>
    <thetext>oh wait no, didn&apos;t read closely enough, it should work. sorry.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9600536</commentid>
    <comment_count>32</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-09 16:37:54 -0400</bug_when>
    <thetext>OK, tested and this does fix the main /dev/shm case.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9600616</commentid>
    <comment_count>33</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-09 17:22:26 -0400</bug_when>
    <thetext>geoff: when you&apos;re secretarializing, take care to make sure bugs actually block the correct trackers, as well as setting the whiteboard fields. This was not formally proposed as a freeze exception issue prior to the meeting, we decided to give it that status during the meeting; in this case you have to set it to block AlphaFreezeException as well as setting the whiteboard.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9601000</commentid>
    <comment_count>34</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-09 22:50:16 -0400</bug_when>
    <thetext>initscripts-9.68-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-17b522dda8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9602151</commentid>
    <comment_count>35</comment_count>
    <who name="David Kaspar [Dee&apos;Kej]">dkaspar</who>
    <bug_when>2016-08-10 07:26:24 -0400</bug_when>
    <thetext>(In reply to Adam Williamson from comment #30)
&gt; Looks to me like if more than one depth of directory needs to be created,
&gt; the mode for the lower levels won&apos;t be preserved. e.g. say initramfs has:
&gt; 
&gt; /run/initramfs/state/foo (0400)
&gt; /run/initramfs/state/foo/bar (0400)
&gt; 
&gt; and /foo does not exist on the installed system, the script will create
&gt; /foo/bar with mode 0400, but I don&apos;t believe it&apos;ll set the mode of /foo to
&gt; 0400.
&gt; 
&gt; There&apos;s also obviously a gap between &apos;mkdir&apos; and &apos;chmod&apos; / &apos;chown&apos; during
&gt; which even the top level directory will have default ownership and
&gt; permissions...

I see what you mean, Adam. We have been discussing this before as well. However, AFAIK, find should always print the top-level directory before the lower-level directory. Therefore, the top-level directory should be always created first (and the rights should be set correctly). And only after that, the files from original directory are copied to the destination directory.

In case we can&apos;t trust the find about how it prints its results, we can sort it with the &apos;sort&apos; command if needed. The missing character or white spaces should always have less ordering value compared to any other printable characters. IOW, the shorter string (substring) will be always sorted before longer (complete) string.

If you insist, I can add the sort option there, just to be sure.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9603414</commentid>
    <comment_count>36</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-10 11:40:17 -0400</bug_when>
    <thetext>yeah, as I said in my follow-up it should be fine, I wasn&apos;t considering that find walked all the way through the directory tree. I don&apos;t know if the window between creation and mode change may be a problem in any way.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9603465</commentid>
    <comment_count>37</comment_count>
    <who name="David Kaspar [Dee&apos;Kej]">dkaspar</who>
    <bug_when>2016-08-10 11:52:03 -0400</bug_when>
    <thetext>(In reply to Adam Williamson from comment #36)
&gt; I don&apos;t know if the window between creation and mode change may be a problem in any way.

Is there a chance that some other processes will be accessing those files before fedora-import-state is finished? If not, then we should be fine, since that bash script should be running as a single-thread, and copying is being done always after folder creation. 

The problem would occur in case the folder creation would fail somehow, but I really don&apos;t know what should be a proper way trying to recover from it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628861</commentid>
    <comment_count>38</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 22:26:09 -0400</bug_when>
    <thetext>initscripts-9.68-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="1"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1188049</attachid>
            <date>2016-08-05 18:07:00 -0400</date>
            <delta_ts>2016-08-09 09:39:04 -0400</delta_ts>
            <desc>initscripts patch: explicitly set correct mode for /dev/shm after import</desc>
            <filename>0001-fedora-import-state-fix-dev-shm-mode-RHBZ-1347436.patch</filename>
            <type>text/plain</type>
            <size>1920</size>
            <attacher name="Adam Williamson">awilliam</attacher>
            
              <data encoding="base64">RnJvbSA0NDhlMGFhOWUyOTZiZDdkYTdlNjdmZGNlY2FjOTc5MjgzMmFiZDBkIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBBZGFtIFdpbGxpYW1zb24gPGF3aWxsaWFtQHJlZGhhdC5jb20+
CkRhdGU6IEZyaSwgNSBBdWcgMjAxNiAxMzozNjoyOSAtMDcwMApTdWJqZWN0OiBbUEFUQ0hdIGZl
ZG9yYS1pbXBvcnQtc3RhdGU6IGZpeCAvZGV2L3NobSBtb2RlIChSSEJaICMxMzQ3NDM2KQoKZHJh
Y3V0IGNyZWF0ZXMgL3J1bi9pbml0cmFtZnMvc3RhdGUvZGV2L3NobSB3aXRoIG1vZGUgMDc1NSwK
d2hpY2ggZG9lcyBub3QgbWF0Y2ggdGhlIGV4cGVjdGVkIG1vZGUgb2YgL2Rldi9zaG0gLSAxNzc3
LgpkcmFjdXQgcmVmdXNlcyB0byBjaGFuZ2UgdGhpcywgY2xhaW1pbmcgYW55dGhpbmcgd29ybGQK
d3JpdGVhYmxlIGluIC9ydW4vaW5pdHJhbWZzL3N0YXRlIGlzIGEgc2VjdXJpdHkgcHJvYmxlbS4K
VGhpcyBtZWFucyB0aGF0IHdoZW4gZmVkb3JhLWltcG9ydC1zdGF0ZSBydW5zLCBhbmQgY29waWVz
Ci9ydW4vaW5pdHJhbWZzL3N0YXRlL2RldiB0byAvZGV2IHByZXNlcnZpbmcgdGhlIG1vZGUsIGl0
CmNoYW5nZXMgL2Rldi9zaG0gZnJvbSAxNzc3IHRvIDA3NTUsIGFuZCBicmVha3Mgc2V2ZXJhbCB0
aGluZ3MuCgpGb3Igbm93LCBsZXQncyBmaXggaXQgcXVpdGUgbmFpdmVseSAoaS5lLiBleHBsaWNp
dGx5KSBhZnRlcgpkb2luZyB0aGUgY29weS4gSXQgd291bGQgYmUgbmljZSBpZiBjcCBvciBzb21l
IGFsdGVybmF0aXZlIGhhZAphICdrZWVwIHRoZSBleGlzdGluZyBtb2RlIGZvciBleGlzdGluZyBm
aWxlcy9kaXJlY3RvcmllcywgYnV0CnVzZSB0aGUgbW9kZSBmcm9tIHRoZSBmaWxlIGJlaW5nIGNv
cGllZCBmb3IgZmlsZXMvZGlyZWN0b3JpZXMKd2hpY2ggZG8gbm90IHlldCBleGlzdCcgb3B0aW9u
IC0gSSB0aGluayB0aGF0J2QgYmUgdGhlIG5pY2VzdApmaXggaGVyZSAtIGJ1dCBBRkFJQ1MgaXQg
ZG9lcyBub3QuCgpUaGUgZHJhd2JhY2sgb2YgdGhpcyBhcHByb2FjaCBpcyB0aGF0IHdlJ3JlIG5v
dyBlZmZlY3RpdmVseQpzcGVjaWZ5aW5nIHRoZSBkZWZhdWx0IG1vZGUgb2YgL2Rldi9zaG0gaW4g
dHdvIHBsYWNlcyAtIHN5c3RlbWQKKHdoaWNoIGNyZWF0ZXMgaXQpIGFuZCBoZXJlLiBJZiB3ZSBl
dmVyIHdhbnRlZCB0byBjaGFuZ2UgdGhlCm1vZGUsIHdlJ2QgaGF2ZSB0byByZW1lbWJlciB0byBj
aGFuZ2UgaXQgYm90aCBpbiBzeXN0ZW1kIGFuZApoZXJlIHRvIGtlZXAgdGhpbmdzIGNvbnNpc3Rl
bnQuIFN0aWxsLCBuby1vbmUgZWxzZSBoYXMgb2ZmZXJlZAphIGJldHRlciBpZGVhIHlldC4KLS0t
CiBzeXN0ZW1kL2ZlZG9yYS1pbXBvcnQtc3RhdGUgfCA1ICsrKysrCiAxIGZpbGUgY2hhbmdlZCwg
NSBpbnNlcnRpb25zKCspCgpkaWZmIC0tZ2l0IGEvc3lzdGVtZC9mZWRvcmEtaW1wb3J0LXN0YXRl
IGIvc3lzdGVtZC9mZWRvcmEtaW1wb3J0LXN0YXRlCmluZGV4IDVhZDI5ZDQuLjcyODBjMDUgMTAw
NzU1Ci0tLSBhL3N5c3RlbWQvZmVkb3JhLWltcG9ydC1zdGF0ZQorKysgYi9zeXN0ZW1kL2ZlZG9y
YS1pbXBvcnQtc3RhdGUKQEAgLTksMyArOSw4IEBAIGZpbmQgLiAtbWluZGVwdGggMSAtbWF4ZGVw
dGggMSAtZXhlYyBjcCAtYXYgLXQgLyB7fSBcOwogaWYgWyAtZSAvc3lzL2ZzL3NlbGludXgvZW5m
b3JjZSAtYSAteCAvdXNyL3NiaW4vcmVzdG9yZWNvbiBdOyB0aGVuCiAgICAgZmluZCAuIC1taW5k
ZXB0aCAxIC1wcmludDAgfCB7IGNkIC8gJiYgeGFyZ3MgLS1udWxsIHJlc3RvcmVjb24gLWlGOyB9
CiBmaQorCisjIFJIQlogIzEzNDc0MzY6IGNvcnJlY3QgbW9kZSBvZiAvZGV2L3NobSBhZnRlciB0
aGUgaW1wb3J0CitpZiBbIC1lIC9ydW4vaW5pdHJhbWZzL3N0YXRlL2Rldi9zaG0gXTsgdGhlbgor
ICAgIGNobW9kIDE3NzcgL2Rldi9zaG0KK2ZpCi0tIAoyLjkuMgoK
</data>
<flag name="review"
          id="2754729"
          type_id="155"
          status="-"
          setter="dkaspar"
    />
          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1189268</attachid>
            <date>2016-08-09 09:38:00 -0400</date>
            <delta_ts>2016-08-09 09:38:31 -0400</delta_ts>
            <desc>fedora-import-state.patch</desc>
            <filename>fedora-import-state.patch</filename>
            <type>text/plain</type>
            <size>1795</size>
            <attacher name="David Kaspar [Dee&apos;Kej]">dkaspar</attacher>
            
              <data encoding="base64">RnJvbSAzYjhiNTE2NDBkZmQ1MTcwMjM4Mjk3MjA4N2RkN2Y0MTIxOWZiYTdkIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiAiRGF2aWQgS2FzcGFyIFtEZWUnS2VqXSIgPGRrYXNwYXJAcmVk
aGF0LmNvbT4KRGF0ZTogTW9uLCA4IEF1ZyAyMDE2IDE3OjIyOjI3ICswMjAwClN1YmplY3Q6IFtQ
QVRDSF0gU2tpcCBtb2RpZnlpbmcgb2YgZXhpc3RpbmcgZm9sZGVycyBpbgogc3lzdGVtZC9mZWRv
cmEtaW1wb3J0LXN0YXRlIHNjcmlwdAoKICBSZXNvbHZlczogIzEzNDc0MzYKLS0tCiBzeXN0ZW1k
L2ZlZG9yYS1pbXBvcnQtc3RhdGUgfCAzNCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
LS0tCiAxIGZpbGUgY2hhbmdlZCwgMzEgaW5zZXJ0aW9ucygrKSwgMyBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9zeXN0ZW1kL2ZlZG9yYS1pbXBvcnQtc3RhdGUgYi9zeXN0ZW1kL2ZlZG9yYS1p
bXBvcnQtc3RhdGUKaW5kZXggNWFkMjlkNC4uYzM0YWQwZiAxMDA3NTUKLS0tIGEvc3lzdGVtZC9m
ZWRvcmEtaW1wb3J0LXN0YXRlCisrKyBiL3N5c3RlbWQvZmVkb3JhLWltcG9ydC1zdGF0ZQpAQCAt
MSwxMSArMSwzOSBAQAogIyEvYmluL2Jhc2gKICMgZmVkb3JhLWltcG9ydC1zdGF0ZTogaW1wb3J0
IHN0YXRlIGZpbGVzIGZyb20gaW5pdHJhbWZzIChlLmcuIG5ldHdvcmsgY29uZmlnKQogCi0jIGNv
cHkgc3RhdGUgaW50byByb290CisjIENvcHkgc3RhdGUgaW50byByb290IGZvbGRlcjoKKyMgPT09
PT09PT09PT09PT09PT09PT09PT09PT09PQogY2QgL3J1bi9pbml0cmFtZnMvc3RhdGUKLWZpbmQg
LiAtbWluZGVwdGggMSAtbWF4ZGVwdGggMSAtZXhlYyBjcCAtYXYgLXQgLyB7fSBcOwogCi0jIHJ1
biByZXN0b3JlY29uIG9uIHRoZSBjb3BpZWQgZmlsZXMKK0lGU19iYWNrdXA9JElGUworSUZTPSQn
XG4nICAgICAgICAgICAgICAgICAjIFByb2Nlc3MgZmluZCdzIHJlc3VsdHMgbGluZSBieSBsaW5l
CisKK2RpcnNfZm91bmQ9JChmaW5kIC4gLXR5cGUgZCkKKworZm9yIGRpciBpbiAkZGlyc19mb3Vu
ZDsgZG8KKyAgcHVzaGQgIiRkaXIiID4gL2Rldi9udWxsCisKKyAgIyBSZW1vdmUgaW5pdGlhbCAn
LicgY2hhciBmcm9tIHRoZSBmaW5kJ3MgcmVzdWx0OgorICBkZXN0X2Rpcj0iJHtkaXIvXC4vfSIK
KworICAjIENyZWF0ZSBkZXN0aW5hdGlvbiBmb2xkZXIgaWYgaXQgZG9lcyBub3QgZXhpc3QgKHdp
dGggdGhlIHNhbWUgcmlnaHRzKToKKyAgaWYgISBbWyAtZCAiJGRlc3RfZGlyIiBdXTsgdGhlbgor
ICAgIG1rZGlyIC1wICIkZGVzdF9kaXIiCisgICAgY2htb2QgLS1yZWZlcmVuY2U9IiRQV0QiICIk
ZGVzdF9kaXIiCisgICAgY2hvd24gLS1yZWZlcmVuY2U9IiRQV0QiICIkZGVzdF9kaXIiCisgIGZp
CisKKyAgIyBDb3B5IGFsbCBmaWxlcyB0aGF0IGFyZSBub3QgZGlyZWN0b3J5OgorICBmaW5kIC4g
LW1pbmRlcHRoIDEgLW1heGRlcHRoIDEgLW5vdCAtdHlwZSBkIC1leGVjIGNwIC1hdiAtdCAiJGRl
c3RfZGlyIiB7fSBcOyA+IC9kZXYvbnVsbAorCisgIHBvcGQgPiAvZGV2L251bGwKK2RvbmUKKwor
SUZTPSRJRlNfYmFja3VwCisKKworIyBSdW4gcmVzdG9yZWNvbiBvbiB0aGUgY29waWVkIGZpbGVz
OgorIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogaWYgWyAtZSAvc3lzL2Zz
L3NlbGludXgvZW5mb3JjZSAtYSAteCAvdXNyL3NiaW4vcmVzdG9yZWNvbiBdOyB0aGVuCiAgICAg
ZmluZCAuIC1taW5kZXB0aCAxIC1wcmludDAgfCB7IGNkIC8gJiYgeGFyZ3MgLS1udWxsIHJlc3Rv
cmVjb24gLWlGOyB9CiBmaQotLSAKMi43LjQKCg==
</data>

          </attachment>
      

    </bug>

</bugzilla>