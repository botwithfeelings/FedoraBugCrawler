<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1311750</bug_id>
          
          <creation_ts>2016-02-24 16:45:00 -0500</creation_ts>
          <short_desc>Set TasksMax in docker.service on releases with systemd &gt;= 228</short_desc>
          <delta_ts>2016-09-02 19:27:27 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Nalin Dahyabhai">nalin</reporter>
          <assigned_to name="Antonio Murdaca">amurdaca</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>jeder</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.12.1-8.gitf1040da.fc25</cf_fixed_in>
          <cf_doc_type>Bug Fix</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-02 19:27:27</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9095652</commentid>
    <comment_count>0</comment_count>
    <who name="Nalin Dahyabhai">nalin</who>
    <bug_when>2016-02-24 16:45:55 -0500</bug_when>
    <thetext>Description of problem:
On newer releases, we might want to set a TasksMax value in docker.service, so that the daemon doesn&apos;t get an EAGAIN when it&apos;s trying to start things.  TasksMax=infinity works for me, but I haven&apos;t worked through the implications.

Version-Release number of selected component (if applicable):
docker-1.10.2-5.git0f5ac89.fc24.x86_64 on kernel-4.5.0-0.rc2.git2.1.fc24.x86_64

How reproducible:
Always

Steps to Reproduce:
1. docker run -d --name porttest -p 3800-3900:3800-3900 busybox top

Actual results:
Docker returns a failure because it couldn&apos;t start that many docker-proxy processes.

Expected results:
Success!  Or rather, lack of an error.

Additional info:
This also causes DockerSuite.TestPsGroupPortRange in the docker integration test suite to fail.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9229857</commentid>
    <comment_count>1</comment_count>
    <who name="Lokesh Mandvekar">lsm5</who>
    <bug_when>2016-04-12 11:14:14 -0400</bug_when>
    <thetext>jerms, wdyt?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9230468</commentid>
    <comment_count>2</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-04-12 14:09:22 -0400</bug_when>
    <thetext>What is the default tasksmax?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9230668</commentid>
    <comment_count>3</comment_count>
    <who name="Jeremy Eder">jeder</who>
    <bug_when>2016-04-12 15:19:48 -0400</bug_when>
    <thetext>This is messy, we just last week got the pids cgroup controller backported into RHEL (it&apos;s in 3.10.0-372) via https://bugzilla.redhat.com/show_bug.cgi?id=1265339).

But the whole point of that controller is to protect from a fork bomb inside a container, and if we set TasksMax=infinity we effectively disable the fork bomb detection that we were after in the first place.

So, unless I&apos;m reading it wrong, no, I would not recommend touching TasksMax.  It also implicitly enables taskaccounting all the way up the cgroup structure.  This needs more thought and testing before we touch it.

As far as preventing the EAGAIN, I haven&apos;t seen an strace so I&apos;m not sure where that&apos;s coming from -- is it from the kernel/iptables?

Anyway we&apos;re not using the docker-proxy anywhere in openshift or atomic, we use the kube-proxy, and soon we will likely be offering at least an option to use iptables.

Again, unless I&apos;m not following -- I can&apos;t see how mapping 1000 ports in a userspace app like docker-proxy is a use-case we should be all too concerned with.  If you really need 1000 ports, what about --net=host ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9230738</commentid>
    <comment_count>5</comment_count>
    <who name="Jeremy Eder">jeder</who>
    <bug_when>2016-04-12 15:38:20 -0400</bug_when>
    <thetext>And now I see this is a Fedora request, so disregard the kernel version stuff.

wrt the fork bomb.

If you look at systemd-system.conf upstream there is:

src/core/system.conf:#DefaultTasksMax=512
src/login/logind.conf:#UserTasksMax=12288
units/systemd-nspawn@.service.in:TasksMax=8192

So, default is 512 and nspawn service gets 8k.  I guess that&apos;s more reasonable than infinity.
So you want to set TasksMax=8192 for docker.service ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9230760</commentid>
    <comment_count>6</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-04-12 15:42:10 -0400</bug_when>
    <thetext>Since container processes end up in a different Cgroup they are not a problem.  We can set this to 8192, but you were concerned about this having a performance hit, correct?  If not performance hit then setting thit so nspawns, default is justifiable.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9386087</commentid>
    <comment_count>7</comment_count>
    <who name="Jeremy Eder">jeder</who>
    <bug_when>2016-06-03 14:38:42 -0400</bug_when>
    <thetext>I am concerned about the accounting stuff because it&apos;s never been tested.

Unless someone magic&apos;s up some data asap, we&apos;re going to enable taskaccounting in openshift anyway:

My POV is here:  https://github.com/openshift/origin/pull/8989#issuecomment-221939970

As far as tasksmax...wasn&apos;t that part of the other BZ...

https://bugzilla.redhat.com/show_bug.cgi?id=1340519</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9386088</commentid>
    <comment_count>8</comment_count>
    <who name="Jeremy Eder">jeder</who>
    <bug_when>2016-06-03 14:39:18 -0400</bug_when>
    <thetext>actually its the cpu/mem accounting.  sigh, long week...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9548690</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-07-26 00:03:57 -0400</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 25 development cycle.
Changing version to &apos;25&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9631756</commentid>
    <comment_count>10</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-08-19 16:42:11 -0400</bug_when>
    <thetext>Lokesh/Antonio, I see TaskMasks=Infinity in Rawhide, but Jeremy recommended 8192

TasksMax=8192 

Could we change to that default.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9635224</commentid>
    <comment_count>11</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-08-22 05:39:47 -0400</bug_when>
    <thetext>Changed to 8192 in both F25 and Rawhide</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9635724</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-22 08:14:07 -0400</bug_when>
    <thetext>docker-1.12.1-4.git8ea583f.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-e7176b9785</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9637896</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-22 19:52:21 -0400</bug_when>
    <thetext>docker-1.12.1-4.git8ea583f.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-e7176b9785</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9640287</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-23 09:12:11 -0400</bug_when>
    <thetext>docker-1.12.1-5.git8ea583f.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-ffeefb3138</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9642984</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-23 19:20:49 -0400</bug_when>
    <thetext>docker-1.12.1-5.git8ea583f.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-ffeefb3138</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9645284</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-24 07:00:06 -0400</bug_when>
    <thetext>docker-1.12.1-6.git49151a1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-626f41754c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9648359</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-25 05:28:52 -0400</bug_when>
    <thetext>docker-1.12.1-6.git49151a1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-626f41754c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9648513</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-25 06:28:43 -0400</bug_when>
    <thetext>docker-1.12.1-7.git49151a1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-7e3f838986</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9649918</commentid>
    <comment_count>19</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-25 14:21:39 -0400</bug_when>
    <thetext>docker-1.12.1-7.git49151a1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-7e3f838986</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9658460</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-29 05:22:52 -0400</bug_when>
    <thetext>docker-1.12.1-8.gitf1040da.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-caa6a905c5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9661243</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-29 18:56:13 -0400</bug_when>
    <thetext>docker-1.12.1-8.gitf1040da.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-caa6a905c5</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676421</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-02 19:27:20 -0400</bug_when>
    <thetext>docker-1.12.1-8.gitf1040da.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>