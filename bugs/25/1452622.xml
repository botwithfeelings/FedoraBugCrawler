<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1452622</bug_id>
          
          <creation_ts>2017-05-19 07:04:00 -0400</creation_ts>
          <short_desc>LUKS passphrase secrets that are a multiple of 16 characters in length result in incorrectly padded base64 data being passed to QEMU</short_desc>
          <delta_ts>2017-06-15 05:21:51 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libvirt</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Lee Yarwood">lyarwood</reporter>
          <assigned_to name="Libvirt Maintainers">libvirt-maint</assigned_to>
          <cc>agedosier</cc>
    
    
    <cc>berrange</cc>
    
    
    <cc>clalancette</cc>
    
    
    <cc>itamar</cc>
    
    
    <cc>laine</cc>
    
    
    <cc>libvirt-maint</cc>
    
    
    <cc>pkrempa</cc>
    
    
    <cc>veillard</cc>
    
    
    <cc>virt-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>libvirt-2.2.1-2.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-15 05:21:51</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10428517</commentid>
    <comment_count>0</comment_count>
    <who name="Lee Yarwood">lyarwood</who>
    <bug_when>2017-05-19 07:04:49 -0400</bug_when>
    <thetext>Description of problem:

LUKS passphrase secrets that are a multiple of 16 characters in length result in incorrectly padded encrypted base64 data being passed to QEMU.

- Create a domain for the test :

qemu-img create -f raw /var/lib/libvirt/images/test.img 1G                  
virt-install --import  --name luks-attach-test --ram 1024 \
             --vcpus 1 --cpu host -w network=default,model=virtio \
             --disk path=/var/lib/libvirt/images/test.img,format=raw \
             --noautoconsole

- The following uses a 64 character length passphrase :

PASS=$(cat /dev/urandom | tr -dc &apos;a-zA-Z0-9&apos; | fold -w 64 | head -n 1)                                                      

- Format an example LUKS disk using qemu-img :

openssl rand -base64 16 &gt; sec0-iv.b64                                              
printf &quot;$PASS&quot; | openssl enc -aes-256-cbc -a -K $(cat /var/lib/libvirt/qemu/domain-6-luks-attach-test/master-key.aes | hexdump -v -e &apos;/1 &quot;%02X&quot;&apos;) -iv $(base64 -d sec0-iv.b64 | hexdump -v -e &apos;/1 &quot;%02X&quot;&apos;) &gt; luks-sec.b64
qemu-img create --object secret,id=secmaster,format=raw,file=/var/lib/libvirt/qemu/domain-6-luks-attach-test/master-key.aes \
                --object secret,id=sec0,keyid=secmaster,format=base64,file=luks-sec.b64,iv=$(&lt;sec0-iv.b64) \
                -f luks -o key-secret=sec0 /var/lib/libvirt/images/test.luks 1G  


- Create the required secrect and disk XML :
                                                                               
cat &gt;&gt; sec.xml &lt;&lt; EOF                                                            
&lt;secret ephemeral=&quot;no&quot; private=&quot;no&quot;&gt;                                               
 &lt;usage type=&quot;volume&quot;&gt;                                                             
  &lt;volume&gt;var/lib/libvirt/images/test.luks&lt;/volume&gt;                                
 &lt;/usage&gt;                                                                          
&lt;/secret&gt;                                                                          
EOF                                                                              
                                                                                   
virsh secret-define sec.xml                                                     
Secret 1ba9af5d-45a5-4ca5-8a0c-07f4fc46984c created                             
                                                                                
cat &gt;&gt; disk.xml &lt;&lt; EOF                                                        
&lt;disk&gt;                                                                          
  &lt;driver name=&quot;qemu&quot; type=&quot;raw&quot;/&gt;                                              
  &lt;source file=&quot;/var/lib/libvirt/images/test.luks&quot;/&gt;                            
  &lt;target bus=&quot;virtio&quot; dev=&quot;vdb&quot;/&gt;                                              
  &lt;encryption format=&quot;luks&quot;&gt;                                                    
    &lt;secret type=&quot;passphrase&quot; uuid=&quot;1ba9af5d-45a5-4ca5-8a0c-07f4fc46984c&quot;/&gt;     
  &lt;/encryption&gt;                                                                 
&lt;/disk&gt;                                                                         
EOF                                                                            

- Set the value of the secret within libvirt :
                                                                                
MYSECRET=$(printf %s &quot;${PASS}&quot; | base64 -w 0)                                      
virsh secret-set-value 1ba9af5d-45a5-4ca5-8a0c-07f4fc46984c ${MYSECRET}         

- Attempt to attach the device :
                              
virsh attach-device luks-attach-test disk.xml
error: Failed to attach device from disk.xml
error: internal error: unable to execute QEMU command &apos;object-add&apos;: Incorrect number of padding bytes (89) found on decrypted data

- The following trace is seen within libvirtd.log with DEBUG enabled :

2017-05-19 10:31:12.567+0000: 3394: debug : qemuDomainObjEnterMonitorInternal:3176 : Entering monitor (mon=0x7f381400f1f0 vm=0x7f382000d510 name=luks-attach-test)
2017-05-19 10:31:12.567+0000: 3394: debug : qemuMonitorAddObject:3060 : type=secret objalias=virtio-disk1-luks-secret0 props=0x7f38300071f0
2017-05-19 10:31:12.567+0000: 3394: debug : qemuMonitorAddObject:3062 : mon:0x7f381400f1f0 vm:0x7f382000d510 json:1 fd:28
2017-05-19 10:31:12.567+0000: 3394: debug : qemuMonitorJSONCommandWithFd:296 : Send command &apos;{&quot;execute&quot;:&quot;object-add&quot;,&quot;arguments&quot;:{&quot;qom-type&quot;:&quot;secret&quot;,&quot;id&quot;:&quot;virtio-disk1-luks-secret0&quot;,&quot;props&quot;:{&quot;data&quot;:&quot;3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==&quot;,&quot;keyid&quot;:&quot;masterKey0&quot;,&quot;iv&quot;:&quot;RMRlju/G5E9qu1/2/5ctKQ==&quot;,&quot;format&quot;:&quot;base64&quot;}},&quot;id&quot;:&quot;libvirt-20&quot;}&apos; for write with FD -1
2017-05-19 10:31:12.567+0000: 3394: info : qemuMonitorSend:1009 : QEMU_MONITOR_SEND_MSG: mon=0x7f381400f1f0 msg={&quot;execute&quot;:&quot;object-add&quot;,&quot;arguments&quot;:{&quot;qom-type&quot;:&quot;secret&quot;,&quot;id&quot;:&quot;virtio-disk1-luks-secret0&quot;,&quot;props&quot;:{&quot;data&quot;:&quot;3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==&quot;,&quot;keyid&quot;:&quot;masterKey0&quot;,&quot;iv&quot;:&quot;RMRlju/G5E9qu1/2/5ctKQ==&quot;,&quot;format&quot;:&quot;base64&quot;}},&quot;id&quot;:&quot;libvirt-20&quot;}^M
 fd=-1
2017-05-19 10:31:12.568+0000: 3391: info : qemuMonitorIOWrite:534 : QEMU_MONITOR_IO_WRITE: mon=0x7f381400f1f0 buf={&quot;execute&quot;:&quot;object-add&quot;,&quot;arguments&quot;:{&quot;qom-type&quot;:&quot;secret&quot;,&quot;id&quot;:&quot;virtio-disk1-luks-secret0&quot;,&quot;props&quot;:{&quot;data&quot;:&quot;3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==&quot;,&quot;keyid&quot;:&quot;masterKey0&quot;,&quot;iv&quot;:&quot;RMRlju/G5E9qu1/2/5ctKQ==&quot;,&quot;format&quot;:&quot;base64&quot;}},&quot;id&quot;:&quot;libvirt-20&quot;}^M
 len=290 ret=290 errno=0
2017-05-19 10:31:12.568+0000: 3391: info : qemuMonitorIOProcess:429 : QEMU_MONITOR_IO_PROCESS: mon=0x7f381400f1f0 buf={&quot;id&quot;: &quot;libvirt-20&quot;, &quot;error&quot;: {&quot;class&quot;: &quot;GenericError&quot;, &quot;desc&quot;: &quot;Incorrect number of padding bytes (89) found on decrypted data&quot;}}^M
 len=132
2017-05-19 10:31:12.568+0000: 3391: debug : qemuMonitorJSONIOProcessLine:191 : Line [{&quot;id&quot;: &quot;libvirt-20&quot;, &quot;error&quot;: {&quot;class&quot;: &quot;GenericError&quot;, &quot;desc&quot;: &quot;Incorrect number of padding bytes (89) found on decrypted data&quot;}}]
2017-05-19 10:31:12.568+0000: 3391: info : qemuMonitorJSONIOProcessLine:211 : QEMU_MONITOR_RECV_REPLY: mon=0x7f381400f1f0 reply={&quot;id&quot;: &quot;libvirt-20&quot;, &quot;error&quot;: {&quot;class&quot;: &quot;GenericError&quot;, &quot;desc&quot;: &quot;Incorrect number of padding bytes (89) found on decrypted data&quot;}}
2017-05-19 10:31:12.568+0000: 3391: debug : qemuMonitorJSONIOProcess:260 : Total used 132 bytes out of 132 available in buffer
2017-05-19 10:31:12.568+0000: 3394: debug : qemuMonitorJSONCommandWithFd:301 : Receive command reply ret=0 rxObject=0x55569cb433f0
2017-05-19 10:31:12.568+0000: 3394: debug : qemuMonitorJSONCheckError:376 : unable to execute QEMU command {&quot;execute&quot;:&quot;object-add&quot;,&quot;arguments&quot;:{&quot;qom-type&quot;:&quot;secret&quot;,&quot;id&quot;:&quot;virtio-disk1-luks-secret0&quot;,&quot;props&quot;:{&quot;data&quot;:&quot;3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==&quot;,&quot;keyid&quot;:&quot;masterKey0&quot;,&quot;iv&quot;:&quot;RMRlju/G5E9qu1/2/5ctKQ==&quot;,&quot;format&quot;:&quot;base64&quot;}},&quot;id&quot;:&quot;libvirt-20&quot;}: {&quot;id&quot;:&quot;libvirt-20&quot;,&quot;error&quot;:{&quot;class&quot;:&quot;GenericError&quot;,&quot;desc&quot;:&quot;Incorrect number of padding bytes (89) found on decrypted data&quot;}}
2017-05-19 10:31:12.568+0000: 3394: error : qemuMonitorJSONCheckError:387 : internal error: unable to execute QEMU command &apos;object-add&apos;: Incorrect number of padding bytes (89) found on decrypted data
2017-05-19 10:31:12.568+0000: 3394: debug : qemuDomainObjExitMonitorInternal:3199 : Exited monitor (mon=0x7f381400f1f0 vm=0x7f382000d510 name=luks-attach-test)

- This is reproducible using the same values via monitor commands directly with QEMU :
                                                                                   
$QEMU -object secret,id=secmaster,format=raw,file=/var/lib/libvirt/qemu/domain-6-luks-attach-test/master-key.aes -nographic -serial mon:stdio
Ctrl+A-c                                                                                                                           
QEMU 2.7.1 monitor - type &apos;help&apos; for more information                                                                               
(qemu) object_add secret,id=sec0,keyid=secmaster,format=base64,data=3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==,iv=RMRlju/G5E9qu1/2/5ctKQ==
Incorrect number of padding bytes (89) found on decrypted data

- However manually generating the encrypted base64 data for the secret again with openssl produces a different valid result :

printf &quot;$PASS&quot; | openssl enc -aes-256-cbc -a -K $(cat /var/lib/libvirt/qemu/domain-6-luks-attach-test/master-key.aes | hexdump -v -e &apos;/1 &quot;%02X&quot;&apos;) -iv $(echo &quot;RMRlju/G5E9qu1/2/5ctKQ==&quot; | base64 -d | hexdump -v -e &apos;/1 &quot;%02X&quot;&apos;)
3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdaJgS46ZIEm9HmMvxZiTgxw=


Libvirt  - 3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdQ==
openssl  - 3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdaJgS46ZIEm9HmMvxZiTgxw=

- Using this value things now work as expected, we can also attach the LUKS device :

$QEMU -object secret,id=secmaster,format=raw,file=/var/lib/libvirt/qemu/domain-6-luks-attach-test/master-key.aes -nographic -serial mon:stdio
Ctrl+A-c                                                                                                                           
QEMU 2.7.1 monitor - type &apos;help&apos; for more information                                                                               
(qemu) object_add secret,id=sec0,keyid=secmaster,format=base64,data=3fTvuaZivMOFN3BjSTdZtIW/sA7mwFVyJ1MpauZrcMJlfDCGzP19KCZA7MiQMKvMHs88QJstgweqwf9aulfqdaJgS46ZIEm9HmMvxZiTgxw=,iv=RMRlju/G5E9qu1/2/5ctKQ==
(qemu) drive_add dummy file=/var/lib/libvirt/images/test.luks,key-secret=sec0,format=luks,if=none,id=drive0
OK

Version-Release number of selected component (if applicable):
libvirt-2.2.0-2.fc25.x86_64

How reproducible:
Always

Steps to Reproduce:
See above.

Actual results:
Secret object fails to be added due to incorrect padding within the encrypted base64 data.

Expected results:
Secret object added successfully allowing a LUKS device to be decrypted correctly.

Additional info:</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10428528</commentid>
    <comment_count>1</comment_count>
    <who name="Peter Krempa">pkrempa</who>
    <bug_when>2017-05-19 07:09:12 -0400</bug_when>
    <thetext>commit 71890992daf37ec78b00b4ce873369421dc99731
Author: Daniel P. Berrange &lt;berrange@redhat.com&gt;
Date:   Tue May 2 11:32:43 2017 +0100

    Fix padding of encrypted data
    
    If we are encoding a block of data that is 16 bytes in length,
    we cannot leave it as 16 bytes, we must pad it out to the next
    block boundary, 32 bytes. Without this padding, the decoder will
    incorrectly treat the last byte of plain text as the padding
    length, as it can&apos;t distinguish padded from non-padded data.
    
    The problem exhibited itself when using a 16 byte passphrase
    for a LUKS volume
    
      $ virsh secret-set-value 55806c7d-8e93-456f-829b-607d8c198367 \
           $(echo -n 1234567812345678 | base64)
      Secret value set
    
      $ virsh start demo
      error: Failed to start domain demo
      error: internal error: process exited while connecting to monitor: &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;Len 16
      2017-05-02T10:35:40.016390Z qemu-system-x86_64: -object \
        secret,id=virtio-disk1-luks-secret0,data=SEtNi5vDUeyseMKHwc1c1Q==,\
        keyid=masterKey0,iv=zm7apUB1A6dPcH53VW960Q==,format=base64: \
        Incorrect number of padding bytes (56) found on decrypted data
    
    Notice how the padding &apos;56&apos; corresponds to the ordinal value of
    the character &apos;8&apos;.
    
    Signed-off-by: Daniel P. Berrange &lt;berrange@redhat.com&gt;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10460689</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-30 20:34:21 -0400</bug_when>
    <thetext>libvirt-2.2.1-2.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-ad6a31ebe1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10467261</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-01 03:07:01 -0400</bug_when>
    <thetext>libvirt-2.2.1-2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-ad6a31ebe1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10508515</commentid>
    <comment_count>4</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-06-15 05:21:51 -0400</bug_when>
    <thetext>libvirt-2.2.1-2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>