<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1375305</bug_id>
          
          <creation_ts>2016-09-12 12:52:00 -0400</creation_ts>
          <short_desc>Unhandled Level1 translation fault in polkitd due to mozjs package</short_desc>
          <delta_ts>2016-09-16 20:58:26 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>mozjs24</component>
          <version>25</version>
          <rep_platform>aarch64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Tracking</keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          <dependson>1242326</dependson>
    
    
    <dependson>1375547</dependson>
          <blocked>922257</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Debarshi Ray">debarshir</reporter>
          <assigned_to name="Debarshi Ray">debarshir</assigned_to>
          <cc>debarshir</cc>
    
    
    <cc>extras-qa</cc>
    
    
    <cc>jeremy.linton</cc>
    
    
    <cc>mohun106</cc>
    
    
    <cc>paulo.cesar.pereira.de.andrade</cc>
    
    
    <cc>pbrobinson</cc>
    
    
    <cc>peter.newton</cc>
    
    
    <cc>rric</cc>
    
    
    <cc>walters</cc>
    
    
    <cc>zheng.xu</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>mozjs24-24.2.0-10.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          <cf_clone_of>1242326</cf_clone_of>
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-16 20:58:26</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9699958</commentid>
    <comment_count>0</comment_count>
    <who name="Debarshi Ray">debarshir</who>
    <bug_when>2016-09-12 12:52:00 -0400</bug_when>
    <thetext>+++ This bug was initially created as a clone of Bug #1242326 +++

Description of problem:
On Aarch64 systems with a VA bits of 48 the polkitd process crashes continuously due to an unhandled level 1 translation fault. On debugging we found that it is caused by the mozjs code.



Version-Release number of selected component (if applicable):
Fedora 21 for Aarch64

How reproducible:
Its easily reproducible on Cavium ThunderX platform.

Steps to Reproduce:
1. Just boot the F21 release for aarch64 and can be seen every time polkitd runs

Actual results:
Below is the crash.

====== cut here ========
unhandled level 1 translation fault (11) at 0x00000000, esr 0x92000045
pgd = ffff8003c3e3ba00
[00000000] *pgd=0000000000000000, *pud=0000000000000000

CPU: 0 PID: 1983 Comm: polkitd Not tainted 3.18.0 #1
task: ffff8003c3a60b00 ti: ffff8003c3ba0000 task.ti: ffff8003c3ba0000
PC is at 0xffff7a733f90
LR is at 0xffff7a733f74
pc : [&lt;0000ffff7a733f90&gt;] lr : [&lt;0000ffff7a733f74&gt;] pstate: 20000000
sp : 0000ffffe1ef0e60
x29: 0000ffffe1ef0e90 x28: 0000ffffb1acdc40 
x27: 0000ffffb1ad18e0 x26: 0000ffffb1acd720 
x25: 0000ffff7a9e2588 x24: 0000000000000000 
x23: 0000000000000000 x22: 0000ffffe1ef0f78 
x21: 0000ffffb1ad1840 x20: 0000000000800000 
x19: 0000ffff7a7a7e08 x18: 0000ffff7a363b4c 
x17: 0000ffff7a797b40 x16: 0000ffff7a40af0c 
x15: 00000000ffffffff x14: 0000ffff7ac0a000 
x13: 0000ffff7ac09000 x12: 0000ffffe1ef0ce0 
x11: 0000ffff7ac2a250 x10: 0000000002eb0939 
x9 : 0000000000000000 x8 : 0000000000000001 
x7 : ffffffffffffffff x6 : 0000ffffb1aca9f0 
x5 : 0000ffffb1aca9f0 x4 : 0000ffffb1aca9f0 
x3 : 0000ffff7a40b074 x2 : 0000ffff7a40b578 
x1 : 000000000000007b x0 : 0000000000000000 

====== end =========

Expected results:
It shouldn&apos;t crash.

Additional info:
The attached patch to the mozjs source fixes the problem. On aarch64 architecture the VA bit maximum is 48.

--- Additional comment from Jan Kurik on 2015-07-15 09:18:20 EDT ---

This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 23 development cycle.
Changing version to &apos;23&apos;.

(As we did not run this process for some time, it could affect also pre-Fedora 23 development
cycle bugs. We are very sorry. It will help us with cleanup during Fedora 23 End Of Life. Thank you.)

More information and reason for this action is here:
https://fedoraproject.org/wiki/BugZappers/HouseKeeping/Fedora23

--- Additional comment from Peter Newton on 2015-08-18 18:53:00 EDT ---

I was interested in making mozjs17 work on an aarch64 system so I built the mozjs17 RPM with the patch above applied.  I can confirm that the RPM built and all of its tests passed on this aarch64 system with a 48b VA kernel.

However, I also built the RPM on a KVM/QEMU VM running Fedora 22 with stock Fedora 22 kernel which is configured with a 42b VA (see Documentation/arm64/memory.txt in kernel source).  In this case, the patch causes the RPM to fail its tests.

I think that JS::Value on 64b platforms uses 17b of tag and 47b of payload (punboxing) for pointers.  So, I am not sure that the patch is actually correct.

--- Additional comment from Radha Mohan Chintakuntla on 2015-08-19 00:30:58 EDT ---

Thanks for testing this out. I am not 100% aware of the mozjs code, so was looking for anyone who can tell if this patch is sufficient or not. Feel free to improve it to make it work on all combinations.

--- Additional comment from Jeremy Linton on 2016-08-02 14:25:34 EDT ---

Please don&apos;t apply the attached patch, it will break x86. It also causes an ABI break, requiring everything linked against mozjs to be rebuilt (which implies a .so name bump).


I have a backported version of the upstream patch against mozjs24, and an additional patch to move polkitd off mozjs17 to mozjs24. 

I would take the bug, but I don&apos;t appear to have permissions.

--- Additional comment from Zheng Xu on 2016-09-07 02:56 EDT ---

Modify the tag pointer data structure using less tagged bits to mozjs be compatible with 48-bit VA kernel configuration.

--- Additional comment from Zheng Xu on 2016-09-07 02:58 EDT ---

Limit the heap allocation to use memory within 47 bits to make mozjs be compatible with 48-bit VA kernel configuration.

--- Additional comment from Zheng Xu on 2016-09-07 02:58 EDT ---

Limit the heap allocation to use memory within 47 bits to make mozjs be compatible with 48-bit VA kernel configuration.

--- Additional comment from Zheng Xu on 2016-09-07 02:59 EDT ---

Limit the heap allocation to use memory within 47 bits to make mozjs be compatible with 48-bit VA kernel configuration.

--- Additional comment from Zheng Xu on 2016-09-07 03:09:59 EDT ---

Not sure if it is too late. I just attached the patches for mozjs fixes for different versions.

Note : mozjs1.8.5 is a bit different. Because the old mozjs has pre-generated js strings in C code which will be mapped to memory by dynamic linker, so changing heap allocation doesn&apos;t help. But the patch for mozjs1.8.5 modifies the tag pointer data structure which is a part of JSAPI, so all the packages depending on mozjs1.8.5 need to be re-built if the patch is used.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9700079</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-12 13:23:37 -0400</bug_when>
    <thetext>mozjs24-24.2.0-10.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-60014be5ba</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9700588</commentid>
    <comment_count>2</comment_count>
    <who name="Jeremy Linton">jeremy.linton</who>
    <bug_when>2016-09-12 17:26:53 -0400</bug_when>
    <thetext>See also bug# 1375368 to move polkit to mozjs24</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9700598</commentid>
    <comment_count>3</comment_count>
    <who name="Jeremy Linton">jeremy.linton</who>
    <bug_when>2016-09-12 17:33:51 -0400</bug_when>
    <thetext>Hi, can we get the patches for mozjs38 and js applied as well? Or do we need to open another defect?

Thanks,</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9702375</commentid>
    <comment_count>4</comment_count>
    <who name="Debarshi Ray">debarshir</who>
    <bug_when>2016-09-13 07:13:42 -0400</bug_when>
    <thetext>(In reply to Jeremy Linton from comment #3)
&gt; Hi, can we get the patches for mozjs38 and js applied as well? Or do we need
&gt; to open another defect?

I filed bug 1375547 for mozjs38.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9705516</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-13 23:25:31 -0400</bug_when>
    <thetext>mozjs24-24.2.0-10.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-60014be5ba</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9715926</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-16 20:58:22 -0400</bug_when>
    <thetext>mozjs24-24.2.0-10.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>