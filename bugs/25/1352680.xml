<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1352680</bug_id>
          
          <creation_ts>2016-07-04 13:20:00 -0400</creation_ts>
          <short_desc>efibootmgr calls in anaconda crashing since efivar-0.24-1.fc25 landed</short_desc>
          <delta_ts>2016-08-18 22:25:15 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>efibootmgr</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>AcceptedBlocker</status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>urgent</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1277284</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="Peter Jones">pjones</assigned_to>
          <cc>aeneby</cc>
    
    
    <cc>fweimer</cc>
    
    
    <cc>jcm</cc>
    
    
    <cc>jdulaney</cc>
    
    
    <cc>juliux.pigface</cc>
    
    
    <cc>mario_limonciello</cc>
    
    
    <cc>pjones</cc>
    
    
    <cc>pschindl</cc>
    
    
    <cc>pwhalen</cc>
    
    
    <cc>robatino</cc>
    
    
    <cc>satellitgo</cc>
    
    
    <cc>surya_prabhakar</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>efibootmgr-13-2.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-08-18 22:25:15</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9479105</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-07-04 13:20:51 -0400</bug_when>
    <thetext>All openQA UEFI tests since efivar-0.24-1.fc25 landed in Rawhide have failed, e.g. https://openqa.fedoraproject.org/tests/24608 . program.log shows:

06:34:59,186 INFO program: Running... efibootmgr
06:34:59,610 DEBUG program: Return code: -11
06:34:59,611 INFO program: Running... efibootmgr -c -w -L Fedora -d /dev/vda -p 1 -l \EFI\fedora\shim.efi
06:34:59,789 DEBUG program: Return code: -11

per davidshea, a negative &apos;return code&apos; like that means &apos;exited with signal&apos;, so this means efibootmgr is exiting with signal 11.

Proposing as an Alpha blocker, this violates all &apos;install must complete&apos; criteria - e.g. &quot;When using a dedicated installer image, the installer must be able to complete an installation using the text, graphical and VNC installation interfaces.&quot; - on UEFI, which is a &quot;supported firmware type&quot; per https://fedoraproject.org/wiki/Fedora_25_Alpha_Release_Criteria#Release-blocking_images_must_boot .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9501796</commentid>
    <comment_count>1</comment_count>
    <who name="Paul Whalen">pwhalen</who>
    <bug_when>2016-07-12 10:35:55 -0400</bug_when>
    <thetext>Also seeing this on aarch64 uefi installs. Ignoring the error and finishing the install the system boots successfully.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9502925</commentid>
    <comment_count>2</comment_count>
    <who name="Mario Limonciello">mario_limonciello</who>
    <bug_when>2016-07-12 17:38:42 -0400</bug_when>
    <thetext>efibootmgr in rawhide currently is missing https://github.com/rhinstaller/efibootmgr/commit/d44b6bba411587c77ed25775bc1f9d962550604c

It would be best to get @pjones to issue a new efibootmgr release and update to that to resolve this issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9502931</commentid>
    <comment_count>3</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-07-12 17:45:07 -0400</bug_when>
    <thetext>pjones has been on vacation lately, which is why this isn&apos;t resolved yet, but he knows about it and will be fixing it when he&apos;s back.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9536029</commentid>
    <comment_count>4</comment_count>
    <who name="Petr Schindler">pschindl</who>
    <bug_when>2016-07-21 05:36:01 -0400</bug_when>
    <thetext>Discussed at 2016-07-20 blocker review meeting: [1]. 

This bug was accepted as Alpha blocker: Failing efibootmgr clearly violates the alpha criterion: &quot;When using a dedicated installer image, the installer must be able to complete an installation using the text, graphical and VNC installation interfaces.&quot;  

[1] https://meetbot.fedoraproject.org/fedora-blocker-review/2016-07-20/f25-blocker-review.2016-07-20-16.00.html</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9549751</commentid>
    <comment_count>5</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-07-26 00:55:29 -0400</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 25 development cycle.
Changing version to &apos;25&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9582570</commentid>
    <comment_count>6</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-03 14:25:03 -0400</bug_when>
    <thetext>Update as of today:

&lt;pjones&gt; gah, that&apos;s still a thing
&lt;pjones&gt; I will try to fix it this afternoon or tomorrow.  I *think* it shouldn&apos;t be much more work.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9604665</commentid>
    <comment_count>7</comment_count>
    <who name="">satellitgo</who>
    <bug_when>2016-08-10 17:50:54 -0400</bug_when>
    <thetext>Fedora-Everything-netinst-x86_64-25-20160809.n.0.iso
installs to efi usb hd and boots on yoga pro 2

used  usb written with f24 gnome-disk restore as installer.

Note:
first install attempt failed
2nd install attempt (used restore disk function in booted netinstall usb) - install worked.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609372</commentid>
    <comment_count>8</comment_count>
    <who name="Aaron Sowry">aeneby</who>
    <bug_when>2016-08-11 22:07:06 -0400</bug_when>
    <thetext>I guess bug 1364823 is related.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609393</commentid>
    <comment_count>9</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-11 22:20:23 -0400</bug_when>
    <thetext>yeah, not sure if it&apos;s exactly the same...looking at the backtrace that one looks like it might occur when installing over an existing Fedora UEFI install, since it runs through a function called warn_duplicate_name. But that&apos;s just a guess.

Anyhow, there are new efivar and efibootmgr builds for F25 and F26 now, so if you can re-test with those it&apos;d be great - should be possible to test by manually updating them in the live environment prior to running the install.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609538</commentid>
    <comment_count>10</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-11 23:31:18 -0400</bug_when>
    <thetext>So I&apos;m testing the fix for this, but there is a problem: one dependent package - fwupdate - was not ported to the new efivar API and rebuilt. This package is included in the Workstation live, so until it&apos;s fixed the Workstation live will not compose (as the current fwupdate package&apos;s deps are now broken).

fwupdate does need changes to work with the new efivar, it&apos;s not just a case of a straight rebuild, and we&apos;re not yet close enough to the go/no-go that it&apos;d be a good idea for me to try and hack this up as a patch tonight...I&apos;ll just leave it to pjones for tomorrow.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609539</commentid>
    <comment_count>11</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-11 23:32:12 -0400</bug_when>
    <thetext>sorry, I should say, the *Rawhide* workstation live will not compose, as the new efivar has gone to Rawhide; F25 will just continue as is (with images building but UEFI installs failing) until an update is submitted and pushed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609608</commentid>
    <comment_count>12</comment_count>
    <who name="Aaron Sowry">aeneby</who>
    <bug_when>2016-08-12 00:32:08 -0400</bug_when>
    <thetext>Forcing the update (--nodeps) of efivar, efivar-libs and efibootmgr from koji in the F25 Workstation Live environment at least stopped efibootmgr from dumping core when I run it. That enabled me to see that I did indeed have duplicate boot entries (3 named &quot;Fedora&quot;).

Before deleting the dupes though I tried running Anaconda again, which still failed during bootloader installation. I then deleted all boot entries and ran Anaconda again - still failed at the same place. Without closing Anaconda I opened a terminal and ran the failed command manually, which succeeded:

# efibootmgr -c -w -L Fedora -d /dev/sda -p 1 -l \\EFI\\fedora\\shim.efi

After this I told Anaconda to continue with the installation anyway, and I now seem to have a working system.

Not sure if this is relevant but the logs where I copied the failed command from didn&apos;t have double-escaping on the shim path, I added that myself.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609612</commentid>
    <comment_count>13</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-12 00:35:29 -0400</bug_when>
    <thetext>The updated packages *do* fix the bug, in my testing. One of my test repos:

https://www.happyassassin.net/temp/repo/x86_64/

currently contains the relevant packages for Rawhide, if anyone else wants to test. When I run a Rawhide install with that repo added, it completes successfully with no efibootmgr errors.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609615</commentid>
    <comment_count>14</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-12 00:37:13 -0400</bug_when>
    <thetext>Aaron: sorry, my bad, I gave you bad information. The efibootmgr run during the installation process uses the efibootmgr from the installed system, not the one from the live environment - so even if you update the version in the live environment it won&apos;t fix the installation (the installed system will still have the older efibootmgr, as the installation process basically just dumps the live system image onto the hard disk, it doesn&apos;t include post-boot changes to the live environment).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9609620</commentid>
    <comment_count>15</comment_count>
    <who name="Aaron Sowry">aeneby</who>
    <bug_when>2016-08-12 00:41:19 -0400</bug_when>
    <thetext>Adam, that makes perfect sense. Also explains why efibootmgr still dumps core in my booted system. I&apos;ll keep an eye out for updates.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9612540</commentid>
    <comment_count>16</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-12 17:58:32 -0400</bug_when>
    <thetext>fwupd also needs rebuilding for the new efivar. fwupd builds against fwupdate, so fwupdate needs to be fixed and built first, then fwupd can be done.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9616178</commentid>
    <comment_count>17</comment_count>
    <who name="John Dulaney">jdulaney</who>
    <bug_when>2016-08-15 14:52:01 -0400</bug_when>
    <thetext>CCing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9623665</commentid>
    <comment_count>18</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-17 13:33:04 -0400</bug_when>
    <thetext>pesign-0.112-4.fc25 mokutil-0.3.0-3.fc25 efibootmgr-13-2.fc25 efivar-28-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-650675f139</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9623725</commentid>
    <comment_count>19</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-17 13:47:23 -0400</bug_when>
    <thetext>Thanks! Not to sound too ungrateful, but I notice there&apos;s quite a lot of change in these builds, with some new feature work being mixed in with the changes to fix compilation, by the looks of it...ideally, during freeze (especially very late in freeze) we&apos;d rather have the minimal amount of change necessary to fix the actual blocker bug, in future.

Shouldn&apos;t be a big problem as the openQA tests should catch any major breakage if there happens to be any, but just a note.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9623793</commentid>
    <comment_count>20</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-17 14:06:54 -0400</bug_when>
    <thetext>Also, I think the update is missing fwupdate and fwupd.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9623824</commentid>
    <comment_count>21</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-17 14:15:58 -0400</bug_when>
    <thetext>Ah, it looks like they were submitted separately (though fwupd still needs doing):

https://bodhi.fedoraproject.org/updates/FEDORA-2016-5ff724b2e5 has fwupdate
https://bodhi.fedoraproject.org/updates/FEDORA-2016-0f013aee39 has dbxtool

by policy these should have been in the efivar update, not submitted separately, as updates are supposed to be internally consistent (an update that makes a backward-incompatible library change must include rebuilds of all packages depending on that library), so there is no risk of one update being pushed without the other(s) and causing dependency breakage.

Fixing this after the fact is a bit of a pain, though, and as this is a release blocker it&apos;s not really difficult to give it a bit of special handling, so I&apos;ll just make sure all three updates get pushed together (ideally, please add fwupd to the fwupdate update).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9624084</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-17 15:52:22 -0400</bug_when>
    <thetext>efibootmgr-13-2.fc25, efivar-28-1.fc25, mokutil-0.3.0-3.fc25, pesign-0.112-4.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-650675f139</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9624318</commentid>
    <comment_count>23</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-08-17 17:23:17 -0400</bug_when>
    <thetext>https://bodhi.fedoraproject.org/updates/FEDORA-2016-5ff724b2e5 now has fwupdate and fwupd. I tested using my side repo:

https://www.happyassassin.net/temp/repo/x86_64/

which now has all three updates in it. A UEFI install with that included as an additional repo succeeds without errors and boots. There also don&apos;t seem to be any dependency issues - I can select the Workstation package set without trouble.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9628849</commentid>
    <comment_count>24</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-08-18 22:24:38 -0400</bug_when>
    <thetext>efibootmgr-13-2.fc25, efivar-28-1.fc25, mokutil-0.3.0-3.fc25, pesign-0.112-4.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>