<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1375851</bug_id>
          
          <creation_ts>2016-09-14 01:44:00 -0400</creation_ts>
          <short_desc>ocserv kdcproxy stopped to work in Fedora 25 due to GNUTLS error</short_desc>
          <delta_ts>2016-10-10 13:47:31 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>ocserv</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Alexander Bokovoy">abokovoy</reporter>
          <assigned_to name="Nikos Mavrogiannopoulos">nmavrogi</assigned_to>
          <cc>nmavrogi</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>ocserv-0.11.4-3.fc25 ocserv-0.11.5-1.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-10-10 13:47:31</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9705816</commentid>
    <comment_count>0</comment_count>
    <who name="Alexander Bokovoy">abokovoy</who>
    <bug_when>2016-09-14 01:44:34 -0400</bug_when>
    <thetext>Description of problem:
After upgrade to Fedora 25, ocserv&apos;s KDC proxy stopped working. Journal output says there is a problem with randomness source reported by GNUTLS:

ocserv-0.11.4-1.fc25.x86_64

# journalctl -u ocserv -f
-- Logs begin at Sat 2014-11-01 17:38:46 CET. --
Sep 14 07:27:56 id.vda.li systemd[1]: Starting OpenConnect SSL VPN server...
Sep 14 07:27:56 id.vda.li ocserv[2537]: Setting &apos;plain&apos; as primary authentication method
Sep 14 07:27:56 id.vda.li ocserv[2537]: Enabling &apos;gssapi&apos; as authentication method
Sep 14 07:27:56 id.vda.li ocserv[2537]: Enabling &apos;gssapi&apos; as authentication method
Sep 14 07:27:56 id.vda.li ocserv[2537]: Setting &apos;file&apos; as supplemental config option
Sep 14 07:28:06 id.vda.li systemd[1]: ocserv.service: PID file /var/run/ocserv.pid not readable (yet?) after start: No such file or directory
Sep 14 07:28:06 id.vda.li ocserv[2608]: main: initialized ocserv 0.11.4
Sep 14 07:28:06 id.vda.li ocserv[2609]: sec-mod: reading supplemental config from files
Sep 14 07:28:06 id.vda.li systemd[1]: Started OpenConnect SSL VPN server.
Sep 14 07:28:06 id.vda.li ocserv[2609]: sec-mod: sec-mod initialized (socket: /var/lib/ocserv/ocserv.sock.2608)
Sep 14 07:28:32 id.vda.li ocserv[2613]: GnuTLS error (at worker-vpn.c:585): Error in the system&apos;s randomness device.
Sep 14 07:28:32 id.vda.li ocserv[2608]: main: X.X.X.X:50280 user disconnected (reason: unspecified, rx: 0, tx: 0)

Unfortunately, nothing can point to exact issue. audit.log does not have any indications that ocserv daemon process couldn&apos;t write to /dev/random or /dev/urandom. gnutls-cli-debug cannot connect to the ocserv as ocserv just drops connection immediately due to GNUTLS error. gnutls-cli when run on the same host against an Apache server running on the same host works just fine.

Looking at similar errors in search engines, I can see Debian users complaining about nzbt showing the same problem in daemon mode when built against gnutls. Unfortunately, no recipe was provided there other than rebuilding against OpenSSL.

I&apos;m filing the bug against ocserv but feel free to move to gnutls if that is the real place where the issue happens.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9705840</commentid>
    <comment_count>1</comment_count>
    <who name="Alexander Bokovoy">abokovoy</who>
    <bug_when>2016-09-14 01:55:46 -0400</bug_when>
    <thetext>Ok, tracing ocserv shows following:
--------------------------------------------------------------------------
[pid  2781] clock_gettime(CLOCK_REALTIME, {1473832277, 955959216}) = 0
[pid  2781] brk(NULL)                   = 0x563df2640000
[pid  2781] brk(NULL)                   = 0x563df2640000
[pid  2781] brk(0x563df263b000)         = 0x563df263b000
[pid  2781] brk(NULL)                   = 0x563df263b000
[pid  2781] getrandom(0x7ffd1021dc90, 32, 0) = -1 EPERM (Operation not permitted)
[pid  2781] sendto(7, &quot;&lt;27&gt;Sep 14 07:51:17 ocserv[2781]: GnuTLS error (at worker-vpn.c:585): Error in the system&apos;s randomness device.&quot;, 110, MSG_NOSIGNAL, NULL, 0) = 110
[pid  2781] exit_group(1)               = ?
--------------------------------------------------------------------------

So, gnutls started using getrandom() call but environment is not set to allow it.

I&apos;m running 4.8.0-0.rc5.git1.1.fc25.x86_64 kernel.

Both bug 1172273 and 1329996 sound not very optimistic in getting getrandom() to glibc. Can we back out use of getrandom() in gnutls or at least try other means if that one is failing?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9705842</commentid>
    <comment_count>2</comment_count>
    <who name="Alexander Bokovoy">abokovoy</who>
    <bug_when>2016-09-14 01:56:26 -0400</bug_when>
    <thetext>This is, at the very least, a blocker for use of ocserv in Fedora 25.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9706273</commentid>
    <comment_count>3</comment_count>
    <who name="Nikos Mavrogiannopoulos">nmavrogi</who>
    <bug_when>2016-09-14 04:19:39 -0400</bug_when>
    <thetext>Yes gnutls uses getrandom() in F25 using the syscall() interface. If you set isolate-worker=false would that work? If yes, then I need to update ocserv&apos;s allowed set of system calls to include getrandom().</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9706279</commentid>
    <comment_count>4</comment_count>
    <who name="Nikos Mavrogiannopoulos">nmavrogi</who>
    <bug_when>2016-09-14 04:21:59 -0400</bug_when>
    <thetext>https://gitlab.com/ocserv/ocserv/commit/cc1dbf1c246375c175b4392e3c6ca2139b0c355a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9706301</commentid>
    <comment_count>5</comment_count>
    <who name="Alexander Bokovoy">abokovoy</who>
    <bug_when>2016-09-14 04:26:38 -0400</bug_when>
    <thetext>Yes, changing &apos;isolate-workers&apos; to &apos;true&apos; helped.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9706349</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-14 04:43:39 -0400</bug_when>
    <thetext>ocserv-0.11.4-3.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-86f48d69f1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9706368</commentid>
    <comment_count>7</comment_count>
    <who name="Nikos Mavrogiannopoulos">nmavrogi</who>
    <bug_when>2016-09-14 04:50:08 -0400</bug_when>
    <thetext>To get deeper into the issue, getrandom() was detected on gnutls library initialization, and the getrandom handlers were set to obtain randomness. However, once the child process started with limited privileges in terms of syscalls gnutls failed.

Given that this is supposed to happen (seccomp filter), I guess this is a legitimate bug for ocserv rather than something that should be addressed in gnutls.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9708872</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-14 17:23:45 -0400</bug_when>
    <thetext>ocserv-0.11.4-3.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-86f48d69f1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9727071</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-20 13:07:05 -0400</bug_when>
    <thetext>ocserv-0.11.4-3.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9739902</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-23 21:50:56 -0400</bug_when>
    <thetext>ocserv-0.11.5-1.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-f145304e25</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9779185</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-10-10 13:47:31 -0400</bug_when>
    <thetext>ocserv-0.11.5-1.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>