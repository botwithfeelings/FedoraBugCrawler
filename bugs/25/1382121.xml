<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1382121</bug_id>
          
          <creation_ts>2016-10-05 15:20:00 -0400</creation_ts>
          <short_desc>[bug] requires(preun) and requires(postun) aren&apos;t returned by repoquery --requires</short_desc>
          <delta_ts>2017-05-05 09:34:13 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>dnf</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Triaged</keywords>
          <priority>medium</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Stephen Gallagher">sgallagh</reporter>
          <assigned_to>rpm-software-management</assigned_to>
          <cc>jmracek</cc>
    
    
    <cc>mluscon</cc>
    
    
    <cc>packaging-team-maint</cc>
    
    
    <cc>pmatilai</cc>
    
    
    <cc>rpm-software-management</cc>
    
    
    <cc>vmukhame</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>dnf-2.4.0-1.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-05-05 09:34:13</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9769164</commentid>
    <comment_count>0</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2016-10-05 15:20:25 -0400</bug_when>
    <thetext>Description of problem:
https://github.com/rpm-software-management/dnf-plugins-core/commit/032c9e971f61ad4e09af98584b39dbbd8122181d added support for a --requires-pre argument to `dnf repoquery`, however there are still three other Requires(foo) types that are unhandled:
 * Requires(preun):
 * Requires(post):
 * Requires(postun):

These dependencies are necessary to use repoquery to determine the full set of packages that would be needed to support the installation and removal of a package.

Version-Release number of selected component (if applicable):
https://github.com/rpm-software-management/dnf-plugins-core/commit/032c9e971f61ad4e09af98584b39dbbd8122181d

How reproducible:
Every time

Steps to Reproduce:
1. Run `dnf repoquery --requires-post sssd-client`

Actual results:
Error: unrecognized arguments: --requires-post


Expected results:
/sbin/ldconfig
/usr/sbin/alternatives


Additional info:
Both RPM and the old yum-based repoquery used to treat all four of these as part of &quot;Requires&quot; and return them all when queried with --requires.

RPM still does:

```
$ rpm -q --requires sssd-client
/bin/sh
/bin/sh
/sbin/ldconfig
/sbin/ldconfig
/sbin/ldconfig
/usr/sbin/alternatives
/usr/sbin/alternatives
libc.so.6()(64bit)
libc.so.6(GLIBC_2.14)(64bit)
libc.so.6(GLIBC_2.2.5)(64bit)
libc.so.6(GLIBC_2.3)(64bit)
libc.so.6(GLIBC_2.3.4)(64bit)
libc.so.6(GLIBC_2.4)(64bit)
libc.so.6(GLIBC_2.7)(64bit)
libc.so.6(GLIBC_2.8)(64bit)
libcom_err.so.2()(64bit)
libk5crypto.so.3()(64bit)
libkrb5.so.3()(64bit)
libkrb5.so.3(krb5_3_MIT)(64bit)
libpam.so.0()(64bit)
libpam.so.0(LIBPAM_1.0)(64bit)
libpam.so.0(LIBPAM_EXTENSION_1.0)(64bit)
libpam.so.0(LIBPAM_MODUTIL_1.0)(64bit)
libpthread.so.0()(64bit)
libpthread.so.0(GLIBC_2.12)(64bit)
libpthread.so.0(GLIBC_2.2.5)(64bit)
libsss_idmap.so.0()(64bit)
libsss_idmap.so.0(SSS_IDMAP_0.4)(64bit)
libsss_nss_idmap.so.0()(64bit)
libsss_nss_idmap.so.0(SSS_NSS_IDMAP_0.0.1)(64bit)
rpmlib(CompressedFileNames) &lt;= 3.0.4-1
rpmlib(FileDigests) &lt;= 4.6.0-1
rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1
rpmlib(PayloadIsXz) &lt;= 5.2-1
rtld(GNU_HASH)
```</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9770111</commentid>
    <comment_count>1</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2016-10-06 01:21:39 -0400</bug_when>
    <thetext>Unfortunately the full rpm-level Requires(pre,post,preun,postun) dependencies are not available at the repodata level, it only has a notion of &quot;pre-requires&quot; which includes Requires(pre,post) type dependencies. Requires(preun,postun) are considered just regular dependencies in repodata.

Dnf cannot query data that just is not there, fixing this would require changes to the repodata format and all the tooling sitting on top of it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9770917</commentid>
    <comment_count>2</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2016-10-06 08:00:26 -0400</bug_when>
    <thetext>(In reply to Panu Matilainen from comment #1)
&gt; Unfortunately the full rpm-level Requires(pre,post,preun,postun)
&gt; dependencies are not available at the repodata level, it only has a notion
&gt; of &quot;pre-requires&quot; which includes Requires(pre,post) type dependencies.
&gt; Requires(preun,postun) are considered just regular dependencies in repodata.
&gt; 
&gt; Dnf cannot query data that just is not there, fixing this would require
&gt; changes to the repodata format and all the tooling sitting on top of it.

OK, just to make sure I parsed that correctly:

When I do a `dnf repoquery --requires-pre`, that actually returns both &quot;Requires(pre):&quot; and &quot;Requires(post):&quot; together, and `dnf repoquery --requires` returns all of &quot;Requires:&quot;, &quot;Requires(preun):&quot; and &quot;Requires(postun):&quot;?

If that&apos;s the case, then I can work with that. Thanks!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9770966</commentid>
    <comment_count>3</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2016-10-06 08:17:26 -0400</bug_when>
    <thetext>(In reply to Stephen Gallagher from comment #2) 
&gt; OK, just to make sure I parsed that correctly:
&gt; 
&gt; When I do a `dnf repoquery --requires-pre`, that actually returns both
&gt; &quot;Requires(pre):&quot; and &quot;Requires(post):&quot; together, and `dnf repoquery
&gt; --requires` returns all of &quot;Requires:&quot;, &quot;Requires(preun):&quot; and
&gt; &quot;Requires(postun):&quot;?

Correctly parsed, that&apos;s what I meant. 

&gt; If that&apos;s the case, then I can work with that. Thanks!

...but whether that fully matches with current reality is another question. Looking at sssd-client on F24:

[root@sopuli ~]# rpm -qv --requires sssd-client|grep /
post,interp: /bin/sh
preun,interp: /bin/sh
post: /sbin/ldconfig
postun: /sbin/ldconfig
postun,interp: /sbin/ldconfig
post: /usr/sbin/alternatives
preun: /usr/sbin/alternatives
[root@sopuli ~]#

This is what repodata says about it:
    &lt;rpm:requires&gt;
      &lt;rpm:entry name=&quot;/bin/sh&quot;/&gt;
      &lt;rpm:entry name=&quot;/bin/sh&quot; pre=&quot;1&quot;/&gt;
      &lt;rpm:entry name=&quot;/sbin/ldconfig&quot;/&gt;
      &lt;rpm:entry name=&quot;/sbin/ldconfig&quot; pre=&quot;1&quot;/&gt;
      &lt;rpm:entry name=&quot;/usr/sbin/alternatives&quot;/&gt;
      &lt;rpm:entry name=&quot;/usr/sbin/alternatives&quot; pre=&quot;1&quot;/&gt;
       ...
    &lt;/rpm:requires&gt;

Which does match what I said, half of them are pre-requires and the other half (which would be those preun and postun deps) are not. However dnf-1.1.10-1.fc24.noarch doesn&apos;t see *any* of them:

[root@sopuli ~]# dnf repoquery --requires sssd-client|grep /
[root@sopuli ~]#</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9770994</commentid>
    <comment_count>4</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2016-10-06 08:27:42 -0400</bug_when>
    <thetext>(In reply to Panu Matilainen from comment #3)
&gt; (In reply to Stephen Gallagher from comment #2) 
&gt; &gt; OK, just to make sure I parsed that correctly:
&gt; &gt; 
&gt; &gt; When I do a `dnf repoquery --requires-pre`, that actually returns both
&gt; &gt; &quot;Requires(pre):&quot; and &quot;Requires(post):&quot; together, and `dnf repoquery
&gt; &gt; --requires` returns all of &quot;Requires:&quot;, &quot;Requires(preun):&quot; and
&gt; &gt; &quot;Requires(postun):&quot;?
&gt; 
&gt; Correctly parsed, that&apos;s what I meant. 
&gt; 
&gt; &gt; If that&apos;s the case, then I can work with that. Thanks!
&gt; 
&gt; ...but whether that fully matches with current reality is another question.
&gt; Looking at sssd-client on F24:
&gt; 
&gt; [root@sopuli ~]# rpm -qv --requires sssd-client|grep /
&gt; post,interp: /bin/sh
&gt; preun,interp: /bin/sh
&gt; post: /sbin/ldconfig
&gt; postun: /sbin/ldconfig
&gt; postun,interp: /sbin/ldconfig
&gt; post: /usr/sbin/alternatives
&gt; preun: /usr/sbin/alternatives
&gt; [root@sopuli ~]#
&gt; 
&gt; This is what repodata says about it:
&gt;     &lt;rpm:requires&gt;
&gt;       &lt;rpm:entry name=&quot;/bin/sh&quot;/&gt;
&gt;       &lt;rpm:entry name=&quot;/bin/sh&quot; pre=&quot;1&quot;/&gt;
&gt;       &lt;rpm:entry name=&quot;/sbin/ldconfig&quot;/&gt;
&gt;       &lt;rpm:entry name=&quot;/sbin/ldconfig&quot; pre=&quot;1&quot;/&gt;
&gt;       &lt;rpm:entry name=&quot;/usr/sbin/alternatives&quot;/&gt;
&gt;       &lt;rpm:entry name=&quot;/usr/sbin/alternatives&quot; pre=&quot;1&quot;/&gt;
&gt;        ...
&gt;     &lt;/rpm:requires&gt;
&gt; 
&gt; Which does match what I said, half of them are pre-requires and the other
&gt; half (which would be those preun and postun deps) are not. However
&gt; dnf-1.1.10-1.fc24.noarch doesn&apos;t see *any* of them:
&gt; 
&gt; [root@sopuli ~]# dnf repoquery --requires sssd-client|grep /
&gt; [root@sopuli ~]#

Right, DNF 1.1.10 doesn&apos;t have the support for requires(pre); that&apos;s been added in DNF 2.0:

https://github.com/rpm-software-management/dnf-plugins-core/commit/032c9e971f61ad4e09af98584b39dbbd8122181d

In DNF 2.0, it also requires `dnf repoquery --requires-pre`, not just `--requires`. That&apos;s a different behavior from yum, but I haven&apos;t got an opinion on whether that&apos;s an issue for others; for me, I don&apos;t care if I have to add an extra flag.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9771007</commentid>
    <comment_count>5</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2016-10-06 08:34:44 -0400</bug_when>
    <thetext>Yes, those pre=&quot;1&quot; deps missing is expected. But it *should* see the ones without it, so there&apos;s a bug somewhere. Based on the repodata, both these: 

# dnf repoquery --requires sssd-client|grep /
and
# dnf repoquery --requires-pre sssd-client|grep /

...should return:
/bin/sh
/sbin/ldconfig
/usr/sbin/alternatives

If that&apos;s the case in dnf 2.0 then good, dnf 1.1.10 is buggy wrt --requires at least.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9771075</commentid>
    <comment_count>6</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2016-10-06 09:08:49 -0400</bug_when>
    <thetext>On Rawhide just now:


# dnf repoquery --requires sssd-client
Last metadata expiration check: 0:21:35 ago on Thu Oct 06 08:43:41 2016 EDT.
libc.so.6(GLIBC_2.14)(64bit)
libc.so.6(GLIBC_2.8)
libcom_err.so.2
libcom_err.so.2()(64bit)
libk5crypto.so.3
libk5crypto.so.3()(64bit)
libkrb5.so.3
libkrb5.so.3()(64bit)
libkrb5.so.3(krb5_3_MIT)
libkrb5.so.3(krb5_3_MIT)(64bit)
libpam.so.0
libpam.so.0()(64bit)
libpam.so.0(LIBPAM_1.0)
libpam.so.0(LIBPAM_1.0)(64bit)
libpam.so.0(LIBPAM_EXTENSION_1.0)
libpam.so.0(LIBPAM_EXTENSION_1.0)(64bit)
libpam.so.0(LIBPAM_MODUTIL_1.0)
libpam.so.0(LIBPAM_MODUTIL_1.0)(64bit)
libpthread.so.0
libpthread.so.0()(64bit)
libpthread.so.0(GLIBC_2.0)
libpthread.so.0(GLIBC_2.12)
libpthread.so.0(GLIBC_2.12)(64bit)
libpthread.so.0(GLIBC_2.2)
libpthread.so.0(GLIBC_2.2.5)(64bit)
libsss_idmap.so.0
libsss_idmap.so.0()(64bit)
libsss_idmap.so.0(SSS_IDMAP_0.4)
libsss_idmap.so.0(SSS_IDMAP_0.4)(64bit)
libsss_nss_idmap.so.0
libsss_nss_idmap.so.0()(64bit)
libsss_nss_idmap.so.0(SSS_NSS_IDMAP_0.0.1)
libsss_nss_idmap.so.0(SSS_NSS_IDMAP_0.0.1)(64bit)
rtld(GNU_HASH)


# dnf repoquery --requires-pre sssd-client
Last metadata expiration check: 0:21:40 ago on Thu Oct 06 08:43:41 2016 EDT.
/bin/sh
/sbin/ldconfig
/usr/sbin/alternatives




So it looks like you&apos;re right; the preun and postun stuff isn&apos;t showing up in the regular --requires, which is probably a bug. Shall we retitle this BZ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9771172</commentid>
    <comment_count>7</comment_count>
    <who name="Panu Matilainen">pmatilai</who>
    <bug_when>2016-10-06 09:46:13 -0400</bug_when>
    <thetext>(In reply to Stephen Gallagher from comment #6)
&gt; So it looks like you&apos;re right; the preun and postun stuff isn&apos;t showing up
&gt; in the regular --requires, which is probably a bug. Shall we retitle this BZ?

Might as well do, at least there&apos;s plenty of information here already :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9796645</commentid>
    <comment_count>8</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-10-17 07:23:35 -0400</bug_when>
    <thetext>There are 2 kind of bugs.

1) (most probably in librepo) that it filters out post/postun/etc. from --requires
2) it&apos;s not completely compatible with yum-repoquery, so I think we will merge output back to --requires</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10274772</commentid>
    <comment_count>9</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2017-03-24 09:15:43 -0400</bug_when>
    <thetext>Here is the patch that should help https://github.com/rpm-software-management/libdnf/pull/279</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10379502</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-02 11:39:56 -0400</bug_when>
    <thetext>dnf-plugins-core-2.0.0-1.fc26 libdnf-0.8.2-1.fc26 dnf-2.4.0-1.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10385154</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-04 05:48:15 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26 dnf-plugins-core-2.0.0-1.fc26 dnf-plugins-extras-2.0.0-1.fc26 libdnf-0.8.2-1.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10387496</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-04 18:04:38 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26, dnf-plugins-core-2.0.0-1.fc26, dnf-plugins-extras-2.0.0-1.fc26, libdnf-0.8.2-1.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-4e95959f0d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10389245</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-05-05 09:34:13 -0400</bug_when>
    <thetext>dnf-2.4.0-1.fc26, dnf-plugins-core-2.0.0-1.fc26, dnf-plugins-extras-2.0.0-1.fc26, libdnf-0.8.2-1.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>