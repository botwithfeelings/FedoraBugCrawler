<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1401260</bug_id>
          
          <creation_ts>2016-12-03 23:03:00 -0500</creation_ts>
          <short_desc>SELinux is preventing chmod from &apos;setattr&apos; accesses on the directory _data.</short_desc>
          <delta_ts>2016-12-16 16:01:40 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>docker</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard>abrt_hash:3db5e4aaf7b7d98fc397b06db793842199d2079d70f22308d7c55bc1bb7d4fa6;VARIANT_ID=workstation;</status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Anass Ahmed">anass.1430</reporter>
          <assigned_to name="Antonio Murdaca">amurdaca</assigned_to>
          <cc>adimania</cc>
    
    
    <cc>admiller</cc>
    
    
    <cc>amurdaca</cc>
    
    
    <cc>anass.1430</cc>
    
    
    <cc>dominick.grift</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>ichavero</cc>
    
    
    <cc>jcajka</cc>
    
    
    <cc>jchaloup</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>lvrabec</cc>
    
    
    <cc>marianne</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>miminar</cc>
    
    
    <cc>nalin</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>pmoore</cc>
    
    
    <cc>riek</cc>
    
    
    <cc>ssekidde</cc>
    
    
    <cc>vbatts</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>docker-1.12.4-2.git1b5971a.fc25 docker-1.12.4-7.gita7cae3f.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-16 16:01:40</cf_last_closed>
          <cf_type>---</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9953972</commentid>
    <comment_count>0</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-03 23:03:09 -0500</bug_when>
    <thetext>Description of problem:
Running the official PostgreSQL docker container with a named volume to perserve data (running the same command without the named volume works):

$ docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres
Unable to find image &apos;postgres:latest&apos; locally
Trying to pull repository docker.io/library/postgres ... 
sha256:3aa888ee9bf0f0e408e23d05bfe1243cd61d3c39a44eb439ba228a4b35e6add6: Pulling from docker.io/library/postgres
386a066cd84a: Pull complete 
...
01f12ce02828: Pull complete 
Digest: sha256:3aa888ee9bf0f0e408e23d05bfe1243cd61d3c39a44eb439ba228a4b35e6add6
Status: Downloaded newer image for docker.io/postgres:latest
chmod: changing permissions of ‘/var/lib/postgresql/data’: Permission denied

Related Issue:
https://github.com/docker/docker/issues/28568

Software Versions:
container-selinux-1.12.3-10.git7b5044b.fc25.x86_64
devassistant-dap-docker-0.11-3.fc24.noarch
docker-1.12.3-10.git7b5044b.fc25.x86_64
docker-common-1.12.3-10.git7b5044b.fc25.x86_64
docker-compose-1.8.1-1.fc25.noarch
docker-forward-journald-1.9.1-9.gitee06d03.fc23.x86_64
docker-v1.10-migrator-1.12.3-10.git7b5044b.fc25.x86_64
docker-vim-1.12.3-10.git7b5044b.fc25.x86_64
docker-zsh-completion-1.12.3-10.git7b5044b.fc25.x86_64
libselinux-2.5-13.fc25.i686
libselinux-2.5-13.fc25.x86_64
libselinux-devel-2.5-13.fc25.x86_64
libselinux-python-2.5-13.fc25.x86_64
libselinux-python3-2.5-13.fc25.x86_64
libselinux-utils-2.5-13.fc25.x86_64
pipelight-selinux-0.2.8.2-4.fc25.noarch
python2-docker-pycreds-0.2.1-2.fc25.noarch
python3-docker-py-1.10.3-1.fc25.noarch
python3-docker-pycreds-0.2.1-2.fc25.noarch
python-dockerfile-parse-0.0.5-5.fc25.noarch
python-dockerpty-0.4.1-3.fc25.noarch
python-docker-py-1.10.3-1.fc25.noarch
rpm-plugin-selinux-4.13.0-5.fc25.x86_64
selinux-policy-3.13.1-224.fc25.noarch
selinux-policy-targeted-3.13.1-224.fc25.noarch
SELinux is preventing chmod from &apos;setattr&apos; accesses on the directory _data.

*****  Plugin catchall (100. confidence) suggests   **************************

If you believe that chmod should be allowed setattr access on the _data directory by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c &apos;chmod&apos; --raw | audit2allow -M my-chmod
# semodule -X 300 -i my-chmod.pp

Additional Information:
Source Context                system_u:system_r:container_t:s0:c142,c635
Target Context                system_u:object_r:container_var_lib_t:s0
Target Objects                _data [ dir ]
Source                        chmod
Source Path                   chmod
Port                          &lt;Unknown&gt;
Host                          (removed)
Source RPM Packages           
Target RPM Packages           
Policy RPM                    &lt;Unknown&gt;
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     (removed)
Platform                      Linux (removed) 4.8.10-300.fc25.x86_64 #1 SMP Mon
                              Nov 21 18:59:16 UTC 2016 x86_64 x86_64
Alert Count                   1
First Seen                    2016-12-04 05:54:03 EET
Last Seen                     2016-12-04 05:54:03 EET
Local ID                      ebc1c4e0-daaa-4141-8a76-f96d1eccf116

Raw Audit Messages
type=AVC msg=audit(1480823643.819:2284): avc:  denied  { setattr } for  pid=15829 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234814 scontext=system_u:system_r:container_t:s0:c142,c635 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0


Hash: chmod,container_t,container_var_lib_t,dir,setattr


Additional info:
reporter:       libreport-2.8.0
hashmarkername: setroubleshoot
kernel:         4.8.10-300.fc25.x86_64
type:           libreport</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954219</commentid>
    <comment_count>1</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-04 06:35:25 -0500</bug_when>
    <thetext>Antonio do we have https://github.com/projectatomic/docker/pull/198/commits/ba713bad6c70d02adf450faacf2830d757d2f75f in this package?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954220</commentid>
    <comment_count>2</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-04 06:40:04 -0500</bug_when>
    <thetext>Dan, we don&apos;t afaict from https://github.com/projectatomic/docker/blob/docker-1.12.3/container/container_unix.go

Has that patch ever been proposed upstream? Should we? Should we keep carrying it?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954225</commentid>
    <comment_count>3</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-04 06:45:59 -0500</bug_when>
    <thetext>Yes this patch has been merged upstream in docker-1.13 I believe.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954226</commentid>
    <comment_count>4</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-04 06:48:03 -0500</bug_when>
    <thetext>https://github.com/docker/docker/issues/28936</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954227</commentid>
    <comment_count>5</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-04 06:50:05 -0500</bug_when>
    <thetext>Ack, I&apos;ll backport it and rebuild Docker in Fedora. Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954305</commentid>
    <comment_count>6</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-04 07:53:19 -0500</bug_when>
    <thetext>I think it has been backported already in upstream docker (1.12.4) 2 days ago:

https://github.com/docker/docker/pull/29050</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954306</commentid>
    <comment_count>7</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-04 07:55:04 -0500</bug_when>
    <thetext>Yup, it has, though 1.12.4 isn&apos;t released yet upstream. The 1.12.4 branch there is still missing some backports. I think we can still backport this to 1.12.3 and then update to 1.12.4 as soon as it&apos;s GA upstream.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954308</commentid>
    <comment_count>8</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-04 07:58:18 -0500</bug_when>
    <thetext>(In reply to Antonio Murdaca from comment #7)
&gt; Yup, it has, though 1.12.4 isn&apos;t released yet upstream. The 1.12.4 branch
&gt; there is still missing some backports. I think we can still backport this to
&gt; 1.12.3 and then update to 1.12.4 as soon as it&apos;s GA upstream.

Great, Looking forward to testing the new update as soon as it hits the updates-testing repository.

Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9954329</commentid>
    <comment_count>9</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-04 08:45:27 -0500</bug_when>
    <thetext>Great, I&apos;ll build and push an updated just after https://bodhi.fedoraproject.org/updates/FEDORA-2016-33e5756dfc lands into stable (in order not to delay that update anymore...)

BTW, I backported the fix to our docker-1.12.3 branch. Moving this to modified.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9972049</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-09 10:17:07 -0500</bug_when>
    <thetext>docker-1.12.3-13.git0423d89.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-de032c73d6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9973341</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-09 22:59:11 -0500</bug_when>
    <thetext>docker-1.12.3-13.git0423d89.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-de032c73d6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9973797</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-10 12:34:11 -0500</bug_when>
    <thetext>docker-1.12.3-15.git0423d89.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-37c2c59240</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9973831</commentid>
    <comment_count>13</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-10 13:20:12 -0500</bug_when>
    <thetext>I don&apos;t know, I think the problem still persists after update.

I thought at first that it worked but it was me that I&apos;ve set SELinux to permissive. The directory of the volume still gets the same context as before.

$ sudo ls -lZ /var/lib/docker/volumes/
total 236
drwxr-xr-x. 3 root root system_u:object_r:container_var_lib_t:s0   4096 Dec 10 20:16 dbstore
-rw-------. 1 root root system_u:object_r:container_var_lib_t:s0 262144 Dec 10 20:16 metadata.db

$ rpm -qa | grep docker
python3-docker-py-1.10.6-1.fc25.noarch
docker-v1.10-migrator-1.12.3-13.git0423d89.fc25.x86_64
python-dockerpty-0.4.1-3.fc25.noarch
python2-docker-pycreds-0.2.1-2.fc25.noarch
docker-1.12.3-13.git0423d89.fc25.x86_64
python3-docker-pycreds-0.2.1-2.fc25.noarch
docker-forward-journald-1.9.1-9.gitee06d03.fc23.x86_64
docker-vim-1.12.3-13.git0423d89.fc25.x86_64
python-docker-py-1.10.6-1.fc25.noarch
docker-common-1.12.3-13.git0423d89.fc25.x86_64
docker-zsh-completion-1.12.3-13.git0423d89.fc25.x86_64
python-dockerfile-parse-0.0.5-5.fc25.noarch
docker-compose-1.8.1-1.fc25.noarch
devassistant-dap-docker-0.11-3.fc24.noarch

What do you think?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9973852</commentid>
    <comment_count>14</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-10 13:39:45 -0500</bug_when>
    <thetext>Anass could you try with docker-1.12.3-15.git0423d89.fc25 (which is updating the selinux policy as well)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9973976</commentid>
    <comment_count>15</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-10 17:34:39 -0500</bug_when>
    <thetext>Oh, I didn&apos;t notice the 13 to 15 thing. I thought it was the git commit that really matters :)

I&apos;m trying to find a way to install it now as it&apos;s clearly not yet available in the testing repository.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9974008</commentid>
    <comment_count>16</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-10 18:27:40 -0500</bug_when>
    <thetext>Downloaded the latest build from Koji and upgraded the packages:
$ koji download-build docker-1.12.3-15.git0423d89.fc25 --arch=x86_64
$ sudo dnf upgrade *.rpm
$ rpm -qa | grep -E &apos;^(docker|container)&apos;
docker-forward-journald-1.9.1-9.gitee06d03.fc23.x86_64
docker-1.12.3-15.git0423d89.fc25.x86_64
docker-zsh-completion-1.12.3-15.git0423d89.fc25.x86_64
container-selinux-1.12.3-15.git0423d89.fc25.x86_64
docker-common-1.12.3-15.git0423d89.fc25.x86_64
docker-compose-1.8.1-1.fc25.noarch
docker-vim-1.12.3-15.git0423d89.fc25.x86_64
docker-v1.10-migrator-1.12.3-15.git0423d89.fc25.x86_64

Still have the same issue:
$ docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres
chmod: changing permissions of ‘/var/lib/postgresql/data’: Permission denied

$ ausearch -c &apos;chmod&apos; --raw
type=AVC msg=audit(1481411519.689:1730): avc:  denied  { setattr } for  pid=23813 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234711 scontext=system_u:system_r:container_t:s0:c102,c533 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0

# ls -lZ /var/lib/docker/volumes/
total 236
drwxr-xr-x. 3 root root system_u:object_r:container_var_lib_t:s0   4096 Dec 11 01:11 dbstore

---

Do I need to do anything after the update (I already restarted the docker after upgrade just in case, though I know it already happens in the %post stage if the service is up and running)?!!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9974234</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-10 22:30:12 -0500</bug_when>
    <thetext>docker-1.12.3-15.git0423d89.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-37c2c59240</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9974668</commentid>
    <comment_count>18</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-11 07:35:50 -0500</bug_when>
    <thetext>Attempt to create a new container with  a new volume, the fixing of the label is only going to happen on initial container creation, I believe.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9974725</commentid>
    <comment_count>19</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-11 09:17:09 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #18)
&gt; Attempt to create a new container with  a new volume, the fixing of the
&gt; label is only going to happen on initial container creation, I believe.

Every time I execute the command, I make sure that the container had been deleted and the named volume too (and all the dangling volumes).

I guess I don&apos;t follow.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9981218</commentid>
    <comment_count>20</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 10:03:38 -0500</bug_when>
    <thetext>docker-1.12.4-2.git1b5971a.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-bb5ee53c0a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9982439</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 16:47:11 -0500</bug_when>
    <thetext>docker-1.12.4-5.git1b5971a.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-2a18b9e056</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9983037</commentid>
    <comment_count>22</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-13 21:25:00 -0500</bug_when>
    <thetext>docker-1.12.4-2.git1b5971a.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-bb5ee53c0a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9986064</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-14 10:33:02 -0500</bug_when>
    <thetext>docker-1.12.4-6.git1b5971a.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-44ed3dd527</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987210</commentid>
    <comment_count>24</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-14 13:40:14 -0500</bug_when>
    <thetext>I&apos;ve just upgraded to:

container-selinux-1.12.4-6.git1b5971a.fc25.x86_64
docker-forward-journald-1.9.1-9.gitee06d03.fc23.x86_64
docker-vim-1.12.4-6.git1b5971a.fc25.x86_64
docker-common-1.12.4-6.git1b5971a.fc25.x86_64
docker-1.12.4-6.git1b5971a.fc25.x86_64
docker-v1.10-migrator-1.12.4-6.git1b5971a.fc25.x86_64
docker-compose-1.8.1-1.fc25.noarch
docker-zsh-completion-1.12.4-6.git1b5971a.fc25.x86_64

using `koji download-build` then `dnf update *.rpms`.

same issue still standing:

$ docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres
chmod: changing permissions of ‘/var/lib/postgresql/data’: Permission denied

$ sudo ausearch -c &apos;chmod&apos; --raw
type=AVC msg=audit(1478201991.682:3567): avc:  denied  { setattr } for  pid=12471 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1341114 scontext=system_u:system_r:container_t:s0:c58,c892 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1478202023.965:3587): avc:  denied  { setattr } for  pid=15251 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1341114 scontext=system_u:system_r:container_t:s0:c58,c892 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1478202040.078:3603): avc:  denied  { setattr } for  pid=16695 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1341114 scontext=system_u:system_r:container_t:s0:c58,c892 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1481393198.087:1261): avc:  denied  { setattr } for  pid=30179 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234814 scontext=system_u:system_r:container_t:s0:c423,c554 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=1
type=AVC msg=audit(1481393362.782:1327): avc:  denied  { setattr } for  pid=9805 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234711 scontext=system_u:system_r:container_t:s0:c358,c997 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=1
type=AVC msg=audit(1481393771.328:1450): avc:  denied  { setattr } for  pid=31288 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234711 scontext=system_u:system_r:container_t:s0:c118,c774 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1481411461.731:1682): avc:  denied  { setattr } for  pid=18884 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234711 scontext=system_u:system_r:container_t:s0:c106,c126 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1481411519.689:1730): avc:  denied  { setattr } for  pid=23813 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234711 scontext=system_u:system_r:container_t:s0:c102,c533 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=0
type=AVC msg=audit(1481465703.692:2072): avc:  denied  { setattr } for  pid=26075 comm=&quot;chmod&quot; name=&quot;_data&quot; dev=&quot;sda2&quot; ino=1234928 scontext=system_u:system_r:container_t:s0:c149,c958 tcontext=system_u:object_r:container_var_lib_t:s0 tclass=dir permissive=1

$ sudo ls -ldZ /var/lib/docker/volumes/dbstore
drwxr-xr-x. 3 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 14 20:33 /var/lib/docker/volumes/dbstore

$ sudo ls -lZ /var/lib/docker/volumes/dbstore
total 4
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 14 20:33 _data


I started to doubt that I&apos;m doing something wrong!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987228</commentid>
    <comment_count>25</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-14 13:46:44 -0500</bug_when>
    <thetext>Can you destroy the dbstore volume and start from scratch?  The problem is the dbstore was already created with the prior container, so it does not get created, I believe.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987234</commentid>
    <comment_count>26</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-14 13:49:50 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #25)
&gt; Can you destroy the dbstore volume and start from scratch?  The problem is
&gt; the dbstore was already created with the prior container, so it does not get
&gt; created, I believe.

I did forget to mention that I did after upgrade:

$ sudo systemctl restart docker
$ docker stop db # though, it wasn&apos;t running because of the issue
$ docker rm -f db
$ docker volume rm dbstore

then I executed the previous commands in comment 24.

but I think my next move will be removing the whole /var/lib/docker directory and start over again from scratch.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987245</commentid>
    <comment_count>27</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-14 13:57:39 -0500</bug_when>
    <thetext>No that should not be necessary.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987272</commentid>
    <comment_count>28</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-14 14:06:42 -0500</bug_when>
    <thetext> I have reproduced, I will look into it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987405</commentid>
    <comment_count>29</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-14 14:59:40 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #28)
&gt;  I have reproduced, I will look into it.

Good.

Just to let you know, I removed the /var/lib/docker directory completely and still had the same issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987441</commentid>
    <comment_count>30</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-14 15:18:10 -0500</bug_when>
    <thetext>Right the patch that I thought fixed this issue only effects bind mounted volumes not volumes created on the host file system.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987636</commentid>
    <comment_count>31</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-14 16:30:36 -0500</bug_when>
    <thetext>docker-1.12.4-2.git1b5971a.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987714</commentid>
    <comment_count>32</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-14 17:06:07 -0500</bug_when>
    <thetext>I believe it&apos;s still open. It hasn&apos;t been solved yet.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987716</commentid>
    <comment_count>33</comment_count>
    <who name="Dusty Mabe">dustymabe</who>
    <bug_when>2016-12-14 17:07:04 -0500</bug_when>
    <thetext>1.12.4-2 does not fix this bug</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987812</commentid>
    <comment_count>34</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-14 17:28:21 -0500</bug_when>
    <thetext>Yeah sorry for this, some bodhi weirdness going on.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987822</commentid>
    <comment_count>35</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-14 17:32:31 -0500</bug_when>
    <thetext>https://github.com/projectatomic/docker/pull/216
Is in projectatomic to fix this issue.

Upstream

https://github.com/docker/docker/pull/29428</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9987896</commentid>
    <comment_count>36</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-14 18:09:45 -0500</bug_when>
    <thetext>I&apos;ll rebuild and update Docker in Fedora with that fix so ppl can test it out.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9988418</commentid>
    <comment_count>37</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-15 00:08:39 -0500</bug_when>
    <thetext>docker-1.12.4-6.git1b5971a.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-44ed3dd527</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990115</commentid>
    <comment_count>38</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-15 09:48:41 -0500</bug_when>
    <thetext>(In reply to Anass Ahmed from comment #29)
&gt; (In reply to Daniel Walsh from comment #28)
&gt; &gt;  I have reproduced, I will look into it.
&gt; 
&gt; Good.
&gt; 
&gt; Just to let you know, I removed the /var/lib/docker directory completely and
&gt; still had the same issue.

docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres

I cannot reproduce the error you&apos;re having though. How did you create &quot;dbstore&quot;? docker volume create --name dbstore? or any other command?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990139</commentid>
    <comment_count>39</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 09:53:02 -0500</bug_when>
    <thetext>
docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres

Auto creates the dbstore in /var/lib/docker/volumes/dbstore

No need for the volumes command

My test does

# docker volume rm dbstore; docker run -ti -v dbstore /var/data fedora ls -lZd /var/data
# docker volume rm dbstore; docker run -ti -v dbstore /var/data:z fedora ls -lZd /var/data
# docker volume rm dbstore; docker run -ti -v dbstore /var/data:Z fedora ls -lZd /var/data

First two should look like container_file_t:s0, last one should look like 
container_file_t:s0:c1,c2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990211</commentid>
    <comment_count>40</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-15 10:04:50 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #39)
&gt; docker run -v dbstore:/var/lib/postgresql/data -e POSTGRES_USER=odoo -e
&gt; POSTGRES_PASSWORD=odoo --name db postgres
&gt; 
&gt; Auto creates the dbstore in /var/lib/docker/volumes/dbstore
&gt; 
&gt; No need for the volumes command
&gt; 
&gt; My test does
&gt; 
&gt; # docker volume rm dbstore; docker run -ti -v dbstore /var/data fedora ls
&gt; -lZd /var/data
&gt; # docker volume rm dbstore; docker run -ti -v dbstore /var/data:z fedora ls
&gt; -lZd /var/data
&gt; # docker volume rm dbstore; docker run -ti -v dbstore /var/data:Z fedora ls
&gt; -lZd /var/data
&gt; 
&gt; First two should look like container_file_t:s0, last one should look like 
&gt; container_file_t:s0:c1,c2

testing with docker-1.12.4-2.git1b5971a.fc25.x86_64 which landed just today in stable:

$ docker run -ti -v dbstore:/var/data fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:02 /var/data
$ docker run -ti -v dbstore:/var/data:z fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:02 /var/data
$ docker run -ti -v dbstore:/var/data:Z fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:03 /var/data

I cannot reproduce this failure. I&apos;m testing with overlayfs, should I use devicemapper?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990231</commentid>
    <comment_count>41</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 10:11:44 -0500</bug_when>
    <thetext>Those are all failures.  If your process tried to write to /var/data you will get permission denied.

The correct labels should look like

system_u:object_r:container_file_t:s0

And

system_u:object_r:container_file_t:s0:c1,c2

container_var_lib_t is the default label for content in /var/lib/docker.   We want to block confined containers from this type.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990265</commentid>
    <comment_count>42</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-15 10:20:22 -0500</bug_when>
    <thetext>(In reply to Antonio Murdaca from comment #40)
&gt; 
&gt; $ docker run -ti -v dbstore:/var/data fedora ls -lZd /var/data
&gt; drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15
&gt; 15:02 /var/data
&gt; $ docker run -ti -v dbstore:/var/data:z fedora ls -lZd /var/data
&gt; drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15
&gt; 15:02 /var/data
&gt; $ docker run -ti -v dbstore:/var/data:Z fedora ls -lZd /var/data
&gt; drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15
&gt; 15:03 /var/data
&gt; 
&gt; I cannot reproduce this failure. I&apos;m testing with overlayfs, should I use
&gt; devicemapper?

You also need to `docker volume rm dbstore` with every create, because the first time the volume is created will take a specific context (as stated above).

Another test would be:
# docker volume rm dbstore; docker run -ti -v dbstore /var/data fedora ls -lZd /var/data &amp;&amp; touch /var/data/test
# docker volume rm dbstore; docker run -ti -v dbstore /var/data:z fedora ls -lZd /var/data &amp;&amp; touch /var/data/test
# docker volume rm dbstore; docker run -ti -v dbstore /var/data:Z fedora ls -lZd /var/data &amp;&amp; touch /var/data/test

to see the issue in action.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990276</commentid>
    <comment_count>43</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 10:22:29 -0500</bug_when>
    <thetext>Use --rm on each container, otherwise the 
docker volume rm dbstore 
will fail.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990279</commentid>
    <comment_count>44</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-15 10:23:57 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #41)
&gt; Those are all failures.  If your process tried to write to /var/data you
&gt; will get permission denied.

alright, the problem is that even with the wrong labels and selinux enforcing, my container _can_ write there (I cannot reproduce the original op issue indeed). May be related to something else though...

&gt; 
&gt; The correct labels should look like
&gt; 
&gt; system_u:object_r:container_file_t:s0
&gt; 
&gt; And
&gt; 
&gt; system_u:object_r:container_file_t:s0:c1,c2
&gt; 
&gt; container_var_lib_t is the default label for content in /var/lib/docker.  
&gt; We want to block confined containers from this type.

alright, btw, I&apos;m still getting the same labels even with your patch on projectatomic/docker:

$ docker run -ti -v dbstore:/var/data fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:19 /var/data
$ docker run -ti -v dbstore:/var/data:z fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:19 /var/data
$ docker run -ti -v dbstore:/var/data:Z fedora ls -lZd /var/data
drwxr-xr-x. 2 root root system_u:object_r:container_var_lib_t:s0 4096 Dec 15 15:19 /var/data</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990288</commentid>
    <comment_count>45</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-15 10:26:12 -0500</bug_when>
    <thetext>alright, I cannot reproduce either, I&apos;m going to build docker for F25 and do an update for you guys to test.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990298</commentid>
    <comment_count>46</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 10:28:42 -0500</bug_when>
    <thetext>Antonio run this command.

 docker run -ti -v dbstore:/var/data:Z fedora cat /proc/self/attr/current
To see if your container is actually running as spc_t, or container_t?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990352</commentid>
    <comment_count>47</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-15 10:37:27 -0500</bug_when>
    <thetext>testing with docker 1.12.4-6:

$ docker volume ls
DRIVER              VOLUME NAME
local               dbstore
$ docker rm db
db
$ docker volume rm dbstore
dbstore
$ docker run -v dbstore:/var/lib/postgresql/data:Z -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo --name db postgres
chmod: changing permissions of ‘/var/lib/postgresql/data’: Permission denied
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES
7fe45f23ddd8        postgres            &quot;/docker-entrypoint.s&quot;   30 seconds ago      Exited (1) 28 seconds ago                       db
$ docker volume ls
DRIVER              VOLUME NAME
local               dbstore

This time, I added :Z to the volume mount. The driver for the volumes is local.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990442</commentid>
    <comment_count>48</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 10:54:23 -0500</bug_when>
    <thetext>Right if the label is not changing, then this version of docker either does not have my patch or my patch is broken.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990466</commentid>
    <comment_count>49</comment_count>
    <who name="Antonio Murdaca">amurdaca</who>
    <bug_when>2016-12-15 10:55:37 -0500</bug_when>
    <thetext>Alright, I can reproduce it now, I was missing `--selinux-enabled` in docker. Now I can see the bug and Dan&apos;s patch fixes it.

Thanks guys. Going to rebuild soon(ish).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9990708</commentid>
    <comment_count>50</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-15 11:52:42 -0500</bug_when>
    <thetext>docker-1.12.4-7.gita7cae3f.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-0f1fa11634</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9991307</commentid>
    <comment_count>51</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-15 15:52:23 -0500</bug_when>
    <thetext>docker-1.12.4-7.gita7cae3f.fc25 fixed it for me. It works with and without :Z option at the end of the volume.

with :Z, only the current (or the recent) container can access the named volume. without :Z or with :z it becomes shared volume (can be accessed from multiple containers).

Thanks for your effort.
Waiting for the new package to hit stable to update my servers.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9991331</commentid>
    <comment_count>52</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2016-12-15 16:03:50 -0500</bug_when>
    <thetext>Please update karma.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9991338</commentid>
    <comment_count>53</comment_count>
    <who name="Anass Ahmed">anass.1430</who>
    <bug_when>2016-12-15 16:07:20 -0500</bug_when>
    <thetext>(In reply to Daniel Walsh from comment #52)
&gt; Please update karma.

I did soon after I tested it, but posted my comment on the wrong bug (bug 1405131) then re-posted it here.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9992302</commentid>
    <comment_count>54</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-16 00:33:48 -0500</bug_when>
    <thetext>docker-1.12.4-7.gita7cae3f.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-0f1fa11634</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9994828</commentid>
    <comment_count>55</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-12-16 16:01:40 -0500</bug_when>
    <thetext>docker-1.12.4-7.gita7cae3f.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>