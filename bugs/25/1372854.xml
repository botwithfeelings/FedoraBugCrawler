<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1372854</bug_id>
          
          <creation_ts>2016-09-02 18:43:00 -0400</creation_ts>
          <short_desc>Occasional failure to correctly bring up network via dhclient in anaconda</short_desc>
          <delta_ts>2016-09-09 17:46:31 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>NetworkManager</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>1373276</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Adam Williamson">awilliam</reporter>
          <assigned_to name="Thomas Haller">thaller</assigned_to>
          <cc>awilliam</cc>
    
    
    <cc>bgalvani</cc>
    
    
    <cc>dcbw</cc>
    
    
    <cc>fgiudici</cc>
    
    
    <cc>lkundrak</cc>
    
    
    <cc>psimerda</cc>
    
    
    <cc>thaller</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>NetworkManager-1.4.0-3.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-09-09 17:46:31</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9676369</commentid>
    <comment_count>0</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-02 18:43:40 -0400</bug_when>
    <thetext>The Fedora QA team uses an automated test system called openQA:

https://openqa.fedoraproject.org/

what openQA basically does is run virtual machines - using qemu user-mode networking - and then...test stuff in them. Most of the tests are installer tests.

Every so often, a test which uses a network repository will fail because the network was not correctly brought up. anaconda fails to configure the network repository, and when openQA tries to send some log files out from the VM (by uploading them to a web server it runs for this purpose), it cannot reach the network either.

I&apos;ve been debugging this by creating a special openQA test which simply boots the installer, tries to upload a log file (to see if the network is working), and dumps out a bunch of diagnostic info via the serial console if it hits the bug. I&apos;ve been running this test over and over, 8 runs at a time. It seems like we hit the failure approximately once in every 30 or 40 runs of the test.

From the diagnostic info we got out, it seems like what happens is that NetworkManager tries to configure the interface via DHCP, but decides the DHCP request failed after a 45 second timeout.

We tried a couple of variations on the test. First we modified the test so NetworkManager uses its internal DHCP client rather than dhclient (by using an anaconda updates.img which adds an NM config file to specify that setting). I tried ~100 runs with that configuration and did not get a single failure.

Second we modified the test to boot to dracut&apos;s emergency shell, rather than anaconda, and run &apos;dhclient ens4&apos; directly from the shell. Again I tried ~100 runs of that, and it successfully brought up the network every time.

So it seems like this only happens with NM+dhclient. Finally, we got a failed run with as much diagnostic info as we could:

https://openqa.stg.fedoraproject.org/tests/37112

all the info is in the serial console log:

https://openqa.stg.fedoraproject.org/tests/37112/file/serial0.txt

under IP ADDR is the output of &apos;ip addr&apos;. Under ROUTE is the output of &apos;route&apos;. From these you can see that the interface has no IPv4 address and there is no default route. Under JOURNAL is the output of &apos;journalctl --no-pager&apos;, and under SYSLOG is the contents of /tmp/syslog , where some messages which don&apos;t appear to reach the journal show up.

Crucially, in /tmp/syslog , we can see that there is actually what looks like a perfectly successful dhclient session:

22:17:15,711 INFO dhclient: Created duid &quot;\000\004\307\326\2422\011\036N\246\217N\251 \030\353\023\313&quot;.
22:17:15,711 INFO dhclient: DHCPDISCOVER on ens4 to 255.255.255.255 port 67 interval 3 (xid=0x6ad3f212)
22:17:15,712 INFO dhclient: DHCPREQUEST on ens4 to 255.255.255.255 port 67 (xid=0x6ad3f212)
22:17:15,712 INFO dhclient: DHCPOFFER from 10.0.2.2
22:17:15,712 INFO dhclient: DHCPACK from 10.0.2.2 (xid=0x6ad3f212)
22:17:15,721 INFO dhclient: bound to 10.0.2.15 -- renewal in 38317 seconds.

This is indeed right where NM ran dhclient - you can see that from the journal NM logs:

Sep 02 22:17:15 localhost NetworkManager[1600]: &lt;debug&gt; [1472854635.4244] dhcp4 (ens4): running: /sbin/dhclient -d -q -sf /usr/libexec/nm-dhcp-helper -pf /var/run/dhclient-ens4.pid -lf /var/lib/NetworkManager/dhclient-a84395a1-4721-30e0-9fbb-e422b26ac329-ens4.lease -cf /var/lib/NetworkManager/dhclient-ens4.conf ens4
Sep 02 22:17:15 localhost NetworkManager[1600]: &lt;info&gt;  [1472854635.4387] dhcp4 (ens4): dhclient started with pid 1681

however, it seems like NM never realizes that dhclient worked, and instead it gives up and kills the dhclient process 45 seconds later:

Sep 02 22:18:00 localhost NetworkManager[1600]: [0;1;39m&lt;warn&gt;  [1472854680.5422] dhcp4 (ens4): request timed out[0m
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;info&gt;  [1472854680.5428] dhcp4 (ens4): state changed unknown -&gt; timeout
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;debug&gt; [1472854680.5428] device[0x56481bc0f9e0] (ens4): new DHCPv4 client state 2
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;debug&gt; [1472854680.5428] device[0x56481bc0f9e0] (ens4): DHCPv4 failed: timeout 1, num tries left 3
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;debug&gt; [1472854680.5428] device[0x56481bc0f9e0] (ens4): remove_pending_action (0): &apos;dhcp4&apos;
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;info&gt;  [1472854680.5428] manager: startup complete
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;debug&gt; [1472854680.5444] kill child process &apos;dhcp-client-ens4&apos; (1681): waiting up to 500 milliseconds for process to terminate normally after sending SIGTERM (15)...
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;debug&gt; [1472854680.5528] kill child process &apos;dhcp-client-ens4&apos; (1681): after sending SIGTERM (15), process 1681 exited by signal 15 (8416 usec elapsed)
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;info&gt;  [1472854680.5533] dhcp4 (ens4): canceled DHCP transaction, DHCP client pid 1681
Sep 02 22:18:00 localhost NetworkManager[1600]: &lt;info&gt;  [1472854680.5533] dhcp4 (ens4): state changed timeout -&gt; done

so the problem is somewhere in NM&apos;s communication with its dhclient process, I guess. thaller is looking into this at present.

This bug seems to occur in both Fedora 25 and Fedora Rawhide tests. The failures have been occurring for some time now, certainly we have failures with the git20160621.072358da snapshot. I don&apos;t believe we&apos;ve actually hit this failure with the final 1.4.0 yet, but it&apos;s only been in Rawhide a few days and is not in F25 yet, so that may just be blind luck. I&apos;ll run my reproducer test on a recent Rawhide image and confirm whether I can trigger the bug there too.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676370</commentid>
    <comment_count>1</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-02 18:44:06 -0400</bug_when>
    <thetext>issue in our Fedora QA issue tracker - https://phab.qadevel.cloud.fedoraproject.org/T836</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676375</commentid>
    <comment_count>2</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-02 18:54:29 -0400</bug_when>
    <thetext>OK, yeah, can confirm I can trigger the failure with an image from today&apos;s Rawhide compose as well:

https://openqa.stg.fedoraproject.org/tests/37129
https://openqa.stg.fedoraproject.org/tests/37129/file/serial0.txt

looks like it happens just the same. That image would have NetworkManager 1.4.0-2.fc26 in it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676378</commentid>
    <comment_count>3</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-02 18:59:26 -0400</bug_when>
    <thetext>In the NM log:


&lt;debug&gt; [1472854635.6994] bus-manager: (dhcp) accepted connection 0x56481bb96650 on private socket
&lt;debug&gt; [1472854635.6999] dhcp4 (ens4): unmapped DHCP state &apos;PREINIT&apos;
&lt;debug&gt; [1472854635.7002] dhcp4 (ens4): DHCP reason &apos;PREINIT&apos; -&gt; state &apos;unknown&apos;
&lt;debug&gt; [1472854635.7004] bus-manager: (dhcp) closed connection 0x56481bb96650 on private socket
&lt;debug&gt; [1472854635.7194] bus-manager: (dhcp) accepted connection 0x56481bb96750 on private socket
&lt;debug&gt; [1472854635.7221] bus-manager: (dhcp) closed connection 0x56481bb96750 on private socket


it seems like dhclient connected to NetworkManager but nothing happens.




So, NMBusManager receives the new private connection and emits PRIVATE_CONNECTION_NEW signal (https://cgit.freedesktop.org/NetworkManager/NetworkManager/tree/src/nm-bus-manager.c?id=673282ece652a2b8d55892f3ee2b78e67b652b65#n204)

Then NMDhcpListener subscribes to the &quot;Event&quot; signal:
https://cgit.freedesktop.org/NetworkManager/NetworkManager/tree/src/dhcp-manager/nm-dhcp-listener.c?id=673282ece652a2b8d55892f3ee2b78e67b652b65#n148


I wonder what guarantees here that we don&apos;t miss the Event before subscribing to the signal? Especially, because nm-dhcp-helper just works right through:
https://cgit.freedesktop.org/NetworkManager/NetworkManager/tree/src/dhcp-manager/nm-dhcp-helper.c?id=673282ece652a2b8d55892f3ee2b78e67b652b65#n100</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676444</commentid>
    <comment_count>4</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-02 19:48:28 -0400</bug_when>
    <thetext>thaller asked me to try with a custom NM build which adds a sleep to try and work around what he thinks is the problem:

http://koji.fedoraproject.org/koji/taskinfo?taskID=15474635

I&apos;ve tried building and using an updates.img with those packages included and it takes effect, but network init seems to fail completely every time. Not sure if there&apos;s a bug in his patch or if it&apos;s a consequence of trying to update NM with an updates.img . I will see if I can build a new installer image with the updated NM build included instead.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9676536</commentid>
    <comment_count>5</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-02 21:35:05 -0400</bug_when>
    <thetext>OK, so I built a couple of netinst ISOs locally - one as a baseline, to make sure the issue still occurred with a self-built ISO, and one with that build of NM in it. And the results from that look hopeful. The baseline ISO does still reproduce the bug. And I&apos;ve done &gt;100 runs with the patched NM build and not hit the bug one time. So I think Thomas is on the right track.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9680178</commentid>
    <comment_count>6</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-05 13:03:08 -0400</bug_when>
    <thetext>fix on review:

https://cgit.freedesktop.org/NetworkManager/NetworkManager/log/?h=th/dhcp-helper-sync-notify-rh1372854</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9681479</commentid>
    <comment_count>7</comment_count>
    <who name="Beniamino Galvani">bgalvani</who>
    <bug_when>2016-09-06 04:25:01 -0400</bug_when>
    <thetext>&gt; dhcp-helper: refactor logging to use logging macros

+#define _NMLOG(always_enabled, level, ...) \
+       G_STMT_START { \
+               if ((always_enabled) || _NMLOG_ENABLED (level)) { \
+                       GTimeVal _tv; \
+                       \
+                       g_get_current_time (&amp;_tv); \
+                       g_print (&quot;nm-dhcp-helper[%ld] %-7s [%ld.%04ld] &quot; _NM_UTILS_MACRO_FIRST (__VA_ARGS__) &quot;\n&quot;, \
+                                (long) getpid (), \
+                                nm_utils_syslog_to_str (level), \
+                                (long) _tv.tv_sec, (long) (_tv.tv_sec, (_tv.tv_usec + 50) / 100) \

Here there is an extra argument, and casts are not required:

                                 _tv.tv_sec, (_tv.tv_usec + 50) / 100 \

Also, _tv.tv_usec is guaranteed to be &lt; 10^6, but (_tv.tv_usec + 50)
is not,	and can be displayed incorrectly (5 digits); the same applies
also to _nm_log_impl() in nm-logging.c

The rest LGTM.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9681577</commentid>
    <comment_count>8</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-06 04:59:15 -0400</bug_when>
    <thetext>(In reply to Beniamino Galvani from comment #7)
&gt; &gt; dhcp-helper: refactor logging to use logging macros

fixed and repushed</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9681618</commentid>
    <comment_count>9</comment_count>
    <who name="Beniamino Galvani">bgalvani</who>
    <bug_when>2016-09-06 05:10:52 -0400</bug_when>
    <thetext>(In reply to Thomas Haller from comment #8)
&gt; (In reply to Beniamino Galvani from comment #7)
&gt; &gt; &gt; dhcp-helper: refactor logging to use logging macros
&gt; 
&gt; fixed and repushed

LGTM</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9681691</commentid>
    <comment_count>10</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-06 05:32:44 -0400</bug_when>
    <thetext>this would be a build for f25 with the suggested fix for testing http://koji.fedoraproject.org/koji/taskinfo?taskID=15514439</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9682089</commentid>
    <comment_count>11</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-06 07:45:24 -0400</bug_when>
    <thetext>The issue seems to be present since 2007. Strange that it seems to happen now as frequently as 1/25 tries. It seems something during the boot of the live-cd is special.
Or maybe the failure rate is just too low for regular users to get a hold on the issue (also, because NM will retry DHCP after timeout).

Anyway. I think this is the right fix and tests correctly for me.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9682095</commentid>
    <comment_count>12</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-06 07:46:36 -0400</bug_when>
    <thetext>Adam, any chance to re-test with build from comment 10?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9683611</commentid>
    <comment_count>13</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-06 12:58:12 -0400</bug_when>
    <thetext>yep, I can run a few tests with that build for sure.

I suspect this is one of those things where a regular user would just go &apos;huh, that&apos;s odd&apos;, reboot, find it works OK and not really think more about it, or be able to report a useful bug. You kinda need something &apos;industrial scale&apos; like openQA to a) be really annoyed by it and b) be able to debug it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9683727</commentid>
    <comment_count>14</comment_count>
    <who name="Francesco Giudici">fgiudici</who>
    <bug_when>2016-09-06 13:44:23 -0400</bug_when>
    <thetext>th/dhcp-helper-sync-notify-rh1372854 branch looks good to me.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9685186</commentid>
    <comment_count>15</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-07 02:42:00 -0400</bug_when>
    <thetext>sorry, i didn&apos;t get time to do this today, was working on another annoying openqa issue all day. will do it tomorrow am.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688172</commentid>
    <comment_count>16</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-07 17:43:57 -0400</bug_when>
    <thetext>OK, I ran my test for this 120 times with the new NM, no failure. Fix looks good.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688464</commentid>
    <comment_count>17</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-07 18:20:25 -0400</bug_when>
    <thetext>@Adam, thank you for confirming. Very helpful.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688479</commentid>
    <comment_count>18</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-07 18:29:13 -0400</bug_when>
    <thetext>branch merged upstream:


master: https://cgit.freedesktop.org/NetworkManager/NetworkManager/commit/?id=42519abdbf6c9778a9f9421e704181b22d4df684

nm-1-4: https://cgit.freedesktop.org/NetworkManager/NetworkManager/commit/?id=0b182d0f450e7caac85096bddbeeef65bdabdd6a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688483</commentid>
    <comment_count>19</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-07 18:31:30 -0400</bug_when>
    <thetext>if you could do f25 and rawhide builds (and an update for f25) that&apos;d be awesome - I&apos;d love to not have to worry about this problem on openQA any more :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688500</commentid>
    <comment_count>20</comment_count>
    <who name="Thomas Haller">thaller</who>
    <bug_when>2016-09-07 18:48:47 -0400</bug_when>
    <thetext>it&apos;s already in the making...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688553</commentid>
    <comment_count>21</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-07 19:46:06 -0400</bug_when>
    <thetext>NetworkManager-1.4.0-3.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-ca1b48f89e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9688565</commentid>
    <comment_count>22</comment_count>
    <who name="Adam Williamson">awilliam</who>
    <bug_when>2016-09-07 19:54:18 -0400</bug_when>
    <thetext>Thanks a lot! While you&apos;re fixing things, feel like taking a swing at https://bugzilla.redhat.com/show_bug.cgi?id=1374090 ? :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9692874</commentid>
    <comment_count>23</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-09 02:25:45 -0400</bug_when>
    <thetext>NetworkManager-1.4.0-3.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-ca1b48f89e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9695554</commentid>
    <comment_count>24</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-09 17:46:26 -0400</bug_when>
    <thetext>NetworkManager-1.4.0-3.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>