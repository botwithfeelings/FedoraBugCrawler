<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1422151</bug_id>
          
          <creation_ts>2017-02-14 10:29:00 -0500</creation_ts>
          <short_desc>Video acceleration using VA-API broken in updates-testing</short_desc>
          <delta_ts>2017-02-25 20:35:21 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>libglvnd</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Thorsten Leemhuis">fedora</reporter>
          <assigned_to name="Nicolas Chauvet (kwizart)">kwizart</assigned_to>
          <cc>hdegoede</cc>
    
    
    <cc>kwizart</cc>
    
    
    <cc>leigh123linux</cc>
    
    
    <cc>xgl-maint</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>libglvnd-0.2.999-10.gitdc16f8c.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-02-25 20:35:21</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10146983</commentid>
    <comment_count>0</comment_count>
    <who name="Thorsten Leemhuis">fedora</who>
    <bug_when>2017-02-14 10:29:47 -0500</bug_when>
    <thetext>Description of problem:
Video acceleration broke for me on Gnome (running in Wayland mode) when updates-testing is enabled:
$ vainfo 
libva info: VA-API version 0.39.4
libva info: va_getDriverName() returns 0
libva info: Trying to open /usr/lib64/dri/emgd_drv_video.so
libva info: va_openDriver() returns -1
vaInitialize failed with error code -1 (unknown libva error),exit

After downgrading to an Mesa without libglvnd using &quot;dnf --disablerepo=updates-testing distro-sync mesa* --allowerasing&quot; it immediately starts working again:

$ vainfo 
libva info: VA-API version 0.39.4
libva info: va_getDriverName() returns 0
libva info: Trying to open /usr/lib64/dri/i965_drv_video.so
libva info: Found init function __vaDriverInit_0_39
libva info: va_openDriver() returns 0
vainfo: VA-API version: 0.39 (libva 1.7.3)
vainfo: Driver version: Intel i965 driver for Intel(R) Kabylake - 1.7.3
vainfo: Supported profile and entrypoints
      VAProfileMPEG2Simple            :	VAEntrypointVLD
      VAProfileMPEG2Simple            :	VAEntrypointEncSlice
      VAProfileMPEG2Main              :	VAEntrypointVLD
      VAProfileMPEG2Main              :	VAEntrypointEncSlice
[â€¦]

Version-Release number of selected component (if applicable):
libglvnd.x86_64 1:0.2.999-10.gitdc16f8c.fc25

Additional info:
Am I missing something? Why is libva trying to open &quot;/usr/lib64/dri/emgd_drv_video.so&quot; when libglvnd is installed?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10147152</commentid>
    <comment_count>1</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-14 11:08:15 -0500</bug_when>
    <thetext>Hi Thorsten,

Can you please provide some more detailed reproduction instructions, what harware are you using, do you have any special related packages installed (like libva providers from rpmfusion for example), what is the use-case which made you first notice this ?

Once I&apos;ve some more info I will try to reproduce and then try to fix this :)

Regards,

Hans</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10147157</commentid>
    <comment_count>2</comment_count>
    <who name="Nicolas Chauvet (kwizart)">kwizart</who>
    <bug_when>2017-02-14 11:10:02 -0500</bug_when>
    <thetext>Also worth to test if it still work as appropriate when using:
export LIBVA_DRIVER_NAME=i965</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10147164</commentid>
    <comment_count>3</comment_count>
    <who name="Nicolas Chauvet (kwizart)">kwizart</who>
    <bug_when>2017-02-14 11:10:50 -0500</bug_when>
    <thetext>(to be tested &quot;with&quot; the libglvnd update).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10148919</commentid>
    <comment_count>4</comment_count>
    <who name="Thorsten Leemhuis">fedora</who>
    <bug_when>2017-02-15 01:59:32 -0500</bug_when>
    <thetext>(In reply to Hans de Goede from comment #1)
&gt; Can you please provide some more detailed reproduction instructions,

Simply running vainfo afaics is enough to verify it&apos;s not working, but yes, ...

&gt; do you have any special related packages installed
&gt; (like libva providers from rpmfusion for example),

...obviously you need to have libva-intel-driver installed from RPM Fusion; sorry, should have mentioned this initially.

&gt; what hardware are you using, 

Dell XPS 13 (9360) at home (Kaby Lake CPU and it&apos;s GPU). 

&gt; what is the use-case which made you first notice this ?

I noticed that video acceleration wasn&apos;t working in VLC due to higher CPU load (fan was working more often), the battery draining more quickly and stuttering when forwarding or playing at higher video speeds (Side note: effects like these are IMHO a good reason why we maybe should find a way how to get libva-intel-driver installed by default in Fedora; but that&apos;s a different topic). Then I ran vainfo and noticed that there was no libva acceleration anymore.

(In reply to Nicolas Chauvet (kwizart) from comment #2)
&gt; Also worth to test if it still work as appropriate when using:
&gt; export LIBVA_DRIVER_NAME=i965

$ LC_ALL=C; LIBVA_DRIVER_NAME=i965 vainfo
libva info: VA-API version 0.39.4
libva info: va_getDriverName() returns 0
libva info: User requested driver &apos;i965&apos;
libva info: Trying to open /usr/lib64/dri/i965_drv_video.so
libva info: Found init function __vaDriverInit_0_39
vainfo: intel_driver.c:103: intel_driver_init: Assertion `drm_state&apos; failed.
Aborted (core dumped)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10149249</commentid>
    <comment_count>5</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 04:29:20 -0500</bug_when>
    <thetext>Ok here is a first data point / workaround:

vainfo does still work when using Xorg instead of wayland, so this may be another eglGetDisplay issue somewhere in the va-api stack, now I need to find where ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10149281</commentid>
    <comment_count>6</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 04:48:31 -0500</bug_when>
    <thetext>Oh, how ugly:

/* XXX: Wayland/DRM support currently lives in Mesa libEGL.so.* library */
#define LIBWAYLAND_DRM_NAME &quot;libEGL.so.1&quot;

    wl_drm_ctx-&gt;handle = dlopen(LIBWAYLAND_DRM_NAME, RTLD_LAZY|RTLD_LOCAL);
    if (!wl_drm_ctx-&gt;handle)
        return false;

Well that explains, I&apos;m preparing a patch which will hopefully fix this now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10149616</commentid>
    <comment_count>7</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 06:58:00 -0500</bug_when>
    <thetext>Thorsten,

Are you sure you ever got vaapi to work in a Wayland session ? I&apos;ve fixed the vainfo command issue, but vaapi still does not work. Even after downgrading to mesa from the normal updates repo + the latest libva packages (instead of my own fixed packages) it still does not work.

For some reason vlc always tries to use vdpau and not libva for me.

In a Xorg gnome3 session I can get vaapi to work in the following ways:

gst-launch-1.0 playbin uri=file:///home/hans/Music/Movies/Pioneer.One.S01E01.720p.x264-VODO/Pioneer.One.S01E01.720p.x264-VODO.mkv
totem Music/Movies/Pioneer.One.S01E01.720p.x264-VODO/Pioneer.One.S01E01.720p.x264-VODO.mkv
VDPAU_DRIVER=va_gl LIBVA_DRIVER_NAME=i965  vlc Music/Movies/Pioneer.One.S01E01.720p.x264-VODO/Pioneer.One.S01E01.720p.x264-VODO.mkv
VDPAU_DRIVER=va_gl LIBVA_DRIVER_NAME=i965 mplayer -vo vdpau  -vc ffh264vdpau Music/Movies/Pioneer.One.S01E01.720p.x264-VODO/Pioneer.One.S01E01.720p.x264-VODO.mkv

All of which fail when using a Wayland session (with the downgraded packages too).
totem gracefully fallsback the others exit with an error.

If you start your movie player from a terminal then you should see messages like these to indicate it is trying to use vaapi:

libva info: VA-API version 0.39.4
libva info: va_getDriverName() returns -1
libva info: User requested driver &apos;i965&apos;
libva info: Trying to open /usr/lib64/dri/i965_drv_video.so
libva info: Found init function __vaDriverInit_0_39

Which I&apos;m not seeing with vlc unless I use VDPAU_DRIVER=va_gl LIBVA_DRIVER_NAME=i965, which only works with Xorg.

Regards,

Hans</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10149654</commentid>
    <comment_count>8</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 07:06:59 -0500</bug_when>
    <thetext>Oh, totem actually does use vaapi under wayland, but for some reason it still uses quite a bit of CPU too. Let me retry with the updates back in place.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10149947</commentid>
    <comment_count>9</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 07:51:55 -0500</bug_when>
    <thetext>(In reply to Hans de Goede from comment #8)
&gt; Oh, totem actually does use vaapi under wayland, but for some reason it
&gt; still uses quite a bit of CPU too. Let me retry with the updates back in
&gt; place.

Ok that works, kicking of builds with fixed packages now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150014</commentid>
    <comment_count>10</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 08:11:11 -0500</bug_when>
    <thetext>Here are fixed libva packages, I head to fix the intel-driver package too, since the same hack is copied there too:

https://koji.fedoraproject.org/koji/buildinfo?buildID=859442
http://koji.rpmfusion.org/koji/buildinfo?buildID=3161

I will submit pull-requests upstream with the fix for both packages and update the glvnd update in bodhi to add the libva update.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150096</commentid>
    <comment_count>11</comment_count>
    <who name="Nicolas Chauvet (kwizart)">kwizart</who>
    <bug_when>2017-02-15 08:31:01 -0500</bug_when>
    <thetext>Looking at the fix, I wonder why libva-wayland.so.1 isn&apos;t linked at libEGL in the first place ?

Using libEGL_mesa.so.0 is probably sane for libva-intel-driver, but might break on non mesa based drivers for libva (aka anything using libva-vdpau-driver).
Testing wayland there isn&apos;t easy, so I will try to reproduce on f26.

Anyway having EGL client that need to learn one another EGL backend isn&apos;t easy.
This somehow breaks encapsulation.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150238</commentid>
    <comment_count>12</comment_count>
    <who name="Hans de Goede">hdegoede</who>
    <bug_when>2017-02-15 09:15:13 -0500</bug_when>
    <thetext>(In reply to Nicolas Chauvet (kwizart) from comment #11)
&gt; Looking at the fix, I wonder why libva-wayland.so.1 isn&apos;t linked at libEGL
&gt; in the first place ?

libva-wayland.so is not using EGL, it is re-using some code from mesa by dl-opening mesa&apos;s libEGL and then taking one (non EGL) symbol from it. That code really needs to be moved to a separate helper library which then both mesa and libva can use.

&gt; Using libEGL_mesa.so.0 is probably sane for libva-intel-driver, but might
&gt; break on non mesa based drivers for libva (aka anything using
&gt; libva-vdpau-driver).

See above, this is not about EGL, it is about re-using some utility functions defined in mesa, so we really always wants mesa&apos;s EGL implementation here and the dlopen call uses RTLD_LOCAL to avoid that none of the other symbols in libEGL leak into the global runtime linking namespace. It is not pretty but it works, and the RTLD_LOCAL should ensure that any actual libEGL users still get their EGL symbols from the glvnd libEGL.so.1 when glvnd is used.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150245</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-15 09:18:45 -0500</bug_when>
    <thetext>libglvnd-0.2.999-10.gitdc16f8c.fc25 libva-1.7.3-3.fc25 mesa-13.0.4-1.fc25 wlc-0.0.7-3.git12ee978.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-9f6383547e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150247</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-15 09:18:55 -0500</bug_when>
    <thetext>libglvnd-0.2.999-10.gitdc16f8c.fc25 libva-1.7.3-3.fc25 mesa-13.0.4-1.fc25 wlc-0.0.7-3.git12ee978.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-9f6383547e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10150919</commentid>
    <comment_count>15</comment_count>
    <who name="Thorsten Leemhuis">fedora</who>
    <bug_when>2017-02-15 12:20:35 -0500</bug_when>
    <thetext>Hans, thx for taking care of this. Vainfo works fine here now with the libva update from koji updates-testing-pending and the libva-intel-driver from RPM Fusion&apos;s koji.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10159874</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-17 10:24:07 -0500</bug_when>
    <thetext>libglvnd-0.2.999-10.gitdc16f8c.fc25, libva-1.7.3-3.fc25, mesa-13.0.4-1.fc25, wlc-0.0.7-3.git12ee978.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-9f6383547e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10184067</commentid>
    <comment_count>17</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-25 20:35:21 -0500</bug_when>
    <thetext>libglvnd-0.2.999-10.gitdc16f8c.fc25, libva-1.7.3-3.fc25, mesa-13.0.4-1.fc25, wlc-0.0.7-3.git12ee978.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>