<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1394993</bug_id>
          
          <creation_ts>2016-11-14 19:19:00 -0500</creation_ts>
          <short_desc>[wayland] Copy/paste and context menus not working correctly</short_desc>
          <delta_ts>2016-11-28 17:43:04 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>evolution</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>NEXTRELEASE</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1396009</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>medium</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Bojan Smojver">bojan</reporter>
          <assigned_to name="Milan Crha">mcrha</assigned_to>
          <cc>lucilanga</cc>
    
    
    <cc>mbarnes</cc>
    
    
    <cc>mcrha</cc>
    
    
    <cc>tpopela</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-11-28 06:23:53</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9890202</commentid>
    <comment_count>0</comment_count>
    <who name="Bojan Smojver">bojan</who>
    <bug_when>2016-11-14 19:19:57 -0500</bug_when>
    <thetext>Description of problem:

Please note, this may not be an Evo bug at all, as it appears to happen only under Wayland. Anyhow...

Problem 1:

Right click on a link inside an email brings up a context menu, but the menu box contains only two options (open and copy) up the top of the box. There are about 10 empty lines below those two.

Problem 2:

If I select Copy Link Location and try to paste it into Firefox, there will be a slight delay and then usually nothing happens (i.e. the text is not pasted into the address box of FF). Journal has things like:

Nov 15 11:14:59 shrek.rexursive.com evolution[10057]: Error writing selection data: Error writing to file descriptor: Broken pipe

Occasionally, pasting the text works into terminal, for instance.

Version-Release number of selected component (if applicable):
evolution-3.22.1-2.fc25.x86_64

How reproducible:
Always for context menu. Most of the time for copy/paste.

Steps to Reproduce:
1. See description.

Actual results:
Context menu appears incorrect. Copy paste doesn&apos;t work.

Expected results:
This worked in F24.

Additional info:
I run Evo under Xvnc on another machine as well and have none of these problem. I am not quite sure whether this copy/paste problem is limited to Evo or not, but it is Wayland specific. So, as I said above, it may not be an Evo bug at all. No idea.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9908671</commentid>
    <comment_count>1</comment_count>
    <who name="Milan Crha">mcrha</who>
    <bug_when>2016-11-21 09:41:25 -0500</bug_when>
    <thetext>Thanks for a bug report. If I&apos;m not mistaken (and my information outdated), the issue is in the webkitgtk4. Could you try the same with
   /usr/libexec/webkit2gtk-4.0/MiniBrowser
please? This applies to the 2) at least. The 1) can be an evolution issue.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9909970</commentid>
    <comment_count>2</comment_count>
    <who name="Bojan Smojver">bojan</who>
    <bug_when>2016-11-21 15:59:54 -0500</bug_when>
    <thetext>(In reply to Milan Crha from comment #1)
&gt; Thanks for a bug report. If I&apos;m not mistaken (and my information outdated),
&gt; the issue is in the webkitgtk4. Could you try the same with
&gt;    /usr/libexec/webkit2gtk-4.0/MiniBrowser
&gt; please? This applies to the 2) at least. The 1) can be an evolution issue.

Copy/paste seems to work more consistently with that browser from Evo (haven&apos;t had one failure). I just tried a few URLs and sometimes it even works with FF, but many times it won&apos;t. The problem is especially obvious into private FF windows. If it matters, I&apos;m running FF with Electrolysis on.

As for issue 1, I keep up to date with updates-testing and I often reboot and I cannot see the issue with the menu right now. So, maybe something else fixed that - no idea.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9914643</commentid>
    <comment_count>3</comment_count>
    <who name="Bojan Smojver">bojan</who>
    <bug_when>2016-11-23 00:17:58 -0500</bug_when>
    <thetext>(In reply to Bojan Smojver from comment #2)

&gt; As for issue 1, I keep up to date with updates-testing and I often reboot
&gt; and I cannot see the issue with the menu right now. So, maybe something else
&gt; fixed that - no idea.

This is back again, but there is a bit more to it. The problems with context menus manifest themselves for email links as well. However, it&apos;s not that the menu is always too big for the number of items in it. Sometimes, the menu is too small and one has to scroll up/down to see everything, although there is plenty of pixels on the screen to display everything (e.g. there are about 8 items to display, but menu is only 2 or 3 items tall).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9916825</commentid>
    <comment_count>4</comment_count>
    <who name="Tomas Popela">tpopela</who>
    <bug_when>2016-11-23 10:30:44 -0500</bug_when>
    <thetext>I can confirm both issues as I see them on my box as well. The second one is a WebKitGTK+ bug (I will later add attach an upstream bug number here) which is also reproducible with Epiphany. The first one is probably Evolution&apos;s bug as we are creating the context menu.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9916933</commentid>
    <comment_count>5</comment_count>
    <who name="Milan Crha">mcrha</who>
    <bug_when>2016-11-23 10:57:39 -0500</bug_when>
    <thetext>(In reply to Bojan Smojver from comment #0)
&gt; Right click on a link inside an email brings up a context menu, but the menu
&gt; box contains only two options (open and copy) up the top of the box. There
&gt; are about 10 empty lines below those two.

My personal theory is that the menu itself is somehow reused, but it is shown before the right items are shown (and all other hidden), thus they cause this misbehaviour. I think it&apos;s the reason why on Xorg the menu is mispositioned - the &quot;empty&quot; items get hidden, but only after the menu itself is shown.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9917311</commentid>
    <comment_count>6</comment_count>
    <who name="Tomas Popela">tpopela</who>
    <bug_when>2016-11-23 12:50:25 -0500</bug_when>
    <thetext>(In reply to Milan Crha from comment #5)
&gt; My personal theory is that the menu itself is somehow reused, but it is
&gt; shown before the right items are shown (and all other hidden), thus they
&gt; cause this misbehaviour. I think it&apos;s the reason why on Xorg the menu is
&gt; mispositioned - the &quot;empty&quot; items get hidden, but only after the menu itself
&gt; is shown.

You are probably right. I actually can see a similar behavior in Nautilus as well. I asked the Wayland devs about it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9917784</commentid>
    <comment_count>7</comment_count>
    <who name="Milan Crha">mcrha</who>
    <bug_when>2016-11-23 17:11:56 -0500</bug_when>
    <thetext>The evolution&apos;s issue is the asynchronous nature of EWebView&apos;s web_view_update_actions() due to webkit_web_view_can_execute_editing_command() usage. When I reorder the callback code back to the web_view_update_actions(), then it behaves better, but only until I have anything selected in the web view. In that case the &quot;Copy&quot; item shows up, but again too late and there is a scrolling in the popup menu, which is odd and wrong at the same time.

The thing is that the e_web_view_update_actions() (similarly to any other &quot;update-actions&quot;) is required to be synchronous, thus when the menu is pop up, the items in it are already shown/hidden as they should be.

I do not know whether there is any replacement for the webkit_web_view_can_execute_editing_command(), like on the web-extension side, to provide our own property in our extension, similar to &quot;NeedInput&quot;, but this time for the editing commands (cut/copy/paste). It could be an unsigned integer, a bit-or of can_cut, can_copy, can_paste.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9934154</commentid>
    <comment_count>8</comment_count>
    <who name="Tomas Popela">tpopela</who>
    <bug_when>2016-11-28 06:23:53 -0500</bug_when>
    <thetext>Fixed with upstream commit [0] that will be included in the next 3.22.3 release of Evolution.

[0] - https://git.gnome.org/browse/evolution/commit/?id=ba1f878</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9936581</commentid>
    <comment_count>9</comment_count>
    <who name="Bojan Smojver">bojan</who>
    <bug_when>2016-11-28 17:43:04 -0500</bug_when>
    <thetext>(In reply to Tomas Popela from comment #8)
&gt; Fixed with upstream commit [0] that will be included in the next 3.22.3
&gt; release of Evolution.
&gt; 
&gt; [0] - https://git.gnome.org/browse/evolution/commit/?id=ba1f878

Thank you!</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>