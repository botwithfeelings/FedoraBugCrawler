<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1401625</bug_id>
          
          <creation_ts>2016-12-05 13:07:00 -0500</creation_ts>
          <short_desc>user_r can&apos;t run systemctl --user</short_desc>
          <delta_ts>2017-01-31 20:34:27 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>selinux-policy</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1412165</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>low</priority>
          <bug_severity>low</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Robin Powell">rlpowell</reporter>
          <assigned_to name="Lukas Vrabec">lvrabec</assigned_to>
          <cc>dominick.grift</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>jpokorny</cc>
    
    
    <cc>lvrabec</cc>
    
    
    <cc>mgrepl</cc>
    
    
    <cc>plautrba</cc>
    
    
    <cc>pmoore</cc>
    
    
    <cc>ssekidde</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>selinux-policy-3.13.1-225.6.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-01-11 02:23:38</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9957153</commentid>
    <comment_count>0</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2016-12-05 13:07:27 -0500</bug_when>
    <thetext>This may be a policy decision rather than a bug, but if so I&apos;d like to know how I should handle this situation.

I want to let users use systemctl --user to talk to systemd --user to launch things at boot time.  My normal users are user_r, and the unconfined module is disabled.

Running &quot;/usr/bin/systemctl --user status&quot; as such a user with dontaudit off and setenforce 0 gives:



type=AVC msg=audit(1480961161.434:45524): avc:  denied  { rlimitinh } for  pid=30186 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=system_u:system_r:chkpwd_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.434:45525): avc:  denied  { siginh } for  pid=30186 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=system_u:system_r:chkpwd_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.435:45526): avc:  denied  { noatsecure } for  pid=30186 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=system_u:system_r:chkpwd_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.445:45530): avc:  denied  { net_admin } for  pid=30185 comm=&quot;crond&quot; capability=12  scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tclass=capability permissive=1
type=USER_AVC msg=audit(1480961161.473:45531): pid=1 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:init_t:s0 msg=&apos;avc:  received setenforce notice (enforcing=0)  exe=&quot;/usr/lib/systemd/systemd&quot; sauid=0 hostname=? addr=? terminal=?&apos;
type=AVC msg=audit(1480961161.500:45532): avc:  denied  { read write } for  pid=1 comm=&quot;systemd&quot; path=&quot;socket:[833929]&quot; dev=&quot;sockfs&quot; ino=833929 scontext=system_u:system_r:init_t:s0 tcontext=system_u:system_r:kernel_t:s0 tclass=unix_stream_socket permissive=1
type=AVC msg=audit(1480961161.504:45533): avc:  denied  { wake_alarm } for  pid=340 comm=&quot;systemd-udevd&quot; capability=35  scontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tcontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tclass=capability2 permissive=1
type=AVC msg=audit(1480961161.545:45534): avc:  denied  { rlimitinh } for  pid=30189 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:init_t:s0 tcontext=system_u:system_r:chkpwd_t:s0 tclass=process permissive=1
type=AVC msg=audit(1480961161.545:45535): avc:  denied  { siginh } for  pid=30189 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:init_t:s0 tcontext=system_u:system_r:chkpwd_t:s0 tclass=process permissive=1
type=AVC msg=audit(1480961161.546:45536): avc:  denied  { noatsecure } for  pid=30189 comm=&quot;unix_chkpwd&quot; scontext=system_u:system_r:init_t:s0 tcontext=system_u:system_r:chkpwd_t:s0 tclass=process permissive=1
type=AVC msg=audit(1480961161.615:45541): avc:  denied  { wake_alarm } for  pid=340 comm=&quot;systemd-udevd&quot; capability=35  scontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tcontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tclass=capability2 permissive=1
type=AVC msg=audit(1480961161.619:45542): avc:  denied  { rlimitinh } for  pid=30187 comm=&quot;systemd&quot; scontext=system_u:system_r:init_t:s0 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.619:45543): avc:  denied  { siginh } for  pid=30187 comm=&quot;systemd&quot; scontext=system_u:system_r:init_t:s0 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.650:45544): avc:  denied  { wake_alarm } for  pid=340 comm=&quot;systemd-udevd&quot; capability=35  scontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tcontext=system_u:system_r:udev_t:s0-s0:c0.c1023 tclass=capability2 permissive=1
type=AVC msg=audit(1480961161.737:45548): avc:  denied  { rlimitinh } for  pid=30218 comm=&quot;sh&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.737:45549): avc:  denied  { siginh } for  pid=30218 comm=&quot;sh&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.738:45550): avc:  denied  { noatsecure } for  pid=30218 comm=&quot;sh&quot; scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=process permissive=1
type=AVC msg=audit(1480961161.749:45552): avc:  denied  { net_admin } for  pid=30185 comm=&quot;crond&quot; capability=12  scontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tcontext=system_u:system_r:crond_t:s0-s0:c0.c1023 tclass=capability permissive=1
type=AVC msg=audit(1480961161.851:45555): avc:  denied  { read write } for  pid=1 comm=&quot;systemd&quot; path=&quot;socket:[833989]&quot; dev=&quot;sockfs&quot; ino=833989 scontext=system_u:system_r:init_t:s0 tcontext=system_u:system_r:kernel_t:s0-s0:c0.c1023 tclass=unix_stream_socket permissive=1
type=AVC msg=audit(1480961163.135:45556): avc:  denied  { execute } for  pid=30240 comm=&quot;bash&quot; name=&quot;systemctl&quot; dev=&quot;vda2&quot; ino=271798 scontext=user_u:user_r:user_t:s0 tcontext=system_u:object_r:systemd_systemctl_exec_t:s0 tclass=file permissive=1
type=AVC msg=audit(1480961163.136:45557): avc:  denied  { read open } for  pid=30240 comm=&quot;bash&quot; path=&quot;/usr/bin/systemctl&quot; dev=&quot;vda2&quot; ino=271798 scontext=user_u:user_r:user_t:s0 tcontext=system_u:object_r:systemd_systemctl_exec_t:s0 tclass=file permissive=1
type=AVC msg=audit(1480961163.136:45558): avc:  denied  { execute_no_trans } for  pid=30240 comm=&quot;bash&quot; path=&quot;/usr/bin/systemctl&quot; dev=&quot;vda2&quot; ino=271798 scontext=user_u:user_r:user_t:s0 tcontext=system_u:object_r:systemd_systemctl_exec_t:s0 tclass=file permissive=1


Let me know what the correct solution is.  Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9961168</commentid>
    <comment_count>1</comment_count>
    <who name="Lukas Vrabec">lvrabec</who>
    <bug_when>2016-12-06 11:42:10 -0500</bug_when>
    <thetext>Hi, 

Could you try this local policy?

$ cat user_systemd.cil 
(allow user_t systemd_systemctl_exec_t (file execute execute_no_trans open read))

Please let me know. 
Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10022521</commentid>
    <comment_count>2</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2016-12-28 02:18:59 -0500</bug_when>
    <thetext>I&apos;m sorry, I&apos;ve never used cil before, so my apologies if I&apos;m doing something dumb, but:

rlpowell@vrici&gt; sudo semodule -i /tmp/user_systemd.cil
Invalid syntax
Bad class-permissions
Problem filling class-permissions list
Bad allow rule at /var/lib/selinux/targeted/tmp/modules/400/user_systemd/cil:1
/sbin/semodule:  Failed!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10022522</commentid>
    <comment_count>3</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2016-12-28 02:19:38 -0500</bug_when>
    <thetext>Just in case:

rlpowell@vrici&gt; cat /tmp/user_systemd.cil
(allow user_t systemd_systemctl_exec_t (file execute execute_no_trans open read))</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10022526</commentid>
    <comment_count>4</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2016-12-28 02:22:18 -0500</bug_when>
    <thetext>Ah, I figured it out.  Yes, this:

rlpowell@vrici&gt; sudo semodule -i /tmp/user_systemd.cil
rlpowell@vrici&gt; cat /tmp/user_systemd.cil
(allow user_t systemd_systemctl_exec_t (file (execute execute_no_trans open read)))

seems to work.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10022532</commentid>
    <comment_count>5</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2016-12-28 02:25:54 -0500</bug_when>
    <thetext>(note that the problem before was &quot;(file execute ...)&quot; instead of &quot;(file (execute ...))&quot;)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10043502</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-08 17:21:56 -0500</bug_when>
    <thetext>selinux-policy-3.13.1-225.6.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-66d634473a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10047673</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-09 22:25:30 -0500</bug_when>
    <thetext>selinux-policy-3.13.1-225.6.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-66d634473a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10050828</commentid>
    <comment_count>8</comment_count>
    <who name="Jan Pokorný">jpokorny</who>
    <bug_when>2017-01-10 17:23:01 -0500</bug_when>
    <thetext>Please build this also for f26/rawhide as this is where I observe
something pretty similar.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10050863</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Pokorný">jpokorny</who>
    <bug_when>2017-01-10 17:39:11 -0500</bug_when>
    <thetext>In fact, with selinux-policy-3.13.1-231.fc26.noarch, the main problem I have
is that with enforcing SELinux, I am receiving:

$ su -c &quot;systemctl status --no-pager -l user@$(id -u)&quot;
&gt; ● user@1000.service - User Manager for UID 1000
&gt;    Loaded: loaded (/usr/lib/systemd/system/user@.service; static; vendor preset: disabled)
&gt;    Active: inactive (dead)
&gt;
&gt; Jan 10 22:17:42 betenoire systemd[1]: Starting User Manager for UID 1000...
&gt; Jan 10 22:17:42 betenoire systemd[1167]: user@1000.service: Failed at step USER spawning
&gt; /usr/lib/systemd/systemd: Permission denied
&gt; Jan 10 22:17:42 betenoire systemd[1]: Started User Manager for UID 1000.

whereas after setting to permissive and relogin, it works.

I am not sure if it&apos;s a material for a separate bug, but the workaround from
[comment 1] does not seem to help with this prerequisite (at least I think
it is a hard prerequisite for &quot;systemctl --user&quot; to succeed).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10051666</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-11 02:23:38 -0500</bug_when>
    <thetext>selinux-policy-3.13.1-225.6.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10052235</commentid>
    <comment_count>11</comment_count>
    <who name="Jan Pokorný">jpokorny</who>
    <bug_when>2017-01-11 05:35:29 -0500</bug_when>
    <thetext>OK, received update up to selinux-policy-3.13-1.233.fc26 and it did not
help for issue detailed in [comment 9], will file a separate bug for
that with details.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10111190</commentid>
    <comment_count>12</comment_count>
    <who name="Robin Powell">rlpowell</who>
    <bug_when>2017-01-31 20:34:27 -0500</bug_when>
    <thetext>This seems to mostly work; the only problem I&apos;m having is that &quot;/bin/systemctl --user status&quot; doesn&apos;t show logs; my local hack is:

logging_list_logs(user_t)
logging_read_generic_logs(user_t)
init_script_file_entry_type(user_t)</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>