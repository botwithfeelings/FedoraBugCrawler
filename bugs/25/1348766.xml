<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1348766</bug_id>
          
          <creation_ts>2016-06-21 22:44:00 -0400</creation_ts>
          <short_desc>&quot;The operation would result in removing the booted kernel&quot; when installonlypkgs is set in dnf.conf</short_desc>
          <delta_ts>2016-10-04 14:03:21 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>dnf</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>RAWHIDE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Triaged</keywords>
          <priority>medium</priority>
          <bug_severity>high</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Fabiano Franz">ffranz</reporter>
          <assigned_to name="Jaroslav Mracek">jmracek</assigned_to>
          <cc>1786578565</cc>
    
    
    <cc>bhaubeck</cc>
    
    
    <cc>eric</cc>
    
    
    <cc>fred.kapp</cc>
    
    
    <cc>jmracek</cc>
    
    
    <cc>jsilhan</cc>
    
    
    <cc>mcurlej</cc>
    
    
    <cc>mluscon</cc>
    
    
    <cc>ncoghlan</cc>
    
    
    <cc>packaging-team-maint</cc>
    
    
    <cc>petre.tudor</cc>
    
    
    <cc>pnemade</cc>
    
    
    <cc>RadekHolyPublic</cc>
    
    
    <cc>reclusivegeek</cc>
    
    
    <cc>rrivera</cc>
    
    
    <cc>thunderbirdtr</cc>
    
    
    <cc>unix.ketan</cc>
    
    
    <cc>vmukhame</cc>
    
    
    <cc>wwoods</cc>
    
    
    <cc>y.junhai</cc>
    
    
    <cc>zbyszek</cc>
    
    
    <cc>zukka77</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-10-04 14:03:21</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9439006</commentid>
    <comment_count>0</comment_count>
    <who name="Fabiano Franz">ffranz</who>
    <bug_when>2016-06-21 22:44:17 -0400</bug_when>
    <thetext>Description of problem:

Trying to upgrade f23 to f24 (post release) with

sudo dnf upgrade --refresh
sudo dnf install dnf-plugin-system-upgrade
sudo dnf system-upgrade download --releasever=24

The last operation fails with

Error: The operation would result in removing the booted kernel: kernel-core-4.5.7-200.fc23.x86_64.
 
I tried dnf clean then dnf distro-sync, and system-upgrade with --allowerasing and --best, none of them helped.  

Version-Release number of selected component (if applicable):

dnf-plugin-system-upgrade 0.7.1-1.fc23

How reproducible:

Always

Steps to Reproduce:
1.
2.
3.

Actual results:

Cannot perform the upgrade from f23 to f24.

Error: The operation would result in removing the booted kernel: kernel-core-4.5.7-200.fc23.x86_64.

Expected results:


Additional info:

$ sudo tail -n 20 /var/log/dnf.log

Jun 21 23:31:54 DEBUG --&gt; Finished dependency resolution
Jun 21 23:31:54 DDEBUG timer: depsolve: 4003 ms
Jun 21 23:31:55 INFO Dependencies resolved.
Jun 21 23:31:55 DDEBUG Cleaning up.
Jun 21 23:31:55 SUBDEBUG 
Traceback (most recent call last):
  File &quot;/usr/lib/python3.4/site-packages/dnf/cli/main.py&quot;, line 60, in main
    return _main(base, args)
  File &quot;/usr/lib/python3.4/site-packages/dnf/cli/main.py&quot;, line 120, in _main
    ret = resolving(cli, base)
  File &quot;/usr/lib/python3.4/site-packages/dnf/cli/main.py&quot;, line 142, in resolving
    base._plugins.run_resolved()
  File &quot;/usr/lib/python3.4/site-packages/dnf/plugin.py&quot;, line 82, in fn
    dnf.util.mapall(operator.methodcaller(method), self.plugins)
  File &quot;/usr/lib/python3.4/site-packages/dnf/util.py&quot;, line 183, in mapall
    return list(map(fn, *seq))
  File &quot;/usr/lib/python3.4/site-packages/dnf-plugins/protected_packages.py&quot;, line 80, in resolved
    raise dnf.exceptions.Error(KERNEL_MSG % kernel_pkg)
dnf.exceptions.Error: The operation would result in removing the booted kernel: kernel-core-4.5.7-200.fc23.x86_64.
Jun 21 23:31:55 CRITICAL Error: The operation would result in removing the booted kernel: kernel-core-4.5.7-200.fc23.x86_64.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9442825</commentid>
    <comment_count>1</comment_count>
    <who name="Eric Doutreleau">eric</who>
    <bug_when>2016-06-22 16:51:33 -0400</bug_when>
    <thetext>I had exactly the same problem

i remove  python3-dnf-plugins-core-0.1.21-2.fc23.noarch

and after that it worked 

hope that helps</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9465256</commentid>
    <comment_count>2</comment_count>
    <who name="Martin Curlej">mcurlej</who>
    <bug_when>2016-06-29 12:00:12 -0400</bug_when>
    <thetext>Had the same problem. After uninstalling the python3-dnf-plugins-core package upgraded without problems.(In reply to Eric Doutreleau from comment #1)

&gt; I had exactly the same problem
&gt; 
&gt; i remove  python3-dnf-plugins-core-0.1.21-2.fc23.noarch
&gt; 
&gt; and after that it worked 
&gt; 
&gt; hope that helps</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9465468</commentid>
    <comment_count>3</comment_count>
    <who name="Zbigniew Jędrzejewski-Szmek">zbyszek</who>
    <bug_when>2016-06-29 12:29:03 -0400</bug_when>
    <thetext>Removing python3-dnf-plugins-core is a work-around which breaks installonly protection for kernel. DNF should not be trying to remove the installed kernel.

What are the contents of /etc/dnf/dnf.conf, and what kernels do you have installed (rpm -q kernel-core)? Also, if possible, please paste the whole output with the list of packages from dnf system-upgrade.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9465986</commentid>
    <comment_count>4</comment_count>
    <who name="Eric Doutreleau">eric</who>
    <bug_when>2016-06-29 15:02:57 -0400</bug_when>
    <thetext>well i m sorry i make the upgrade.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9466701</commentid>
    <comment_count>5</comment_count>
    <who name="Ronaldo Rivera">rrivera</who>
    <bug_when>2016-06-29 22:11:23 -0400</bug_when>
    <thetext>I can confirm the workaround by removing python3-dnf-plugins-core-0.1.21-2.fc23.noarch worked for me as well.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9472905</commentid>
    <comment_count>6</comment_count>
    <who name="Petre">petre.tudor</who>
    <bug_when>2016-07-01 12:38:47 -0400</bug_when>
    <thetext>Similar problem here. I am on F24.

$ rpm -q kernel-core
kernel-core-4.5.7-300.fc24.x86_64


$ cat /etc/dnf/dnf.conf                                                                                                                                           
[main]
gpgcheck=1
installonly_limit=3
clean_requirements_on_remove=True
installonlypkgs=electron

Is it safe to remove python3-dnf-plugins-core and upgrade?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9472907</commentid>
    <comment_count>7</comment_count>
    <who name="Andrea Zucchelli">zukka77</who>
    <bug_when>2016-07-01 12:41:57 -0400</bug_when>
    <thetext>Same situation as Petre, same kernel same dnf.conf</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9473137</commentid>
    <comment_count>8</comment_count>
    <who name="Fredy">fred.kapp</who>
    <bug_when>2016-07-01 14:03:35 -0400</bug_when>
    <thetext>I had the same situation than Petre &amp; Andrea and this worked for me :

https://bugzilla.redhat.com/show_bug.cgi?id=1347999#c2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9474067</commentid>
    <comment_count>9</comment_count>
    <who name="Petre">petre.tudor</who>
    <bug_when>2016-07-02 14:39:34 -0400</bug_when>
    <thetext>(In reply to Fredy from comment #8)
&gt; I had the same situation than Petre &amp; Andrea and this worked for me :
&gt; 
&gt; https://bugzilla.redhat.com/show_bug.cgi?id=1347999#c2


I commented out this line and it worked:

installonlypkgs=electron</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9479366</commentid>
    <comment_count>10</comment_count>
    <who name="Nick Coghlan">ncoghlan</who>
    <bug_when>2016-07-04 17:26:33 -0400</bug_when>
    <thetext>OK, it looks like the culprit for the immediate problem people are seeing is the https://copr.fedorainfracloud.org/coprs/mosquito/atom/ COPR repository: https://github.com/FZUG/repo/issues/129

It&apos;s not specifically related to the system upgrade process, it&apos;s related to the electron RPM in that COPR appending the &quot;installonlypkgs=electron&quot; line to /etc/dnf/dnf.conf

That specific case has been resolved in the above linked issue, so if you remove the DNF conf line mentioned above and then do a &quot;dnf upgrade -y&quot;, the problem won&apos;t come back.

However, that doesn&apos;t fix the underlying cause of the misbehaviour: explicitly setting &quot;installonlypkgs&quot; in /etc/dnf/dnf.conf currently removes the implicit kernel protections, which makes that setting unduly hard to use correctly.

Accordingly, I&apos;m changing the affected component for this BZ to dnf-plugins-core, and amending the title to reflect the fact the problem occurs whenever &quot;installonlypkgs&quot; is set in /etc/dnf/dnf.conf and F24 needs to upgrade the kernel, rather than being specific to upgrades from F23.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9480612</commentid>
    <comment_count>11</comment_count>
    <who name="Paul Jones">reclusivegeek</who>
    <bug_when>2016-07-05 04:38:31 -0400</bug_when>
    <thetext>It appears that this problem now occurs on F23 when doing an update. It is not just when upgrading.

# dnf update
Dependencies resolved.
Error: The operation would result in removing the booted kernel: kernel-core-4.5.7-200.fc23.x86_64.

If you need any further information please let me know.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9482322</commentid>
    <comment_count>12</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-07-05 15:22:02 -0400</bug_when>
    <thetext>*** Bug 1347999 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9482324</commentid>
    <comment_count>13</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-07-05 15:22:04 -0400</bug_when>
    <thetext>*** Bug 1352240 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9490437</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2016-07-08 05:36:50 -0400</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9496139</commentid>
    <comment_count>15</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-07-11 07:15:44 -0400</bug_when>
    <thetext>*** Bug 1352199 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9544274</commentid>
    <comment_count>16</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-07-24 13:14:44 -0400</bug_when>
    <thetext>*** Bug 1359522 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9549887</commentid>
    <comment_count>17</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-07-26 01:01:45 -0400</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 25 development cycle.
Changing version to &apos;25&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9713609</commentid>
    <comment_count>18</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-09-16 04:29:45 -0400</bug_when>
    <thetext>The problem here is that by default INSTALLONLYPKGS=(&apos;kernel&apos;, &apos;installonlypkg(kernel)&apos;, &apos;installonlypkg(kernel-module)&apos;, &apos;installonlypkg(vm)&apos;)

But if in dnf.conf is
installonlypkgs=electron

than only electron is installonlypkgs, therefore kernel packages are handled as standard packages.

The question is what we can do? We can introduce installonlypkgs+=electron that will append electron into installonlypkgs, but it doesn&apos;t prevent the problem when installonlypkgs=electron in dnf.conf. Or we can say that installonlypkgs=electron mean append electron into list, but it is nonsense because why user cannot completely refactor the group of installonlypkgs.
What do you think? Please your opinion here is really essential.

Anyway in meanwhile I am going to improve the documentation to prevent the problem.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9714224</commentid>
    <comment_count>19</comment_count>
    <who name="Zbigniew Jędrzejewski-Szmek">zbyszek</who>
    <bug_when>2016-09-16 08:17:42 -0400</bug_when>
    <thetext>I&apos;d do the same that systemd does for settings which should &quot;accumulate&quot;
1. &quot;installonlypackages=foo&quot; adds foo to the existing list
2. &quot;installonlypackages=&quot; resets the list

This is very close to current semantics (in case 2.), and will DTRT that users seems to expect in case 1.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9714765</commentid>
    <comment_count>20</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-09-16 11:02:07 -0400</bug_when>
    <thetext>Thanks for reaction, but config parser take only last option if presented multiple time. I prepared patch that will honor example [1] from Comment 19.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9714915</commentid>
    <comment_count>21</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-09-16 11:35:31 -0400</bug_when>
    <thetext>Here is the PR: https://github.com/rpm-software-management/dnf/pull/613</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>