<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1413762</bug_id>
          
          <creation_ts>2017-01-16 17:05:00 -0500</creation_ts>
          <short_desc>Turn on --with-dtrace for nodejs</short_desc>
          <delta_ts>2017-02-06 22:47:10 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>nodejs</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>https://sourceware.org/bugzilla/show_bug.cgi?id=21063</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Kinston Hughes">k2683901</reporter>
          <assigned_to name="NodeJS Packaging SIG">nodejs-sig</assigned_to>
          <cc>jamielinux</cc>
    
    
    <cc>mrunge</cc>
    
    
    <cc>nodejs-sig</cc>
    
    
    <cc>piotr1212</cc>
    
    
    <cc>sgallagh</cc>
    
    
    <cc>tchollingsworth</cc>
    
    
    <cc>thrcka</cc>
    
    
    <cc>zsvetlik</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>nodejs-6.9.4-2.fc25 nodejs-6.9.4-2.el7</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-01-21 14:22:25</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10068067</commentid>
    <comment_count>0</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-16 17:05:22 -0500</bug_when>
    <thetext>Description of problem:

.spec file has had configure --without-dtrace set since the initial commit in 2012. Linxux tracing has come a long way since then and now that fc25 ships the 4.9 kernel with bpf, the use of tracing is increasingly becoming a standard tool for admins and devs. 

It would be nice to have nodejs ship with USDT tracepoints out of the box in fedora, please turn it on and push a new build.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10068080</commentid>
    <comment_count>1</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-16 17:13:43 -0500</bug_when>
    <thetext>Postgres ships --with-dtrace on fedora, there seems to be a &quot;BuildRequires: systemtap-sdt-devel&quot; involved. In case it helps.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10071123</commentid>
    <comment_count>2</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2017-01-17 07:38:52 -0500</bug_when>
    <thetext>Postgres&apos;s --with-dtrace option also carries compatibility for systemtap. Node.js doesn&apos;t... it specifically requires Dtrace (which isn&apos;t available on Fedora).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10073218</commentid>
    <comment_count>3</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-17 14:13:22 -0500</bug_when>
    <thetext>(In reply to Stephen Gallagher from comment #2)
&gt; Postgres&apos;s --with-dtrace option also carries compatibility for systemtap.
&gt; Node.js doesn&apos;t... it specifically requires Dtrace (which isn&apos;t available on
&gt; Fedora).

I guess that&apos;s is no longer the case. 
# ./configure --help | grep -i tap
 --systemtap-includes=SYSTEMTAP_INCLUDES
                        directory containing systemtap header files

So node does know about systemtap.

Second, here&apos;s a blog post by Brendan Gregg showing nodejs provides USDT tracepoints which the kernel BPF
can use: http://www.brendangregg.com/blog/2016-10-12/linux-bcc-nodejs-usdt.html

Finally, I&apos;ve just pulled and successfully compiled node once with --with-dtrace and once without. Turning that flag produces a binary which includes the USDTs missing from the currently shipped fedora package.

# readelf -n ~/bin/node

&lt;...&gt;
Displaying notes found at file offset 0x01b809bc with length 0x000003c4:
  Owner                 Data size	Description
  stapsdt              0x0000003c	NT_STAPSDT (SystemTap probe descriptors)
    Provider: node
    Name: gc__start 
&lt;...&gt;

Please turn on --with-dtrace for node.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10073227</commentid>
    <comment_count>4</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-17 14:16:31 -0500</bug_when>
    <thetext>I noticed that Node now also has --with-lttng, but I don&apos;t know that offers anything beyond --with-dtrace beyond requiring different tools. FYI.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10073241</commentid>
    <comment_count>5</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-17 14:23:37 -0500</bug_when>
    <thetext>From Node Changelog (https://github.com/nodejs/node/commit/38c0c47bbe280ddc42054418091571e532d82a1e)


-2013.05.13, Version 0.11.2 (Unstable)
+2013.06.26, Version 0.11.3 (Unstable) 
&lt;...&gt;
+* dtrace: unify dtrace and systemtap interfaces (Timothy J Fontaine)

first fedora package dates to 2012, but tracing support for systemtap on linux has been possible for 2+ years. Recently, with
kernel 4.9, it&apos;s finally become possible to use the BPF kernel facilities instead of relying on systemtap to leverage that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10076648</commentid>
    <comment_count>6</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2017-01-18 09:23:08 -0500</bug_when>
    <thetext>Rebuilding the Node.js package in Fedora after adding `BuildRequires: systemtap-sdt-devel` and setting `--with-dtrace` in configure leads to a failure:

https://koji.fedoraproject.org/koji/taskinfo?taskID=17321978

If someone would like to take a look at the spec, it&apos;s https://paste.fedoraproject.org/529733/14847493/

I don&apos;t have any additional time to spend on this today, but if someone wants to propose a correction to that spec, I&apos;m listening.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10078086</commentid>
    <comment_count>7</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-18 17:05:59 -0500</bug_when>
    <thetext>I hate build scripts.

This is a bug in the systemtap provided `dtrace` shim, which fails to properly handle the CFLAGS envar when it contains new line.

From spec:

export CFLAGS=&apos;%{optflags} -g \
               -D_LARGEFILE_SOURCE \
               -D_FILE_OFFSET_BITS=64 \
               -DZLIB_CONST \
               -fno-delete-null-pointer-checks&apos;
export CXXFLAGS=&apos;%{optflags} -g \
                 -D_LARGEFILE_SOURCE \
                 -D_FILE_OFFSET_BITS=64 \
                 -DZLIB_CONST \
                 -fno-delete-null-pointer-checks&apos;

The package compiles if you add the following lines right after:

# Explicit new lines in C(XX)FLAGS can break naive build scripts
export CFLAGS=&quot;$(echo ${CFLAGS} | tr &apos;\n\\&apos; &apos;  &apos;)&quot;
export CXXFLAGS=&quot;$(echo ${CXXFLAGS} | tr &apos;\n\\&apos; &apos;  &apos;)&quot;

I&apos;ve opened an issue on the systemtap bugzilla, see:
https://sourceware.org/bugzilla/show_bug.cgi?id=21063</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10078088</commentid>
    <comment_count>8</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-18 17:07:44 -0500</bug_when>
    <thetext>I want those two hours of my life back, dammit.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10080229</commentid>
    <comment_count>9</comment_count>
    <who name="Stephen Gallagher">sgallagh</who>
    <bug_when>2017-01-19 08:50:16 -0500</bug_when>
    <thetext>(In reply to Kinston Hughes from comment #7)
&gt; I hate build scripts.
&gt; 
&gt; This is a bug in the systemtap provided `dtrace` shim, which fails to
&gt; properly handle the CFLAGS envar when it contains new line.

That was some mighty fine detective work, Kinston! Thanks very much for tracking it down. I doubt I&apos;d have put in enough effort to find that.

I&apos;m running a scratch build now; assuming it succeeds, I will push it to dist-git and do an official build for Rawhide, F25 and EPEL 7.

p.s. I gave you credit in the Changelog.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10081504</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-19 14:28:34 -0500</bug_when>
    <thetext>nodejs-6.9.4-2.fc25 libuv-1.10.2-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-922de2d990</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10081508</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-19 14:28:51 -0500</bug_when>
    <thetext>nodejs-6.9.4-2.el7 libuv-1.10.2-1.el7 has been submitted as an update to Fedora EPEL 7. https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-834d4d8dc8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10081897</commentid>
    <comment_count>12</comment_count>
    <who name="Kinston Hughes">k2683901</who>
    <bug_when>2017-01-19 16:39:05 -0500</bug_when>
    <thetext>Thanks! 

Side note, I had the CFLAGS envars still set in a terminal after I finished investigating and a bunch of other unrelated projects I compiled exhibited mysterious deaths as well. I&apos;m too frightened to go near the fedora packaging guidelines , but it just seems like doing multi-line envars in the SPEC file should be a no-no.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10084673</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-20 13:47:18 -0500</bug_when>
    <thetext>libuv-1.10.2-1.el7, nodejs-6.9.4-2.el7 has been pushed to the Fedora EPEL 7 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-EPEL-2017-834d4d8dc8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10084863</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-20 14:56:03 -0500</bug_when>
    <thetext>libuv-1.10.2-1.fc25, nodejs-6.9.4-2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-922de2d990</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10086048</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-21 14:22:25 -0500</bug_when>
    <thetext>libuv-1.10.2-1.fc25, nodejs-6.9.4-2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10125954</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-06 22:47:10 -0500</bug_when>
    <thetext>libuv-1.10.2-1.el7, nodejs-6.9.4-2.el7 has been pushed to the Fedora EPEL 7 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>