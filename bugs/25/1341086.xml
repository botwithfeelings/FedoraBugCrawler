<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1341086</bug_id>
          
          <creation_ts>2016-05-31 04:57:00 -0400</creation_ts>
          <short_desc>dnf install exists with 0 even if it did not install all packages</short_desc>
          <delta_ts>2016-12-02 10:20:33 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>dnf</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>RAWHIDE</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Triaged</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jan Pazdziora">jpazdziora</reporter>
          <assigned_to name="Jaroslav Mracek">jmracek</assigned_to>
          <cc>ffesti</cc>
    
    
    <cc>jmracek</cc>
    
    
    <cc>jpazdziora</cc>
    
    
    <cc>jsilhan</cc>
    
    
    <cc>mluscon</cc>
    
    
    <cc>packaging-team-maint</cc>
    
    
    <cc>pnemade</cc>
    
    
    <cc>vmukhame</cc>
    
    
    <cc>zbyszek</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in></cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-12-02 10:20:33</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9371391</commentid>
    <comment_count>0</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-05-31 04:57:49 -0400</bug_when>
    <thetext>Description of problem:

man dnf(8) says:

       dnf [options] install &lt;spec&gt;...
              DNF makes sure that the given packages  and  their  dependencies
              are  installed  on  the  system.  Each  &lt;spec&gt;  can  be either a
              &lt;package-spec&gt;, or a @&lt;group-spec&gt;. See Install Examples.  If  a
              given  package  or  provide  cannot  be  (and  is  not  already)
              installed, the exit code will be non-zero.

That does not seem to be the case when the package installation fails due to cpio error, for example.

Version-Release number of selected component (if applicable):

dnf-1.1.6-2.fc23.noarch

How reproducible:

Deterministic.

Steps to Reproduce:
1. docker run --rm -ti fedora:23 dnf install -y opencryptoki ; echo $?

Actual results:

$ docker run --rm -ti fedora:23 dnf install -y opencryptoki
Fedora 23 - x86_64                               58 MB/s |  43 MB     00:00    
Fedora 23 - x86_64 - Updates                     51 MB/s |  22 MB     00:00    
Last metadata expiration check performed 0:00:11 ago on Tue May 31 08:53:10 2016.
Dependencies resolved.
================================================================================
 Package                    Arch         Version            Repository     Size
================================================================================
Installing:
 opencryptoki               x86_64       3.4.1-1.fc23       updates       101 k
 opencryptoki-icsftok       x86_64       3.4.1-1.fc23       updates       228 k
 opencryptoki-libs          x86_64       3.4.1-1.fc23       updates        45 k

Transaction Summary
================================================================================
Install  3 Packages

Total download size: 373 k
Installed size: 1.0 M
Downloading Packages:
(1/3): opencryptoki-libs-3.4.1-1.fc23.x86_64.rp 351 kB/s |  45 kB     00:00    
(2/3): opencryptoki-3.4.1-1.fc23.x86_64.rpm     780 kB/s | 101 kB     00:00    
(3/3): opencryptoki-icsftok-3.4.1-1.fc23.x86_64 1.4 MB/s | 228 kB     00:00    
--------------------------------------------------------------------------------
Total                                           167 kB/s | 373 kB     00:02     
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Installing  : opencryptoki-libs-3.4.1-1.fc23.x86_64                       1/3 
  Installing  : opencryptoki-icsftok-3.4.1-1.fc23.x86_64                    2/3 
  Installing  : opencryptoki-3.4.1-1.fc23.x86_64                            3/3 
Error unpacking rpm package opencryptoki-3.4.1-1.fc23.x86_64
Error unpacking rpm package opencryptoki-3.4.1-1.fc23.x86_64
error: unpacking of archive failed on file /var/lock/opencryptoki: cpio: mkdir
opencryptoki-3.4.1-1.fc23.x86_64 was supposed to be installed but is not!
  Verifying   : opencryptoki-3.4.1-1.fc23.x86_64                            1/3 
  Verifying   : opencryptoki-libs-3.4.1-1.fc23.x86_64                       2/3 
  Verifying   : opencryptoki-icsftok-3.4.1-1.fc23.x86_64                    3/3 

Installed:
  opencryptoki-icsftok.x86_64 3.4.1-1.fc23                                      
  opencryptoki-libs.x86_64 3.4.1-1.fc23                                         

Failed:
  opencryptoki.x86_64 3.4.1-1.fc23                                              

Complete!
$ echo $?
0

Expected results:

The exit status should be 1.

Additional info:

Due to bug 1341079, package is not installed, dnf even reports is in the &quot;Failed&quot; section, but still exists with 0.

This breaks container image builds because in build time, RUN commands exit with success and then the image does not contain what it is supposed to and what the author expects.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9389399</commentid>
    <comment_count>1</comment_count>
    <who name="Igor Gnatenko">ignatenko</who>
    <bug_when>2016-06-06 05:42:01 -0400</bug_when>
    <thetext>yes, looks like a bug...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9490433</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Admin XMLRPC Client">fedora-admin-xmlrpc</who>
    <bug_when>2016-07-08 05:36:38 -0400</bug_when>
    <thetext>This package has changed ownership in the Fedora Package Database.  Reassigning to the new owner of this component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9566684</commentid>
    <comment_count>3</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-07-29 07:34:32 -0400</bug_when>
    <thetext>I created a PR: https://github.com/rpm-software-management/dnf/pull/552</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9566733</commentid>
    <comment_count>4</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-07-29 07:44:09 -0400</bug_when>
    <thetext>The PR description - It returns 1 if one or more packages were not installed or removed (was supposed to be installed but is not!), but there is not roll-back of transaction, therefore correctly installed packages are still present on system.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9791331</commentid>
    <comment_count>5</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-10-14 06:20:32 -0400</bug_when>
    <thetext>Probably we can still improve the verification of packages on RPM level. Please Florian can you share with us your opinion for the bugzila and proposed patch? Any information provided will be very helpful.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9814698</commentid>
    <comment_count>6</comment_count>
    <who name="Florian Festi">ffesti</who>
    <bug_when>2016-10-24 05:45:27 -0400</bug_when>
    <thetext>Well, the error handling on the rpm level is not that great. It skips subsequent related transaction members like the removals of failed updates but that&apos;s basically all it does. So returning 1 and reporting the error is probably the best thing dnf can do unless rpm grows some better recovery mechanisms.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9866400</commentid>
    <comment_count>7</comment_count>
    <who name="Jaroslav Mracek">jmracek</who>
    <bug_when>2016-11-07 07:25:19 -0500</bug_when>
    <thetext>*** Bug 1392061 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9928040</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora End Of Life">jkurik</who>
    <bug_when>2016-11-25 04:10:07 -0500</bug_when>
    <thetext>This message is a reminder that Fedora 23 is nearing its end of life.
Approximately 4 (four) weeks from now Fedora will stop maintaining
and issuing updates for Fedora 23. It is Fedora&apos;s policy to close all
bug reports from releases that are no longer maintained. At that time
this bug will be closed as EOL if it remains open with a Fedora  &apos;version&apos;
of &apos;23&apos;.

Package Maintainer: If you wish for this bug to remain open because you
plan to fix it in a currently maintained version, simply change the &apos;version&apos; 
to a later Fedora version.

Thank you for reporting this issue and we are sorry that we were not 
able to fix it before Fedora 23 is end of life. If you would still like 
to see this bug fixed and are able to reproduce it against a later version 
of Fedora, you are encouraged  change the &apos;version&apos; to a later Fedora 
version prior this bug is closed as described in the policy above.

Although we aim to fix as many bugs as possible during every release&apos;s 
lifetime, sometimes those efforts are overtaken by events. Often a 
more recent Fedora release includes newer upstream software that fixes 
bugs or makes them obsolete.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9930075</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Pazdziora">jpazdziora</who>
    <bug_when>2016-11-25 08:58:47 -0500</bug_when>
    <thetext>Issue still present with dnf-1.1.10-3.fc25.noarch.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>