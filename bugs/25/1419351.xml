<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1419351</bug_id>
          
          <creation_ts>2017-02-05 13:20:00 -0500</creation_ts>
          <short_desc>on boot exports fail due to network not up</short_desc>
          <delta_ts>2017-06-01 13:35:02 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>nfs-utils</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>CURRENTRELEASE</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1409012</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>medium</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Tom Shield">twshield</reporter>
          <assigned_to name="Steve Dickson">steved</assigned_to>
          <cc>bcodding</cc>
    
    
    <cc>bfields</cc>
    
    
    <cc>jiyin</cc>
    
    
    <cc>jlayton</cc>
    
    
    <cc>smayhew</cc>
    
    
    <cc>steved</cc>
    
    
    <cc>twshield</cc>
    
    
    <cc>watanabe.yu+redhat.bugzilla</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>nfs-utils-2.1.1-4.rc2.fc26 nfs-utils-2.1.1-4.rc2.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-06-01 13:35:02</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10121971</commentid>
    <comment_count>0</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-02-05 13:20:47 -0500</bug_when>
    <thetext>Description of problem:

On boot exports fail:

Feb 02 15:19:05 localhost.localdomain systemd[1]: Starting NFS server and services...
Feb 02 15:19:05 localhost.localdomain exportfs[912]: exportfs: Failed to resolve yflyer
(and rest of export list fails similarly)

Version-Release number of selected component (if applicable):

nfs-utils-2.1.1-1.fc25.x86_64

How reproducible:

every time

Steps to Reproduce:
1. enable nfs-server to start on boot.  Add exports to /etc/exports. Using NetworkManager to start wired network via dhcp.  Have NetworkManager-wait-online.service enabled.
2.  reboot
3.  

Actual results:

exports are not exported

Expected results:

exports will be exported

Additional info:

Note error messages above: nfs server is trying to do export even before local host name is set from dhcp using systemd-hostnamed.service.

Adding

After=network-online.target

to nfs-server.service solves the problem.

I did not have this problem in Fedora 23 (I did not even have NetworkManager-wait-online enabled there) on the same machine (I just rebooted back into F23 to check).

Openvpn also has the same problem (and the same solution works), so I don&apos;t know if this is a problem with nfs-utils or NetworkManager or systemd. Or perhaps a change that was made to NetworkManager or systemd that makes this addition necessary.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10314757</commentid>
    <comment_count>1</comment_count>
    <who name="Steve Dickson">steved</who>
    <bug_when>2017-04-07 11:12:30 -0400</bug_when>
    <thetext>Started the upstream discussion 
    http://marc.info/?l=linux-nfs&amp;m=149157766819591&amp;w=2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10322115</commentid>
    <comment_count>2</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-10 18:57:13 -0400</bug_when>
    <thetext>nfs-utils-2.1.1-4.rc2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-bca43e3f7e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10322302</commentid>
    <comment_count>3</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-10 20:26:43 -0400</bug_when>
    <thetext>nfs-utils-2.1.1-4.rc2.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-218c78b2e7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10322472</commentid>
    <comment_count>4</comment_count>
    <who name="Yu Watanabe">watanabe.yu+redhat.bugzilla</who>
    <bug_when>2017-04-10 21:41:21 -0400</bug_when>
    <thetext>Why do you only add Wants=network-online.target ?
Wants= option is independent of After= option.
So you should also add After=network-online.target, unless if you really do not want to care the order of that the network becomes online and that the NFS related services are started.

See systemd.unit(5). In the description of the &quot;Requires=&quot; option,
&gt; If a unit foo.service requires a unit bar.service as configured 
&gt; with Requires= and no ordering is configured with After= or Before=, 
&gt; then both units will be started simultaneously and without any 
&gt; delay between them if foo.service is activated.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10326095</commentid>
    <comment_count>5</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-04-11 15:18:04 -0400</bug_when>
    <thetext>I installed nfs-utils-2.1.1-4.rc2.fc25.x86_64 and moved my service file in /etc/systemd/system out of the way, disabled and re-enabled nfs-server and rebooted:

[root@taylor ~]# journalctl -r -u nfs-server.service
-- Logs begin at Mon 2017-01-16 13:19:53 CST, end at Tue 2017-04-11 14:11:28 CDT. --
Apr 11 14:10:41 localhost.localdomain systemd[1]: Started NFS server and services.
Apr 11 14:10:41 localhost.localdomain exportfs[830]: exportfs: Failed to resolve laser

so I agree that wants is not enough, my addition of after as above is what works for me.

Restarting the nfs-server.service does bring it up.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10331345</commentid>
    <comment_count>6</comment_count>
    <who name="Steve Dickson">steved</who>
    <bug_when>2017-04-12 20:12:03 -0400</bug_when>
    <thetext>(In reply to Yu Watanabe from comment #4)
&gt; Why do you only add Wants=network-online.target ?
&gt; Wants= option is independent of After= option.
&gt; So you should also add After=network-online.target, unless if you really do
&gt; not want to care the order of that the network becomes online and that the
&gt; NFS related services are started.
There is the upstream discussion
    https://www.spinics.net/lists/linux-nfs/msg63132.html

It seems the systemd.special(7) man page says to use Wants=

Units that strictly require a configured network connection should
pull in network-online.target (via a Wants= type dependency) and
order themselves after it. This target unit is intended to pull in
a service that delays further execution until the network is
sufficiently set up. What precisely this requires is left to the
implementation of the network managing service.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10331392</commentid>
    <comment_count>7</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-04-12 20:21:51 -0400</bug_when>
    <thetext>(In reply to Steve Dickson from comment #6)
&gt; (In reply to Yu Watanabe from comment #4)
&gt; &gt; Why do you only add Wants=network-online.target ?
&gt; &gt; Wants= option is independent of After= option.
&gt; &gt; So you should also add After=network-online.target, unless if you really do
&gt; &gt; not want to care the order of that the network becomes online and that the
&gt; &gt; NFS related services are started.
&gt; There is the upstream discussion
&gt;     https://www.spinics.net/lists/linux-nfs/msg63132.html
&gt; 
&gt; It seems the systemd.special(7) man page says to use Wants=
&gt; 
&gt; Units that strictly require a configured network connection should
&gt; pull in network-online.target (via a Wants= type dependency) and
&gt; order themselves after it. This target unit is intended to pull in
&gt; a service that delays further execution until the network is
&gt; sufficiently set up. What precisely this requires is left to the
&gt; implementation of the network managing service.

I read &quot;and order themselves after it&quot; to mean that you should also use After= along with Wants=.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10336052</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-14 13:20:11 -0400</bug_when>
    <thetext>nfs-utils-2.1.1-4.rc2.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10344318</commentid>
    <comment_count>9</comment_count>
    <who name="Yu Watanabe">watanabe.yu+redhat.bugzilla</who>
    <bug_when>2017-04-19 02:35:36 -0400</bug_when>
    <thetext>(In reply to Tom Shield from comment #7)
&gt; I read &quot;and order themselves after it&quot; to mean that you should also use
&gt; After= along with Wants=.

Yes. Right.
Please do not close this bug. This bug is not fixed yet.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10344901</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-19 05:23:36 -0400</bug_when>
    <thetext>nfs-utils-2.1.1-4.rc2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10346426</commentid>
    <comment_count>11</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-04-19 11:27:45 -0400</bug_when>
    <thetext>(In reply to Fedora Update System from comment #10)
&gt; nfs-utils-2.1.1-4.rc2.fc25 has been pushed to the Fedora 25 stable
&gt; repository. If problems still persist, please make note of it in this bug
&gt; report.

Already did note that this is not fixed.  See comment #5.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10346473</commentid>
    <comment_count>12</comment_count>
    <who name="Steve Dickson">steved</who>
    <bug_when>2017-04-19 11:42:53 -0400</bug_when>
    <thetext>(In reply to Tom Shield from comment #5)
&gt; I installed nfs-utils-2.1.1-4.rc2.fc25.x86_64 and moved my service file in
&gt; /etc/systemd/system out of the way, disabled and re-enabled nfs-server and
&gt; rebooted:
If you moved a service file out of the way, How do you expect things to work?

&gt; 
&gt; [root@taylor ~]# journalctl -r -u nfs-server.service
&gt; -- Logs begin at Mon 2017-01-16 13:19:53 CST, end at Tue 2017-04-11 14:11:28
&gt; CDT. --
&gt; Apr 11 14:10:41 localhost.localdomain systemd[1]: Started NFS server and
&gt; services.
&gt; Apr 11 14:10:41 localhost.localdomain exportfs[830]: exportfs: Failed to
&gt; resolve laser
&gt; 
&gt; so I agree that wants is not enough, my addition of after as above is what
&gt; works for me.
&gt; 
&gt; Restarting the nfs-server.service does bring it up.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10346502</commentid>
    <comment_count>13</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-04-19 11:52:08 -0400</bug_when>
    <thetext>(In reply to Steve Dickson from comment #12)
&gt; (In reply to Tom Shield from comment #5)
&gt; &gt; I installed nfs-utils-2.1.1-4.rc2.fc25.x86_64 and moved my service file in
&gt; &gt; /etc/systemd/system out of the way, disabled and re-enabled nfs-server and
&gt; &gt; rebooted:
&gt; If you moved a service file out of the way, How do you expect things to work?
&gt; 

Note the path.  I moved my edited service file (as described in the original bug report) in /etc/systemd/system out of the way so that the updated one in /lib/systemd/system would be picked up and linked to by the enable command.

When you put edited/custom service files in /etc/systemd/system (so updates don&apos;t over write them) you need to disable and enable the service again to get the links updated.  Same is true when you remove a service file in /etc/systemd/system.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10346506</commentid>
    <comment_count>14</comment_count>
    <who name="Steve Dickson">steved</who>
    <bug_when>2017-04-19 11:54:54 -0400</bug_when>
    <thetext>Note, I started an upstream discussion 
    http://marc.info/?l=linux-nfs&amp;m=149261158415078&amp;w=2

Maybe you could add to it?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10357555</commentid>
    <comment_count>15</comment_count>
    <who name="Steve Dickson">steved</who>
    <bug_when>2017-04-24 12:53:03 -0400</bug_when>
    <thetext>The upstream posting
   http://marc.info/?l=linux-nfs&amp;m=149304767813604&amp;w=2</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10401788</commentid>
    <comment_count>16</comment_count>
    <who name="Tom Shield">twshield</who>
    <bug_when>2017-05-10 15:14:52 -0400</bug_when>
    <thetext>just installed nfs-utils.x86_64 1:2.1.1-5.rc2.fc25 and rebooted.  Nfs exports succeeded.  Addition of After= network-online.target seems to have solved the problem.  Thanks.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>