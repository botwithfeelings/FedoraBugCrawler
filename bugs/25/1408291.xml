<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1408291</bug_id>
          
          <creation_ts>2016-12-22 14:29:00 -0500</creation_ts>
          <short_desc>c++ optimization breaks exception handling</short_desc>
          <delta_ts>2017-02-09 15:49:44 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>gtest</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Merlin Mathesius">mmathesi</reporter>
          <assigned_to name="Terje RÃ¸sten">terjeros</assigned_to>
          <cc>davejohansen</cc>
    
    
    <cc>helio</cc>
    
    
    <cc>jakub</cc>
    
    
    <cc>jwakely</cc>
    
    
    <cc>law</cc>
    
    
    <cc>mpolacek</cc>
    
    
    <cc>psabata</cc>
    
    
    <cc>sgallagh</cc>
    
    
    <cc>tagoh</cc>
    
    
    <cc>terjeros</cc>
    
    
    <cc>tstclair</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>gtest-1.7.0-8.fc25 gtest-1.7.0-8.fc24</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-02-08 23:20:59</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10016995</commentid>
    <comment_count>0</comment_count>
    <who name="Merlin Mathesius">mmathesi</who>
    <bug_when>2016-12-22 14:29:56 -0500</bug_when>
    <thetext>Description of problem:
When attempting to rebuild the gtest-1.7.0 package in Fedora 25, we discovered the build was failing due to self-test failures. Further investigation revealed that the package build and self-tests would succeed if the default C++ optimization flag (-O2) was removed. It was found that executables compiled with C++  optimization would segfault instead of properly handling exceptions.

Version-Release number of selected component (if applicable):
gcc-c++-6.2.1-2.fc25.x86_64

How reproducible:
Every time

Steps to Reproduce:
1. sudo dnf install gcc-c++ cmake
2. mkdir workspace
3. cd workspace
4. wget https://github.com/google/googletest/archive/release-1.7.0/gtest-1.7.0.zip
5. unzip gtest-1.7.0.zip
6. GTEST_DIR=$(pwd)/googletest-release-1.7.0
7. mkdir build-unopt
8. pushd build-unopt
9. cmake -Dgtest_build_tests=ON ${GTEST_DIR}
10. VERBOSE=1 make CXX_FLAGS= gtest_catch_exceptions_ex_test_ gtest_catch_exceptions_no_ex_test_
11. ctest -R gtest_catch_exceptions_test
12. ./gtest_catch_exceptions_ex_test_
13. ./gtest_catch_exceptions_no_ex_test_
14. popd
15. mkdir build-optimized
16. pushd build-optimized
17. cmake -Dgtest_build_tests=ON ${GTEST_DIR}
18. VERBOSE=1 make CXX_FLAGS=-O gtest_catch_exceptions_ex_test_ gtest_catch_exceptions_no_ex_test_
19. ctest -R gtest_catch_exceptions_test
20. ./gtest_catch_exceptions_ex_test_
21. ./gtest_catch_exceptions_no_ex_test_

Actual results:

&quot;ctest -R gtest_catch_exceptions_test&quot; passes when executables are compiled without optimization, but fails when compiled with optimization.

When the compiled executables (./gtest_catch_exceptions_ex_test_ and ./gtest_catch_exceptions_no_ex_test_) are run directly from the command line, the UN-optimized versions run to completion with the gtest framework catching the exceptions. The optimized versions segfault--which is why the above &quot;ctest ...&quot; fails.

Expected results:

&quot;ctest -R gtest_catch_exceptions_test&quot; should always pass, regardless if the binaries are compiled with optimization or not.

The compiled executables should not segfault when run directly, regardless if the binaries are compiled with optimization or not.

Additional info:

Upstream googletest framework is aware of this problem:
    https://github.com/google/googletest/issues/845

This issue is causing gtest-1.7.0 to fail to build from source in Fedora:
    https://bugzilla.redhat.com/show_bug.cgi?id=1406937</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10017095</commentid>
    <comment_count>1</comment_count>
    <who name="Jonathan Wakely">jwakely</who>
    <bug_when>2016-12-22 15:55:33 -0500</bug_when>
    <thetext>This is almost certainly a known bug in gtest, caused by calling member functions through a null pointer. See &quot;Optimizations remove null pointer checks for this&quot; at https://gcc.gnu.org/gcc-6/porting_to.html</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10017097</commentid>
    <comment_count>2</comment_count>
    <who name="Jonathan Wakely">jwakely</who>
    <bug_when>2016-12-22 15:56:56 -0500</bug_when>
    <thetext>The stack trace in the github issue confirms it, it shows this=0x0 at the point of failure. This is not a gcc bug. The code has undefined behaviour.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10017105</commentid>
    <comment_count>3</comment_count>
    <who name="Jonathan Wakely">jwakely</who>
    <bug_when>2016-12-22 16:05:02 -0500</bug_when>
    <thetext>Using CXX_FLAGS=&quot;-O -fno-delete-null-pointer-checks&quot; confirms it. Changing component to gtest, where the problem is.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10017401</commentid>
    <comment_count>4</comment_count>
    <who name="Jonathan Wakely">jwakely</who>
    <bug_when>2016-12-22 21:02:18 -0500</bug_when>
    <thetext>Patch here: https://github.com/google/googletest/pull/967.patch

Beware of bugs in the patch; I have only proved it correct, not tried it ;)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10089822</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-23 13:54:56 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-0caadc8ba7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10089824</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-23 13:55:09 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc24 has been submitted as an update to Fedora 24. https://bodhi.fedoraproject.org/updates/FEDORA-2017-cec378cd2f</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10093944</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-24 20:22:19 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc24 has been pushed to the Fedora 24 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-cec378cd2f</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10103671</commentid>
    <comment_count>8</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-01-28 14:19:03 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-0caadc8ba7</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10133137</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-08 23:20:59 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10135956</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-09 15:49:44 -0500</bug_when>
    <thetext>gtest-1.7.0-8.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>