<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1353999</bug_id>
          
          <creation_ts>2016-07-08 12:32:00 -0400</creation_ts>
          <short_desc>CNFE when running thermostat web-storage-service with jetty 9.4.0.M0</short_desc>
          <delta_ts>2016-10-08 22:54:24 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>thermostat</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>http://icedtea.classpath.org/bugzilla/show_bug.cgi?id=3125</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Severin Gehwolf">sgehwolf</reporter>
          <assigned_to name="Severin Gehwolf">sgehwolf</assigned_to>
          <cc>ebaron</cc>
    
    
    <cc>eclipse-sig</cc>
    
    
    <cc>java-sig-commits</cc>
    
    
    <cc>jerboaa</cc>
    
    
    <cc>krzysztof.daniel</cc>
    
    
    <cc>mizdebsk</cc>
    
    
    <cc>msimacek</cc>
    
    
    <cc>omajid</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>thermostat-1.6.4-2.fc25</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2016-10-08 22:54:24</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>9491599</commentid>
    <comment_count>0</comment_count>
      <attachid>1177703</attachid>
    <who name="Severin Gehwolf">sgehwolf</who>
    <bug_when>2016-07-08 12:32:45 -0400</bug_when>
    <thetext>Created attachment 1177703
Proposed fix which works for us.

Description of problem:
This is an upstream bug in upcoming jetty 9.4.0. Caused by this refactoring:
https://github.com/eclipse/jetty.project/commit/a311c8bde171551a57ff28c04851a3b53acfc1e0

Version-Release number of selected component (if applicable):
$ rpm -q jetty-server
jetty-server-9.4.0-0.2.M0.fc25.noarch
$ rpm -q thermostat
thermostat-1.6.0-1.fc25.x86_64

How reproducible:
100%

Steps to Reproduce:
1. dnf install thermostat-webapp (A mock setup will do too)
2. echo -e &apos;yes\nm\nm\nm\nc\nc\nc\na\na\na&apos; | thermostat setup -c
3. thermostat web-storage-service

Actual results:
starting storage server...
server listening on ip: mongodb://127.0.0.1:27518
log file is here: /root/.thermostat-1.6/logs/db.log
pid: 8285
2016-07-08 15:01:52.035:INFO::Thread-3: Logging initialized @1374ms
2016-07-08 15:01:52.083:INFO:oejs.Server:Thread-3: jetty-9.4.0.M0
2016-07-08 15:01:52.083:WARN:oejs.Server:Thread-3: THIS IS NOT A STABLE RELEASE! DO NOT USE IN PRODUCTION!
2016-07-08 15:01:52.083:WARN:oejs.Server:Thread-3: Download a stable release from http://download.eclipse.org/jetty/
2016-07-08 15:01:52.092:WARN:oejw.WebAppContext:Thread-3: Failed startup of context o.e.j.w.WebAppContext@6cdce5ed{/thermostat/storage,null,null}{/usr/share/thermostat/webapp}
java.lang.ClassNotFoundException: org.eclipse.jetty.webapp.WebInfConfiguration
        at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
        at org.eclipse.jetty.util.Loader.loadClass(Loader.java:65)
        at org.eclipse.jetty.webapp.WebAppContext.loadConfigurations(WebAppContext.java:931)
        at org.eclipse.jetty.webapp.WebAppContext.preConfigure(WebAppContext.java:451)
        at org.eclipse.jetty.webapp.WebAppContext.doStart(WebAppContext.java:520)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.start(AbstractLifeCycle.java:68)
        at org.eclipse.jetty.util.component.ContainerLifeCycle.start(ContainerLifeCycle.java:132)
        at org.eclipse.jetty.server.Server.start(Server.java:437)
        at org.eclipse.jetty.util.component.ContainerLifeCycle.doStart(ContainerLifeCycle.java:106)
        at org.eclipse.jetty.server.handler.AbstractHandler.doStart(AbstractHandler.java:93)
        at org.eclipse.jetty.server.Server.doStart(Server.java:404)
        at org.eclipse.jetty.util.component.AbstractLifeCycle.start(AbstractLifeCycle.java:68)
        at com.redhat.thermostat.web.endpoint.internal.JettyContainerLauncher.doStartContainerAndDeployWar(JettyContainerLauncher.java:214)
        at com.redhat.thermostat.web.endpoint.internal.JettyContainerLauncher.startContainerAndDeployWar(JettyContainerLauncher.java:125)
        at com.redhat.thermostat.web.endpoint.internal.JettyContainerLauncher.access$000(JettyContainerLauncher.java:77)
        at com.redhat.thermostat.web.endpoint.internal.JettyContainerLauncher$1.run(JettyContainerLauncher.java:99)
        at java.lang.Thread.run(Thread.java:745)
server shutdown complete: /root/.thermostat-1.6/data/db
log file is here: /root/.thermostat-1.6/logs/db.log
Failed to start embedded jetty instance

Expected results:
No ClassNotFoundException and successful startup.

Additional info:
This is likely only reproducible when jetty is being started within an OSGi environment. Such is the case for &quot;thermostat web-storage-service&quot;.

Note that the code in Loader around line 65 looks like this:

    @SuppressWarnings(&quot;rawtypes&quot;)
    public static Class loadClass(String name)
        throws ClassNotFoundException
    {
        ClassLoader loader=Thread.currentThread().getContextClassLoader();
        return (loader==null ) ? Class.forName(name) : loader.loadClass(name);
    }

loader in this context points to the app class loader which booted up the OSGi framework. However, the OSGi bundle jetty-webapp was loaded as a bundle and thus, classes inside it will get loaded with the bundles class loader. Then TCCL won&apos;t see the relevant config classes in the webapp bundle whereas the bundle class loader would see it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9491644</commentid>
    <comment_count>1</comment_count>
    <who name="Severin Gehwolf">sgehwolf</who>
    <bug_when>2016-07-08 12:54:00 -0400</bug_when>
    <thetext>Upstream issue:
https://github.com/eclipse/jetty.project/issues/705</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9509117</commentid>
    <comment_count>2</comment_count>
    <who name="Severin Gehwolf">sgehwolf</who>
    <bug_when>2016-07-14 08:12:29 -0400</bug_when>
    <thetext>We&apos;ve worked around this in thermostat-1.6.0-2.fc25</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9549587</commentid>
    <comment_count>3</comment_count>
    <who name="Jan Kurik">jkurik</who>
    <bug_when>2016-07-26 00:46:21 -0400</bug_when>
    <thetext>This bug appears to have been reported against &apos;rawhide&apos; during the Fedora 25 development cycle.
Changing version to &apos;25&apos;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9581637</commentid>
    <comment_count>4</comment_count>
    <who name="Severin Gehwolf">sgehwolf</who>
    <bug_when>2016-08-03 09:53:57 -0400</bug_when>
    <thetext>Upstream discussion convinced me that there is likely not much to be done on the jetty side. Re-assigning to thermostat component.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9722203</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-19 12:33:44 -0400</bug_when>
    <thetext>thermostat-1.6.4-2.fc25 jgraphx-3.6.0.0-1.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2016-8e90151ad6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9727579</commentid>
    <comment_count>6</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-09-20 15:57:36 -0400</bug_when>
    <thetext>jgraphx-3.6.0.0-1.fc25, thermostat-1.6.4-2.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2016-8e90151ad6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>9775803</commentid>
    <comment_count>7</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2016-10-08 22:54:24 -0400</bug_when>
    <thetext>jgraphx-3.6.0.0-1.fc25, thermostat-1.6.4-2.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1177703</attachid>
            <date>2016-07-08 12:32:00 -0400</date>
            <delta_ts>2016-07-08 12:33:44 -0400</delta_ts>
            <desc>Proposed fix which works for us.</desc>
            <filename>0001-Fix-WebAppContext-context-class-loading.patch</filename>
            <type>text/plain</type>
            <size>2813</size>
            <attacher name="Severin Gehwolf">sgehwolf</attacher>
            
              <data encoding="base64">RnJvbSBiZTcyZDUxOGZlYzI5YTBhMzY4OTZkNmRmY2JjMTIzZTIwYmY0YjM5IE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBTZXZlcmluIEdlaHdvbGYgPHNnZWh3b2xmQHJlZGhhdC5jb20+
CkRhdGU6IEZyaSwgOCBKdWwgMjAxNiAxODoxOTo0NCArMDIwMApTdWJqZWN0OiBbUEFUQ0hdIEZp
eCBXZWJBcHBDb250ZXh0IGNvbnRleHQgY2xhc3MgbG9hZGluZy4KCi0tLQogamV0dHkuc3BlYyAg
ICAgICAgICAgICAgICAgICAgIHwgIDcgKysrKysrLQogd2ViYXBwY29udGV4dF9sb2FkZXJfZml4
LnBhdGNoIHwgMTMgKysrKysrKysrKysrKwogMiBmaWxlcyBjaGFuZ2VkLCAxOSBpbnNlcnRpb25z
KCspLCAxIGRlbGV0aW9uKC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgd2ViYXBwY29udGV4dF9sb2Fk
ZXJfZml4LnBhdGNoCgpkaWZmIC0tZ2l0IGEvamV0dHkuc3BlYyBiL2pldHR5LnNwZWMKaW5kZXgg
MmRiYjY5Yy4uYWQ1ZDhjYiAxMDA2NDQKLS0tIGEvamV0dHkuc3BlYworKysgYi9qZXR0eS5zcGVj
CkBAIC01NCw3ICs1NCw3IEBACiAKIE5hbWU6ICAgICAgICAgICBqZXR0eQogVmVyc2lvbjogICAg
ICAgIDkuNC4wCi1SZWxlYXNlOiAgICAgICAgMC4yLiV7YWRkdmVyfSV7P2Rpc3R9CitSZWxlYXNl
OiAgICAgICAgMC4zLiV7YWRkdmVyfSV7P2Rpc3R9CiBTdW1tYXJ5OiAgICAgICAgSmF2YSBXZWJz
ZXJ2ZXIgYW5kIFNlcnZsZXQgQ29udGFpbmVyCiAKICMgSmV0dHkgaXMgZHVhbCBsaWNlbnNlZCB1
bmRlciBib3RoIEFTTCAyLjAgYW5kIEVQTCAxLjAsIHNlZSBOT1RJQ0UudHh0CkBAIC02OCw2ICs2
OCw3IEBAIFNvdXJjZTU6ICAgICAgICAle25hbWV9LnNlcnZpY2UKIFNvdXJjZTY6ICAgICAgICBM
SUNFTlNFLU1JVAogCiBQYXRjaDE6ICAgICAgICAgMDAwMS1GZWRvcmEtamV0dHkuaG9tZS5wYXRj
aAorUGF0Y2gyOiAgICAgICAgIHdlYmFwcGNvbnRleHRfbG9hZGVyX2ZpeC5wYXRjaAogCiBCdWls
ZFJlcXVpcmVzOiAgZ2Vyb25pbW8tYW5ub3RhdGlvbgogQnVpbGRSZXF1aXJlczogIGdlcm9uaW1v
LWphc3BpYy1zcGVjCkBAIC02MDQsNiArNjA1LDcgQEAgTGljZW5zZTogICAgICAgIChBU0wgMi4w
IG9yIEVQTCkgYW5kIE1JVAogJXNldHVwIC1xIC1uICV7bmFtZX0ucHJvamVjdC0le25hbWV9LSV7
dmVyc2lvbn0uJXthZGR2ZXJ9CiAKICVwYXRjaDEgLXAxCislcGF0Y2gyIC1wMgogCiBmaW5kIC4g
LW5hbWUgIiouP2FyIiAtZXhlYyBybSB7fSBcOwogZmluZCAuIC1uYW1lICIqLmNsYXNzIiAtZXhl
YyBybSB7fSBcOwpAQCAtMTAwMCw2ICsxMDAyLDkgQEAgZXhpdCAwCiAlZG9jIE5PVElDRS50eHQg
TElDRU5TRSoKIAogJWNoYW5nZWxvZworKiBGcmkgSnVsIDA4IDIwMTYgU2V2ZXJpbiBHZWh3b2xm
IDxzZ2Vod29sZkByZWRoYXQuY29tPiAtIDkuNC4wLTAuMy5NMAorLSBGaXggV2ViQXBwQ29udGV4
dCBjb250ZXh0IGNsYXNzIGxvYWRpbmcuCisKICogVGh1IEp1biAxNiAyMDE2IE1pa29sYWogSXpk
ZWJza2kgPG1pemRlYnNrQHJlZGhhdC5jb20+IC0gOS40LjAtMC4yLk0wCiAtIEFkZCBtaXNzaW5n
IGJ1aWxkLXJlcXVpcmVzCiAKZGlmZiAtLWdpdCBhL3dlYmFwcGNvbnRleHRfbG9hZGVyX2ZpeC5w
YXRjaCBiL3dlYmFwcGNvbnRleHRfbG9hZGVyX2ZpeC5wYXRjaApuZXcgZmlsZSBtb2RlIDEwMDY0
NAppbmRleCAwMDAwMDAwLi5lZTYyNTMwCi0tLSAvZGV2L251bGwKKysrIGIvd2ViYXBwY29udGV4
dF9sb2FkZXJfZml4LnBhdGNoCkBAIC0wLDAgKzEsMTMgQEAKK2RpZmYgLS1naXQgYS9qZXR0eS5w
cm9qZWN0LWpldHR5LTkuNC4wLk0wL2pldHR5LXdlYmFwcC9zcmMvbWFpbi9qYXZhL29yZy9lY2xp
cHNlL2pldHR5L3dlYmFwcC9XZWJBcHBDb250ZXh0LmphdmEgYi9qZXR0eS5wcm9qZWN0LWpldHR5
LTkuNC4wLk0wL2pldHR5LXdlYmFwcC9zcmMvbWFpbi9qYXZhL29yZy9lY2xpcHNlL2pldHR5L3dl
YmFwcC9XZWJBcHBDb250ZXh0LmphdmEKK2luZGV4IDkyNGIyMjMuLjM5MjNjZjkgMTAwNjQ0Cist
LS0gYS9qZXR0eS5wcm9qZWN0LWpldHR5LTkuNC4wLk0wL2pldHR5LXdlYmFwcC9zcmMvbWFpbi9q
YXZhL29yZy9lY2xpcHNlL2pldHR5L3dlYmFwcC9XZWJBcHBDb250ZXh0LmphdmEKKysrKyBiL2pl
dHR5LnByb2plY3QtamV0dHktOS40LjAuTTAvamV0dHktd2ViYXBwL3NyYy9tYWluL2phdmEvb3Jn
L2VjbGlwc2UvamV0dHkvd2ViYXBwL1dlYkFwcENvbnRleHQuamF2YQorQEAgLTkyOCw3ICs5Mjgs
NyBAQCBwdWJsaWMgY2xhc3MgV2ViQXBwQ29udGV4dCBleHRlbmRzIFNlcnZsZXRDb250ZXh0SGFu
ZGxlciBpbXBsZW1lbnRzIFdlYkFwcENsYXNzTAorICAgICAgICAgaWYgKF9jb25maWd1cmF0aW9u
Q2xhc3Nlcy5zaXplKCk9PTApCisgICAgICAgICAgICAgX2NvbmZpZ3VyYXRpb25DbGFzc2VzLmFk
ZEFsbChDb25maWd1cmF0aW9uLkNsYXNzTGlzdC5zZXJ2ZXJEZWZhdWx0KGdldFNlcnZlcigpKSk7
CisgICAgICAgICBmb3IgKFN0cmluZyBjb25maWdDbGFzcyA6IF9jb25maWd1cmF0aW9uQ2xhc3Nl
cykKKy0gICAgICAgICAgICBfY29uZmlndXJhdGlvbnMuYWRkKChDb25maWd1cmF0aW9uKUxvYWRl
ci5sb2FkQ2xhc3MoY29uZmlnQ2xhc3MpLm5ld0luc3RhbmNlKCkpOworKyAgICAgICAgICAgIF9j
b25maWd1cmF0aW9ucy5hZGQoKENvbmZpZ3VyYXRpb24pTG9hZGVyLmxvYWRDbGFzcyh0aGlzLmdl
dENsYXNzKCksIGNvbmZpZ0NsYXNzKS5uZXdJbnN0YW5jZSgpKTsKKyAgICAgfQorIAorICAgICAv
KiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0gKi8KLS0gCjIuNS41Cgo=
</data>

          </attachment>
      

    </bug>

</bugzilla>