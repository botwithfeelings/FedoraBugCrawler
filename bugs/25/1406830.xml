<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1406830</bug_id>
          
          <creation_ts>2016-12-21 10:15:00 -0500</creation_ts>
          <short_desc>using --tmpfs to specify the sizes of things like /run and /tmp get overridden by the hook</short_desc>
          <delta_ts>2017-04-01 12:57:17 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>oci-systemd-hook</component>
          <version>25</version>
          <rep_platform>Unspecified</rep_platform>
          <op_sys>Unspecified</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>Reopened</keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="James Hogarth">james.hogarth</reporter>
          <assigned_to name="Daniel Walsh">dwalsh</assigned_to>
          <cc>amurdaca</cc>
    
    
    <cc>dwalsh</cc>
    
    
    <cc>lsm5</cc>
    
    
    <cc>nalin</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>oci-systemd-hook-0.1.5-1.git16f7c8a.fc25 oci-systemd-hook-0.1.6-1.gitfe22236.fc25 oci-systemd-hook-0.1.6-1.gitfe22236.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-14 13:22:56</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          <external_bugs name="Github">projectatomic/oci-systemd-hook/issues/38</external_bugs>
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10011469</commentid>
    <comment_count>0</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2016-12-21 10:15:25 -0500</bug_when>
    <thetext>Description of problem:
If there&apos;s a preference to set the size allocated to something the hook usually handles (eg /tmp or /run) using --tmpfs this gets overridden by the hook and no longer has any effect

Version-Release number of selected component (if applicable):
docker-1.12.3-12.git97974ae.fc25.x86_64
oci-systemd-hook-0.1.4-3.git41491a3.fc25.x86_64


How reproducible:
deterministic

Steps to Reproduce:
1. 

cat &gt; Dockerfile.systemd-test &lt;&lt; EOF
FROM centos:latest

RUN yum -y install systemd bash
ENTRYPOINT [&quot;/sbin/init&quot;]
EOF


2. docker build -f Dockerfile.systemd-test -t systemd-test . 
3. docker run -d --tmpfs /tmp:rw,mode=1777,size=2G --name systemd-test systemd-test
4. docker exec systemd-test df -h

Actual results:
Filesystem                                             Size  Used Avail Use% Mounted on
/dev/mapper/luks-533c35ab-2572-45ad-b18b-5203c8b8563f  231G  192G   37G  84% /
tmpfs                                                  3.9G     0  3.9G   0% /dev
tmpfs                                                  3.9G     0  3.9G   0% /sys/fs/cgroup
tmpfs                                                  4.0E     0  4.0E   0% /tmp
/dev/mapper/luks-533c35ab-2572-45ad-b18b-5203c8b8563f  231G  192G   37G  84% /etc/hosts
shm                                                     64M     0   64M   0% /dev/shm
tmpfs                                                   64M   16K   64M   1% /run


Expected results:
A /tmp of 2G in size

Additional info:
Using docker inspect the tmpfs point is seen:

&quot;Tmpfs&quot;: {
  &quot;/tmp&quot;: &quot;rw,mode=1777,size=2G&quot;
},

However this is not reflect in mounts:

&quot;Mounts&quot;: [],

The oci-systemd-hook checks mounts in the json, but not tmpfs:

https://github.com/projectatomic/oci-systemd-hook/blob/master/src/systemdhook.c#L775

As a result it doesn&apos;t &quot;see&quot; /tmp as already mounted so promptly mounts over it with its own setting.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10131120</commentid>
    <comment_count>1</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-08 08:50:02 -0500</bug_when>
    <thetext>oci-systemd-hook-0.1.5-1.git16f7c8a.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-8a6b1e478c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10134136</commentid>
    <comment_count>2</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-02-09 07:17:34 -0500</bug_when>
    <thetext>This doesn&apos;t fix this test case ...

[ja.hogarth@lap37607 tmpfstest]$ docker run -d --tmpfs /tmp:rw,mode=1777,size=2G --name systemd-test systemd-test
0fa074ee8e282c0806dd5ca3d7023e3915a441eda66952732edf9ec4bda42d4a
[ja.hogarth@lap37607 tmpfstest]$  docker exec systemd-test df -h
Filesystem                                             Size  Used Avail Use% Mounted on
/dev/mapper/luks-533c35ab-2572-45ad-b18b-5203c8b8563f  231G   98G  131G  43% /
tmpfs                                                  3.9G     0  3.9G   0% /dev
tmpfs                                                  3.9G     0  3.9G   0% /sys/fs/cgroup
tmpfs                                                  3.9G     0  3.9G   0% /tmp
/dev/mapper/luks-533c35ab-2572-45ad-b18b-5203c8b8563f  231G   98G  131G  43% /etc/hosts
shm                                                     64M     0   64M   0% /dev/shm
tmpfs                                                   64M   16K   64M   1% /run
tmpfs                                                   64M     0   64M   0% /var/log/journal

Based on that run I&apos;d have expect /tmp to be 2G but it is still 50% of the host RAM as it has been overridden by the automounting of oci-systemd-hook still.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10134154</commentid>
    <comment_count>3</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-02-09 07:23:19 -0500</bug_when>
    <thetext>From docker inspect:

 &quot;Tmpfs&quot;: {
                &quot;/tmp&quot;: &quot;rw,mode=1777,size=2G&quot;
            },
 &quot;Mounts&quot;: [],


Looking at the code the decision about whether oci-systemd-hook should auto create the tmpfs structures (such as /tmp) is still based on Mounts, which is unpopulated.


[ja.hogarth@lap37607 tmpfstest]$ rpm -qa \*docker\* oci-systemd-hook
oci-systemd-hook-0.1.5-1.git16f7c8a.fc25.x86_64
python2-dockerfile-parse-0.0.5-7.fc25.noarch
docker-common-1.12.6-6.gitae7d637.fc25.x86_64
docker-1.12.6-6.gitae7d637.fc25.x86_64
docker-v1.10-migrator-1.12.6-6.gitae7d637.fc25.x86_64
python-docker-py-1.10.6-1.fc25.noarch
python2-docker-pycreds-0.2.1-2.fc25.noarch
docker-client-4.0.6-3.fc25.noarch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10135230</commentid>
    <comment_count>4</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-02-09 11:43:34 -0500</bug_when>
    <thetext>James could you attempt your test with this patch on oci-systemd-hook

https://github.com/projectatomic/oci-systemd-hook/pull/49

From my testing it fixes your issue, and greatly simplifies oci-systemd-hook.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10136225</commentid>
    <comment_count>5</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-02-09 17:20:47 -0500</bug_when>
    <thetext>oci-systemd-hook-0.1.5-1.git16f7c8a.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-8a6b1e478c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10136333</commentid>
    <comment_count>6</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-02-09 18:05:22 -0500</bug_when>
    <thetext>So the good news:

So I popped this on top of the most recent F25 build in koji (the one with the bodhi update) and it does indeed fix this issue:

rb:system|[james@james-lap tmpfstest]$ docker run -d --tmpfs /tmp:rw,mode=1777,size=2G --name systemd-test systemd-test
ae30a11142d7ee67d9693643ce74d90d74f76fce1b5aa32b067e66d60d241029
rb:system|[james@james-lap tmpfstest]$  docker exec systemd-test df -h
Filesystem                                             Size  Used Avail Use% Mounted on
/dev/sdb1                                              932G  348G  583G  38% /
tmpfs                                                  7.8G     0  7.8G   0% /dev
tmpfs                                                  7.8G     0  7.8G   0% /sys/fs/cgroup
tmpfs                                                  2.0G     0  2.0G   0% /tmp
/dev/sdb1                                              932G  348G  583G  38% /etc/hosts
shm                                                     64M     0   64M   0% /dev/shm
tmpfs                                                   64M     0   64M   0% /run
tmpfs                                                   64M     0   64M   0% /var/log/journal
/dev/mapper/luks-2d9f6449-a51a-41eb-9ee0-56b54271c942  111G   89G   21G  82% /var/log/journal/ae30a11142d7ee67d9693643ce74d90d

A 2GB /tmp on tmpfs specified and the container indeed shows /tmp with only 2G rather than the 8GB I&apos;d expect on this machine otherwise.

The bad news:

For some reason although you can see /sbin/init in docker top it doesn&apos;t appear to actually do anything:

rb:system|[james@james-lap tmpfstest]$ while true; do  docker top localtest-mdb ; sleep 1 ; done
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                8027                8011                0                   23:02               ?                   00:00:00            /sbin/init
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                8027                8011                0                   23:02               ?                   00:00:00            /sbin/init
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD

There&apos;s no journald or dbus etc so it&apos;s pretty broken like that and nothing in the way of logs.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10138025</commentid>
    <comment_count>7</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-02-10 08:33:00 -0500</bug_when>
    <thetext>Yes, I am continuing to work on it. For some reason I can&apos;t get anywhere on Rawhide with this stuff.  But I have pushed more patches to that branch which might fix your last issue.

Basically remount /sys/fs/cgroup/systemd so that it can be read/write</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10139281</commentid>
    <comment_count>8</comment_count>
    <who name="James Hogarth">james.hogarth</who>
    <bug_when>2017-02-10 15:08:44 -0500</bug_when>
    <thetext>So I&apos;ve built oci-systemd-hook with the current koji build and this applied on top of it:

https://patch-diff.githubusercontent.com/raw/projectatomic/oci-systemd-hook/pull/49.patch

From the three issues I raised recently:

bug 1406435 - this is still fixed with this patch applied

bug 1406830 - this bug is not fixed with this patch

docker run -d --tmpfs /tmp:rw,mode=1777,size=2G --name systemd-test systemd-test
tmpfs    7.8G     0  7.8G   0% /tmp

bug 1419040 - this bug is still fixed with this patch applied</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10139384</commentid>
    <comment_count>9</comment_count>
    <who name="Daniel Walsh">dwalsh</who>
    <bug_when>2017-02-10 16:33:38 -0500</bug_when>
    <thetext>That&apos;s weird, that one works for me.

docker run --rm -ti --tmpfs /tmp:rw,mode=1777,size=2G --name systemd-test fedora mount | grep /tmp
tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noexec,relatime,context=&quot;system_u:object_r:container_file_t:s0:c607,c838&quot;,size=2097152k)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10230902</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-12 07:41:48 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-a25973481c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10230905</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-12 07:42:07 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-5e4259e590</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10231298</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-12 17:51:53 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.5-1.git16f7c8a.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10231439</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-12 20:21:45 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-5e4259e590</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10231541</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-12 21:51:11 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-a25973481c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10238742</commentid>
    <comment_count>15</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-14 13:22:56 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10296607</commentid>
    <comment_count>16</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-01 12:57:17 -0400</bug_when>
    <thetext>oci-systemd-hook-0.1.6-1.gitfe22236.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>