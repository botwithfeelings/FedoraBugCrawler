<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1"
          urlbase="https://bugzilla.redhat.com/"
          
          maintainer="bugzilla-error-list@redhat.com"
>

    <bug>
          <bug_id>1430268</bug_id>
          
          <creation_ts>2017-03-08 04:10:00 -0500</creation_ts>
          <short_desc>high CPU load when usb PIV cards such as Yubikey NEO is removed.</short_desc>
          <delta_ts>2017-04-01 12:53:23 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Fedora</classification>
          <product>Fedora</product>
          <component>coolkey</component>
          <version>25</version>
          <rep_platform>x86_64</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>ERRATA</resolution>
          
          <see_also>https://bugzilla.redhat.com/show_bug.cgi?id=1364917</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>unspecified</priority>
          <bug_severity>unspecified</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Min Tun">minhantun</reporter>
          <assigned_to name="Jakub Jelen">jjelen</assigned_to>
          <cc>jjelen</cc>
    
    
    <cc>jmagne</cc>
    
    
    <cc>minhantun</cc>
    
    
    <cc>rrelyea</cc>
          <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>
          
          <cf_fixed_in>coolkey-1.1.0-31.fc25 coolkey-1.1.0-33.fc26</cf_fixed_in>
          <cf_doc_type>If docs needed, set a value</cf_doc_type>
          <cf_release_notes></cf_release_notes>
          <cf_story_points>---</cf_story_points>
          
          <cf_environment></cf_environment>
          <cf_last_closed>2017-03-20 23:19:48</cf_last_closed>
          <cf_type>Bug</cf_type>
          <cf_regression_status>---</cf_regression_status>
          <cf_mount_type>---</cf_mount_type>
          <cf_documentation_action>---</cf_documentation_action>
          <cf_crm></cf_crm>
          <cf_verified_branch></cf_verified_branch>
          <cf_category>---</cf_category>
          <cf_ovirt_team>---</cf_ovirt_team>
          
          <cf_cloudforms_team>---</cf_cloudforms_team>
          <external_bugs name="Red Hat Bugzilla">1286320</external_bugs>
          
          
          
          <target_release>---</target_release>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>10219731</commentid>
    <comment_count>0</comment_count>
    <who name="Min Tun">minhantun</who>
    <bug_when>2017-03-08 04:10:46 -0500</bug_when>
    <thetext>Description of problem:
gnome-session-worker and pcscd services spike up in CPU usage close to 100% combined when a USB based PIV card is removed. Tested with Yubikey Neo.

It would appear that coolkey package is the one causing the issue. Once the package is removed the behaviour is no longer there.

Version-Release number of selected component (if applicable):
coolkey 1.1.0-30-fc24

How reproducible:
repeatable very easily.

Steps to Reproduce:
1. sudo sudo -u gdm org.gnome.login-screen enable-smartcard-authentication true 
2. run top | grep pcscd or run top | grep gnome-session-worker
3. insert yubikey then remove
4. see CPU usage spike.

Expected results:
no change in CPU usage.


Additional info:
The same bug was reported in red hat (https://bugzilla.redhat.com/show_bug.cgi?id=1286320) and have been patched. It seems coolkey-1.1.0-36-el7_3 version contains the pacth (https://rhn.redhat.com/errata/RHBA-2017-0094.html) but not available in Fedora repos.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219770</commentid>
    <comment_count>1</comment_count>
    <who name="Min Tun">minhantun</who>
    <bug_when>2017-03-08 04:17:33 -0500</bug_when>
    <thetext>(In reply to Min Tun from comment #0)
&gt; Description of problem:
&gt; gnome-session-worker and pcscd services spike up in CPU usage close to 100%
&gt; combined when a USB based PIV card is removed. Tested with Yubikey Neo.
&gt; 
&gt; It would appear that coolkey package is the one causing the issue. Once the
&gt; package is removed the behaviour is no longer there.
&gt; 
&gt; Version-Release number of selected component (if applicable):
&gt; coolkey 1.1.0-30-fc24
&gt; 
&gt; How reproducible:
&gt; repeatable very easily.
&gt; 
&gt; Steps to Reproduce:
&gt; 1. sudo sudo -u gdm org.gnome.login-screen enable-smartcard-authentication
&gt; true 
&gt; 2. run top | grep pcscd or run top | grep gnome-session-worker
&gt; 3. insert yubikey then remove
&gt; 4. see CPU usage spike.
&gt; 
&gt; Expected results:
&gt; no change in CPU usage.
&gt; 
&gt; 
&gt; Additional info:
&gt; The same bug was reported in red hat
&gt; (https://bugzilla.redhat.com/show_bug.cgi?id=1286320) and have been patched.
&gt; It seems coolkey-1.1.0-36-el7_3 version contains the pacth
&gt; (https://rhn.redhat.com/errata/RHBA-2017-0094.html) but not available in
&gt; Fedora repos.

Its gnome-settings-daemon not gnome-session-worker</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219844</commentid>
    <comment_count>2</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2017-03-08 04:37:45 -0500</bug_when>
    <thetext>I was able to reproduce similar bug #1364917 with normal reader and normal PIV cards some time ago.

According to the Debian and the patch [1], it looks like it is fixed in the pcsc-lite-ccid-1.4.23 (in all Fedora releases today) [2].

The coolkey patch trying to address this issue is this patch [3], which is (most) probably the missing bit to make it working. I will try to build it together. Thanks for report.

[1] https://alioth.debian.org/plugins/scmgit/cgi-bin/gitweb.cgi?p=pcsclite/CCID.git;a=commitdiff_plain;h=3c21f452543983f3625a1965ce234074cbda6865
[2] https://anonscm.debian.org/cgit/pcsclite/CCID.git/commit/?id=3c21f452543983f3625a1965ce234074cbda6865
[3] https://git.centos.org/blob/rpms!coolkey/41c12790f3b9915ef3a1ebe2d610722180031c67/SOURCES!coolkey-1.1.0-max-cpu-bug.patch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10219973</commentid>
    <comment_count>3</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2017-03-08 05:09:39 -0500</bug_when>
    <thetext>Here is testing build with the patch discussed in the previous comment:

https://koji.fedoraproject.org/koji/taskinfo?taskID=18262935

Can you verify that it solves the problem for you? If so, I will send the updates soon.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223043</commentid>
    <comment_count>4</comment_count>
    <who name="Min Tun">minhantun</who>
    <bug_when>2017-03-08 18:02:41 -0500</bug_when>
    <thetext>Hi Jakub,

I have just tested the rpm. It has fixed the issue and no longer reproducible. How long does it normally take before this fix will be available in the repos? Thanks for your help.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223294</commentid>
    <comment_count>5</comment_count>
    <who name="Bob Relyea">rrelyea</who>
    <bug_when>2017-03-08 20:08:11 -0500</bug_when>
    <thetext>jakub. there&apos;s a RHEL patch that fixes this issue I&apos;ll attach it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223295</commentid>
    <comment_count>6</comment_count>
      <attachid>1261412</attachid>
    <who name="Bob Relyea">rrelyea</who>
    <bug_when>2017-03-08 20:09:24 -0500</bug_when>
    <thetext>Created attachment 1261412
Handle loop if the full reader is removed</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223296</commentid>
    <comment_count>7</comment_count>
    <who name="Bob Relyea">rrelyea</who>
    <bug_when>2017-03-08 20:10:57 -0500</bug_when>
    <thetext>ah, never mind you found the equivalent.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223913</commentid>
    <comment_count>8</comment_count>
    <who name="Jakub Jelen">jjelen</who>
    <bug_when>2017-03-09 03:16:01 -0500</bug_when>
    <thetext>Thank you for verification. I will submit builds today so you should be able to update today from testing or from stable a bit later.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223943</commentid>
    <comment_count>9</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-09 03:27:35 -0500</bug_when>
    <thetext>coolkey-1.1.0-33.fc26 has been submitted as an update to Fedora 26. https://bodhi.fedoraproject.org/updates/FEDORA-2017-34623e007d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10223988</commentid>
    <comment_count>10</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-09 03:40:35 -0500</bug_when>
    <thetext>coolkey-1.1.0-31.fc25 has been submitted as an update to Fedora 25. https://bodhi.fedoraproject.org/updates/FEDORA-2017-c680a6ecea</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10229838</commentid>
    <comment_count>11</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-10 18:23:24 -0500</bug_when>
    <thetext>coolkey-1.1.0-33.fc26 has been pushed to the Fedora 26 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-34623e007d</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10230389</commentid>
    <comment_count>12</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-11 09:24:51 -0500</bug_when>
    <thetext>coolkey-1.1.0-31.fc25 has been pushed to the Fedora 25 testing repository. If problems still persist, please make note of it in this bug report.
See https://fedoraproject.org/wiki/QA:Updates_Testing for
instructions on how to install test updates.
You can provide feedback for this update here: https://bodhi.fedoraproject.org/updates/FEDORA-2017-c680a6ecea</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10257692</commentid>
    <comment_count>13</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-03-20 23:19:48 -0400</bug_when>
    <thetext>coolkey-1.1.0-31.fc25 has been pushed to the Fedora 25 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>10296545</commentid>
    <comment_count>14</comment_count>
    <who name="Fedora Update System">updates</who>
    <bug_when>2017-04-01 12:53:23 -0400</bug_when>
    <thetext>coolkey-1.1.0-33.fc26 has been pushed to the Fedora 26 stable repository. If problems still persist, please make note of it in this bug report.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>1261412</attachid>
            <date>2017-03-08 20:09:00 -0500</date>
            <delta_ts>2017-03-08 20:09:24 -0500</delta_ts>
            <desc>Handle loop if the full reader is removed</desc>
            <filename>coolkey-1.1.0-fix-spurious-event.patch</filename>
            <type>text/plain</type>
            <size>700</size>
            <attacher name="Bob Relyea">rrelyea</attacher>
            
              <data encoding="base64">ZGlmZiAtdXAgLi9zcmMvY29vbGtleS9zbG90LmNwcC5maXgtc3B1cmlvdXMgLi9zcmMvY29vbGtl
eS9zbG90LmNwcAotLS0gLi9zcmMvY29vbGtleS9zbG90LmNwcC5maXgtc3B1cmlvdXMJMjAxNC0w
OS0yNiAxNTozMToxNy4yNzc5NTg4OTUgLTA3MDAKKysrIC4vc3JjL2Nvb2xrZXkvc2xvdC5jcHAJ
MjAxNC0wOS0yNiAxNTozNDozMy4yMTgzMTMyMjcgLTA3MDAKQEAgLTE0MTIsNiArMTQxMiw3IEBA
IFNsb3RMaXN0Ojp3YWl0Rm9yU2xvdEV2ZW50KENLX0ZMQUdTIGZsYWcKICAgICAgICAgI2VuZGlm
CiAgICAgfSB3aGlsZSAoKHN0YXR1cyA9PSBDS1lTVUNDRVNTKSB8fAogICAgICAgIChDS1lDYXJk
Q29udGV4dF9HZXRMYXN0RXJyb3IoY29udGV4dCkgPT0gU0NBUkRfRV9USU1FT1VUKSB8fAorICAg
ICAgIChDS1lDYXJkQ29udGV4dF9HZXRMYXN0RXJyb3IoY29udGV4dCkgPT0gU0NBUkRfRV9VTktO
T1dOX1JFQURFUikgfHwKICAgICAgICAoQ0tZQ2FyZENvbnRleHRfR2V0TGFzdEVycm9yKGNvbnRl
eHQpID09IFNDQVJEX0VfUkVBREVSX1VOQVZBSUxBQkxFKSB8fAogICAgICAgIChDS1lDYXJkQ29u
dGV4dF9HZXRMYXN0RXJyb3IoY29udGV4dCkgPT0gU0NBUkRfRV9OT19TRVJWSUNFKSB8fAogICAg
ICAgIChDS1lDYXJkQ29udGV4dF9HZXRMYXN0RXJyb3IoY29udGV4dCkgPT0gU0NBUkRfRV9TRVJW
SUNFX1NUT1BQRUQpICk7Cg==
</data>

          </attachment>
      

    </bug>

</bugzilla>