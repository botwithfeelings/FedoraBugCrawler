<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.redhat.com/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.12068.1" urlbase="https://bugzilla.redhat.com/" maintainer="bugzilla-error-list@redhat.com">

  <bug>
    <bug_id>1344387</bug_id>

    <creation_ts>2016-06-09 10:25:00 -0400</creation_ts>
    <short_desc>Cannot change winbind password</short_desc>
    <delta_ts>2016-06-10 04:14:44 -0400</delta_ts>
    <reporter_accessible>1</reporter_accessible>
    <cclist_accessible>1</cclist_accessible>
    <classification_id>2</classification_id>
    <classification>Fedora</classification>
    <product>Fedora</product>
    <component>authconfig</component>
    <version>24</version>
    <rep_platform>Unspecified</rep_platform>
    <op_sys>Unspecified</op_sys>
    <bug_status>CLOSED</bug_status>
    <resolution>WONTFIX</resolution>

    <bug_file_loc></bug_file_loc>
    <status_whiteboard></status_whiteboard>
    <keywords></keywords>
    <priority>unspecified</priority>
    <bug_severity>unspecified</bug_severity>
    <target_milestone>---</target_milestone>

    <everconfirmed>1</everconfirmed>
    <reporter name="David Woodhouse">dwmw2</reporter>
    <assigned_to name="Tomas Mraz">tmraz</assigned_to>
    <cc>abokovoy</cc>

    <cc>asn</cc>

    <cc>gdeschner</cc>

    <cc>jlayton</cc>

    <cc>jlieskov</cc>

    <cc>jrivera</cc>

    <cc>lmohanty</cc>

    <cc>madam</cc>

    <cc>sbose</cc>

    <cc>ssorce</cc>

    <cc>tmraz</cc>
    <qa_contact name="Fedora Extras Quality Assurance">extras-qa</qa_contact>

    <cf_fixed_in></cf_fixed_in>
  <cf_doc_type>If docs needed, set a value</cf_doc_type>
<cf_release_notes></cf_release_notes>
<cf_story_points>---</cf_story_points>

<cf_environment></cf_environment>
<cf_last_closed>2016-06-10 03:38:53</cf_last_closed>
<cf_type>Bug</cf_type>
<cf_regression_status>---</cf_regression_status>
<cf_mount_type>---</cf_mount_type>
<cf_documentation_action>---</cf_documentation_action>
<cf_crm></cf_crm>
<cf_verified_branch></cf_verified_branch>
<cf_category>---</cf_category>
<cf_ovirt_team>---</cf_ovirt_team>

<cf_cloudforms_team>---</cf_cloudforms_team>

<target_release>---</target_release>

<votes>0</votes>

<comment_sort_order>oldest_to_newest</comment_sort_order>
<long_desc isprivate="0">
<commentid>9401368</commentid>
<comment_count>0</comment_count>
<who name="David Woodhouse">dwmw2</who>
<bug_when>2016-06-09 10:25:43 -0400</bug_when>
<thetext>[dwoodhou@i7 ~]$ passwd Changing password for user dwoodhou. Changing password for dwoodhou. (current) UNIX password: Changing password for dwoodhou (current) NT password: passwd: Authentication token manipulation error [2016/06/09
15:23:32.168000, 4, pid=89748, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_dual.c:1389(child_handler) child daemon request 13 [2016/06/09 15:23:32.168106, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_dual.c:512(child_process_request) child_process_request: request fn PAM_AUTH [2016/06/09 15:23:32.168132, 3, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:1671(winbindd_dual_pam_auth) [89746]: dual pam auth GER\dwoodhou [2016/06/09 15:23:32.168153, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:1713(winbindd_dual_pam_auth) winbindd_dual_pam_auth: domain: GER last was online [2016/06/09 15:23:32.168172, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:1172(winbindd_dual_pam_auth_kerberos) winbindd_dual_pam_auth_kerberos [2016/06/09 15:23:32.168196, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:545(generate_krb5_ccache) using ccache: MEMORY:winbindd_pam_ccache (internal) [2016/06/09 15:23:33.251161, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:724(winbindd_raw_kerberos_login) winbindd_raw_kerberos_login: winbindd validated ticket of dwoodhou@GER.CORP.INTEL.COM [2016/06/09 15:23:33.251300, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:1724(winbindd_dual_pam_auth) winbindd_dual_pam_auth_kerberos succeeded [2016/06/09 15:23:33.251411, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:542(refresh_sequence_number) refresh_sequence_number: GER time ok [2016/06/09 15:23:33.251436, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:587(refresh_sequence_number) refresh_sequence_number: GER seq number is now 1465221236 [2016/06/09 15:23:33.251471, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:966(wcache_save_name_to_sid) wcache_save_name_to_sid: GER\DWOODHOU -&gt; S-1-5-21-2052111302-1275210071-1644491937-279532 (NT_STATUS_OK) [2016/06/09 15:23:33.251749, 10, pid=89748, effective(0, 0), real(0, 0),
class=winbind] ../source3/winbindd/winbindd_cache.c:542(refresh_sequence_number) refresh_sequence_number: GER time ok [2016/06/09 15:23:33.251767, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:587(refresh_sequence_number) refresh_sequence_number: GER seq number is now 1465221236 [2016/06/09 15:23:33.251786, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:628(centry_expired) centry_expired: Key PWD_POL/GER for domain GER is good. [2016/06/09 15:23:33.251816, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:736(wcache_fetch) wcache_fetch: returning entry PWD_POL/GER for domain GER [2016/06/09 15:23:33.251830, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_cache.c:3039(password_policy) lockout_policy: [Cached] - cached info for domain GER status: NT_STATUS_OK [2016/06/09 15:23:33.251846, 5, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_pam.c:1932(winbindd_dual_pam_auth) Plain-text authentication for user GER\dwoodhou returned NT_STATUS_OK (PAM: 0) [2016/06/09 15:23:33.251863, 4, pid=89748, effective(0, 0), real(0, 0), class=winbind]
../source3/winbindd/winbindd_dual.c:1397(child_handler) Finished processing child request 13 [2016/06/09 15:23:33.251877, 10, pid=89748, effective(0, 0), real(0, 0), class=winbind] ../source3/winbindd/winbindd_dual.c:104(child_write_response) Writing
8078 bytes to parent</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9401371</commentid>
<comment_count>1</comment_count>
<who name="David Woodhouse">dwmw2</who>
<bug_when>2016-06-09 10:26:36 -0400</bug_when>
<thetext>/etc/pam.d/system-auth (as used by /etc/pam.d/passwd) looks like this: #password requisite pam_pwquality.so try_first_pass retry=3 password sufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok password sufficient
pam_winbind.so use_authtok password required pam_deny.so</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9401592</commentid>
<comment_count>2</comment_count>
<who name="Guenther Deschner">gdeschner</who>
<bug_when>2016-06-09 11:22:50 -0400</bug_when>
<thetext>Can you try to move &quot;password sufficient pam_winbind.so&quot; above &quot;password sufficient pam_unix.so&quot; and retry? From the logs no password change attempt is registered at all. Also, &quot;auth&quot; and &quot;account&quot;
need to know about winbind as well.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9402085</commentid>
<comment_count>3</comment_count>
<who name="David Woodhouse">dwmw2</who>
<bug_when>2016-06-09 14:38:34 -0400</bug_when>
<thetext>(In reply to Guenther Deschner from comment #2) &gt; Can you try to move &gt; &gt; &quot;password sufficient pam_winbind.so&quot; &gt; &gt; above &gt; &gt; &quot;password sufficient pam_unix.so&quot; &gt; &gt; and retry? From the logs no
password change attempt is registered at all. &gt; &gt; Also, &quot;auth&quot; and &quot;account&quot; need to know about winbind as well. Yeah, it&apos;s all set up by authconfig: authconfig --update --enablewinbindauth --disablewinbind
--disablesssd \ --disablesssdauth --enablewinbindusedefaultdomain --enablewinbindoffline \ --disablelocauthorize; With pam_unix removed (or placed later as you suggest) the effect is remarkably similar: $ passwd Changing password for user dwoodhou.
Changing password for dwoodhou (current) NT password: passwd: Authentication token manipulation error From /var/log/secure... Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] ENTER: pam_sm_chauthtok (flags: 0x4000) Jun
9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_SERVICE) = &quot;passwd&quot; (0x5651aac51360) Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_USER) =
&quot;dwoodhou&quot; (0x5651aac51380) Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_TTY) = &quot;pts/96&quot; (0x5651aac50ce0) Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): [pamh:
0x5651aac511e0] STATE: ITEM(PAM_CONV) = 0x5651aac513a0 Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): username [dwoodhou] obtained Jun 9 19:38:06 i7 passwd: pam_winbind(passwd:chauthtok): getting password (0x000051a3) Jun 9 19:38:10 i7
passwd: pam_winbind(passwd:chauthtok): enabling krb5 login flag Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): request wbcLogonUser succeeded Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): user &apos;dwoodhou&apos; granted access
Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] LEAVE: pam_sm_chauthtok returning 0 (PAM_SUCCESS) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_SERVICE) =
&quot;passwd&quot; (0x5651aac51360) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_USER) = &quot;dwoodhou&quot; (0x5651aac51380) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh:
0x5651aac511e0] STATE: ITEM(PAM_TTY) = &quot;pts/96&quot; (0x5651aac50ce0) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_OLDAUTHTOK) = 0x5651aac5b8b0 Jun 9 19:38:11 i7 passwd:
pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_CONV) = 0x5651aac513a0 Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSCRIPT) = &quot;logon.bat&quot; (0x5651aac5b930)
Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSERVER) = &quot;IRSGER402&quot; (0x5651aac5bc60) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE:
DATA(PAM_WINBIND_PWD_LAST_SET) = 0x57597c07 Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] ENTER: pam_sm_chauthtok (flags: 0x2000) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE:
ITEM(PAM_SERVICE) = &quot;passwd&quot; (0x5651aac51360) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_USER) = &quot;dwoodhou&quot; (0x5651aac51380) Jun 9 19:38:11 i7 passwd:
pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_TTY) = &quot;pts/96&quot; (0x5651aac50ce0) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_OLDAUTHTOK) = 0x5651aac5b8b0 Jun 9
19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_CONV) = 0x5651aac513a0 Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSCRIPT) =
&quot;logon.bat&quot; (0x5651aac5b930) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSERVER) = &quot;IRSGER402&quot; (0x5651aac5bc60) Jun 9 19:38:11 i7 passwd:
pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_PWD_LAST_SET) = 0x57597c07 Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): username [dwoodhou] obtained Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok):
getting password (0x00005193) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): password - new password not obtained Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] LEAVE: pam_sm_chauthtok returning 21
(PAM_AUTHTOK_RECOVER_ERR) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_SERVICE) = &quot;passwd&quot; (0x5651aac51360) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0]
STATE: ITEM(PAM_USER) = &quot;dwoodhou&quot; (0x5651aac51380) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_TTY) = &quot;pts/96&quot; (0x5651aac50ce0) Jun 9 19:38:11 i7 passwd:
pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_OLDAUTHTOK) = 0x5651aac5b8b0 Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: ITEM(PAM_CONV) = 0x5651aac513a0 Jun 9 19:38:11 i7 passwd:
pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSCRIPT) = &quot;logon.bat&quot; (0x5651aac5b930) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_LOGONSERVER) =
&quot;IRSGER402&quot; (0x5651aac5bc60) Jun 9 19:38:11 i7 passwd: pam_winbind(passwd:chauthtok): [pamh: 0x5651aac511e0] STATE: DATA(PAM_WINBIND_PWD_LAST_SET) = 0x57597c07 Jun 9 19:38:11 i7 passwd: gkr-pam: no password set, and use_authtok was
specified Jun 9 19:38:13 i7 passwd: PAM [pamh: 0x5651aac511e0] CLEAN: cleaning up PAM data 0x5651aac5bc60 (error_status = 20) Jun 9 19:38:13 i7 passwd: PAM [pamh: 0x5651aac511e0] CLEAN: cleaning up PAM data 0x5651aac5b930 (error_status = 20)</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9402088</commentid>
<comment_count>4</comment_count>
<who name="David Woodhouse">dwmw2</who>
<bug_when>2016-06-09 14:40:31 -0400</bug_when>
<thetext>Oh, there&apos;s a clue there. If I remove &apos;use_authtok&apos; it works...</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9402277</commentid>
<comment_count>5</comment_count>
<who name="Sumit Bose">sbose</who>
<bug_when>2016-06-09 15:47:00 -0400</bug_when>
<thetext>Given that you commented out the pam_pwquality.so according to comment #1 this is expected. pam_pwquality.so would have asked for the new password, check it according to its rules and put it on the PAM stack for other modules to consume.
authconfig adds the &apos;use_authtok&apos; option to the other modules to make sure that they use the password which was checked by pam_pwquality.so and not ask on their own. I agree that it makes sense to disable pam_pwquality.so for user managed
by pam_winbind because AD is doing password policy checks on it own. Nevertheless pam_pwquality.so might still be useful for local user handled by pam_unix. That&apos;s why authconfig puts it in front. I would expect that unless you remove
use_authtok from pam_unix as well you cannot change the password of local users either.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9403222</commentid>
<comment_count>6</comment_count>
<who name="Tomas Mraz">tmraz</who>
<bug_when>2016-06-10 03:38:53 -0400</bug_when>
<thetext>I&apos;m sorry but authconfig cannot accommodate manual editing of pam configuration files. If you start to edit it you&apos;re on your own.</thetext>
</long_desc>
<long_desc isprivate="0">
<commentid>9403283</commentid>
<comment_count>7</comment_count>
<who name="David Woodhouse">dwmw2</who>
<bug_when>2016-06-10 04:14:44 -0400</bug_when>
<thetext>Apologies, yes. I&apos;d always believed this didn&apos;t work &quot;out of the box&quot;, and had forgotten that I&apos;d tweaked the config file on this box... perhaps in an attempt to get it to work. I just never got round to chasing it
up and filing a bug (there were more important things to be fixing). Whatever the original problem *was*, it seems to have gone away. A clean config *is* working.</thetext>
</long_desc>

</bug>

</bugzilla>
